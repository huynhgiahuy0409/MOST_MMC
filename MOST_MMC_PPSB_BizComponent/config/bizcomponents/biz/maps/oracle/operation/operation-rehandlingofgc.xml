<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="rehandlingOfGC">
	
	<resultMap 	type="rehandlingOfGCItem" 		id="CargoRehandlingItemMap">	
		<result property="jobNo"					column="JOBNO"/>
		<result property="rhdlNo"					column="RHDLNO"/>
		<result property="orgRefNo"					column="ORGREFNO"/>
		<result property="vslCallId"				column="VSLCALLID"/>
		<result property="nxVslCallId"				column="NXVSLCALLID"/>
		<result property="nxRefNo"					column="NXREFNO"/>
		<result property="opeClassCd"				column="OPECLASSCD"/>
		<result property="caTgNm"					column="CATGNM"/>
		<result property="pkgQty"					column="PKGQTY"/>
		<result property="wgt"						column="WGT"/>
		<result property="msrmt"					column="MSRMT"/>
		<result property="stsYn"					column="STSYN"/>
		<result property="orgGrNo"					column="ORGGRNO"/>
		<result property="cgNo"						column="CGNO"/>
		<result property="rhdlMode"					column="RHDLMODE"/>
		<result property="rhdlModeNm"				column="RHDLMODENM"/>	
		<result property="rhdlPkgQty"				column="RHDLPKGQTY"/>
		<result property="rhdlWgt"					column="RHDLWGT"/>
		<result property="rhdlMsrmt"				column="RHDLMSRMT"/>
		<result property="balPkgQty"				column="BALPKGQTY"/>
		<result property="balWgt"					column="BALWGT"/>
		<result property="balMsrmt"					column="BALMSRMT"/>		
		<result property="cgCoCd"					column="CGCOCD"/>
		<result property="cgCoNm"					column="CGCONM"/>
		<result property="rhdlChk"					column="RHDLCHK"/>
		<result property="spCaCoCd"					column="SPCACOCD"/>
		<result property="spCaCoNm"					column="SPCACONM"/>
		<result property="shuYn"					column="SHUYN"/>
		<result property="dmgYn"					column="DMGYN"/>
		<result property="blSn"						column="BLSN"/>
		<result property="cgTpCd" 					column="CGTPCD"/>
		<result property="nxCgNo" 					column="NXCGNO"/>
		<result property="orgBlSn" 			column="ORGBLSN"/>
		<result property="orgVslCallId" 			column="ORGVSLCALLID"/>
		<!--<result property="stat" 			column="STAT"/>--> 
		<result property="statNm" 			column="STATNM"/>
		<result property="orgCgNo" 			column="ORGCGNO"/>
		<result property="fnlHoYn" 			column="FNLHOYN"/>
		<result property="fnlLoadYn" 			column="FNLLOADYN"/>		
		<result property="grNo"					column="GRNO"/>
		<result property="rhdlGroupNo"					column="RHDLGROUPNO"/>
		<result property="userId"					column="USERID"/>
		<result property="updDt"					column="UPDDT"/>
		<result property="linked"					column="LINKED"/>
		<result property="whLocIds"					column="WHLOCIDS"/>
		<result property="delvTpCd"					column="DELVTPCD"/>
		
    </resultMap>
	<!--  ################ Query Statement Define ######################################### -->
	<sql id="sqlRehandleMstAuth">
		<if test='userType == "E"'>			
  			AND
			 (
                    EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.SHIPG_NOTE_NO 
                               AND SN.FWRD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.SHIPG_NOTE_NO 
                               AND SN.SHIPG_AGNCY = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TVC_VSL_SCH S, TMT_BL L, TFZ_DOC_PTNR_ROLE_DEF D
							 WHERE S.JPVC_NO = A.VSL_CALL_ID 
				               AND S.VSL_CD = L.VSL_CD
				               AND S.CALL_YEAR = L.CALL_YEAR
				               AND S.CALL_SEQ = L.CALL_SEQ
							   AND L.BL_NO = A.CG_NO
							   AND L.DOC_ID = D.DOC_ID 
							   AND L.JOB_NO = D.JOB_NO 
							   AND D.PTNR_CD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_BL BL
                             WHERE BL.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND BL.BL_NO = A.CG_NO 
                               AND BL.TSPTR = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN, TMT_GR GR 
                             WHERE SN.TSPT_COMP = #{ptnrCode}
                               AND SN.VSL_CALL_ID = GR.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
                               AND GR.VSL_CALL_ID = A.VSL_CALL_ID
                               AND GR.GR_NO = A.CG_NO)
                )
		</if>
	</sql>
	
	<sql id="sqlRehandleAuth">
		<if test='userType == "E"'>			
  			AND
			 (
                    EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.ORG_REF_NO 
                               AND SN.FWRD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID
                               AND SN.SHIPG_NOTE_NO = A.ORG_REF_NO  
                               AND SN.SHIPG_AGNCY = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TVC_VSL_SCH S, TMT_BL L, TFZ_DOC_PTNR_ROLE_DEF D
							 WHERE S.JPVC_NO = A.VSL_CALL_ID 
				               AND S.VSL_CD = L.VSL_CD
				               AND S.CALL_YEAR = L.CALL_YEAR
				               AND S.CALL_SEQ = L.CALL_SEQ
							   AND L.BL_NO = A.CG_NO
							   AND L.DOC_ID = D.DOC_ID 
							   AND L.JOB_NO = D.JOB_NO 
							   AND D.PTNR_CD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_BL BL
                             WHERE BL.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND BL.BL_NO = A.CG_NO 
                               AND BL.TSPTR = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN, TMT_GR GR 
                             WHERE SN.TSPT_COMP = #{ptnrCode}
                               AND SN.VSL_CALL_ID = GR.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
                               AND GR.VSL_CALL_ID = A.VSL_CALL_ID
                               AND GR.GR_NO = A.CG_NO)
                )
		</if>
	</sql>
	
	<sql id ="dynamic_rh_all">	<!-- 4 -->
		<if test="nxVslCallId == null or nxVslCallId == ''">
		
			SELECT	
			   		A.VSL_CALL_ID	   												AS VSLCALLID,
			   		DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO, 'I',A.CG_NO,'T',A.CG_NO) 				    AS ORGREFNO, 
			   		DECODE(A.OPE_CLASS_CD,'S',A.CG_NO,'E',A.CG_NO,'') 		   	    AS ORGGRNO,
			   		'' 		   	    AS GRNO,
			   		DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO,
			   	                     'I',A.CG_NO,'T',A.CG_NO) 							AS BLSN,
			   		A.CG_NO															AS CGNO,
			   		A.CG_NO															AS ORGCGNO,
			   		' '      		   		   										AS NXVSLCALLID,
		       		' '              		   										AS NXREFNO,
			   		A.OPE_CLASS_CD 			   		   	   						    AS OPECLASSCD,
				   	(SELECT 	TCM.S_CD_NM 
				   		FROM 	TMT_CD_MSTD TCM 
				   		WHERE  	TCM.L_CD = 'MT' 
				    	   		AND TCM.M_CD = 'CATGTP' 
						   		AND TCM.S_CD = A.OPE_CLASS_CD)							AS CATGNM,
			   		B.PKG_QTY   			  											AS PKGQTY,
			   		B.WGT 															AS WGT,
			   		B.MSRMT 															AS MSRMT,
			   		' '              	 	   										AS STSYN,
		       		' '			           											AS RHDLMODE,
		       		' '					   											AS RHDLMODENM,
			   		0					   											AS RHDLPKGQTY,
			  		0.00					   											AS RHDLWGT,
			   		0.00					   											AS RHDLMSRMT,
			  		TO_NUMBER(B.PKG_QTY) 												AS BALPKGQTY,
			  		TO_NUMBER(B.WGT) 													AS BALWGT,
			  		TO_NUMBER(B.MSRMT) 												AS BALMSRMT,
					' '              				  									AS RHDLNO,
					A.STAFF_CD		   			  									AS USERID,
					TO_CHAR(A.UPDATE_TIME,'DD/MM/YYYY HH24:MI')								AS UPDDT,
					B.WH_TP_CD			  	  	   	  									AS CGCOCD,
					(SELECT 	TCM.S_CD_NM 
				   		FROM 	TMT_CD_MSTD TCM 
				   		WHERE  	TCM.L_CD = 'MT' 
				   	   			AND TCM.M_CD = 'CGCOCD' 
					   			AND TCM.S_CD = B.WH_TP_CD)	   	 							AS CGCONM,
					'N'   																AS RHDLCHK,
					' '		  															AS JOBNO,
					DECODE(B.WH_TP_CD, 'S','Y','N') AS SHUYN,
					DECODE(B.WH_TP_CD, 'D','Y','N') AS DMGYN,
					B.SP_CA_CO_CD 														AS SPCACOCD,
					(SELECT		TCM.S_CD_NM 
			   			FROM 	TMT_CD_MSTD TCM 
			   			WHERE  	TCM.L_CD = 'MT' 
			   	   				AND TCM.M_CD = 'SPCACOCD' 
				   				AND TCM.S_CD = B.SP_CA_CO_CD)	   	 						AS SPCACONM,
					' ' AS CGTPCD,
					' ' AS NXCGNO,
					A.VSL_CALL_ID	   													AS ORGVSLCALLID,
					DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO,
			   	                     'I',A.CG_NO,'T',A.CG_NO) 				    AS ORGBLSN,
					'' AS STAT,
					'' AS STATNM,
					'N' AS FNLHOYN,
					'N' AS FNLLOADYN,
					'' AS RHDLGROUPNO,
					'' AS LINKED,
					F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
					'' AS delvTpCd			 
			FROM 	TMT_CG_MST A,
		 			TMT_BL BL,
       				TMT_SHIPG_NOTE SN,
			 		(SELECT	INA.VSL_CALL_ID AS  VSL_CALL_ID,
                    		INA.CG_NO       AS  CG_NO,
		                    INA.WH_TP_CD    AS  WH_TP_CD,
		                    INA.PKG_QTY     AS  PKG_QTY,
		                    INA.MSRMT       AS  MSRMT,
		                    INA.WGT         AS  WGT,
		                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM	(SELECT 
			                           	LC.VSL_CALL_ID         AS VSL_CALL_ID ,
			                           	LC.CG_NO               AS CG_NO ,
			                           	LC.WH_TP_CD              AS WH_TP_CD,
			                           	SUM(LC.PKG_QTY)        AS PKG_QTY,
			                           	SUM(LC.CG_VOL)           AS MSRMT ,
			                           	SUM(LC.CG_WGT)             AS WGT,
			                           	J.SP_CA_CO_CD        AS SP_CA_CO_CD
								FROM	TMT_INV_LOC LC, TMT_JOB J
               		 			WHERE 	LC.JOB_NO = J.JOB_NO 
										AND LC.VSL_CALL_ID = J.VSL_CALL_ID
										AND    LC.CG_NO = J.CG_NO
										AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
                				GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
                	WHERE	INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
			WHERE	A.VSL_CALL_ID = B.VSL_CALL_ID
					AND	  A.CG_NO = B.CG_NO
		 			AND A.VSL_CALL_ID = BL.VSL_CALL_ID(+) AND A.CG_NO = BL.BL_NO(+)
 					AND A.VSL_CALL_ID = SN.VSL_CALL_ID(+) AND A.SHIPG_NOTE_NO = SN.SHIPG_NOTE_NO(+)
 					AND A.CG_NO NOT IN (SELECT CG_NO FROM TMT_RHDL_CG WHERE VSL_CALL_ID = A.VSL_CALL_ID AND CG_NO = A.CG_NO)
					<if test="estArrvDateFrm != null and estArrvDateFrm != ''">
						AND
						  ( BL.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
									00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
									' 23:59:59','DD/MM/YYYY HH24:MI:SS') OR
						 SN.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
									00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
									' 23:59:59','DD/MM/YYYY HH24:MI:SS')
						  )
					</if> 
					<if test="vslCallId != null and vslCallId != ''">
			  			AND B.VSL_CALL_ID = #{vslCallId}
					</if>
					<if test="opeClassCd != null and opeClassCd != ''">
			  			AND A.OPE_CLASS_CD = #{opeClassCd}
					</if>
					<if test="shipgNoteNo != null and shipgNoteNo != ''">
						<if test="blNo != null and blNo != ''">
			   				AND (A.SHIPG_NOTE_NO = #{shipgNoteNo}  OR  A.CG_NO = #{blNo})
						</if>
						<if test="blNo == null or blNo == ''">
			   				AND
							A.SHIPG_NOTE_NO = #{shipgNoteNo} 
						</if>  
					</if>
					<if test="shipgNoteNo == null or shipgNoteNo == ''">
						<if test="blNo != null and blNo != ''">
			   				AND A.CG_NO = #{blNo}
						 </if>
					</if>
					<include refid="sqlRehandleMstAuth"/>
			UNION ALL	
		</if>	
		SELECT	A.VSL_CALL_ID         											AS VSLCALLID,
		       	A.ORG_REF_NO           											AS ORGREFNO,
		       	A.ORG_GR_NO            											AS ORGGRNO,
		        '' 		   	    AS GRNO,
		        (SELECT DECODE(COUNT(*),0,A.ORG_REF_NO,A.NX_REF_NO) 
			   		   FROM TMT_RHDL_CG G 
					   WHERE G.RHDL_NO = A.RHDL_NO
					   AND	 G.RHDL_MODE = 'C'
					   AND	 G.NX_REF_NO IS NOT NULL) 							AS BLSN,
			   	A.CG_NO				  											AS CGNO,			   
			   	A.CG_NO															AS ORGCGNO,			  
			   	A.NX_VSL_CALL_ID       											AS NXVSLCALLID,
		       	A.NX_REF_NO            											AS NXREFNO,
			   	A.OPE_CLASS_CD         											AS OPECLASSCD,
			   	(SELECT 	TCM.S_CD_NM 
			   		FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
			   	   			AND TCM.M_CD = 'CATGTP' 
				   			AND TCM.S_CD = A.OPE_CLASS_CD )								AS CATGNM,
			   	CASE 
			   	   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.PKG_QTY FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT		SUM(LC.PKG_QTY)
							FROM 	TMT_INV_LOC LC, TMT_JOB J
							WHERE 	LC.JOB_NO = J.JOB_NO
									AND LC.VSL_CALL_ID = J.VSL_CALL_ID
									AND	LC.CG_NO = J.CG_NO
									AND	LC.WH_TP_CD = A.CG_CO_CD
									AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
									AND	LC.CG_NO = A.CG_NO
									AND LC.VSL_CALL_ID = A.VSL_CALL_ID
									AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
							HAVING SUM(LC.PKG_QTY) <![CDATA[ > ]]> 0
							GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS PKGQTY,
			   	CASE
				   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.CG_WGT FROM TMT_JOB J WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT		SUM(LC.CG_WGT)
							FROM 	TMT_INV_LOC LC, TMT_JOB J
							WHERE 	LC.JOB_NO = J.JOB_NO
									AND LC.VSL_CALL_ID = J.VSL_CALL_ID
									AND	LC.CG_NO = J.CG_NO
									AND	LC.WH_TP_CD = A.CG_CO_CD
									AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
									AND	LC.CG_NO = A.CG_NO
									AND LC.VSL_CALL_ID = A.VSL_CALL_ID
									AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
							HAVING SUM(LC.CG_WGT) <![CDATA[ > ]]> 0
							GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS WGT,
			   	CASE 
			   		WHEN A.JOB_NO IS NOT NULL
				   	THEN
				   	   NVL((SELECT J.CG_VOL FROM TMT_JOB J WHERE J.JOB_NO = A.JOB_NO),0)
				   	WHEN A.JOB_NO IS NULL
				   	THEN
				  	NVL((SELECT		SUM(LC.CG_VOL)
							FROM	TMT_INV_LOC LC, TMT_JOB J
							WHERE 	LC.JOB_NO = J.JOB_NO
									AND LC.VSL_CALL_ID = J.VSL_CALL_ID
									AND	LC.CG_NO = J.CG_NO
									AND	LC.WH_TP_CD = A.CG_CO_CD
									AND NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
									AND	LC.CG_NO = A.CG_NO
									AND LC.VSL_CALL_ID = A.VSL_CALL_ID
									AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
							HAVING SUM(LC.CG_VOL) <![CDATA[ > ]]> 0
							GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS MSRMT,
		       	A.STS_YN               														AS STSYN,
		       	A.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD  WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = A.RHDL_MODE)            	AS RHDLMODENM,
			   	NVL(TO_NUMBER(A.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   	NVL(TO_NUMBER(REPLACE(NVL(A.CG_WGT,0),',','')),0) 	   							AS RHDLWGT,
			   	NVL(TO_NUMBER(A.CG_VOL),0)						   							AS RHDLMSRMT,
			   	TO_NUMBER(B.PKG_QTY)
			   		- TO_NUMBER((SELECT NVL(SUM(H.PKG_QTY),0) 
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALPKGQTY,
			   	TO_NUMBER(B.WGT)    
			   		- TO_NUMBER((SELECT NVL(SUM(H.CG_WGT),0) 
			   	 			FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALWGT,
			   	TO_NUMBER(B.MSRMT)	
			   		- TO_NUMBER((SELECT NVL(SUM(H.CG_VOL),0)
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')								
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALMSRMT,
			   	A.RHDL_NO              														AS RHDLNO,
			   	A.STAFF_CD		   			  											AS USERID,
			   	TO_CHAR(A.UPDATE_TIME,'DD/MM/YYYY HH24:MI')										AS UPDDT,
			   	A.CG_CO_CD 																	AS CGCOCD,
			   	(SELECT		TCM.S_CD_NM 
			   		FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
					   	   	AND TCM.M_CD = 'CGCOCD' 
						   	AND TCM.S_CD = A.CG_CO_CD)	   	 										AS CGCONM,
			   	'Y' 																			AS RHDLCHK,
			   	A.JOB_NO		  																AS JOBNO,
			  	DECODE(A.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  	DECODE(A.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  	A.SP_CA_CO_CD 														AS SPCACOCD,
			  	(SELECT		TCM.S_CD_NM 
			   		FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
					   	   	AND TCM.M_CD = 'SPCACOCD' 
						   	AND TCM.S_CD = A.SP_CA_CO_CD)	   	 						AS SPCACONM,
				' ' AS CGTPCD,
				A.NX_CG_NO AS NXCGNO,
				A.VSL_CALL_ID	   													AS ORGVSLCALLID,
				A.ORG_REF_NO													    AS ORGBLSN,
				'' AS STAT,
				'' AS STATNM,
				'N' AS FNLHOYN,
				'N' AS FNLLOADYN,
			 	A.RHDL_GROUP_NO AS RHDLGROUPNO,
			 	'' AS LINKED,
				F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
				'' AS delvTpCd	 			      
		FROM 	TMT_RHDL_CG A,
       			TMT_BL BL,
       			TMT_SHIPG_NOTE SN
			 	,(SELECT	INA.VSL_CALL_ID AS  VSL_CALL_ID,
		                    INA.CG_NO       AS  CG_NO,
		                    INA.WH_TP_CD    AS  WH_TP_CD,
		                    INA.PKG_QTY     AS  PKG_QTY,
		                    INA.MSRMT       AS  MSRMT,
		                    INA.WGT         AS  WGT,
		                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM 	(SELECT 
			                      	LC.VSL_CALL_ID         AS VSL_CALL_ID ,
			                        LC.CG_NO               AS CG_NO ,
									LC.WH_TP_CD              AS WH_TP_CD,
									SUM(LC.PKG_QTY)        AS PKG_QTY,
									SUM(LC.CG_VOL)           AS MSRMT ,
									SUM(LC.CG_WGT)             AS WGT,
									J.SP_CA_CO_CD        AS SP_CA_CO_CD
			                FROM 	TMT_INV_LOC LC, TMT_JOB J
			                WHERE 	LC.JOB_NO = J.JOB_NO 
					                AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					                AND    LC.CG_NO = J.CG_NO
					                AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
			                GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
			                
			         WHERE  INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
			         
		WHERE 	NOT EXISTS (SELECT * FROM TMT_JOB C WHERE A.JOB_NO IS NOT NULL AND C.JOB_NO = A.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))	  		
				AND A.VSL_CALL_ID = B.VSL_CALL_ID
				AND A.CG_NO = B.CG_NO
				AND A.VSL_CALL_ID = BL.VSL_CALL_ID(+)
		       	AND A.CG_NO = BL.BL_NO(+)
		       	AND A.VSL_CALL_ID = SN.VSL_CALL_ID(+)
		       	AND A.ORG_REF_NO = SN.SHIPG_NOTE_NO(+)
		        <if test="estArrvDateFrm != null and estArrvDateFrm != ''">
          			AND
				  	( BL.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '00:00:00','DD/MM/YYYY HH24:MI:SS') 
				  		AND TO_DATE(#{estArrvDateTo} || ' 23:59:59','DD/MM/YYYY HH24:MI:SS') 
				  		OR
	 					SN.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '00:00:00','DD/MM/YYYY HH24:MI:SS') 
	 					AND TO_DATE(#{estArrvDateTo} || ' 23:59:59','DD/MM/YYYY HH24:MI:SS')
	  				)
			 	</if> 
			   	<if test="vslCallId != null and vslCallId != ''">
      				AND A.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					<if test="blNo != null and blNo != ''">
     					AND (  A.ORG_REF_NO = #{shipgNoteNo}  OR   A.ORG_REF_NO = #{blNo})
					</if>
					<if test="blNo == null or blNo == ''">
     					AND
						A.ORG_REF_NO = #{shipgNoteNo}
					</if>  
				</if>
				<if test="shipgNoteNo == null or shipgNoteNo == ''">
					<if test="blNo != null and blNo != ''">
     					AND A.ORG_REF_NO = #{blNo}
					 </if>
				</if>
				<if test="nxRefNo != null and nxRefNo != ''">
    				AND A.NX_REF_NO = #{nxRefNo}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
    				AND A.NX_VSL_CALL_ID = #{nxVslCallId}
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
    				AND A.OPE_CLASS_CD = #{opeClassCd}
				</if>
				<if test="rhdlMode != null and rhdlMode != ''">
    				AND A.RHDL_MODE = #{rhdlMode}
				</if>
				<include refid="sqlRehandleAuth"/>
         ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	
	<sql id ="dynamic_rh">	<!-- 4 -->
		SELECT	A.VSL_CALL_ID         											AS VSLCALLID,
		       	A.ORG_REF_NO           											AS ORGREFNO,
		       	A.ORG_GR_NO            											AS ORGGRNO,
		       	(SELECT DECODE(COUNT(*),0,A.ORG_REF_NO,A.NX_REF_NO) 
			   		   FROM TMT_RHDL_CG G 
					   WHERE G.RHDL_NO = A.RHDL_NO
					   AND	 G.RHDL_MODE = 'C'
					   AND	 G.NX_REF_NO IS NOT NULL) 							AS BLSN,
			   	A.CG_NO				  											AS CGNO,			   
			   	A.CG_NO															AS ORGCGNO,
			    '' 		   	    AS GRNO,
			   	A.NX_VSL_CALL_ID       											AS NXVSLCALLID,
		       	A.NX_REF_NO            											AS NXREFNO,
			   	A.OPE_CLASS_CD         											AS OPECLASSCD,
			   	(SELECT 	TCM.S_CD_NM 
		   			FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
						   	AND TCM.M_CD = 'CATGTP' 
							AND TCM.S_CD = A.OPE_CLASS_CD )								AS CATGNM,
			   	CASE 
			   	   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.PKG_QTY FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT		SUM(LC.PKG_QTY)
							FROM 	TMT_INV_LOC LC, TMT_JOB J
							WHERE 	LC.JOB_NO = J.JOB_NO
									AND LC.VSL_CALL_ID = J.VSL_CALL_ID
									AND	LC.CG_NO = J.CG_NO
									AND	LC.WH_TP_CD = A.CG_CO_CD
									AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
									AND	LC.CG_NO = A.CG_NO
									AND LC.VSL_CALL_ID = A.VSL_CALL_ID
									AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
							HAVING SUM(LC.PKG_QTY) <![CDATA[ > ]]> 0
							GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS PKGQTY,
			   	CASE
				   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.CG_WGT FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT		SUM(LC.CG_WGT)
							FROM 	TMT_INV_LOC LC, TMT_JOB J
							WHERE 	LC.JOB_NO = J.JOB_NO
									AND LC.VSL_CALL_ID = J.VSL_CALL_ID
									AND	LC.CG_NO = J.CG_NO
									AND	LC.WH_TP_CD = A.CG_CO_CD
									AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
									AND	LC.CG_NO = A.CG_NO
									AND LC.VSL_CALL_ID = A.VSL_CALL_ID
									AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
							HAVING SUM(LC.CG_WGT) <![CDATA[ > ]]> 0
							GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS WGT,
			   	CASE 
			   		WHEN A.JOB_NO IS NOT NULL
				   	THEN
				   	   NVL((SELECT J.CG_VOL FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   	WHEN A.JOB_NO IS NULL
				   	THEN
				  		NVL((SELECT		SUM(LC.CG_VOL)
								FROM 	TMT_INV_LOC LC, TMT_JOB J
								WHERE 	LC.JOB_NO = J.JOB_NO
										AND LC.VSL_CALL_ID = J.VSL_CALL_ID
										AND	LC.CG_NO = J.CG_NO
										AND	LC.WH_TP_CD = A.CG_CO_CD
										AND NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
										AND	LC.CG_NO = A.CG_NO
										AND LC.VSL_CALL_ID = A.VSL_CALL_ID
										AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
								HAVING SUM(LC.CG_VOL) <![CDATA[ > ]]> 0
								GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS MSRMT,
		      	A.STS_YN               														AS STSYN,
		       	A.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD  WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = A.RHDL_MODE)            	AS RHDLMODENM,
			   	NVL(TO_NUMBER(A.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   	NVL(TO_NUMBER(REPLACE(NVL(A.CG_WGT,0),',','')),0) 	   							AS RHDLWGT,
			   	NVL(TO_NUMBER(A.CG_VOL),0)						   							AS RHDLMSRMT,
			   	TO_NUMBER(B.PKG_QTY)
			   		- TO_NUMBER((SELECT NVL(SUM(H.PKG_QTY),0) 
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALPKGQTY,
			   	TO_NUMBER(B.WGT)    
			   		- TO_NUMBER((SELECT NVL(SUM(H.CG_WGT),0) 
			   	 			FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALWGT,
			   	TO_NUMBER(B.MSRMT)	
			   		- TO_NUMBER((SELECT NVL(SUM(H.CG_VOL),0)
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')								
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALMSRMT,
			   	A.RHDL_NO              														AS RHDLNO,
			   	A.STAFF_CD		   			  											AS USERID,
			   	TO_CHAR(A.UPDATE_TIME,'DD/MM/YYYY HH24:MI')										AS UPDDT,
			   	A.CG_CO_CD 																	AS CGCOCD,
			   	(SELECT		TCM.S_CD_NM 
			   		FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
			   	   			AND TCM.M_CD = 'CGCOCD' 
				   			AND TCM.S_CD = A.CG_CO_CD)	   	 										AS CGCONM,
			   	'Y' 																			AS RHDLCHK,
			   	A.JOB_NO		  																AS JOBNO,
			 	DECODE(A.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  	DECODE(A.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  	A.SP_CA_CO_CD 														AS SPCACOCD,
			  	(SELECT		TCM.S_CD_NM 
			   		FROM 	TMT_CD_MSTD TCM 
			   		WHERE  	TCM.L_CD = 'MT' 
			   	   			AND TCM.M_CD = 'SPCACOCD' 
				   			AND TCM.S_CD = A.SP_CA_CO_CD)	   	 						AS SPCACONM,
				' ' AS CGTPCD,
				A.NX_CG_NO AS NXCGNO,
				A.VSL_CALL_ID	   													AS ORGVSLCALLID,
				A.ORG_REF_NO													    AS ORGBLSN,
				'' AS STAT,
				'' AS STATNM,
				'N' AS FNLHOYN,
				'N' AS FNLLOADYN,
				A.RHDL_GROUP_NO AS RHDLGROUPNO,
				'' AS LINKED,
				F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
				'' AS delvTpCd	 	 			      
		FROM 	TMT_RHDL_CG A
				,(SELECT 	INA.VSL_CALL_ID AS  VSL_CALL_ID,
		                    INA.CG_NO       AS  CG_NO,
		                    INA.WH_TP_CD    AS  WH_TP_CD,
		                    INA.PKG_QTY     AS  PKG_QTY,
		                    INA.MSRMT       AS  MSRMT,
		                    INA.WGT         AS  WGT,
		                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM 	(SELECT 
                           			LC.VSL_CALL_ID         AS VSL_CALL_ID ,
									LC.CG_NO               AS CG_NO ,
									LC.WH_TP_CD              AS WH_TP_CD,
									SUM(LC.PKG_QTY)        AS PKG_QTY,
									SUM(LC.MSRMT)           AS MSRMT ,
									SUM(LC.CG_WGT)             AS WGT,
									J.SP_CA_CO_CD        AS SP_CA_CO_CD
                			FROM 	TMT_INV_LOC LC, TMT_JOB J
               	 			WHERE 	LC.JOB_NO = J.JOB_NO 
					                AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					                AND    LC.CG_NO = J.CG_NO
					                AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
                			GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
                	WHERE	INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
                	
		WHERE	NOT EXISTS (SELECT * FROM TMT_JOB C WHERE A.JOB_NO IS NOT NULL AND C.JOB_NO = A.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))
				AND A.VSL_CALL_ID = B.VSL_CALL_ID
				AND A.ORG_REF_NO = B.CG_NO
			   <if test="vslCallId != null and vslCallId != ''">
      				AND A.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					<if test="blNo != null and blNo != ''">
     					AND
					 	(A.ORG_REF_NO = #{shipgNoteNo}  OR   A.ORG_REF_NO = #{blNo})
					</if>
					<if test="blNo == null or blNo == ''">
     					AND
						A.ORG_REF_NO = #{shipgNoteNo}
					</if>  
				</if>
				<if test="shipgNoteNo == null or shipgNoteNo == ''">
					<if test="blNo != null and blNo != ''">
     					AND
					  	A.ORG_REF_NO = #{blNo}
					 </if>
				</if>
				<if test="nxRefNo != null and nxRefNo != ''">
    				AND
					A.NX_REF_NO = #{nxRefNo}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
    				AND
					A.NX_VSL_CALL_ID = #{nxVslCallId}
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
    				AND
					A.OPE_CLASS_CD = #{opeClassCd}
				</if>
				<if test="rhdlMode != null and rhdlMode != ''">
    				AND
					A.RHDL_MODE = #{rhdlMode}
				</if>
				<include refid="sqlRehandleAuth"/>
         ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	
	<sql id="getCargoRehandlingList">
		<if test="rhdlMode == null or rhdlMode == ''">
			<include refid="dynamic_rh_all"/>
		</if>
		<if test="rhdlMode != null and rhdlMode != ''">
			<if test='rhdlMode == "N"'>
				<include refid="dynamic_rh_all"/>
			</if>
			<if test='rhdlMode != "N"'>
				<include refid="dynamic_rh"/>
			</if>
		</if>
			
	</sql>
	
	<select id="selectCargoRehandlingList"  parameterType="rehandlingOfGCParm" resultMap="CargoRehandlingItemMap">
	 	<if test="pageNo != 0"> 
             SELECT * FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getCargoRehandlingList"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	</select>
	
	<select id="selectCargoRehandlingListCount"  parameterType="rehandlingOfGCParm" resultType="java.lang.String">
		SELECT COUNT(*)
          FROM (<include refid="getCargoRehandlingList"/>)
	</select>
	
	<sql id ="dynamic_rh_popup">	<!-- 6 -->
		SELECT	R.VSL_CALL_ID          VSLCALLID,
			   	R.CG_NO				AS CGNO,
				R.ORG_REF_NO           ORGREFNO,
				R.ORG_GR_NO            ORGGRNO,
				R.NX_VSL_CALL_ID       NXVSLCALLID,
				R.NX_REF_NO            NXREFNO,
				R.OPE_CLASS_CD         OPECLASSCD,
               	(SELECT TCM.S_CD_NM 
                   FROM TMT_CD_MSTD TCM 
                   WHERE  TCM.L_CD = 'MT' 
                      AND TCM.M_CD = 'CATGTP' 
                   AND TCM.S_CD = R.OPE_CLASS_CD )                                    AS CATGNM,
               	CASE 
               		WHEN R.OPE_CLASS_CD = 'T'
               		THEN NVL((SELECT	BL.PKG_QTY
						   		FROM 	TMT_VSL_SCH SCH, TMT_BL BL
						  		WHERE 	SCH.VSL_CALL_ID = R.VSL_CALL_ID
										AND SCH.VSL_CD = BL.VSL_CD
										AND SCH.CALL_YEAR = BL.CALL_YEAR
										AND SCH.CALL_SEQ = BL.CALL_SEQ
										AND BL.BL_NO = R.ORG_REF_NO
										AND BL.MF_DOC_ID = 'K6'), 0)
               		WHEN R.OPE_CLASS_CD = 'E'
               		THEN NVL((SELECT 	G.PKG_QTY 
               					FROM 	TMT_JOB G
						  		WHERE 	G.JOB_NO = R.JOB_NO AND G.VSL_CALL_ID =  #{vslCallId}),0)
               		WHEN R.OPE_CLASS_CD = 'S'
               		THEN NVL((SELECT 	G.PKG_QTY 
               					FROM 	TMT_JOB G
						  		WHERE 	G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
										AND ROWNUM  = 1),0)
               		WHEN R.OPE_CLASS_CD = 'I'
               		THEN NVL((SELECT 	C.PKG_QTY 
               					FROM 	TMT_CG_MST C
						  		WHERE 	C.VSL_CALL_ID = R.VSL_CALL_ID
										AND C.CG_NO = R.ORG_REF_NO
										AND C.VSL_CALL_ID =  #{vslCallId}
										AND R.OPE_CLASS_CD = 'I'), 0)
               		ELSE 0 END AS PKGQTY,
               	CASE 
               		WHEN R.OPE_CLASS_CD = 'T'
               		THEN NVL((SELECT 	BL.CG_WGT
						   		FROM 	TMT_VSL_SCH SCH, TMT_BL BL
						  		WHERE 	SCH.VSL_CALL_ID = R.VSL_CALL_ID
									  	AND SCH.VSL_CALL_ID =  #{vslCallId}
										AND SCH.VSL_CD = BL.VSL_CD
										AND SCH.CALL_YEAR = BL.CALL_YEAR
										AND SCH.CALL_SEQ = BL.CALL_SEQ
										AND BL.BL_NO = R.ORG_REF_NO 
										AND BL.MF_DOC_ID = 'K6'), 0.0)
               		WHEN R.OPE_CLASS_CD = 'E'
               		THEN NVL((SELECT 	G.CG_WGT 
               					FROM 	TMT_JOB G
						  		WHERE 	G.JOB_NO = R.JOB_NO and G.VSL_CALL_ID =  #{vslCallId}), 0.0)
              		WHEN R.OPE_CLASS_CD = 'S'
               		THEN NVL((SELECT 	G.PKG_QTY 
               					FROM 	TMT_JOB G
						  		WHERE 	G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
										AND ROWNUM = 1), 0)
               		WHEN R.OPE_CLASS_CD = 'I'
               		THEN NVL((SELECT	C.CG_WGT 
               					FROM 	TMT_CG_MST C
						  		WHERE 	C.VSL_CALL_ID = R.VSL_CALL_ID
										AND C.CG_NO = R.ORG_REF_NO
										AND C.VSL_CALL_ID =  #{vslCallId}
										AND R.OPE_CLASS_CD = 'I'), 0.0)                                                                   
               		ELSE 0 END AS WGT,
               	CASE 
               		WHEN R.OPE_CLASS_CD = 'T'
               		THEN NVL((SELECT	BL.CG_VOL
						   		FROM 	TMT_VSL_SCH SCH, TMT_BL BL
						  		WHERE	SCH.VSL_CALL_ID = R.VSL_CALL_ID
										AND SCH.VSL_CD = BL.VSL_CD
										AND SCH.CALL_YEAR = BL.CALL_YEAR
										AND SCH.CALL_SEQ = BL.CALL_SEQ
										AND BL.BL_NO = R.ORG_REF_NO 
										AND BL.MF_DOC_ID = 'K6'), 0.0)
               		WHEN R.OPE_CLASS_CD = 'E'
               		THEN NVL((SELECT	G.CG_VOL 
               					FROM 	TMT_JOB G
						  		WHERE 	G.JOB_NO = R.JOB_NO AND G.VSL_CALL_ID =  #{vslCallId}), 0.0)
               		WHEN R.OPE_CLASS_CD = 'S'
               		THEN NVL((SELECT	G.PKG_QTY 
               					FROM 	TMT_JOB G
						  		WHERE 	G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
										AND ROWNUM = 1), 0)
               		WHEN R.OPE_CLASS_CD = 'I'
               		THEN NVL((SELECT	C.CG_VOL 
               					FROM 	TMT_CG_MST C
						  		WHERE 	C.VSL_CALL_ID = R.VSL_CALL_ID AND C.VSL_CALL_ID =  #{vslCallId}
										AND C.CG_NO = R.ORG_REF_NO
										AND R.OPE_CLASS_CD = 'I'), 0.0)
               		ELSE 0
               		END                                                      AS MSRMT,
               	R.STS_YN               STSYN,
               	R.RHDL_MODE            RHDLMODE,
			   	(SELECT 	S_CD_NM 
			   		FROM 	TMT_CD_MSTD 
				 	WHERE 	L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE
				 	GROUP BY S_CD_NM)    RHDLMODENM,
               	NVL(TO_NUMBER(R.PKG_QTY),0)                         RHDLPKGQTY,
               	NVL(TO_NUMBER(REPLACE(NVL(R.CG_WGT,0),',','')),0)        RHDLWGT,
               	NVL(TO_NUMBER(R.CG_VOL),0)                           RHDLMSRMT,
               	0   BALPKGQTY,
				0.0 BALWGT,
				0.0 BALMSRMT,
				R.RHDL_NO              RHDLNO,
				R.STAFF_CD USERID,
				R.CG_CO_CD AS CGCOCD,
				DECODE(R.CG_CO_CD,'S','SHUT-OUT','D','DAMAGE','G','NORMAL','NORMAL') AS CGCONM,
				'Y' AS RHDLCHK,
				DECODE(R.CG_CO_CD, 'S','Y','N') AS SHUYN,
				DECODE(R.CG_CO_CD, 'D','Y','N') AS DMGYN,    
				R.JOB_NO AS JOBNO,
               	(SELECT J.RHDL_NO FROM TMT_JOB J WHERE J.RHDL_NO = R.RHDL_NO AND J.VSL_CALL_ID =  #{vslCallId} GROUP BY J.RHDL_NO) AS JOBRHDLNO
		FROM 	TMT_RHDL_CG R
		WHERE  	R.VSL_CALL_ID = #{vslCallId}
				AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.VSL_CALL_ID =  #{vslCallId})
				<if test="orgRefNo != null and orgRefNo != ''">
	   				AND R.ORG_REF_NO = #{orgRefNo}
				</if>
				<if test="nxRefNo != null and nxRefNo != ''">
	   				AND R.NX_REF_NO = #{nxRefNo}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
	   				AND R.NX_VSL_CALL_ID = #{nxVslCallId}
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
	   				AND R.OPE_CLASS_CD = #{opeClassCd}
				</if>
				<if test="rhdlMode != null and rhdlMode != ''">
	   				AND R.RHDL_MODE = #{rhdlMode}
				</if>
				<if test="cgNo != null and cgNo != ''">
	   				AND R.CG_NO = #{cgNo}
				</if>
	</sql>
	 
	<select id="selectCargoRehandlingPopupList"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
		<include refid="dynamic_rh_popup"/>	  	
	</select>
	
	<select id="selectCargoRhdlBlSnCombo"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
	   SELECT 	DISTINCT 
	   			CASE 
					WHEN R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL 
			   		THEN R.NX_REF_NO 
			   		WHEN R.RHDL_MODE = 'R' 
			   		THEN R.ORG_REF_NO 
			   	END AS BLSN 
		FROM 	TMT_RHDL_CG R
		WHERE 	(R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL) OR R.RHDL_MODE = 'R'
				AND EXISTS (SELECT R.VSL_CALL_ID FROM TMT_RHDL_CG S WHERE S.RHDL_NO = R.RHDL_NO AND S.RHDL_MODE = 'R' AND S.VSL_CALL_ID =  #{vslCallId})
				AND EXISTS (SELECT R.VSL_CALL_ID FROM TMT_RHDL_CG S WHERE S.RHDL_NO = R.RHDL_NO AND S.RHDL_MODE = 'C' AND S.NX_VSL_CALL_ID IS NOT NULL AND S.VSL_CALL_ID =  #{vslCallId})
	</select>
	
	<select id="selectCargoRhdlStorageSnCombo"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
	  	SELECT 	G.SHIPG_NOTE_NO AS ORGBLSN
        FROM 	TMT_SHIPG_NOTE S, TMT_GR G,TMT_CG_MST C
       	WHERE 	C.CG_NO = G.GR_NO
				AND C.VSL_CALL_ID = G.VSL_CALL_ID
				AND S.VSL_CALL_ID = G.VSL_CALL_ID
				AND S.SHIPG_NOTE_NO = G.SHIPG_NOTE_NO        
				AND S.CATG_CD IN ('S')
				AND NVL(C.WH_FNL_DELV_YN,'N') &lt;&gt;'Y'  
				<if test="arrvDtFm != null and arrvDtFm != ''">
				 AND S.EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
				                                   AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
				</if>              
           GROUP BY G.SHIPG_NOTE_NO
           ORDER BY G.SHIPG_NOTE_NO		
	</select>
	
	<select id="selectCargoRhdlOpBlSnCombo"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
	   	SELECT
				BLSN,
	   			MAX(GRNO) AS GRNO
	   	FROM 	(
		   			SELECT 	DISTINCT 
		   					CASE 
	               				WHEN R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL 
	               				THEN R.NX_REF_NO 
	               				WHEN R.RHDL_MODE = 'R' 
	               				THEN R.ORG_REF_NO 
	               			END AS BLSN,
	               			R.NX_CG_NO AS GRNO 
	        		FROM 	TMT_RHDL_CG R
	        		WHERE 	(R.RHDL_MODE = 'R' AND R.VSL_CALL_ID =  #{vslCallId})
	        				OR (R.RHDL_MODE = 'C' AND  R.NX_VSL_CALL_ID =  #{vslCallId})
	   			)
	   	GROUP BY BLSN
	</select>
	
	<select id="selectRhdlShippingNoteComboList"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
		SELECT	S.SHIPG_NOTE_NO    AS SHIPGNOTENO
	    FROM 	TMT_SHIPG_NOTE S
		WHERE  
		       	S.STAT_CD IN ('FS', 'AP')
				<if test="vslCallId != null and vslCallId != ''">
	   				AND
					S.VSL_CALL_ID = #{vslCallId} 
				</if>
				<if test="vslCallId == null or vslCallId == ''">
	   				AND
					S.VSL_CALL_ID &lt;&gt; 'NonCallId'
				</if>
				<if test="arrvDtFm != null and arrvDtFm != ''">
					AND S.EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
	                                      AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
				</if>
				<if test='opeClassCd == "T"'>
	   				AND
					S.CATG_CD  = 'T'
				</if>
				<if test='opeClassCd != "T"'>
	   				AND
					S.CATG_CD  = 'R'
				</if>		 	  
		  GROUP BY S.SHIPG_NOTE_NO
		  ORDER BY S.SHIPG_NOTE_NO
	</select>
	
	<select id="selectRhdlGrNoComboList"  parameterType="rehandlingOfGCParm" resultType="rehandlingOfGCItem">
		 SELECT 	GR_NO    AS NXCGNO
	     FROM 		TMT_GR
		 WHERE 		VSL_CALL_ID = #{vslCallId} 
					AND SHIPG_NOTE_NO  = #{shipgNoteNo}
					AND ROWNUM = 1
					<if test="arrvDtFm != null and arrvDtFm != ''">
						AND EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
		                                      AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
					</if>
		  GROUP BY GR_NO
		  ORDER BY GR_NO
	</select>
	
	<select id="selectCargoRhdlGroupNo" parameterType="rehandlingOfGCParm" resultType="java.lang.String">
	 	SELECT NVL(MAX(TO_NUMBER(S.RHDL_GROUP_NO)),0)+1 AS RHDLGROUPNO FROM TMT_RHDL_CG S
	 	WHERE S.VSL_CALL_ID = #{vslCallId} AND S.ORG_REF_NO = #{orgRefNo}
	 </select>
	 
	 <insert id="insertCargoRehandlingItems"  parameterType="rehandlingOfGCItem">
	  MERGE INTO TMT_RHDL_CG A 
	  USING (SELECT '00000'  AS  empty FROM dual) B 
	  	 ON (A.VSL_CALL_ID = #{vslCallId} AND A.ORG_REF_NO = #{orgRefNo} AND A.RHDL_NO = #{rhdlNo} AND B.empty ='00000')
	     WHEN MATCHED THEN
	         UPDATE SET A.NX_VSL_CALL_ID = #{nxVslCallId},
						A.NX_REF_NO = #{nxRefNo},
						A.OPE_CLASS_CD = #{opeClassCd},
						A.PKG_QTY = #{rhdlPkgQty},
						A.CG_WGT = #{rhdlWgt},
						A.CG_VOL = #{rhdlMsrmt},
						A.STS_YN = DECODE(#{stsYn},NULL,'N','','N', #{stsYn}),
						A.ORG_GR_NO = #{orgGrNo},
						A.RHDL_MODE = #{rhdlMode},
						A.UPDATE_TIME = SYSDATE,
						A.STAFF_CD = #{userId},
						A.VERSION 	= 	#{newVersion},
						A.NX_CG_NO = 	nvl(#{nxCgNo},null),
						A.RHDL_GROUP_NO = #{rhdlGroupNo}		
	     WHEN NOT MATCHED THEN
	     INSERT (
			RHDL_NO,
			VSL_CALL_ID,
			ORG_REF_NO,
			NX_VSL_CALL_ID,
			NX_REF_NO,
			OPE_CLASS_CD,
			PKG_QTY,
			CG_WGT,
			CG_VOL,
			STS_YN,
			ORG_GR_NO,
			RHDL_MODE,
			CG_NO,
			CG_CO_CD,
			SP_CA_CO_CD,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			NX_CG_NO,
			RHDL_GROUP_NO
			) VALUES (
		  	('R'||TO_CHAR(SYSDATE, 'YYMM') || (SELECT NVL(TRIM(To_CHAR(MAX(SUBSTR(RHDL_NO, -4, 4))+1, '0000')),'0000') 
			 FROM  TMT_RHDL_CG)), 
			#{vslCallId}, 
			#{orgRefNo}, 
			#{nxVslCallId}, 
			#{nxRefNo}, 
			#{opeClassCd}, 
			#{rhdlPkgQty}, 
			#{rhdlWgt}, 
			#{rhdlMsrmt}, 
			DECODE(#{stsYn},null,'N', #{stsYn}),
			#{orgGrNo}, 
			#{rhdlMode},
			#{cgNo},
			#{cgCoCd},
			#{spCaCoCd},
			SYSDATE, 
			#{userId},
			#{newVersion},
			nvl(#{nxCgNo},null),
			#{rhdlGroupNo}
			)
	</insert>
	
	<delete id="deleteCargoRehandlingItems"  parameterType="rehandlingOfGCItem">
		DELETE 	FROM TMT_RHDL_CG
		WHERE	RHDL_NO = #{rhdlNo}
	</delete>
	
</mapper>
