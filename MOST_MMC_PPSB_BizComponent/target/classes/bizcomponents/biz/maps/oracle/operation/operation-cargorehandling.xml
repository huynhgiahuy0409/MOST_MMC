<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cargoRehandling">
	

	<resultMap 	type="CargoRehandlingItem" 		id="CargoRehandlingItemMap">	
		<result property="jobNo"					column="JOBNO"/>
		<result property="seq"						column="SEQ"/>
		<result property="rhdlNo"					column="RHDLNO"/>
		<result property="orgRefNo"					column="ORGREFNO"/>
		<result property="vslCallId"				column="VSLCALLID"/>
		<result property="nxVslCallId"				column="NXVSLCALLID"/>
		<result property="nxRefNo"					column="NXREFNO"/>
		<result property="opeClassCd"				column="OPECLASSCD"/>
		<result property="caTgNm"					column="CATGNM"/>
		<result property="caTgCd"					column="CATGCD"/>
		<result property="pkgQty"					column="PKGQTY"/>
		<result property="wgt"						column="WGT"/>
		<result property="msrmt"					column="MSRMT"/>
		<result property="stsYn"					column="STSYN"/>
		<result property="orgGrNo"					column="ORGGRNO"/>
		<result property="cgNo"						column="CGNO"/>
		<result property="rhdlYn"					column="RHDLYN"/>
		<result property="rhdlMode"					column="RHDLMODE"/>
		<result property="rhdlModeNm"				column="RHDLMODENM"/>	
		<result property="rhdlPkgQty"				column="RHDLPKGQTY"/>
		<result property="rhdlWgt"					column="RHDLWGT"/>
		<result property="rhdlMsrmt"				column="RHDLMSRMT"/>
		<result property="balPkgQty"				column="BALPKGQTY"/>
		<result property="balWgt"					column="BALWGT"/>
		<result property="balMsrmt"					column="BALMSRMT"/>		
		<result property="cgCoCd"					column="CGCOCD"/>
		<result property="cgCoNm"					column="CGCONM"/>
		<result property="rhdlChk"					column="RHDLCHK"/>
		<result property="spCaCoCd"					column="SPCACOCD"/>
		<result property="spCaCoNm"					column="SPCACONM"/>
		<result property="shuYn"					column="SHUYN"/>
		<result property="dmgYn"					column="DMGYN"/>
		<result property="blSn"						column="BLSN"/>
		<result property="cgTpCd" 					column="CGTPCD"/>
		<result property="nxCgNo" 					column="NXCGNO"/>
		<result property="orgBlSn" 					column="ORGBLSN"/>
		<result property="orgVslCallId" 			column="ORGVSLCALLID"/>
		<!--<result property="stat" 				column="STAT"/>--> 
		<result property="statNm" 					column="STATNM"/>
		<result property="orgCgNo" 					column="ORGCGNO"/>
		<result property="fnlHoYn" 					column="FNLHOYN"/>
		<result property="fnlLoadYn" 				column="FNLLOADYN"/>		
		<result property="grNo"						column="GRNO"/>
		<result property="rhdlGroupNo"				column="RHDLGROUPNO"/>
		<result property="userId"					column="USERID"/>
		<result property="updDt"					column="UPDDT"/>
		<result property="linked"					column="LINKED"/>
		<result property="whLocIds"					column="WHLOCIDS"/>
		<result property="delvTpCd"					column="DELVTPCD"/>
		
    </resultMap>
    
    
    <select id="selectCargoRehandlingList"  parameterType="CargoRehandlingParm" resultMap="CargoRehandlingItemMap">
	 	<include refid="getCargoRehandlingList"/>
	</select>
	 
    <sql id ="getCargoRehandlingList">
		/* RehandlingForGeneralCargo.getOriginalCargoItems */
		WITH INV_CG_INFO AS
		(
				SELECT 
						LC.VSL_CALL_ID,
						LC.WH_TP_CD,
						SUM (LC.PKG_QTY) AS PKG_QTY,
	                  	SUM (LC.CG_VOL) AS MSRMT,
	                  	SUM (LC.CG_WGT) AS WGT,
	                  	M.SHIPG_AGNT AS SHIPG_AGENT,
						CASE
						    WHEN M.BL_NO IS NULL THEN M.SHIPG_NOTE_NO
						    ELSE M.BL_NO
						END                                                      
																				 AS BLSN,
						M.OPE_CLASS_CD,
						REGEXP_REPLACE((LISTAGG (DISTINCT LOC_ID, ',') WITHIN GROUP (ORDER BY LOC_ID))
			         				,'([^,]+)(,\1)*(,|$)', '\1\3') 				 AS WHLOC
				FROM	
						TMT_INV_LOC LC
						INNER JOIN TMT_JOB J ON LC.VSL_CALL_ID = J.VSL_CALL_ID AND LC.CG_NO = J.CG_NO AND LC.JOB_NO = J.JOB_NO
						INNER JOIN TMT_CG_MST M ON LC.VSL_CALL_ID = M.VSL_CALL_ID AND LC.CG_NO = M.CG_NO
				WHERE 	J.CG_NO NOT LIKE 'RTS' || '%'
						<!-- AND SUBSTR(LC.JOB_NO,1,2) <![CDATA[ <> ]]> 'JG'    -->                              
						<if test="vslCallId != null and vslCallId != ''">
							AND LC.VSL_CALL_ID = #{vslCallId}
						</if>
				GROUP BY LC.VSL_CALL_ID, LC.WH_TP_CD, M.BL_NO, M.SHIPG_NOTE_NO, M.OPE_CLASS_CD, M.SHIPG_AGNT 
			UNION ALL 
	            SELECT DISTINCT J.VSL_CALL_ID,
	                  '' WH_TP_CD,
	                  MAX (J.PKG_QTY) AS PKG_QTY,
	                  MAX (J.CG_VOL) AS MSRMT,
	                  MAX (J.CG_WGT) AS WGT,
	                  '' AS SHIPG_AGENT,
	                  M.CG_NO AS BLSN,
	                  M.IX_CD AS OPE_CLASS_CD,
	                  REGEXP_REPLACE (
	                     (LISTAGG (DISTINCT TO_LOC_ID, ',')
	                         WITHIN GROUP (ORDER BY TO_LOC_ID)),
	                     '([^,]+)(,\1)*(,|$)',
	                     '\1\3')
	                     AS WHLOC
	             FROM  TMT_JOB J
	                  INNER JOIN TMT_RORO_MST M
	                     ON J.VSL_CALL_ID = M.VSL_CALL_ID AND J.CG_NO = M.CG_NO
	            WHERE 1 = 1
	         GROUP BY J.VSL_CALL_ID,
	                  M.CG_NO,
	                  M.IX_CD
		)
		, RHDL_CG_INFO AS
		(
			SELECT	VSL_CALL_ID,
					ORG_REF_NO,
					SUM (CG_WGT) AS WGT,
                  	SUM (CG_VOL) AS MSRMT,
                  	SUM (PKG_QTY) AS PKG_QTY,
					SUM (DECODE (RHDL_MODE, 'R', CG_WGT, 'C', CG_WGT, 0)) AS RTS_WGT,
                  	SUM (DECODE (RHDL_MODE, 'R', CG_VOL, 'C', CG_VOL, 0)) AS RTS_MSRMT,
                  	SUM (DECODE (RHDL_MODE, 'R', PKG_QTY, 'C', PKG_QTY, 0)) AS RTS_PKG_QTY
			FROM	TMT_RHDL_CG
			<where>
				<if test="vslCallId != null and vslCallId != ''">
					AND VSL_CALL_ID = #{vslCallId}
				</if>
			</where>
			GROUP BY VSL_CALL_ID,
					ORG_REF_NO
		)
		,YARD_IN_DATE AS
			    (SELECT 
			    		J.VSL_CALL_ID,
						CASE
						    WHEN C.BL_NO IS NULL THEN C.SHIPG_NOTE_NO
						    ELSE C.BL_NO
						END                   AS BLSN,
						MIN (J.WORK_ST_DT)    AS MIN_YARD_IN_DT,
						MAX (J.WORK_ST_DT)    AS MAX_YARD_IN_DT,
						SUM (J.PKG_QTY)       AS PKG_QTY,
						SUM (J.CG_VOL)         AS MSRMT,
						SUM (J.CG_WGT)           AS WGT
			    FROM    TMT_JOB J
			            INNER JOIN TMT_CG_MST C ON J.VSL_CALL_ID = C.VSL_CALL_ID AND J.CG_NO = C.CG_NO
			    WHERE   J.JOB_PURP_CD IN ('AW', 'GW', 'WW')
			    GROUP BY J.VSL_CALL_ID, C.SHIPG_NOTE_NO, C.BL_NO
		 	UNION ALL 
	          SELECT DISTINCT J.VSL_CALL_ID,
	                  C.CG_NO AS BLSN,
	                  MIN (J.WORK_ST_DT) AS MIN_YARD_IN_DT,
	                  MAX (J.WORK_ST_DT) AS MAX_YARD_IN_DT,
	                  MAX (J.PKG_QTY) AS PKG_QTY,
	                  MAX (J.CG_VOL) AS MSRMT,
	                  MAX (J.CG_WGT) AS WGT
	             FROM TMT_JOB J
	                  INNER JOIN TMT_RORO_MST C
	                     ON J.VSL_CALL_ID = C.VSL_CALL_ID AND J.CG_NO = C.CG_NO
	            WHERE J.JOB_PURP_CD IN ('AW', 'GW', 'WW')
	         GROUP BY J.VSL_CALL_ID, C.CG_NO
		)
		
		<choose>
			<when test="((masterBlNo != null and masterBlNo != '') or (blNo != null and blNo != '')) and ((bookingNo == null or bookingNo == '') and (shipgNoteNo == null or shipgNoteNo == ''))">
				<include refid="getBlItems" />
			</when>
			<when test="((masterBlNo == null or masterBlNo == '') and (blNo == null or blNo == '')) and ((bookingNo != null and bookingNo != '') or (shipgNoteNo != null and shipgNoteNo != ''))">
				<include refid="getSnItems" />
			</when>
			<otherwise>
				<include refid="getBlItems" />
				UNION ALL
				<include refid="getBlForROROItems" />
				UNION ALL
				<include refid="getSnItems" />
				UNION ALL
				<include refid="getSnForROROItems" />
			</otherwise>
		</choose>
		ORDER BY VSLCALLID, ORGREFNO
	</sql>
    
    
    <sql id = "getBlItems">
		SELECT 
				DISTINCT
				S.VSL_CALL_ID 							AS VSLCALLID,
				B.MF_DOC_ID 							AS MFDOCID,
				S.BLSN 									AS ORGREFNO,
				B.CATG_CD 								AS CATGCD,
				F_CM_001 ('MT', 'CATGTP', B.CATG_CD)	AS CATGNM,
				B.CG_TP_CD								AS CGTPCD,
				F_CM_001 ('MT', 'CGTP', B.CG_TP_CD)		AS CGTPNM,
				S.WGT									AS STACKED_MT,
				S.MSRMT									AS STACKED_M3,
				S.PKG_QTY								AS STACKED_QTY,
				(SELECT 
				 		CASE WHEN COUNT (1) > 0 
								THEN 'Y' ELSE 'N' 
							END     AS RHDL_YN
				   FROM  TMT_RHDL_CG R2
				  WHERE  R2.VSL_CALL_ID = B.VSL_CALL_ID 
				  		AND R2.ORG_REF_NO = B.BL_NO)
				    									AS RHDLYN,
				B.CG_WGT AS WGT,
		        B.PKG_QTY AS PKGQTY,
		        B.CG_VOL AS MSRMT,
                B.CMDT_CD                               AS CMDTCD,
                CASE
                	WHEN (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0))
                END          							AS BALWGT,
                CASE
                	WHEN (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0))
                END     								AS BALMSRMT,
                CASE
                	WHEN (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0))
                END 									AS BALPKGQTY,
				S.WHLOC AS WHLOCIDS,
		       B.EACH_VOL AS EACHMSRMT,
		       B.EACH_WGT AS EACHWGT,
		       B.CMDT_GRP_CD AS cmdtGrCd,
		       (SELECT CMDT_GRP_DESC FROM TMT_CMDT_GRP WHERE CMDT_GRP_CD = B.CMDT_GRP_CD)AS cmdtGrNm,
		       B.CMDT_CD AS cmdtCd,
		       F_GET_CMDT_DESC (B.CMDT_CD) AS cmdtNm,
		       B.PKG_TP_CD AS pkgTpCd,
		       F_CM_012 ('MT', 'PKGTP', B.PKG_TP_CD) AS pkgTpNm,
		       B.LOT_NO AS pkgNo,
		       B.MARK_NO AS markAndNumber,
		       B.GDS_RMK AS goodsRemark,
		       S.SHIPG_AGENT AS shipgAgentCd,
		       NVL (S.SHIPG_AGENT, F_GET_PTNR_SNM (S.SHIPG_AGENT)) AS shipgAgentNm,
		       B.CNSNE AS cnsneCd,
		       F_GET_PTNR_SNM (B.CNSNE) AS cnsneNm
		  FROM INV_CG_INFO  S
		       LEFT JOIN YARD_IN_DATE Y
		           ON S.VSL_CALL_ID = Y.VSl_CALL_ID AND S.BLSN = Y.BLSN
		       INNER JOIN TMT_BL B
		           ON S.VSL_CALL_ID = B.VSL_CALL_ID AND S.BLSN = B.BL_NO
		       LEFT OUTER JOIN RHDL_CG_INFO R
		           ON S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BLSN = R.ORG_REF_NO
		  <where>	
				<if test="yardInDateFrom != null and yardInDateFrom != ''">
					AND Y.MIN_YARD_IN_DT &gt;= TO_DATE(#{yardInDateFrom}, 'DD/MM/YYYY')
				</if>
				<if test="yardInDateTo != null and yardInDateTo != ''">
					AND Y.MAX_YARD_IN_DT &lt;= (TO_DATE(#{yardInDateTo}, 'DD/MM/YYYY') + 1)
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
					AND B.CATG_CD = #{opeClassCd}
				</if>
				<if test="vslCallId != null and vslCallId != ''">
					AND S.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="masterBlNo != null and masterBlNo != ''">
					AND B.MF_DOC_ID = #{masterBlNo}
				</if>
				<if test="blNo != null and blNo != ''">
					AND B.BL_NO = #{blNo}
				</if>
				<if test="cmdtGrCd != null and cmdtGrCd != ''">
					AND B.CMDT_GRP_CD = #{cmdtGrCd}
				</if>
				<if test="cmdtCd != null and cmdtCd != ''">
					AND B.CMDT_CD = #{cmdtCd}
				</if>
				<if test="pkgNo != null and pkgNo != ''">
					AND B.PKG_NO = #{pkgNo}
				</if>
				<if test="shipgAgentCd != null and shipgAgentCd != ''">
					AND B.SHIPG_AGENT = #{shipgAgentCd}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
					AND EXISTS (SELECT VSL_CALL_ID FROM TMT_RHDL_CG R WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND B.VSL_CALL_ID = R.VSL_CALL_ID 
					<if test="nxRefNo != null and nxRefNo != ''">
						AND B.BL_NO = #{nxRefNo}
					</if>
					)
				</if>
		</where>
    </sql>
    
    
    <sql id = "getBlForROROItems">
		SELECT 
			   S.VSL_CALL_ID AS VSLCALLID,
		       B.MF_DOC_ID AS MFDOCID,
		       S.BLSN AS ORGREFNO,
		       B.CATG_CD AS CATGCD,
		       F_CM_001 ('MT', 'CATGTP', B.CATG_CD) AS CATGNM,
		       B.CG_TP_CD AS CGTPCD,
		       F_CM_001 ('MT', 'CGTP', B.CG_TP_CD) AS CGTPNM,
		       S.WGT AS STACKED_MT,
		       S.MSRMT AS STACKED_M3,
		       S.PKG_QTY AS STACKED_QTY,
		       (SELECT CASE WHEN COUNT (1) > 0 THEN 'Y' ELSE 'N' END AS RHDL_YN
		          FROM TMT_RHDL_CG R2
		         WHERE R2.VSL_CALL_ID = B.VSL_CALL_ID AND R2.ORG_REF_NO = B.BL_NO) AS RHDLYN,
		       B.CG_WGT AS WGT,
		       B.PKG_QTY AS PKGQTY,
		       B.CG_VOL AS MSRMT,
		       B.CMDT_CD AS CMDTCD,
		       CASE
		          WHEN (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0)) <![CDATA[ < ]]> 0 THEN 0
		          ELSE (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0))
		       END
		          AS BALWGT,
		       CASE
		          WHEN (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0)) <![CDATA[ < ]]> 0 THEN 0
		          ELSE (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0))
		       END
		          AS BALMSRMT,
		       CASE
		          WHEN (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0)) <![CDATA[ < ]]> 0 THEN 0
		          ELSE (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0))
		       END
		          AS BALPKGQTY,
		       S.WHLOC AS WHLOCIDS,
		       B.EACH_VOL AS EACHMSRMT,
		       B.EACH_WGT AS EACHWGT,
		       B.CMDT_GRP_CD AS cmdtGrCd,
		       (SELECT CMDT_GRP_DESC
		          FROM TMT_CMDT_GRP
		         WHERE CMDT_GRP_CD = B.CMDT_GRP_CD) AS cmdtGrNm,
		       B.CMDT_CD AS cmdtCd,
		       F_GET_CMDT_DESC (B.CMDT_CD) AS cmdtNm,
		       B.PKG_TP_CD AS pkgTpCd,
		       F_CM_012 ('MT', 'PKGTP', B.PKG_TP_CD) AS pkgTpNm,
		       B.LOT_NO AS pkgNo,
		       B.MARK_NO AS markAndNumber,
		       B.GDS_RMK AS goodsRemark,
		       '' AS shipgAgentCd,
		       '' AS shipgAgentNm,
		       B.CNSNE AS cnsneCd,
		       F_GET_PTNR_SNM (B.CNSNE) AS cnsneNm
		  FROM INV_CG_INFO  S
		       LEFT JOIN YARD_IN_DATE Y
		           ON S.VSL_CALL_ID = Y.VSl_CALL_ID AND S.BLSN = Y.BLSN
		       INNER JOIN TMT_BL B
		           ON S.VSL_CALL_ID = B.VSL_CALL_ID AND S.BLSN = B.BL_NO
		       LEFT OUTER JOIN RHDL_CG_INFO R
		           ON S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BLSN = R.ORG_REF_NO
		  <where>	
				<if test="yardInDateFrom != null and yardInDateFrom != ''">
					AND Y.MIN_YARD_IN_DT &gt;= TO_DATE(#{yardInDateFrom}, 'DD/MM/YYYY')
				</if>
				<if test="yardInDateTo != null and yardInDateTo != ''">
					AND Y.MAX_YARD_IN_DT &lt;= (TO_DATE(#{yardInDateTo}, 'DD/MM/YYYY') + 1)
				</if>
				AND B.CG_TP_CD IN ('RCV')
       			AND B.CATG_CD = 'I'
				<if test="vslCallId != null and vslCallId != ''">
					AND S.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="masterBlNo != null and masterBlNo != ''">
					AND B.MF_DOC_ID = #{masterBlNo}
				</if>
				<if test="blNo != null and blNo != ''">
					AND B.BL_NO = #{blNo}
				</if>
				<if test="cmdtGrCd != null and cmdtGrCd != ''">
					AND B.CMDT_GRP_CD = #{cmdtGrCd}
				</if>
				<if test="cmdtCd != null and cmdtCd != ''">
					AND B.CMDT_CD = #{cmdtCd}
				</if>
				<if test="pkgNo != null and pkgNo != ''">
					AND B.PKG_NO = #{pkgNo}
				</if>
				<if test="shipgAgentCd != null and shipgAgentCd != ''">
					AND B.SHIPG_AGENT = #{shipgAgentCd}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
					AND EXISTS (SELECT VSL_CALL_ID FROM TMT_RHDL_CG R WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND B.VSL_CALL_ID = R.VSL_CALL_ID 
					<if test="nxRefNo != null and nxRefNo != ''">
						AND B.BL_NO = #{nxRefNo}
					</if>
					)
				</if>
		</where>
    </sql>
    
    <sql id = "getSnItems">
	    SELECT 
				DISTINCT 	
				S.VSL_CALL_ID 							AS VSLCALLID,
				B.MF_DOC_ID 							AS MFDOCID,
				S.BLSN 									AS ORGREFNO,
				B.CATG_CD 								AS CATGCD,
				F_CM_001 ('MT', 'CATGTP', B.CATG_CD)	AS CATGNM,
				B.CG_TP_CD								AS CGTPCD,
				F_CM_001 ('MT', 'CGTP', B.CG_TP_CD)		AS CGTPNM,
				S.WGT									AS STACKED_MT,
				S.MSRMT									AS STACKED_M3,
				S.PKG_QTY								AS STACKED_QTY,
				(SELECT CASE WHEN COUNT (1) > 0 
							THEN 'Y' 
							ELSE 'N' 
						END    AS RHDL_YN
				   FROM TMT_RHDL_CG R2
				  WHERE R2.VSL_CALL_ID = B.VSL_CALL_ID
					    AND R2.ORG_REF_NO = B.SHIPG_NOTE_NO)       
					        							AS RHDLYN,
				B.CG_WGT AS WGT,
		        B.PKG_QTY AS PKGQTY,
		        B.CG_VOL AS M3,
                B.CMDT_CD								AS CMDTCD,
                CASE
                	WHEN (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0))
                END          							AS BALWGT,
                CASE
                	WHEN (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0))
                END     								AS BALMSRMT,
                CASE
                	WHEN (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0))
                END 									AS BALPKGQTY,
				S.WHLOC									AS WHLOCIDS,
				B.EACH_VOL 								AS EACHMSRMT,
                B.EACH_WGT 								AS EACHWGT,
                B.CMDT_GRP_CD AS cmdtGrCd,
		       	(SELECT CMDT_GRP_DESC FROM TMT_CMDT_GRP WHERE CMDT_GRP_CD = B.CMDT_GRP_CD)AS cmdtGrNm,
		       	B.CMDT_CD AS cmdtCd,
		       	F_GET_CMDT_DESC(B.CMDT_CD) AS cmdtNm,
		       	B.PKG_TP_CD AS pkgTpCd,
		       	F_CM_012('MT', 'PKGTP', B.PKG_TP_CD) pkgTpNm,
		       	B.PKG_NO AS pkgNo,
		       	B.MARK_NO  AS markAndNumber,
		       	B.GDS_RMK AS goodsRemark,
		       	B.SHPR AS shipgAgentCd,
		       	NVL(B.SHPR_NM, F_GET_PTNR_SNM(B.SHPR)) AS shipgAgentNm,
		       	B.CNSNE AS cnsneCd,
		       	NVL(B.CNSNE_NM, F_GET_PTNR_SNM(B.CNSNE)) AS cnsneNm
		  FROM 
		  	   INV_CG_INFO  S
		       LEFT JOIN YARD_IN_DATE Y
		           ON S.VSL_CALL_ID = Y.VSl_CALL_ID AND S.BLSN = Y.BLSN
		       INNER JOIN TMT_SHIPG_NOTE B
		           ON S.VSL_CALL_ID = B.VSL_CALL_ID AND S.BLSN = B.SHIPG_NOTE_NO
		       LEFT OUTER JOIN RHDL_CG_INFO R
		           ON S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BLSN = R.ORG_REF_NO
	      <where>
	      		B.CATG_CD IN ('E', 'S' , 'R')
				<if test="yardInDateFrom != null and yardInDateFrom != ''">
					AND Y.MIN_YARD_IN_DT &gt;= TO_DATE(#{yardInDateFrom}, 'DD/MM/YYYY')
				</if>
				<if test="yardInDateTo != null and yardInDateTo != ''">
					AND Y.MAX_YARD_IN_DT &lt;= (TO_DATE(#{yardInDateTo}, 'DD/MM/YYYY')+1)
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
					AND B.CATG_CD = #{opeClassCd}
				</if>
				<if test="vslCallId != null and vslCallId != ''">
					AND S.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="bookingNo != null and bookingNo != ''">
					AND B.MF_DOC_ID = #{bookingNo}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND B.SHIPG_NOTE_NO = #{shipgNoteNo}
				</if>
				<if test="cmdtGrCd != null and cmdtGrCd != ''">
					AND B.CMDT_GRP_CD = #{cmdtGrCd}
				</if>
				<if test="cmdtCd != null and cmdtCd != ''">
					AND B.CMDT_CD = #{cmdtCd}
				</if>
				<if test="pkgNo != null and pkgNo != ''">
					AND B.PKG_NO = #{pkgNo}
				</if>
				<if test="shipgAgentCd != null and shipgAgentCd != ''">
					AND B.SHPR = #{shipgAgentCd}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
					AND EXISTS (SELECT VSL_CALL_ID FROM TMT_RHDL_CG R WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND B.VSL_CALL_ID = R.VSL_CALL_ID 
					<if test="nxRefNo != null and nxRefNo != ''">
						AND B.SHIPG_NOTE_NO = #{nxRefNo}
					</if>
					)
				</if>
			</where>     
    </sql>
    
    <sql id = "getSnForROROItems">
	    SELECT 
				DISTINCT 	
				S.VSL_CALL_ID 							AS VSLCALLID,
				B.MF_DOC_ID 							AS MFDOCID,
				S.BLSN 									AS ORGREFNO,
				B.CATG_CD 								AS CATGCD,
				F_CM_001 ('MT', 'CATGTP', B.CATG_CD)	AS CATGNM,
				B.CG_TP_CD								AS CGTPCD,
				F_CM_001 ('MT', 'CGTP', B.CG_TP_CD)		AS CGTPNM,
				S.WGT									AS STACKED_MT,
				S.MSRMT									AS STACKED_M3,
				S.PKG_QTY								AS STACKED_QTY,
				(SELECT CASE WHEN COUNT (1) > 0 
							THEN 'Y' 
							ELSE 'N' 
						END    AS RHDL_YN
				   FROM TMT_RHDL_CG R2
				  WHERE R2.VSL_CALL_ID = B.VSL_CALL_ID
					    AND R2.ORG_REF_NO = B.SHIPG_NOTE_NO)       
					        							AS RHDLYN,
				B.CG_WGT AS WGT,
		        B.PKG_QTY AS PKGQTY,
		        B.CG_VOL AS M3,
                B.CMDT_CD								AS CMDTCD,
                CASE
                	WHEN (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.WGT, 0) - NVL (R.RTS_WGT, 0))
                END          							AS BALWGT,
                CASE
                	WHEN (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.MSRMT, 0) - NVL (R.RTS_MSRMT, 0))
                END     								AS BALMSRMT,
                CASE
                	WHEN (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0)) <![CDATA[ < ]]> 0
                	THEN 0
                	ELSE (NVL (S.PKG_QTY, 0) - NVL (R.RTS_PKG_QTY, 0))
                END 									AS BALPKGQTY,
				S.WHLOC									AS WHLOCIDS,
				B.EACH_VOL 								AS EACHMSRMT,
                B.EACH_WGT 								AS EACHWGT,
                B.CMDT_GRP_CD AS cmdtGrCd,
		       	(SELECT CMDT_GRP_DESC FROM TMT_CMDT_GRP WHERE CMDT_GRP_CD = B.CMDT_GRP_CD)AS cmdtGrNm,
		       	B.CMDT_CD AS cmdtCd,
		       	F_GET_CMDT_DESC(B.CMDT_CD) AS cmdtNm,
		       	B.PKG_TP_CD AS pkgTpCd,
		       	F_CM_012('MT', 'PKGTP', B.PKG_TP_CD) pkgTpNm,
		       	B.PKG_NO AS pkgNo,
		       	B.MARK_NO  AS markAndNumber,
		       	B.GDS_RMK AS goodsRemark,
		       	B.SHPR AS shipgAgentCd,
		       	NVL(B.SHPR_NM, F_GET_PTNR_SNM(B.SHPR)) AS shipgAgentNm,
		       	B.CNSNE AS cnsneCd,
		       	NVL(B.CNSNE_NM, F_GET_PTNR_SNM(B.CNSNE)) AS cnsneNm
		  FROM 
		  	   INV_CG_INFO  S
		       LEFT JOIN YARD_IN_DATE Y
		           ON S.VSL_CALL_ID = Y.VSl_CALL_ID AND S.BLSN = Y.BLSN
		       INNER JOIN TMT_GR GR
                   ON S.VSL_CALL_ID = GR.VSL_CALL_ID AND S.BLSN = GR.GR_NO
               INNER JOIN TMT_SHIPG_NOTE B
                   ON S.VSL_CALL_ID = B.VSL_CALL_ID AND GR.SHIPG_NOTE_NO = B.SHIPG_NOTE_NO
		       LEFT OUTER JOIN RHDL_CG_INFO R
		           ON S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BLSN = R.ORG_REF_NO
	      <where>
	      		B.CATG_CD IN ('E', 'S' , 'R')
				<if test="yardInDateFrom != null and yardInDateFrom != ''">
					AND Y.MIN_YARD_IN_DT &gt;= TO_DATE(#{yardInDateFrom}, 'DD/MM/YYYY')
				</if>
				<if test="yardInDateTo != null and yardInDateTo != ''">
					AND Y.MAX_YARD_IN_DT &lt;= (TO_DATE(#{yardInDateTo}, 'DD/MM/YYYY')+1)
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
					AND B.CATG_CD = #{opeClassCd}
				</if>
				<if test="vslCallId != null and vslCallId != ''">
					AND S.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="bookingNo != null and bookingNo != ''">
					AND B.MF_DOC_ID = #{bookingNo}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND B.SHIPG_NOTE_NO = #{shipgNoteNo}
				</if>
				<if test="cmdtGrCd != null and cmdtGrCd != ''">
					AND B.CMDT_GRP_CD = #{cmdtGrCd}
				</if>
				<if test="cmdtCd != null and cmdtCd != ''">
					AND B.CMDT_CD = #{cmdtCd}
				</if>
				<if test="pkgNo != null and pkgNo != ''">
					AND B.PKG_NO = #{pkgNo}
				</if>
				<if test="shipgAgentCd != null and shipgAgentCd != ''">
					AND B.SHPR = #{shipgAgentCd}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
					AND EXISTS (SELECT VSL_CALL_ID FROM TMT_RHDL_CG R WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND B.VSL_CALL_ID = R.VSL_CALL_ID 
					<if test="nxRefNo != null and nxRefNo != ''">
						AND B.SHIPG_NOTE_NO = #{nxRefNo}
					</if>
					)
				</if>
			</where>     
    </sql>
    
    <select id="selectCargoRehandlingDetailList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
		/*selectCargoRehandlingDetailList*/
		WITH CAN_UPDATE_RHDL_CHGVSL AS(
			SELECT DISTINCT
				   JB.VSL_CALL_ID,
				   JB.CG_NO,
				   JB.WB_TRANSACTION_NO,
				   JB.LORRY_NO
				   FROM TMT_JOB JB LEFT OUTER JOIN TMT_WEIGHTBRIDGE WB ON WB.VSL_CALL_ID = JB.VSL_CALL_ID
				   										AND WB.TRANSACTION_NO = JB.WB_TRANSACTION_NO
				   WHERE WB.SECOND_WGT_DT IS NULL AND JB.JOB_PURP_CD = 'AV'
		),
		CAN_UPDATE_RHDL_RTS AS(
			SELECT DISTINCT
				   JB.VSL_CALL_ID,
				   JB.CG_NO,
				   JB.WB_TRANSACTION_NO,
				   JB.LORRY_NO,
				   GR.SHIPG_NOTE_NO
				   FROM TMT_JOB JB INNER JOIN TMT_GR GR ON GR.VSL_CALL_ID = JB.VSL_CALL_ID AND GR.GR_NO = JB.CG_NO
				   					LEFT OUTER JOIN TMT_WEIGHTBRIDGE WB ON WB.GR_NO = JB.CG_NO 
				   										AND WB.VSL_CALL_ID = JB.VSL_CALL_ID
				   										AND WB.TRANSACTION_NO = JB.WB_TRANSACTION_NO
				   WHERE WB.SECOND_WGT_DT IS NULL AND JB.JOB_PURP_CD = 'WG'
		),
		CAN_DELETE_RHDL_CHGVSL AS(
			SELECT DISTINCT
				   JB.VSL_CALL_ID,
				   JB.CG_NO,
				   JB.WB_TRANSACTION_NO,
				   JB.LORRY_NO
				   FROM TMT_JOB JB
				   WHERE JB.JOB_PURP_CD = 'WA'
		),
		EXIST_OPE_RHDL_RTS AS(
					SELECT GR_NO,
		                SHIPG_NOTE_NO,
		                VSL_CALL_ID,
		                RHDL_NO
		           FROM TMT_GR
		          WHERE RHDL_MODE = 'R'
		),
		SUM_CHG_VSL_OPE AS(
			SELECT DISTINCT
				   JB.VSL_CALL_ID,
				   JB.CG_NO,
				   SUM(NVL(JB.CG_WGT, 0)) AS SUMMT,
				   SUM(NVL(JB.CG_VOL, 0)) AS SUMM3,
				   SUM(NVL(JB.PKG_QTY, 0)) AS SUMQTY
				   FROM TMT_JOB JB
				   WHERE JB.JOB_PURP_CD = 'AV'
				   GROUP BY JB.VSL_CALL_ID, JB.CG_NO
		),
		SUM_RTS_OPE AS(
			SELECT DISTINCT JB.VSL_CALL_ID,
                           GR.SHIPG_NOTE_NO,
                           SUM (NVL (JB.CG_WGT, 0)) AS SUMMT,
                           SUM (NVL (JB.CG_VOL, 0)) AS SUMM3,
                           SUM (NVL (JB.PKG_QTY, 0)) AS SUMQTY
             FROM TMT_JOB JB
                  INNER JOIN TMT_GR GR
                     ON JB.VSL_CALL_ID = GR.VSL_CALL_ID AND JB.CG_NO = GR.GR_NO
            WHERE JB.JOB_PURP_CD = 'WG'
         GROUP BY JB.VSL_CALL_ID, GR.SHIPG_NOTE_NO
		)
		
		SELECT  DISTINCT
				RC.OPE_CLASS_CD                                AS CATGCD,
				RD.SEQ			                               AS SEQ,
				F_CM_012 ('MT', 'CATGTP', RC.OPE_CLASS_CD)     AS CATGNM,
				RC.NX_VSL_CALL_ID                              AS NXVSLCALLID,
				SN.MF_DOC_ID                                   AS NXMFDOCID,
				RC.NX_REF_NO                                   AS NXREFNO,
				F_CM_012 ('MT', 'CGTP', SN.CG_TP_CD)           AS CGTPNM,
				RC.RHDL_MODE                                   AS RHDLMODE,
				F_CM_012 ('MT', 'RHDLMODE', RC.RHDL_MODE)      AS RHDLMODENM,
				RD.RHDL_NO                                     AS RHDLNO,
				RD.PKG_QTY                                     AS RHDLPKGQTY,
				RD.CG_WGT                                      AS RHDLWGT,
				RD.CG_VOL                                      AS RHDLMSRMT,
				RD.PKG_QTY                                     AS OLDRHDLPKGQTY,
				RD.CG_WGT                                      AS OLDRHDLWGT,
				RD.CG_VOL                                      AS OLDRHDLMSRMT,
				RD.JOB_NO									   AS JOBNO,
				NVL(RC.NX_CG_NO,GR.GR_NO)					   AS NXCGNO,
				TO_CHAR (RC.UPDATE_TIME, 'DD/MM/YYYY HH24:MI') AS UPDDT,
		        RD.UPDATE_TIME AS UPDATEDT,
		        RD.STAFF_CD AS USERID,
		        CASE WHEN BL.BL_NO IS NOT NULL THEN BL.CG_WGT ELSE SN1.CG_WGT END AS WGT,
		        CASE WHEN BL.BL_NO IS NOT NULL THEN BL.PKG_QTY ELSE SN1.PKG_QTY END AS PKGQTY,
		        CASE WHEN BL.BL_NO IS NOT NULL THEN BL.CG_VOL ELSE SN1.CG_VOL END AS MSRMT,
		        NVL((SELECT SUM(NVL(CG_WGT, 0)) FROM TMT_RHDL_CG_DTL WHERE RHDL_NO IN (SELECT RHDL_NO FROM TMT_RHDL_CG WHERE VSL_CALL_ID = RC.VSL_CALL_ID AND ORG_REF_NO = RC.ORG_REF_NO) AND JOB_NO <![CDATA[ <> ]]> RD.JOB_NO), 0) AS SUMCHGVSLWGT,
		        NVL((SELECT SUM(NVL(CG_VOL, 0)) FROM TMT_RHDL_CG_DTL WHERE RHDL_NO IN (SELECT RHDL_NO FROM TMT_RHDL_CG WHERE VSL_CALL_ID = RC.VSL_CALL_ID AND ORG_REF_NO = RC.ORG_REF_NO) AND JOB_NO <![CDATA[ <> ]]> RD.JOB_NO), 0) AS SUMCHGVSLVOL,
		        NVL((SELECT SUM(NVL(PKG_QTY, 0)) FROM TMT_RHDL_CG_DTL WHERE RHDL_NO IN (SELECT RHDL_NO FROM TMT_RHDL_CG WHERE VSL_CALL_ID = RC.VSL_CALL_ID AND ORG_REF_NO = RC.ORG_REF_NO) AND JOB_NO <![CDATA[ <> ]]> RD.JOB_NO), 0) AS SUMCHGVSLQTY,
		        RC.VSL_CALL_ID AS VSLCALLID,
		        RC.ORG_REF_NO AS ORGREFNO,
		        
		        <!--In case change vessel, If 2nd weight time is null it will be 'N'. In contrast it will be 'Y'-->
		        CASE 
		        	WHEN RC.RHDL_MODE = 'C' THEN
		        		CASE
				        	WHEN ((SELECT COUNT(*) FROM (SELECT LORRY_NO FROM CAN_UPDATE_RHDL_CHGVSL WHERE VSL_CALL_ID = RC.NX_VSL_CALL_ID AND CG_NO = RC.NX_CG_NO)) > 0) THEN 'N'
				        	ELSE 'Y'
				        END
				    ELSE ''    
		        END	AS CANUPDATECHGVSL,
		        
		        <!--In case RTS, If 2nd weight time is null it will be 'N'. In contrast it will be 'Y'-->
		        CASE 
		        	WHEN RC.RHDL_MODE = 'R' THEN
		        		CASE
				        	WHEN ((SELECT COUNT(*) FROM (SELECT LORRY_NO FROM CAN_UPDATE_RHDL_RTS WHERE VSL_CALL_ID = GR1.VSL_CALL_ID AND SHIPG_NOTE_NO = SN1.SHIPG_NOTE_NO)) > 0) THEN 'N'
				        	ELSE 'Y'
				        END
				     ELSE ''
		        END	AS CANUPDATERTS,
		        CASE WHEN RC.RHDL_MODE = 'R' THEN SN1.CG_TP_CD
		        	 WHEN RC.RHDL_MODE = 'C' THEN SN.CG_TP_CD
		        	 ELSE ''
		       	END	AS UPDATECGTP,
		       	CASE 
		        	WHEN RC.RHDL_MODE = 'C' THEN
		        		CASE
				        	WHEN ((SELECT COUNT(*) FROM (SELECT LORRY_NO FROM CAN_DELETE_RHDL_CHGVSL WHERE VSL_CALL_ID = RC.NX_VSL_CALL_ID AND CG_NO = RC.NX_CG_NO)) > 0) THEN 'N'
				        	ELSE 'Y'
				        END
				    ELSE ''    
		        END	AS CANDELETECHGVSL,
		        CASE WHEN GR1.GR_NO IS NULL THEN 'Y'
		        	 ELSE 'N'
		       	END	AS CANDELETERTS,
		       	CASE 
		        	WHEN RC.RHDL_MODE = 'R' THEN
		        		CASE
				        	WHEN ((SELECT GR_NO
		                            FROM EXIST_OPE_RHDL_RTS
		                            WHERE     VSL_CALL_ID = SN1.VSL_CALL_ID
                                 AND SHIPG_NOTE_NO = SN1.SHIPG_NOTE_NO
                                 AND RHDL_NO = RD.RHDL_NO AND ROWNUM = 1) IS NULL) THEN 'N'
				        	ELSE 'Y'
				        END
				     ELSE ''
		        END	AS ISEXISTRTSOPE,
		        
		        CASE WHEN RC.RHDL_MODE = 'R' THEN NVL(ACTRTS.SUMMT, 0) ELSE NVL(ACTCHGVSL.SUMMT, 0) END AS actMt,
		        CASE WHEN RC.RHDL_MODE = 'R' THEN NVL(ACTRTS.SUMM3, 0) ELSE NVL(ACTCHGVSL.SUMM3, 0) END AS actM3,
		        CASE WHEN RC.RHDL_MODE = 'R' THEN NVL(ACTRTS.SUMQTY, 0) ELSE NVL(ACTCHGVSL.SUMQTY, 0) END AS actQty,
		        (SELECT LOC_ID FROM TMT_INV_LOC WHERE VSL_CALL_ID = RC.NX_VSL_CALL_ID AND REF_NO = RC.NX_REF_NO AND JOB_NO = RD.JOB_NO AND ROWNUM = 1) AS locId
		  FROM  TMT_RHDL_CG_DTL  RD
		  		   INNER JOIN TMT_RHDL_CG RC
		  		   	   ON RC.RHDL_NO = RD.RHDL_NO
			       LEFT JOIN TMT_SHIPG_NOTE SN
			           ON     RC.NX_REF_NO = SN.SHIPG_NOTE_NO
			              AND RC.NX_VSL_CALL_ID = SN.VSL_CALL_ID
			       LEFT JOIN TMT_GR GR
			       	   ON	  SN.VSL_CALL_ID = GR.VSL_CALL_ID
			       	   	  AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
			       	   	  AND RC.RHDL_NO = GR.RHDL_NO
			       LEFT OUTER JOIN TMT_BL BL ON RC.VSL_CALL_ID = BL.VSL_CALL_ID AND RC.ORG_REF_NO = BL.BL_NO
			       LEFT OUTER JOIN TMT_SHIPG_NOTE SN1 ON RC.VSL_CALL_ID = SN1.VSL_CALL_ID AND RC.ORG_REF_NO = SN1.SHIPG_NOTE_NO
			       LEFT JOIN TMT_GR GR1
			       	   ON	  SN1.VSL_CALL_ID = GR1.VSL_CALL_ID
			       	   	  AND SN1.SHIPG_NOTE_NO = GR1.SHIPG_NOTE_NO
			       	   	  AND RC.RHDL_NO = GR1.RHDL_NO
			       LEFT OUTER JOIN SUM_CHG_VSL_OPE ACTCHGVSL ON ACTCHGVSL.VSL_CALL_ID = RC.NX_VSL_CALL_ID AND ACTCHGVSL.CG_NO = NVL(RC.NX_CG_NO,GR.GR_NO)
			       LEFT OUTER JOIN SUM_RTS_OPE ACTRTS ON ACTRTS.VSL_CALL_ID = RC.VSL_CALL_ID AND ACTRTS.SHIPG_NOTE_NO = SN1.SHIPG_NOTE_NO
		 <where>
		 		<!-- RC.VSL_CALL_ID = #{vslCallId} AND RC.ORG_REF_NO = #{orgRefNo} -->
		 		<if test="rhdlNo != null and rhdlNo != ''">
		 			AND	RC.RHDL_NO = #{rhdlNo}
		 		</if>
		 		<if test="vslCallId != null and vslCallId != ''">
		 			AND	RC.VSL_CALL_ID = #{vslCallId}
		 		</if>
		 		<if test="orgRefNo != null and orgRefNo != ''">
		 			AND RC.ORG_REF_NO = #{orgRefNo}
		 		</if>
		 		
		 		<if test="nxVslCallId != null and nxVslCallId != ''">
		 			AND	RC.NX_VSL_CALL_ID = #{nxVslCallId}
		 		</if>
		 		<if test="nxRefNo != null and nxRefNo != ''">
		 			AND RC.NX_REF_NO = #{nxRefNo}
		 		</if>
		 		<if test="rhdlMode != null and rhdlMode != ''">
		 			AND RC.NX_REF_NO = #{nxRefNo}
		 		</if>
		 </where>
	   ORDER BY RD.RHDL_NO, RD.SEQ
	</select>
	
	<select id="selectCommodityGroupList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
    	<if test="vslCallId == null or vslCallId == ''">
		 	SELECT DISTINCT CMDT_GRP_DESC AS scdNm, CMDT_GRP_CD AS scd
			    FROM TMT_CMDT
			ORDER BY CMDT_GRP_DESC
 		</if>
 		<if test="vslCallId != '' and vslCallId != null">
 			SELECT DISTINCT CMDT.CMDT_GRP_CD AS scd, CMDT.CMDT_GRP_DESC AS scdNm
			  FROM TMT_BL BL, TMT_CMDT CMDT
			 WHERE VSL_CALL_ID = #{vslCallId} AND BL.CMDT_GRP_CD = CMDT.CMDT_GRP_CD
			UNION
			SELECT DISTINCT CMDT.CMDT_GRP_CD AS scd, CMDT.CMDT_GRP_DESC AS scdNm
			  FROM TMT_SHIPG_NOTE SN, TMT_CMDT CMDT
			 WHERE VSL_CALL_ID = #{vslCallId} AND SN.CMDT_GRP_CD = CMDT.CMDT_GRP_CD
 		</if>
	</select>
	
	<select id="selectCommodtiyCodeList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
    	SELECT DISTINCT CMDT_CD AS scd,
    					CMDT_DESC AS scdNm
    	FROM TMT_CMDT
    	WHERE CMDT_GRP_CD =  #{cmdtGrCd}			
	</select>
    
    <select id="validateDelete"  parameterType="CargoRehandlingParm" resultMap="CargoRehandlingItemMap">
    	SELECT 
    		  S.VSL_CALL_ID  AS NXVSLCALLID,
    		  S.SHIPG_NOTE_NO AS NXREFNO
    	 FROM TMT_JOB J
    	 	  INNER JOIN TMT_GR G ON J.VSL_CALL_ID = G.VSL_CALL_ID AND J.CG_NO = G.GR_NO
    	 	  INNER JOIN TMT_SHIPG_NOTE S ON G.VSL_CALL_ID = S.VSL_CALL_ID AND G.SHIPG_NOTE_NO = S.SHIPG_NOTE_NO
    	WHERE 1 = 1
    		 <if test='rhdlMode == "C"'>
    		 	AND S.VSL_CALL_ID = #{nxVslCallId} AND S.SHIPG_NOTE_NO = #{nxRefNo}
    		  	AND J.JOB_TP_CD = 'LD' AND J.JOB_PURP_CD = 'WA'			
    		 </if>
    		 <if test='rhdlMode == "R"'>
    		 	AND S.VSL_CALL_ID = #{vslCallId} AND S.SHIPG_NOTE_NO = #{orgRefNo}
    		 	AND G.RHDL_NO = #{rhdlNo}
    		 </if>
    		 AND ROWNUM = 1
	</select>
	<select id="selectRstGr"  parameterType="GoodsReceiptParm" resultType="GoodsReceiptItem">
    	SELECT 
    		  G.VSL_CALL_ID AS VSLCALLID,
    		  G.SHIPG_NOTE_NO AS SHIPGNOTENO,
    		  G.GR_NO AS GRNO
    	 FROM TMT_GR G
    	 	  INNER JOIN TMT_RHDL_CG RC ON G.VSL_CALL_ID = RC.VSL_CALL_ID
    	 									 AND G.SHIPG_NOTE_NO = RC.ORG_REF_NO
    	 									 AND G.RHDL_NO = RC.RHDL_NO
    	WHERE 
    		  G.RHDL_NO = #{rhdlNo}
	</select>
    
    <select id="selectInvLocList"  parameterType="CargoRehandlingParm" resultMap="CargoRehandlingItemMap">
	    
		 SELECT  /*controller-cargorehandling.xml selectInvLocList*/
		 		 L.VSL_CALL_ID       AS VSLCALLID,
		         NVL(L.REF_NO,L.CG_NO) AS ORGREFNO,
		         L.CG_NO             AS CGNO,
		         L.WH_TP_CD			 AS WHTPCD,
		         L.WH_LOC_TP		 AS WHLOCTP,
		         L.WH_LOC_ID         AS WHID,
		         L.LOC_ID            AS WHLOCIDS,
		         SUM (L.PKG_QTY) AS PKGQTY,
         		SUM (L.CG_WGT) AS WGT,
         		SUM (L.CG_VOL) AS MSRMT
		    FROM TMT_INV_LOC L
		   WHERE L.VSL_CALL_ID = #{vslCallId}
		  		 AND NVL(L.REF_NO,L.CG_NO) = #{orgRefNo} 
		  		 <!-- AND L.CG_NO = #{cgNo} -->
		  		 AND WH_TP_CD = 'G'
		  		 AND L.LOC_ID = #{locId}
		  		 AND L.CG_NO NOT LIKE 'RTS' || '%'
		    <!-- FROM TMT_INV_LOC L
		         LEFT JOIN TMT_JOB J
		             ON L.VSL_CALL_ID = J.VSL_CALL_ID AND L.JOB_NO = J.JOB_NO AND J.OPE_CLASS_CD = #{opeClassCd}
		         LEFT JOIN TMT_GR G
		             ON     J.VSL_CALL_ID = G.VSL_CALL_ID AND J.CG_NO = G.GR_NO  AND J.OPE_CLASS_CD = 'E'
		   WHERE     L.VSL_CALL_ID = #{vslCallId}
		         AND WH_TP_CD = 'G'
		         AND (   (J.OPE_CLASS_CD IN ('I','T') AND J.JOB_TP_CD = 'DS' AND L.CG_NO = #{orgRefNo})
		              OR (J.OPE_CLASS_CD = 'E' AND G.SHIPG_NOTE_NO = #{orgRefNo})
		              OR (SUBSTR(L.JOB_NO,1,2) = 'JR'
		              		AND L.REF_NO = #{orgRefNo})) -->
		GROUP BY L.VSL_CALL_ID,
		         L.REF_NO,
		         L.CG_NO,
		         L.WH_TP_CD,
		         L.WH_LOC_TP,
		         L.WH_LOC_ID,
		         L.LOC_ID   
	      HAVING (SUM (L.CG_WGT) <![CDATA[ >= ]]> 0 AND SUM (L.PKG_QTY) <![CDATA[ >= ]]> 0 AND SUM (L.CG_VOL) <![CDATA[ >= ]]> 0)
	      		 AND (SUM (L.CG_WGT)  + SUM (L.PKG_QTY) + SUM (L.CG_VOL)) <![CDATA[ > ]]> 0
		ORDER BY L.VSL_CALL_ID, L.REF_NO, L.CG_NO,L.LOC_ID   
	</select>
    
    <select id="selectRhdlLinkJobNo"  parameterType="CargoRehandlingParm" resultType="java.lang.String">
	    <!-- SELECT  'JR' || TO_CHAR(SYSDATE, 'YYMMDD') || NVL(TRIM(To_CHAR(SUBSTR(MAX(JOB_NO) ,-8,8)+1, '00000000')),'00000000')  as jobNo 
	      FROM TMT_INV_LOC
	     WHERE SUBSTR(JOB_NO, 1, 2) = 'JR' -->
	    SELECT    
    		   'J'
		       || TO_CHAR (SYSDATE, 'YYMMDD')
		       || NVL (
		              TRIM (TO_CHAR (SUBSTR (MAX (JOB_NO), -9, 9) + 1, '000000000')),
		              '000000000')    AS jobNo
	      FROM TMT_JOB
    </select>
    
    <insert id="insertCargoInvLocationItems"  parameterType="cargoRehandlingItem">
		INSERT INTO TMT_INV_LOC(		
			JOB_NO,
			CG_NO,
			LOC_ID,
			PKG_QTY,
			CG_VOL,
			CG_WGT,
			VSL_CALL_ID,
			WH_TP_CD,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			SEQ,
			WH_LOC_ID,
			WH_LOC_TP,
			REF_NO,
			MF_DOC_ID
		) VALUES (
			#{jobNo},
			#{cgNo}, 
			#{locId}, 
			#{pkgQty}, 
			#{msrmt},
			#{wgt}, 
			#{vslCallId},
			#{whTpCd},
			SYSDATE,
			#{userId},
			#{newVersion},
			(SELECT NVL(MAX(SEQ), 0)+1 
			   FROM TMT_INV_LOC
			  WHERE VSL_CALL_ID=#{vslCallId} 
					 AND CG_NO=#{cgNo}
					 AND JOB_NO=#{jobNo}
					 AND LOC_ID=#{locId}),
					 
			<!-- SUBSTR(#{whLocIds}, 0, INSTR(#{whLocIds}, '-')-1), -->
			(SELECT SUBSTR (#{locId}, 1, INSTR (#{locId}, '-') - 1) FROM DUAL),
			#{whLocTp},
			#{refNo},
			#{mfDocId}
		)
	</insert>
    
    <insert id="insertJobItems"  parameterType="CargoJobItem">
		INSERT INTO TMT_JOB(
			JOB_NO,
			JOB_TP_CD,
			WORK_ST_DT,
			WORK_END_DT,
			PKG_QTY,
			CG_VOL,
			CG_WGT,
			STAT_CD,
			CG_NO,
			VSL_CALL_ID,
			JOB_PURP_CD,
			JOB_GROUP,
			DMG_YN,
			RHDL_MODE,
			RHDL_NO,
			SHU_YN,
			OPE_CLASS_CD,
			DELV_TP_CD,
			PKG_TP_CD,
			TSPT_TP_CD,
			LORRY_NO,
			GATE_TXN_NO,
			UPDATE_TIME,
			STAFF_CD,
			VERSION
		) VALUES (
			 #{jobNo},
			 #{jobTpCd}, 
			 SYSDATE,
			 SYSDATE,
			 NVL(#{pkgQty},0), 
			 NVL(#{msrmt},0), 
			 NVL(#{wgt},0), 
			 #{statCd}, 
			 #{cgNo}, 
			 #{vslCallId}, 
			 #{jobPurpCd}, 
			 (SELECT NVL(MAX(TO_NUMBER(S.JOB_GROUP)),0)+1 AS JOBGROUP FROM TMT_JOB S),
			 DECODE(#{dmgYn},NULL,'N','true','Y','false','N','Y','Y','N','N'),
			 #{rhdlMode},
			 #{rhdlNo}, 
			 DECODE(#{shuYn},NULL,'N','true','Y','false','N','Y','Y','N','N'),
			 #{opeClassCd},
			 #{delvTpCd},
			 #{pkgTpCd},
			 #{tsptTpCd},
			 #{lorryId},
			 #{gateTxnNo},
			 SYSDATE,
			 #{userId},
			 #{newVersion}
		)

	</insert>
    
    <insert id="insertCargoMstItems"  parameterType="cargoRehandlingItem">
		INSERT INTO TMT_CG_MST(
			VSL_CALL_ID,    
			CG_NO,          
			OPE_CLASS_CD,   
			TSPT_TP_CD,  	
			STAT_CD,     
			PKG_QTY,      
			CG_WGT,       
			CG_VOL,
			HDL_IN_ST_DT,
			HDL_IN_END_DT,
			DMG_YN,         
			RHDL_MODE,      
			DELV_TP_CD,     
			CG_TP_CD,       
			SHIPG_NOTE_NO, 
			UPDATE_TIME,
			STAFF_CD,
			VERSION
		) VALUES (
			#{nxVslCallId},      
			#{nxCgNo},           
			#{opeClassCd},     
			'LR',       
			#{stat},
			#{rhdlPkgQty}, 
			#{rhdlWgt},
			#{rhdlMsrmt},
			SYSDATE,
			SYSDATE,
			'N',
			#{rhdlMode},
			#{delvTpCd},
			#{cgTpCd},
			#{nxRefNo},
			SYSDATE,
			#{userId},
			#{newVersion}
			)
	</insert>
    
    <update id="updateAmtCargoMstItems" parameterType="cargoRehandlingItem">
    	UPDATE TMT_CG_MST
    	SET
    		PKG_QTY = PKG_QTY+#{rhdlPkgQty},
			CG_WGT 	= CG_WGT+#{rhdlWgt},       
			CG_VOL 	= CG_VOL+#{rhdlMsrmt}
    	WHERE
    			VSL_CALL_ID = #{nxVslCallId} 
    		AND CG_NO = #{nxCgNo}
    </update>
    
    <delete  id ="deleteCargoMstItems"  parameterType="cargoRehandlingItem">
    	DELETE FROM TMT_CG_MST
    	WHERE VSL_CALL_ID = #{nxVslCallId} 
    		AND CG_NO = #{nxCgNo}
    </delete>
    
    
    
    
    
    
    
    
    
    
    
	
	<sql id="sqlRehandleMstAuth">
		<if test='userType == "E"'>			
  		AND
			 (
                    EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.SHIPG_NOTE_NO 
                               AND SN.FWRD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.SHIPG_NOTE_NO 
                               AND SN.SHIPG_AGNCY = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TVC_VSL_SCH S, TMT_BL L, TFZ_DOC_PTNR_ROLE_DEF D
							 WHERE S.JPVC_NO = A.VSL_CALL_ID 
				               AND S.VSL_CD = L.VSL_CD
				               AND S.CALL_YEAR = L.CALL_YEAR
				               AND S.CALL_SEQ = L.CALL_SEQ
							   AND L.BL_NO = A.CG_NO
							   AND L.DOC_ID = D.DOC_ID 
							   AND L.JOB_NO = D.JOB_NO 
							   AND D.PTNR_CD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_BL BL
                             WHERE BL.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND BL.BL_NO = A.CG_NO 
                               AND BL.TSPTR = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN, TMT_GR GR 
                             WHERE SN.TSPT_COMP = #{ptnrCode}
                               AND SN.VSL_CALL_ID = GR.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
                               AND GR.VSL_CALL_ID = A.VSL_CALL_ID
                               AND GR.GR_NO = A.CG_NO)
                )
		</if>
	</sql>
	
	<sql id="sqlRehandleAuth">
		<if test='userType == "E"'>			
  AND
			 (
                    EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = A.ORG_REF_NO 
                               AND SN.FWRD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN
                             WHERE SN.VSL_CALL_ID = A.VSL_CALL_ID
                               AND SN.SHIPG_NOTE_NO = A.ORG_REF_NO  
                               AND SN.SHIPG_AGNCY = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TVC_VSL_SCH S, TMT_BL L, TFZ_DOC_PTNR_ROLE_DEF D
							 WHERE S.JPVC_NO = A.VSL_CALL_ID 
				               AND S.VSL_CD = L.VSL_CD
				               AND S.CALL_YEAR = L.CALL_YEAR
				               AND S.CALL_SEQ = L.CALL_SEQ
							   AND L.BL_NO = A.CG_NO
							   AND L.DOC_ID = D.DOC_ID 
							   AND L.JOB_NO = D.JOB_NO 
							   AND D.PTNR_CD = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_BL BL
                             WHERE BL.VSL_CALL_ID = A.VSL_CALL_ID 
                               AND BL.BL_NO = A.CG_NO 
                               AND BL.TSPTR = #{ptnrCode})
                 OR EXISTS (SELECT '1' FROM TMT_SHIPG_NOTE SN, TMT_GR GR 
                             WHERE SN.TSPT_COMP = #{ptnrCode}
                               AND SN.VSL_CALL_ID = GR.VSL_CALL_ID 
                               AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
                               AND GR.VSL_CALL_ID = A.VSL_CALL_ID
                               AND GR.GR_NO = A.CG_NO)
                )
		</if>
	</sql>
    
	<select id="selectCargoRehandlingComboList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
		SELECT RHDL_NO              RHDLNO,
		       VSL_CALL_ID          VSLCALLID,
		       ORG_REF_NO           ORGREFNO,
		       NX_VSL_CALL_ID       NXVSLCALLID,
		       NX_REF_NO            NXREFNO,
		       OPE_CLASS_CD         OPECLASSCD,
		       PKG_QTY              PKGQTY,
		       WGT                  WGT,
		       MSRMT                MSRMT,
		       STS_YN               STSYN,
		       ORG_GR_NO            ORGGRNO,
		       RHDL_MODE            RHDLMODE,
		       UPD_DT               UPDDT,
		       STAFF_CD          USERID,
			   VERSION              VERSION
		  FROM TMT_RHDL_CG

	</select>

	<!-- get RhdlNo base on (nxVslCallId, nxRefNo). If does not have -> create new one.   -->
	<select id="selectRhdlNo"  parameterType="CargoRehandlingParm" resultType="java.lang.String">
	    SELECT    
		    	CASE
		    		WHEN 
		    			(SELECT RHDL_NO FROM TMT_RHDL_CG WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND NX_REF_NO = #{nxRefNo}) IS NULL
		    			THEN (SELECT  'R'
							       || TO_CHAR (SYSDATE, 'YYMM')
							       || NVL (TRIM (TO_CHAR (MAX (SUBSTR (RHDL_NO, -4, 4)) + 1, '0000')),
							               '0000')
							  FROM TMT_RHDL_CG )
		    		ELSE
		    			(SELECT MAX(RHDL_NO) FROM TMT_RHDL_CG WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND NX_REF_NO = #{nxRefNo})
		    	END 
		    		 AS RHDL_NO
		    		
		FROM DUAL
		
    </select>
	<insert id="insertCargoRehandlingItems"  parameterType="CargoRehandlingItem">
	  <!-- <selectKey order="BEFORE" resultType="CargoRehandlingItem" keyProperty="rhdlNo" >
			SELECT ('R'||TO_CHAR(SYSDATE, 'YYMM') || (SELECT NVL(TRIM(TO_CHAR(MAX(SUBSTR(RHDL_NO, -4, 4))+1, '0000')),'0000') 
			  		FROM TMT_RHDL_CG)) AS rhdlNo
			  FROM DUAL 
	  </selectKey> -->
	  BEGIN 
	  	INSERT INTO TMT_RHDL_CG_DTL(
	  		RHDL_NO
			,SEQ
			,PKG_QTY
			,CG_WGT
			,CG_VOL
			,JOB_NO
			,STAFF_CD
			,UPDATE_TIME
			,VERSION
	  	)VALUES	(
	  		 #{rhdlNo}
	  		,(SELECT DECODE (MAX (SEQ), NULL, 1, MAX (SEQ) + 1) FROM TMT_RHDL_CG_DTL WHERE RHDL_NO = #{rhdlNo})
	  		,#{rhdlPkgQty} 
			,#{rhdlWgt}
			,#{rhdlMsrmt}
			,#{jobNo}
			,#{userId}
			,SYSDATE
			,#{newVersion}
	  	);
	  	MERGE INTO TMT_RHDL_CG A
	  	USING (SELECT '00000' AS COSTCD FROM DUAL)B ON (
				    A.RHDL_NO	= #{rhdlNo} 
				AND B.COSTCD 	= '00000')
		WHEN MATCHED THEN
				UPDATE SET 
					 PKG_QTY 	= PKG_QTY + #{rhdlPkgQty} 
					,CG_WGT 		= CG_WGT + #{rhdlWgt}
					,CG_VOL 		= CG_VOL + #{rhdlMsrmt}
					,A.UPDATE_TIME = SYSDATE
	    WHEN NOT MATCHED THEN
				INSERT (
					RHDL_NO,
					VSL_CALL_ID,
					ORG_REF_NO,
					NX_VSL_CALL_ID,
					NX_REF_NO,
					OPE_CLASS_CD,
					PKG_QTY,
					CG_WGT,
					CG_VOL,
					STS_YN,
					ORG_GR_NO,
					RHDL_MODE,
					CG_NO,
					CG_CO_CD,
					SP_CA_CO_CD,
					UPDATE_TIME,
					STAFF_CD,
					VERSION,
					NX_CG_NO,
					RHDL_GROUP_NO,
					ORG_MF_DOC_ID,
					NX_MF_DOC_ID
				) VALUES (
				  	#{rhdlNo}, 
					#{vslCallId}, 
					#{orgRefNo}, 
					#{nxVslCallId}, 
					#{nxRefNo}, 
					#{opeClassCd}, 
					#{rhdlPkgQty}, 
					#{rhdlWgt}, 
					#{rhdlMsrmt}, 
					DECODE(#{stsYn},null,'N', #{stsYn}),
					#{orgGrNo}, 
					#{rhdlMode},
					#{cgNo},
					#{cgCoCd},
					#{spCaCoCd},
					SYSDATE, 
					#{userId},
					#{newVersion},
					nvl(#{nxCgNo},null),
					#{rhdlGroupNo},
					#{mfDocId},
					#{nxMfDocId}
				);
				
			MERGE INTO TMT_SHIPG_NOTE S
		  	USING TMT_RHDL_CG C ON (
					    S.SHIPG_NOTE_NO	= #{nxRefNo}
					AND S.VSL_CALL_ID 	= #{nxVslCallId} 
					AND S.SHIPG_NOTE_NO	= C.NX_REF_NO
					AND S.VSL_CALL_ID 	= C.NX_VSL_CALL_ID )
			WHEN MATCHED THEN
					UPDATE SET 
						 S.PKG_QTY 		= C.PKG_QTY 
						,S.CG_WGT 		= C.CG_WGT
						,S.CG_VOL 	= C.CG_VOL
						,S.UPDATE_TIME 		= SYSDATE;
						
			MERGE INTO TMT_SHIPG_NOTE_AMT SAMT
		  	USING TMT_RHDL_CG C ON (
					    SAMT.SHIPG_NOTE_NO	= #{nxRefNo}
					AND SAMT.VSL_CALL_ID 	= #{nxVslCallId} 
					AND SAMT.SHIPG_NOTE_NO	= C.NX_REF_NO
					AND SAMT.VSL_CALL_ID 	= C.NX_VSL_CALL_ID )
			WHEN MATCHED THEN
					UPDATE SET 
						 SAMT.PKG_QTY 		= C.PKG_QTY 
						,SAMT.CG_WGT 		= C.CG_WGT
						,SAMT.CG_VOL 		= C.CG_VOL
						,SAMT.UPDATE_TIME 	= SYSDATE
						,SAMT.I_QTY 		= C.PKG_QTY 
						,SAMT.I_MT 			= C.CG_WGT
						,SAMT.I_M3 			= C.CG_VOL ;
						
		    MERGE INTO TMT_GR G
		  	USING TMT_RHDL_CG C ON (
					    G.SHIPG_NOTE_NO	= #{nxRefNo}
					AND G.VSL_CALL_ID 	= #{nxVslCallId} 
					AND G.SHIPG_NOTE_NO	= C.NX_REF_NO
					AND G.GR_NO			= C.NX_CG_NO
					AND G.VSL_CALL_ID 	= C.NX_VSL_CALL_ID )
			WHEN MATCHED THEN
					UPDATE SET 
						 G.PKG_QTY 		= C.PKG_QTY 
						,G.CG_WGT 			= C.CG_WGT
						,G.CG_VOL 		= C.CG_VOL
						,G.UPDATE_TIME 		= SYSDATE;
			END;
	
	
	 <!--  MERGE INTO TMT_RHDL_CG A 
	  USING (SELECT '00000'  AS  empty FROM dual) B 
	  	 ON (A.VSL_CALL_ID = #{vslCallId} AND A.ORG_REF_NO = #{orgRefNo} AND A.RHDL_NO = #{rhdlNo} AND B.empty ='00000')   AND A.RHDL_GROUP_NO = #{rhdlGroupNo} 
	     WHEN MATCHED THEN
	         UPDATE SET A.NX_VSL_CALL_ID = #{nxVslCallId},
						A.NX_REF_NO = #{nxRefNo},
						A.OPE_CLASS_CD = #{opeClassCd},
						A.PKG_QTY = #{rhdlPkgQty},
						A.WGT = #{rhdlWgt},
						A.MSRMT = #{rhdlMsrmt},
						A.STS_YN = DECODE(#{stsYn},NULL,'N','','N', #{stsYn}),
						A.ORG_GR_NO = #{orgGrNo},
						A.RHDL_MODE = #{rhdlMode},
						A.UPD_DT = SYSDATE,
						A.UPD_USER_ID = #{userId},
						A.VERSION 	= 	#{newVersion},
						A.NX_CG_NO = 	nvl(#{nxCgNo},null),
						A.RHDL_GROUP_NO = #{rhdlGroupNo}		
	     WHEN NOT MATCHED THEN
	     INSERT (
			RHDL_NO,
			VSL_CALL_ID,
			ORG_REF_NO,
			NX_VSL_CALL_ID,
			NX_REF_NO,
			OPE_CLASS_CD,
			PKG_QTY,
			WGT,
			MSRMT,
			STS_YN,
			ORG_GR_NO,
			RHDL_MODE,
			CG_NO,
			CG_CO_CD,
			SP_CA_CO_CD,
			UPD_DT,
			UPD_USER_ID,
			VERSION,
			NX_CG_NO,
			RHDL_GROUP_NO
			) VALUES (
		  	('R'||TO_CHAR(SYSDATE, 'YYMM') || (SELECT NVL(TRIM(To_CHAR(MAX(SUBSTR(RHDL_NO, -4, 4))+1, '0000')),'0000') 
			 FROM  TMT_RHDL_CG)), 
			#{vslCallId}, 
			#{orgRefNo}, 
			#{nxVslCallId}, 
			#{nxRefNo}, 
			#{opeClassCd}, 
			#{rhdlPkgQty}, 
			#{rhdlWgt}, 
			#{rhdlMsrmt}, 
			DECODE(#{stsYn},null,'N', #{stsYn}),
			#{orgGrNo}, 
			#{rhdlMode},
			#{cgNo},
			#{cgCoCd},
			#{spCaCoCd},
			SYSDATE, 
			#{userId},
			#{newVersion},
			nvl(#{nxCgNo},null),
			#{rhdlGroupNo}
			) -->
	</insert>

	<update id="updateCargoRehandlingItems"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_RHDL_CG A
		   SET 			A.NX_VSL_CALL_ID = #{nxVslCallId},
						A.NX_REF_NO = #{nxRefNo},
						A.OPE_CLASS_CD = #{opeClassCd},
						A.PKG_QTY = #{rhdlPkgQty},
						A.WGT = #{rhdlWgt},
						A.MSRMT = #{rhdlMsrmt},
						A.STS_YN = DECODE(#{stsYn},NULL,'N','','N', #{stsYn}),
						A.ORG_GR_NO = #{orgGrNo},
						A.RHDL_MODE = #{rhdlMode},
						A.UPDATE_TIME = SYSDATE,
						A.STAFF_CD = #{userId},
						A.VERSION = #{newVersion}	
		 WHERE	A.VSL_CALL_ID = #{vslCallId} A.AND ORG_REF_NO = #{orgRefNo} AND A.RHDL_NO = #{rhdlNo}
	</update>

	<delete id="deleteCargoRehandlingItems"  parameterType="CargoRehandlingItem">
		BEGIN
			DELETE FROM TMT_JOB
				   WHERE VSL_CALL_ID = #{nxVslCallId}
				   		 AND job_no  = #{jobNo};
			
			DELETE 	FROM TMT_RHDL_CG_DTL
			       WHERE RHDL_NO = #{rhdlNo}
						 AND SEQ = #{seq};
			
	  		MERGE INTO TMT_RHDL_CG A
		  	USING (SELECT COUNT(RHDL_NO) AS CNT FROM TMT_RHDL_CG_DTL WHERE RHDL_NO = #{rhdlNo} )B ON (
					    A.RHDL_NO	= #{rhdlNo} 
					AND B.CNT > 0)
			WHEN MATCHED THEN
					UPDATE SET 
						 A.PKG_QTY 	= PKG_QTY - #{rhdlPkgQty} 
						,A.CG_WGT 		= CG_WGT - #{rhdlWgt}
						,A.CG_VOL 	= CG_VOL - #{rhdlMsrmt}
						,A.UPDATE_TIME 	= SYSDATE;
		    
		    DELETE 
					  FROM TMT_RHDL_CG A
					 WHERE RHDL_NO = #{rhdlNo}
						   AND ((SELECT COUNT(RHDL_NO) FROM TMT_RHDL_CG_DTL WHERE RHDL_NO = #{rhdlNo}) = 0);
		END;
	</delete> 
	
	<delete id="deleteCargoRehandlingInvLocItems"  parameterType="CargoRehandlingItem">
		DELETE 	FROM TMT_INV_LOC
		WHERE	
				<!-- SUBSTR(JOB_NO, 1, 2) = 'JR' 
				AND --> 
				JOB_NO = #{jobNo}

	</delete> 
	 
	
<!--CATGTP = T, RHDLMODE = N-->
<!--	(1) 1 selectCargoRhdlTS-->
<!--CATGTP = E, RHDLMODE = N-->
<!--	(2) 2 selectCargoRhdlEX-->
<!--CATGTP = I, RHDLMODE = N-->
<!--	(3) 3 selectCargoRhdlIM-->
<!--CATGTP = T,E,I,ALL, RHDLMODE = R,C OR NX-NOT NULL-->
<!--	(4) 4 selectCargoRhdl--> 
<!--CATGTP = ALL , RHDLMODE = N-->
<!--	(8) 1+2+3 selectCargoRhdlAllNo-->
<!--CATGTP = ALL, RHDLMODE = ALL-->
<!--	(9) 1 + 2 + 3+ 4 selectCargoRhdlAllYes-->	
	<sql id ="dynamic_rh_all">	<!-- 4 -->
		<if test="nxVslCallId == null or nxVslCallId == ''">
		
		SELECT /*+ FIRST_ROWS(10)*/ 
			   A.VSL_CALL_ID	   												AS VSLCALLID,
			   DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO,
			   	                     'I',A.CG_NO,'T',A.CG_NO) 				    AS ORGREFNO, 
			   DECODE(A.OPE_CLASS_CD,'S',A.CG_NO,'E',A.CG_NO,'') 		   	    AS ORGGRNO,
			   '' 		   	    AS GRNO,
			   DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO,
			   	                     'I',A.CG_NO,'T',A.CG_NO) 							AS BLSN,
			   A.CG_NO															AS CGNO,
			   A.CG_NO															AS ORGCGNO,
			   ' '      		   		   										AS NXVSLCALLID,
		       ' '              		   										AS NXREFNO,
			   A.OPE_CLASS_CD 			   		   	   						    AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   		   FROM TMT_CD_MSTD TCM 
			   		   WHERE  TCM.L_CD = 'MT' 
			    	   AND TCM.M_CD = 'CATGTP' 
					   AND TCM.S_CD = A.OPE_CLASS_CD)							AS CATGNM,
			   B.PKG_QTY   			  											AS PKGQTY,
			   B.WGT 															AS WGT,
			   B.MSRMT 															AS MSRMT,
			   ' '              	 	   										AS STSYN,
		       ' '			           											AS RHDLMODE,
		       ' '					   											AS RHDLMODENM,
			   0					   											AS RHDLPKGQTY,
			   0.00					   											AS RHDLWGT,
			   0.00					   											AS RHDLMSRMT,
			  TO_NUMBER(B.PKG_QTY) 												AS BALPKGQTY,
			  TO_NUMBER(B.WGT) 													AS BALWGT,
			  TO_NUMBER(B.MSRMT) 												AS BALMSRMT,
			' '              				  									AS RHDLNO,
			A.STAFF_CD		   			  									AS USERID,
			TO_CHAR(A.UPD_DT,'DD/MM/YYYY HH24:MI')								AS UPDDT,
			B.WH_TP_CD			  	  	   	  									AS CGCOCD,
			(SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = B.WH_TP_CD)	   	 							AS CGCONM,
			'N'   																AS RHDLCHK,
			' '		  															AS JOBNO,
			DECODE(B.WH_TP_CD, 'S','Y','N') AS SHUYN,
			DECODE(B.WH_TP_CD, 'D','Y','N') AS DMGYN,
			B.SP_CA_CO_CD 														AS SPCACOCD,
			(SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = B.SP_CA_CO_CD)	   	 						AS SPCACONM,
			' ' AS CGTPCD,
			' ' AS NXCGNO,
			A.VSL_CALL_ID	   													AS ORGVSLCALLID,
			DECODE(A.OPE_CLASS_CD,'E',A.SHIPG_NOTE_NO,'S',A.SHIPG_NOTE_NO,
			   	                     'I',A.CG_NO,'T',A.CG_NO) 				    AS ORGBLSN,
			'' AS STAT,
			'' AS STATNM,
			'N' AS FNLHOYN,
			'N' AS FNLLOADYN,
			'' AS RHDLGROUPNO,
			'' AS LINKED,
			F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
			'' AS delvTpCd			 
		FROM TMT_CG_MST A,
		 TMT_BL BL,
       TMT_SHIPG_NOTE SN,
			 (SELECT INA.VSL_CALL_ID AS  VSL_CALL_ID,
                    INA.CG_NO       AS  CG_NO,
                    INA.WH_TP_CD    AS  WH_TP_CD,
                    INA.PKG_QTY     AS  PKG_QTY,
                    INA.MSRMT       AS  MSRMT,
                    INA.WGT         AS  WGT,
                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM (SELECT 
                           LC.VSL_CALL_ID         AS VSL_CALL_ID ,
                           LC.CG_NO               AS CG_NO ,
                           LC.WH_TP_CD              AS WH_TP_CD,
                           SUM(LC.PKG_QTY)        AS PKG_QTY,
                           SUM(LC.MSRMT)           AS MSRMT ,
                           SUM(LC.WGT)             AS WGT,
                           J.SP_CA_CO_CD        AS SP_CA_CO_CD
                FROM TMT_INV_LOC LC, TMT_JOB J
                WHERE LC.JOB_NO = J.JOB_NO 
                AND LC.VSL_CALL_ID = J.VSL_CALL_ID
                AND    LC.CG_NO = J.CG_NO
                AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
                GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
                WHERE  INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
		WHERE A.VSL_CALL_ID = B.VSL_CALL_ID
		AND	  A.CG_NO = B.CG_NO
		 AND A.VSL_CALL_ID = BL.VSL_CALL_ID(+) AND A.CG_NO = BL.BL_NO(+)
 AND A.VSL_CALL_ID = SN.VSL_CALL_ID(+) AND A.SHIPG_NOTE_NO = SN.SHIPG_NOTE_NO(+)
 AND A.CG_NO NOT IN (SELECT CG_NO FROM TMT_RHDL_CG WHERE VSL_CALL_ID = A.VSL_CALL_ID AND CG_NO = A.CG_NO)
 <if test="estArrvDateFrm != null and estArrvDateFrm != ''">
 AND
	  ( BL.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
				00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
				' 23:59:59','DD/MM/YYYY HH24:MI:SS') OR
	 SN.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
				00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
				' 23:59:59','DD/MM/YYYY HH24:MI:SS')
	  )
 </if> 
		<if test="vslCallId != null and vslCallId != ''">
  AND
			  B.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test="opeClassCd != null and opeClassCd != ''">
  AND
			  A.OPE_CLASS_CD = #{opeClassCd}
		</if>
		<if test="shipgNoteNo != null and shipgNoteNo != ''">
			<if test="blNo != null and blNo != ''">
   AND
			 (A.SHIPG_NOTE_NO = #{shipgNoteNo}  OR  A.CG_NO = #{blNo})
			</if>
			<if test="blNo == null or blNo == ''">
   AND
				A.SHIPG_NOTE_NO = #{shipgNoteNo} 
			</if>  
		</if>
		<if test="shipgNoteNo == null or shipgNoteNo == ''">
			<if test="blNo != null and blNo != ''">
   AND
			  A.CG_NO = #{blNo}
			 </if>
		</if>
		<include refid="sqlRehandleMstAuth"/>
			UNION ALL	
		</if>	
		SELECT A.VSL_CALL_ID         											AS VSLCALLID,
		       A.ORG_REF_NO           											AS ORGREFNO,
		       A.ORG_GR_NO            											AS ORGGRNO,
		         '' 		   	    AS GRNO,
		        (SELECT DECODE(COUNT(*),0,A.ORG_REF_NO,A.NX_REF_NO) 
			   		   FROM TMT_RHDL_CG G 
					   WHERE G.RHDL_NO = A.RHDL_NO
					   AND	 G.RHDL_MODE = 'C'
					   AND	 G.NX_REF_NO IS NOT NULL) 							AS BLSN,
			   A.CG_NO				  											AS CGNO,			   
			   A.CG_NO															AS ORGCGNO,			  
			   A.NX_VSL_CALL_ID       											AS NXVSLCALLID,
		       A.NX_REF_NO            											AS NXREFNO,
			   A.OPE_CLASS_CD         											AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CATGTP' 
				   AND TCM.S_CD = A.OPE_CLASS_CD )								AS CATGNM,
			   CASE 
			   	   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.PKG_QTY FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.PKG_QTY)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.PKG_QTY) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS PKGQTY,
			   CASE
				   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.WGT FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.WGT)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.WGT) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS WGT,
			   CASE 
			   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.MSRMT FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.MSRMT)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.MSRMT) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS MSRMT,
		       A.STS_YN               														AS STSYN,
		       A.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD 
		        WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = A.RHDL_MODE)            	AS RHDLMODENM,
			   NVL(TO_NUMBER(A.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   NVL(TO_NUMBER(REPLACE(NVL(A.WGT,0),',','')),0) 	   							AS RHDLWGT,
			   NVL(TO_NUMBER(A.MSRMT),0)						   							AS RHDLMSRMT,
			   TO_NUMBER(B.PKG_QTY)
			   - TO_NUMBER((SELECT NVL(SUM(H.PKG_QTY),0) 
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALPKGQTY,
			   TO_NUMBER(B.WGT)    
			   - TO_NUMBER((SELECT NVL(SUM(H.WGT),0) 
			   	 			FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALWGT,
			   TO_NUMBER(B.MSRMT)	
			   - TO_NUMBER((SELECT NVL(SUM(H.MSRMT),0)
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')								
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALMSRMT,
			   A.RHDL_NO              														AS RHDLNO,
			   A.STAFF_CD		   			  											AS USERID,
			   TO_CHAR(A.UPD_DT,'DD/MM/YYYY HH24:MI')										AS UPDDT,
			   A.CG_CO_CD 																	AS CGCOCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = A.CG_CO_CD)	   	 										AS CGCONM,
			   'Y' 																			AS RHDLCHK,
			   A.JOB_NO		  																AS JOBNO,
			  DECODE(A.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  DECODE(A.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  A.SP_CA_CO_CD 														AS SPCACOCD,
			  (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = A.SP_CA_CO_CD)	   	 						AS SPCACONM,
				   ' ' AS CGTPCD,
				   A.NX_CG_NO AS NXCGNO,
			A.VSL_CALL_ID	   													AS ORGVSLCALLID,
			A.ORG_REF_NO													    AS ORGBLSN,
			'' AS STAT,
			'' AS STATNM,
			'N' AS FNLHOYN,
			'N' AS FNLLOADYN,
			 A.RHDL_GROUP_NO AS RHDLGROUPNO,
			 '' AS LINKED,
			F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
			'' AS delvTpCd	 			      
		FROM TMT_RHDL_CG A,
       TMT_BL BL,
       TMT_SHIPG_NOTE SN
			 , (SELECT INA.VSL_CALL_ID AS  VSL_CALL_ID,
                    INA.CG_NO       AS  CG_NO,
                    INA.WH_TP_CD    AS  WH_TP_CD,
                    INA.PKG_QTY     AS  PKG_QTY,
                    INA.MSRMT       AS  MSRMT,
                    INA.WGT         AS  WGT,
                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM (SELECT 
			                           LC.VSL_CALL_ID         AS VSL_CALL_ID ,
			                           LC.CG_NO               AS CG_NO ,
			                           LC.WH_TP_CD              AS WH_TP_CD,
			                           SUM(LC.PKG_QTY)        AS PKG_QTY,
			                           SUM(LC.MSRMT)           AS MSRMT ,
			                           SUM(LC.WGT)             AS WGT,
			                           J.SP_CA_CO_CD        AS SP_CA_CO_CD
			                FROM TMT_INV_LOC LC, TMT_JOB J
			                WHERE LC.JOB_NO = J.JOB_NO 
			                AND LC.VSL_CALL_ID = J.VSL_CALL_ID
			                AND    LC.CG_NO = J.CG_NO
			                AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
			                GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
			                WHERE  INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
		WHERE NOT EXISTS (SELECT * FROM TMT_JOB C WHERE A.JOB_NO IS NOT NULL AND C.JOB_NO = A.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))	  		
				AND A.VSL_CALL_ID = B.VSL_CALL_ID
				AND A.CG_NO = B.CG_NO
				AND A.VSL_CALL_ID = BL.VSL_CALL_ID(+)
		       AND A.CG_NO = BL.BL_NO(+)
		       AND A.VSL_CALL_ID = SN.VSL_CALL_ID(+)
		       AND A.ORG_REF_NO = SN.SHIPG_NOTE_NO(+)
		        <if test="estArrvDateFrm != null and estArrvDateFrm != ''">
          AND
				  ( BL.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
				00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
				' 23:59:59','DD/MM/YYYY HH24:MI:SS') OR
	 SN.EST_ARRV_DT BETWEEN TO_DATE(#{estArrvDateFrm} || '
				00:00:00','DD/MM/YYYY HH24:MI:SS') AND TO_DATE(#{estArrvDateTo} ||
				' 23:59:59','DD/MM/YYYY HH24:MI:SS')
	  )
			 </if> 
			   <if test="vslCallId != null and vslCallId != ''">
      AND
					  A.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					<if test="blNo != null and blNo != ''">
     AND
					 (  A.ORG_REF_NO = #{shipgNoteNo}  OR   A.ORG_REF_NO = #{blNo})
					</if>
					<if test="blNo == null or blNo == ''">
     AND
						A.ORG_REF_NO = #{shipgNoteNo}
					</if>  
				</if>
				<if test="shipgNoteNo == null or shipgNoteNo == ''">
					<if test="blNo != null and blNo != ''">
     AND
					  A.ORG_REF_NO = #{blNo}
					 </if>
				</if>
				<if test="nxRefNo != null and nxRefNo != ''">
    AND
					  A.NX_REF_NO = #{nxRefNo}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
    AND
					  A.NX_VSL_CALL_ID = #{nxVslCallId}
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
    AND
					  A.OPE_CLASS_CD = #{opeClassCd}
				</if>
				<if test="rhdlMode != null and rhdlMode != ''">
    AND
					  A.RHDL_MODE = #{rhdlMode}
				</if>
				<include refid="sqlRehandleAuth"/>
         ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	<sql id ="dynamic_rh">	<!-- 4 -->
		SELECT A.VSL_CALL_ID         											AS VSLCALLID,
		       A.ORG_REF_NO           											AS ORGREFNO,
		       A.ORG_GR_NO            											AS ORGGRNO,
		        (SELECT DECODE(COUNT(*),0,A.ORG_REF_NO,A.NX_REF_NO) 
			   		   FROM TMT_RHDL_CG G 
					   WHERE G.RHDL_NO = A.RHDL_NO
					   AND	 G.RHDL_MODE = 'C'
					   AND	 G.NX_REF_NO IS NOT NULL) 							AS BLSN,
			   A.CG_NO				  											AS CGNO,			   
			   A.CG_NO															AS ORGCGNO,
			    '' 		   	    AS GRNO,
			   A.NX_VSL_CALL_ID       											AS NXVSLCALLID,
		       A.NX_REF_NO            											AS NXREFNO,
			   A.OPE_CLASS_CD         											AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CATGTP' 
				   AND TCM.S_CD = A.OPE_CLASS_CD )								AS CATGNM,
			   CASE 
			   	   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.PKG_QTY FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.PKG_QTY)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.PKG_QTY) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS PKGQTY,
			   CASE
				   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.WGT FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.WGT)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND	NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.WGT) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS WGT,
			   CASE 
			   WHEN A.JOB_NO IS NOT NULL
				   THEN
				   	   NVL((SELECT J.MSRMT FROM TMT_JOB J
					   WHERE J.JOB_NO = A.JOB_NO),0)
				   WHEN A.JOB_NO IS NULL
				   THEN
				  	NVL((SELECT  SUM(LC.MSRMT)
					FROM TMT_INV_LOC LC, TMT_JOB J
					WHERE LC.JOB_NO = J.JOB_NO
					AND LC.VSL_CALL_ID = J.VSL_CALL_ID
					AND	LC.CG_NO = J.CG_NO
					AND	LC.WH_TP_CD = A.CG_CO_CD
					AND NVL(J.SP_CA_CO_CD,' ') = NVL(A.SP_CA_CO_CD, ' ')
					AND	LC.CG_NO = A.CG_NO
					AND LC.VSL_CALL_ID = A.VSL_CALL_ID
					AND (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
					HAVING SUM(LC.MSRMT) <![CDATA[ > ]]> 0
					GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD),0) END 	AS MSRMT,
		       A.STS_YN               														AS STSYN,
		       A.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD 
		        WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = A.RHDL_MODE)            	AS RHDLMODENM,
			   NVL(TO_NUMBER(A.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   NVL(TO_NUMBER(REPLACE(NVL(A.WGT,0),',','')),0) 	   							AS RHDLWGT,
			   NVL(TO_NUMBER(A.MSRMT),0)						   							AS RHDLMSRMT,
			   TO_NUMBER(B.PKG_QTY)
			   - TO_NUMBER((SELECT NVL(SUM(H.PKG_QTY),0) 
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALPKGQTY,
			   TO_NUMBER(B.WGT)    
			   - TO_NUMBER((SELECT NVL(SUM(H.WGT),0) 
			   	 			FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID 
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')		
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALWGT,
			   TO_NUMBER(B.MSRMT)	
			   - TO_NUMBER((SELECT NVL(SUM(H.MSRMT),0)
			   	 		    FROM TMT_RHDL_CG H 
							WHERE  H.VSL_CALL_ID = A.VSL_CALL_ID
							AND H.CG_CO_CD = B.WH_TP_CD
							AND NVL(H.SP_CA_CO_CD,' ') = NVL(B.SP_CA_CO_CD, ' ')								
							AND H.CG_NO = A.CG_NO
							AND H.RHDL_NO <![CDATA[ <= ]]> A.RHDL_NO
							)) 																AS BALMSRMT,
			   A.RHDL_NO              														AS RHDLNO,
			   A.STAFF_CD		   			  											AS USERID,
			   TO_CHAR(A.UPD_DT,'DD/MM/YYYY HH24:MI')										AS UPDDT,
			   A.CG_CO_CD 																	AS CGCOCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = A.CG_CO_CD)	   	 										AS CGCONM,
			   'Y' 																			AS RHDLCHK,
			   A.JOB_NO		  																AS JOBNO,
			  DECODE(A.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  DECODE(A.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  A.SP_CA_CO_CD 														AS SPCACOCD,
			  (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = A.SP_CA_CO_CD)	   	 						AS SPCACONM,
				   ' ' AS CGTPCD,
				   A.NX_CG_NO AS NXCGNO,
			A.VSL_CALL_ID	   													AS ORGVSLCALLID,
			A.ORG_REF_NO													    AS ORGBLSN,
			'' AS STAT,
			'' AS STATNM,
			'N' AS FNLHOYN,
			'N' AS FNLLOADYN,
			A.RHDL_GROUP_NO AS RHDLGROUPNO,
			'' AS LINKED,
			F_GET_INV_WH(A.VSL_CALL_ID, A.CG_NO) AS WHLOCIDS,
			'' AS delvTpCd	 	 			      
		FROM TMT_RHDL_CG A
			, (SELECT INA.VSL_CALL_ID AS  VSL_CALL_ID,
                    INA.CG_NO       AS  CG_NO,
                    INA.WH_TP_CD    AS  WH_TP_CD,
                    INA.PKG_QTY     AS  PKG_QTY,
                    INA.MSRMT       AS  MSRMT,
                    INA.WGT         AS  WGT,
                    INA.SP_CA_CO_CD AS  SP_CA_CO_CD
                     FROM (SELECT 
                           LC.VSL_CALL_ID         AS VSL_CALL_ID ,
                           LC.CG_NO               AS CG_NO ,
                           LC.WH_TP_CD              AS WH_TP_CD,
                           SUM(LC.PKG_QTY)        AS PKG_QTY,
                           SUM(LC.MSRMT)           AS MSRMT ,
                           SUM(LC.WGT)             AS WGT,
                           J.SP_CA_CO_CD        AS SP_CA_CO_CD
                FROM TMT_INV_LOC LC, TMT_JOB J
                WHERE LC.JOB_NO = J.JOB_NO 
                AND LC.VSL_CALL_ID = J.VSL_CALL_ID
                AND    LC.CG_NO = J.CG_NO
                AND    (J.RHDL_MODE IS NULL OR J.RHDL_MODE ='' OR J.RHDL_MODE = 'N')
                GROUP BY LC.VSL_CALL_ID, LC.CG_NO,LC.WH_TP_CD,J.SP_CA_CO_CD) INA
                WHERE  INA.WGT <![CDATA[ > ]]> 0 OR INA.MSRMT <![CDATA[ > ]]> 0 OR INA.PKG_QTY <![CDATA[ > ]]> 0) B
		WHERE NOT EXISTS (SELECT * FROM TMT_JOB C WHERE A.JOB_NO IS NOT NULL AND C.JOB_NO = A.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))
				AND A.VSL_CALL_ID = B.VSL_CALL_ID
				AND A.ORG_REF_NO = B.CG_NO
			   <if test="vslCallId != null and vslCallId != ''">
      AND
					  A.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					<if test="blNo != null and blNo != ''">
     AND
					 (  A.ORG_REF_NO = #{shipgNoteNo}  OR   A.ORG_REF_NO = #{blNo})
					</if>
					<if test="blNo == null or blNo == ''">
     AND
						A.ORG_REF_NO = #{shipgNoteNo}
					</if>  
				</if>
				<if test="shipgNoteNo == null or shipgNoteNo == ''">
					<if test="blNo != null and blNo != ''">
     AND
					  A.ORG_REF_NO = #{blNo}
					 </if>
				</if>
				<if test="nxRefNo != null and nxRefNo != ''">
    AND
					  A.NX_REF_NO = #{nxRefNo}
				</if>
				<if test="nxVslCallId != null and nxVslCallId != ''">
    AND
					  A.NX_VSL_CALL_ID = #{nxVslCallId}
				</if>
				<if test="opeClassCd != null and opeClassCd != ''">
    AND
					  A.OPE_CLASS_CD = #{opeClassCd}
				</if>
				<if test="rhdlMode != null and rhdlMode != ''">
    AND
					  A.RHDL_MODE = #{rhdlMode}
				</if>
				<include refid="sqlRehandleAuth"/>
         ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>  
	<sql id ="dynamic_rh_op">
	SELECT 	   R.VSL_CALL_ID 													AS VSLCALLID,
		       R.ORG_REF_NO           											AS ORGREFNO,
		       R.ORG_REF_NO 													AS BLSN,
			   R.ORG_GR_NO	   													AS ORGGRNO,
			   R.ORG_GR_NO	   													AS GRNO,
			   R.CG_NO				  											AS CGNO,
			   R.CG_NO				  											AS ORGCGNO,
			   ' ' 																AS NXVSLCALLID,
		       ' '            													AS NXREFNO,
			   R.OPE_CLASS_CD         											AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CATGTP' 
				   AND TCM.S_CD = R.OPE_CLASS_CD )								AS CATGNM,
			    NVL(J.PKG_QTY , 0)             												AS PKGQTY,
              NVL(J.WGT , 0)                												AS WGT,
               NVL(J.MSRMT, 0)               												AS MSRMT,
		       R.STS_YN               														AS STSYN,
		       R.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD 
		        WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)            	AS RHDLMODENM,
			   NVL(TO_NUMBER(R.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   NVL(TO_NUMBER(REPLACE(NVL(R.WGT,0),',','')),0) 	   							AS RHDLWGT,
			   NVL(TO_NUMBER(R.MSRMT),0)						   							AS RHDLMSRMT,
			   0   																			AS BALPKGQTY,
			   0.0 																			AS BALWGT,
			   0.0 																			AS BALMSRMT,
			   R.RHDL_NO              														AS RHDLNO,
			   ''		   			  											AS USERID,
			   ''																		AS UPDDT,
			   R.CG_CO_CD 																	AS CGCOCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = R.CG_CO_CD)	   	 										AS CGCONM,
			   'Y' 																			AS RHDLCHK,
			   R.JOB_NO		  																AS JOBNO,
			  DECODE(R.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  DECODE(R.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  R.SP_CA_CO_CD 														AS SPCACOCD,
			  (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = R.SP_CA_CO_CD)	   	 						AS SPCACONM,
		 	  DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO),NULL,
                (SELECT S.CG_TP_CD FROM TMT_BL S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BL_NO = R.ORG_REF_NO),
                (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO)) CGTPCD,
				R.NX_CG_NO AS NXCGNO,
				R.VSL_CALL_ID	   													AS ORGVSLCALLID,
			R.ORG_REF_NO													   		AS ORGBLSN,
			 /* GET_RHDL_STATUS(R.RHDL_NO, R.VSL_CALL_ID, R.CG_NO, R.RHDL_GROUP_NO, 'R') AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
			<!-- (SELECT TCM.S_CD_NM FROM TMT_CD_MSTD TCM 
                       WHERE  TCM.L_CD = 'MT'
                       AND TCM.M_CD ='CGSTATUS'
                       AND TCM.S_CD = F_GET_RHDL_STATUS(R.RHDL_NO, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'R')) AS STATNM, -->
			NVL(J.FNL_OPE_YN, 'N') 			AS FNLHOYN, 
			'N' 								AS FNLLOADYN,
			R.RHDL_GROUP_NO AS RHDLGROUPNO,
			F_GET_SN_LINKED(R.VSL_CALL_ID, R.ORG_REF_NO)  AS LINKED,
			F_GET_INV_WH(R.VSL_CALL_ID, R.CG_NO) 			AS WHLOCIDS,
			(SELECT CG.DELV_TP_CD AS DELVTPCD FROM TMT_CG_MST CG
			 WHERE CG.VSL_CALL_ID = R.VSL_CALL_ID
			 AND   CG.CG_NO = R.CG_NO) 					AS DELVTPCD,
			 J.ST_RHDL AS stRhdl,
			 J.ST_RHDL AS endRhdl
			  	
		FROM TMT_RHDL_CG R
				, (
                SELECT  NVL (SUM (j1.pkg_qty), 0)   AS PKG_QTY
                        , NVL (SUM (j1.wgt), 0)      AS WGT
                        , NVL (SUM (j1.msrmt), 0)    AS MSRMT
                        , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
                        , J1.VSL_CALL_ID            AS VSL_CALL_ID
                        , J1.CG_NO                  AS CG_NO
                        , J1.RHDL_NO                AS RHDL_NO
                        , J1.JOB_PURP_CD            AS JOB_PURP_CD
                        , TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        , TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
                FROM    TMT_JOB J1
            WHERE
			<if test="stRhdl != null and stRhdl != ''">
			 	  TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                			AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
			<if test="vslCallId != null and vslCallId != ''">
				  J1.VSL_CALL_ID = #{vslCallId}
			</if>
                GROUP BY J1.VSL_CALL_ID, J1.RHDL_NO, J1.CG_NO, J1.JOB_PURP_CD,J1.WORK_ST_DT, J1.WORK_END_DT
                ) J
		WHERE 
<!--		R.NX_VSL_CALL_ID IS NULL-->
<!--		AND	R.RHDL_MODE = 'R'-->
		    R.VSL_CALL_ID = J.VSL_CALL_ID(+)
     	AND R.RHDL_NO = J.RHDL_NO(+)
     	AND R.CG_NO = J.CG_NO(+)
		AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))
		AND	R.RHDL_MODE = 'R'
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
				  R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
			 	 R.ORG_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="stRhdl != null and stRhdl != ''">
   AND
			 	 TO_DATE(J.ST_RHDL,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
			
		UNION
		SELECT 
		               R.VSL_CALL_ID                                                AS VSLCALLID,
		               R.ORG_REF_NO                                                      AS ORGREFNO,
		               R.NX_REF_NO                                                      AS BLSN,
		               ''                                                               AS ORGGRNO,
		               R.NX_CG_NO                                                       AS GRNO,
		               R.NX_CG_NO                                                       AS CGNO,
		               ''                                                               AS ORGCGNO,
		               R.NX_VSL_CALL_ID                                                 AS NXVSLCALLID,
		               R.NX_REF_NO                                                      AS NXREFNO,
		               (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID)                         AS OPECLASSCD,
		               (SELECT TCM.S_CD_NM 
		                   FROM TMT_CD_MSTD TCM 
		                   WHERE  TCM.L_CD = 'MT' 
		                      AND TCM.M_CD = 'CATGTP' 
		                   AND TCM.S_CD = (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                                    WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                                    AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID))    AS CATGNM,
		              NVL(SUM(J.PKG_QTY), 0)                                                               AS PKGQTY,
		              NVL(SUM(J.WGT), 0)                                                             AS WGT,
		               NVL(SUM(J.MSRMT), 0)                                                               AS MSRMT,
		               (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.STS_YN ='Y')                                         AS STSYN,
		               R.RHDL_MODE                                                      AS RHDLMODE,
		                (SELECT S_CD_NM FROM TMT_CD_MSTD 
		                WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)  AS RHDLMODENM,
		               NVL(TO_NUMBER(SUM(R.PKG_QTY)),0)                                 AS RHDLPKGQTY,
		               NVL(TO_NUMBER(REPLACE(NVL(SUM(R.WGT),0),',','')),0)              AS RHDLWGT,
		               NVL(TO_NUMBER(SUM(R.MSRMT)),0)                                   AS RHDLMSRMT,
		               0                                                                AS BALPKGQTY,
		               0.0                                                              AS BALWGT,
		               0.0                                                              AS BALMSRMT,
		               F_GET_RHDL_NOS(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO)                                      AS RHDLNO,
		               ''		   			  								AS USERID,
			           ''															AS UPDDT,
		               R.CG_CO_CD                                                       AS CGCOCD,
		               <!-- F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
		                              R.RHDL_GROUP_NO,
		                              'CG')                                             AS CGCONM, -->
		               '' AS CGCONM,
		               'Y'                                                              AS RHDLCHK,
		               ''                                                               AS JOBNO,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'S')                                      AS SHUYN,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'D')                                      AS DMGYN,
		              ''                                                                AS SPCACOCD,
		              <!-- F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO,
	                              'SP')                                             AS SPCACONM, -->
	              '' AS SPCACONM,
	              DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO),NULL,NULL,
	              (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO)) CGTPCD,
	              R.NX_CG_NO                                                        AS NXCGNO,
	              R.VSL_CALL_ID                                                     AS ORGVSLCALLID,
	              R.ORG_REF_NO                                                      AS ORGBLSN,
	              /* GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C')          AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
	             <!-- (SELECT TCM.S_CD_NM FROM TMT_CD_MSTD TCM 
	                       WHERE  TCM.L_CD = 'MT'
	                       AND TCM.M_CD ='CGSTATUS'
	                       AND TCM.S_CD = F_GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C'))     AS STATNM, -->
	             'N'    AS FNLHOYN, 
	             NVL(MAX(J.FNL_OPE_YN), 'N') 										AS FNLLOADYN,
	              R.RHDL_GROUP_NO                                                   AS RHDLGROUPNO,
	              F_GET_SN_LINKED(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS LINKED,
			F_GET_INV_WH(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS WHLOCIDS,
			'' 					AS DELVTPCD,
			J.ST_RHDL AS stRhdl,
			J.ST_RHDL AS endRhdl
	        FROM TMT_RHDL_CG R
	        		, (
		                SELECT      NVL (SUM (j1.pkg_qty), 0)    AS PKG_QTY
		                            , NVL (SUM (j1.wgt), 0)      AS WGT
		                            , NVL (SUM (j1.msrmt), 0)    AS MSRMT
		                            , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
		                            , J1.VSL_CALL_ID
		                            , J1.CG_NO
		                            , J1.RHDL_GROUP_NO	
		                        	, J1.RHDL_NO
		                        	, TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        			, TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
		                FROM        TMT_JOB J1
		                WHERE       J1.RHDL_MODE = 'C'
		                            AND J1.JOB_PURP_CD IN ('AV')
		                            AND RHDL_NO IS NOT NULL
		                            <if test="stRhdl != null and stRhdl != ''">
                              AND
									 	 TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
						                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
									</if>
									<if test="vslCallId != null and vslCallId != ''">
         AND
										  J1.VSL_CALL_ID = #{vslCallId}
									</if>
		                GROUP BY    J1.VSL_CALL_ID, J1.CG_NO, J1.RHDL_GROUP_NO, J1.RHDL_NO, J1.RHDL_MODE, J1.JOB_PURP_CD, J1.WORK_ST_DT, J1.WORK_END_DT
		            ) J
	        WHERE    R.NX_VSL_CALL_ID IS NOT NULL
            AND    R.RHDL_MODE = 'C'
            		AND R.NX_VSL_CALL_ID = J.VSL_CALL_ID(+)
            		AND R.NX_CG_NO = J.CG_NO(+)
            		AND R.RHDL_NO = J.RHDL_NO(+)
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>				
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
		 	 	 R.NX_VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
		 		 R.NX_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="stRhdl != null and stRhdl != ''">
   AND
			 	 TO_DATE(J.ST_RHDL,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
		GROUP BY R.NX_VSL_CALL_ID, R.NX_REF_NO, R.NX_CG_NO, R.RHDL_GROUP_NO, R.RHDL_MODE,R.VSL_CALL_ID,R.ORG_REF_NO,R.CG_CO_CD,J.ST_RHDL,J.END_RHDL
		ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	<sql id ="dynamic_rh_op_nonJPVC">
	SELECT 	   R.VSL_CALL_ID 													AS VSLCALLID,
		       R.ORG_REF_NO           											AS ORGREFNO,
		       R.ORG_REF_NO 													AS BLSN,
			   R.ORG_GR_NO	   													AS ORGGRNO,
			   R.ORG_GR_NO	   													AS GRNO,
			   R.CG_NO				  											AS CGNO,
			   R.CG_NO				  											AS ORGCGNO,
			   ' ' 																AS NXVSLCALLID,
		       ' '            													AS NXREFNO,
			   R.OPE_CLASS_CD         											AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CATGTP' 
				   AND TCM.S_CD = R.OPE_CLASS_CD )								AS CATGNM,
			    NVL(J.PKG_QTY , 0)             												AS PKGQTY,
              NVL(J.WGT , 0)                												AS WGT,
               NVL(J.MSRMT, 0)               												AS MSRMT,
		       R.STS_YN               														AS STSYN,
		       R.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD 
		        WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)            	AS RHDLMODENM,
			   NVL(TO_NUMBER(R.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   NVL(TO_NUMBER(REPLACE(NVL(R.WGT,0),',','')),0) 	   							AS RHDLWGT,
			   NVL(TO_NUMBER(R.MSRMT),0)						   							AS RHDLMSRMT,
			   0   																			AS BALPKGQTY,
			   0.0 																			AS BALWGT,
			   0.0 																			AS BALMSRMT,
			   R.RHDL_NO              														AS RHDLNO,
			   ''		   			  											AS USERID,
			   ''																		AS UPDDT,
			   R.CG_CO_CD 																	AS CGCOCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = R.CG_CO_CD)	   	 										AS CGCONM,
			   'Y' 																			AS RHDLCHK,
			   R.JOB_NO		  																AS JOBNO,
			  DECODE(R.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  DECODE(R.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  R.SP_CA_CO_CD 														AS SPCACOCD,
			  (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = R.SP_CA_CO_CD)	   	 						AS SPCACONM,
		 	  DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO),NULL,
                (SELECT S.CG_TP_CD FROM TMT_BL S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BL_NO = R.ORG_REF_NO),
                (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO)) CGTPCD,
				R.NX_CG_NO AS NXCGNO,
				R.VSL_CALL_ID	   													AS ORGVSLCALLID,
			R.ORG_REF_NO													   		AS ORGBLSN,
			 /* GET_RHDL_STATUS(R.RHDL_NO, R.VSL_CALL_ID, R.CG_NO, R.RHDL_GROUP_NO, 'R') AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
			/*(SELECT TCM.S_CD_NM FROM TMT_CD_MSTD TCM 
                       WHERE  TCM.L_CD = 'MT'
                       AND TCM.M_CD ='CGSTATUS'
                       AND TCM.S_CD = F_GET_RHDL_STATUS(R.RHDL_NO, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'R')) AS STATNM, */
            'Delivered' AS STATNM,
			NVL(J.FNL_OPE_YN, 'N') 			AS FNLHOYN, 
			'N' 								AS FNLLOADYN,
			R.RHDL_GROUP_NO AS RHDLGROUPNO,
			F_GET_SN_LINKED(R.VSL_CALL_ID, R.ORG_REF_NO)  AS LINKED,
			F_GET_INV_WH(R.VSL_CALL_ID, R.CG_NO) 			AS WHLOCIDS,
			(SELECT CG.DELV_TP_CD AS DELVTPCD FROM TMT_CG_MST CG
			 WHERE CG.VSL_CALL_ID = R.VSL_CALL_ID
			 AND   CG.CG_NO = R.CG_NO) 					AS DELVTPCD,
			 J.ST_RHDL AS stRhdl,
			 J.ST_RHDL AS endRhdl
			  	
		FROM TMT_RHDL_CG R,TMT_SHIPG_NOTE SN, (
                SELECT  NVL (SUM (j1.pkg_qty), 0)   AS PKG_QTY
                        , NVL (SUM (j1.wgt), 0)      AS WGT
                        , NVL (SUM (j1.msrmt), 0)    AS MSRMT
                        , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
                        , J1.VSL_CALL_ID            AS VSL_CALL_ID
                        , J1.CG_NO                  AS CG_NO
                        , J1.RHDL_NO                AS RHDL_NO
                        , J1.JOB_PURP_CD            AS JOB_PURP_CD
                        , TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        , TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
                FROM    TMT_JOB J1
            WHERE 1=1
			<if test="stRhdl != null and stRhdl != ''">
			 AND	 TO_CHAR( TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') ) BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                			AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
			<if test="vslCallId != null and vslCallId != ''">
				  AND J1.VSL_CALL_ID = #{vslCallId}
			</if>
                GROUP BY J1.VSL_CALL_ID, J1.RHDL_NO, J1.CG_NO, J1.JOB_PURP_CD,J1.WORK_ST_DT, J1.WORK_END_DT
                ) J
		WHERE 
<!--		R.NX_VSL_CALL_ID IS NULL-->
<!--		AND	R.RHDL_MODE = 'R'-->
		    R.VSL_CALL_ID = J.VSL_CALL_ID(+)
     	AND R.RHDL_NO = J.RHDL_NO(+)
     	AND R.CG_NO = J.CG_NO(+)
     	AND SN.SHIPG_NOTE_NO = R.ORG_REF_NO(+)
		AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
				  R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
			 	 R.ORG_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="vslCallId == 'NonCallId'" >
				<if test="stRhdl != null and stRhdl != ''">
    AND
				 	 SN.EST_ARRV_DT  <![CDATA[ >= ]]> TO_DATE(#{stRhdl} || '00:00:00','DD/MM/YYYY HH24:MI:SS') 
	                	AND SN.EST_ARRV_DT <![CDATA[ <= ]]> TO_DATE(#{endRhdl}|| '23:59:59','DD/MM/YYYY HH24:MI:SS')
				</if>
			</if>
			
		UNION
		SELECT 
		               R.VSL_CALL_ID                                                AS VSLCALLID,
		               R.ORG_REF_NO                                                      AS ORGREFNO,
		               R.NX_REF_NO                                                      AS BLSN,
		               ''                                                               AS ORGGRNO,
		               R.NX_CG_NO                                                       AS GRNO,
		               R.NX_CG_NO                                                       AS CGNO,
		               ''                                                               AS ORGCGNO,
		               R.NX_VSL_CALL_ID                                                 AS NXVSLCALLID,
		               R.NX_REF_NO                                                      AS NXREFNO,
		               (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID)                         AS OPECLASSCD,
		               (SELECT TCM.S_CD_NM 
		                   FROM TMT_CD_MSTD TCM 
		                   WHERE  TCM.L_CD = 'MT' 
		                      AND TCM.M_CD = 'CATGTP' 
		                   AND TCM.S_CD = (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                                    WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                                    AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID))    AS CATGNM,
		              NVL(SUM(J.PKG_QTY), 0)                                                               AS PKGQTY,
		              NVL(SUM(J.WGT), 0)                                                             AS WGT,
		               NVL(SUM(J.MSRMT), 0)                                                               AS MSRMT,
		               (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.STS_YN ='Y')                                         AS STSYN,
		               R.RHDL_MODE                                                      AS RHDLMODE,
		                (SELECT S_CD_NM FROM TMT_CD_MSTD 
		                WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)  AS RHDLMODENM,
		               NVL(TO_NUMBER(SUM(R.PKG_QTY)),0)                                 AS RHDLPKGQTY,
		               NVL(TO_NUMBER(REPLACE(NVL(SUM(R.WGT),0),',','')),0)              AS RHDLWGT,
		               NVL(TO_NUMBER(SUM(R.MSRMT)),0)                                   AS RHDLMSRMT,
		               0                                                                AS BALPKGQTY,
		               0.0                                                              AS BALWGT,
		               0.0                                                              AS BALMSRMT,
		               F_GET_RHDL_NOS(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO)                                      AS RHDLNO,
		               ''		   			  								AS USERID,
			           ''															AS UPDDT,
		               R.CG_CO_CD                                                       AS CGCOCD,
		              <!--  F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
		                              R.RHDL_GROUP_NO,
		                              'CG')                                             AS CGCONM, -->
		               '' AS CGCONM,
		               'Y'                                                              AS RHDLCHK,
		               ''                                                               AS JOBNO,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'S')                                      AS SHUYN,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'D')                                      AS DMGYN,
		              ''                                                                AS SPCACOCD,
		              <!-- F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO,
	                              'SP')                                             AS SPCACONM, -->
	              ''   AS SPCACONM,
	              DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO),NULL,NULL,
	              (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO)) CGTPCD,
	              R.NX_CG_NO                                                        AS NXCGNO,
	              R.VSL_CALL_ID                                                     AS ORGVSLCALLID,
	              R.ORG_REF_NO                                                      AS ORGBLSN,
	              /* GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C')          AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
	            /* (SELECT TCM.S_CD_NM FROM TMT_CD_MSTD TCM 
	                       WHERE  TCM.L_CD = 'MT'
	                       AND TCM.M_CD ='CGSTATUS'
	                       AND TCM.S_CD = F_GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C'))     AS STATNM, */
	                       'Delivered' AS STATNM,
	             'N'    AS FNLHOYN, 
	             NVL(MAX(J.FNL_OPE_YN), 'N') 										AS FNLLOADYN,
	              R.RHDL_GROUP_NO                                                   AS RHDLGROUPNO,
	              F_GET_SN_LINKED(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS LINKED,
			F_GET_INV_WH(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS WHLOCIDS,
			'' 					AS DELVTPCD,
			J.ST_RHDL AS stRhdl,
			J.ST_RHDL AS endRhdl
	        FROM TMT_RHDL_CG R,TMT_SHIPG_NOTE SN, (
		                SELECT      NVL (SUM (j1.pkg_qty), 0)    AS PKG_QTY
		                            , NVL (SUM (j1.wgt), 0)      AS WGT
		                            , NVL (SUM (j1.msrmt), 0)    AS MSRMT
		                            , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
		                            , J1.VSL_CALL_ID
		                            , J1.CG_NO
		                            , J1.RHDL_GROUP_NO	
		                        	, J1.RHDL_NO
		                        	, TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        			, TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
		                FROM        TMT_JOB J1
		                WHERE       J1.RHDL_MODE = 'C'
		                            AND J1.JOB_PURP_CD IN ('AV')
		                            AND RHDL_NO IS NOT NULL
		                            <if test="stRhdl != null and stRhdl != ''">
                              AND
									 	 TO_CHAR( TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') ) BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
						                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
									</if>
									<if test="vslCallId != null and vslCallId != ''">
         AND
										  J1.VSL_CALL_ID = #{vslCallId}
									</if>
		                GROUP BY    J1.VSL_CALL_ID, J1.CG_NO, J1.RHDL_GROUP_NO, J1.RHDL_NO, J1.RHDL_MODE, J1.JOB_PURP_CD, J1.WORK_ST_DT, J1.WORK_END_DT
		            ) J
	        WHERE    R.NX_VSL_CALL_ID IS NOT NULL
            AND    R.RHDL_MODE = 'C'
            		AND R.NX_VSL_CALL_ID = J.VSL_CALL_ID(+)
            		AND R.NX_CG_NO = J.CG_NO(+)
            		AND R.RHDL_NO = J.RHDL_NO(+)
            		AND SN.SHIPG_NOTE_NO = R.ORG_REF_NO(+)
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>				
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
		 	 	 R.NX_VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
		 		 R.NX_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="vslCallId == 'NonCallId'" >
				<if test="stRhdl != null and stRhdl != ''">
    AND
				 	 SN.EST_ARRV_DT  <![CDATA[ >= ]]> TO_DATE(#{stRhdl} || '00:00:00','DD/MM/YYYY HH24:MI:SS') 
	                	AND SN.EST_ARRV_DT <![CDATA[ <= ]]> TO_DATE(#{endRhdl}|| '23:59:59','DD/MM/YYYY HH24:MI:SS')
				</if>
			</if>
		GROUP BY R.NX_VSL_CALL_ID, R.NX_REF_NO, R.NX_CG_NO, R.RHDL_GROUP_NO, R.RHDL_MODE,R.VSL_CALL_ID,R.ORG_REF_NO,R.CG_CO_CD,J.ST_RHDL,J.END_RHDL
		ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	<sql id ="dynamic_rh_op_r">	<!-- 5 -->
	SELECT 	   R.VSL_CALL_ID 													AS VSLCALLID,
		       R.ORG_REF_NO           											AS ORGREFNO,
		       R.ORG_REF_NO 													AS BLSN,
			   R.ORG_GR_NO	   													AS ORGGRNO,
			   R.ORG_GR_NO	   													AS GRNO,
			   R.CG_NO				  											AS CGNO,
			   R.CG_NO				  											AS ORGCGNO,
			   ' ' 																AS NXVSLCALLID,
		       ' '            													AS NXREFNO,
			   R.OPE_CLASS_CD         											AS OPECLASSCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CATGTP' 
				   AND TCM.S_CD = R.OPE_CLASS_CD )								AS CATGNM,
			   NVL(J.PKG_QTY, 0)                 											AS PKGQTY,
               NVL(J.WGT, 0)                  												AS WGT,
               NVL(J.MSRMT, 0)               												AS MSRMT,
		       R.STS_YN               														AS STSYN,
		       R.RHDL_MODE            														AS RHDLMODE,
		        (SELECT S_CD_NM FROM TMT_CD_MSTD 
		        WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)            	AS RHDLMODENM,
			   NVL(TO_NUMBER(R.PKG_QTY),0)  					   							AS RHDLPKGQTY,
			   NVL(TO_NUMBER(REPLACE(NVL(R.WGT,0),',','')),0) 	   							AS RHDLWGT,
			   NVL(TO_NUMBER(R.MSRMT),0)						   							AS RHDLMSRMT,
			   0   																			AS BALPKGQTY,
			   0.0 																			AS BALWGT,
			   0.0 																			AS BALMSRMT,
			   R.RHDL_NO              														AS RHDLNO,
			   ''		   			  											AS USERID,
			   ''																		AS UPDDT,
			   R.CG_CO_CD 																	AS CGCOCD,
			   (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'CGCOCD' 
				   AND TCM.S_CD = R.CG_CO_CD)	   	 										AS CGCONM,
			   'Y' 																			AS RHDLCHK,
			   R.JOB_NO		  																AS JOBNO,
			  DECODE(R.CG_CO_CD, 'S','Y','N') AS SHUYN,
			  DECODE(R.CG_CO_CD, 'D','Y','N') AS DMGYN,
			  R.SP_CA_CO_CD 														AS SPCACOCD,
			  (SELECT TCM.S_CD_NM 
			   	FROM TMT_CD_MSTD TCM 
			   	WHERE  TCM.L_CD = 'MT' 
			   	   AND TCM.M_CD = 'SPCACOCD' 
				   AND TCM.S_CD = R.SP_CA_CO_CD)	   	 						AS SPCACONM,
			   DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO),NULL,
                (SELECT S.CG_TP_CD FROM TMT_BL S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.BL_NO = R.ORG_REF_NO),
                (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.ORG_REF_NO)) CGTPCD,
				R.NX_CG_NO AS NXCGNO,
				R.VSL_CALL_ID	   													AS ORGVSLCALLID,
			R.ORG_REF_NO													    AS ORGBLSN,
			/* GET_RHDL_STATUS(R.RHDL_NO, R.VSL_CALL_ID, R.CG_NO,R.RHDL_GROUP_NO,'R') AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
			(SELECT TCM.S_CD_NM FROM TMT_CD_MSTDTCM 
                       WHERE  TCM.L_CD = 'MT'
                       AND TCM.M_CD ='CGSTATUS'
                       AND TCM.S_CD = F_GET_RHDL_STATUS(R.RHDL_NO, R.NX_VSL_CALL_ID, R.NX_CG_NO,R.RHDL_GROUP_NO,'R')) AS STATNM,
            NVL(J.FNL_OPE_YN, 'N') 								AS FNLHOYN, 
			'N' 												AS FNLLOADYN,
			R.RHDL_GROUP_NO 									AS RHDLGROUPNO,
			F_GET_SN_LINKED(R.VSL_CALL_ID, R.ORG_REF_NO) 			AS LINKED,
			F_GET_INV_WH(R.VSL_CALL_ID, R.CG_NO) AS WHLOCIDS,
			(SELECT CG.DELV_TP_CD AS DELVTPCD FROM TMT_CG_MST CG
			 WHERE CG.VSL_CALL_ID = R.VSL_CALL_ID
			 AND   CG.CG_NO = R.CG_NO) 							AS DELVTPCD	,
			 J.ST_RHDL 											AS stRhdl ,
         	 J.END_RHDL
		FROM TMT_RHDL_CG R
				, (
                SELECT  NVL (SUM (j1.pkg_qty), 0)   AS PKG_QTY
                        , NVL (SUM (j1.wgt), 0)      AS WGT
                        , NVL (SUM (j1.msrmt), 0)    AS MSRMT
                        , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
                        , J1.VSL_CALL_ID            AS VSL_CALL_ID
                        , J1.CG_NO                  AS CG_NO
                        , J1.RHDL_NO                AS RHDL_NO
                        , J1.JOB_PURP_CD            AS JOB_PURP_CD
                        ,TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        ,TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
                FROM    TMT_JOB J1
                WHERE   J1.JOB_PURP_CD IN ('WG')
	                	<if test="stRhdl != null and stRhdl != ''">
                  AND
						 	 TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
			                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
						</if>
						<if test="vslCallId != null and vslCallId != ''">
      AND
							 J1.VSL_CALL_ID = #{vslCallId}
						</if>
                GROUP BY J1.VSL_CALL_ID, J1.RHDL_NO, J1.CG_NO, J1.JOB_PURP_CD, J1.WORK_ST_DT, J1.WORK_END_DT
                ) J
		WHERE   R.NX_VSL_CALL_ID IS NULL
			AND	R.RHDL_MODE = 'R'
			AND R.VSL_CALL_ID = J.VSL_CALL_ID(+)
     		AND R.RHDL_NO = J.RHDL_NO(+)
     		AND R.CG_NO = J.CG_NO(+)
		AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))	  	
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>	
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
				  R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
			 	 R.ORG_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="stRhdl != null and stRhdl != ''">
   AND
			 	 TO_DATE(J.ST_RHDL,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
         ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	<sql id ="dynamic_rh_op_c">	<!-- 5 --> 
		SELECT 
		               R.VSL_CALL_ID                                                    AS VSLCALLID,
		               R.ORG_REF_NO                                                     AS ORGREFNO,
		               R.NX_REF_NO                                                      AS BLSN,
		               ''                                                               AS ORGGRNO,
		               R.NX_CG_NO                                                       AS GRNO,
		               R.NX_CG_NO                                                       AS CGNO,
		               ''                                                               AS ORGCGNO,
		               R.NX_VSL_CALL_ID                                                 AS NXVSLCALLID,
		               R.NX_REF_NO                                                      AS NXREFNO,
		               (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID)                         AS OPECLASSCD,
		               (SELECT TCM.S_CD_NM 
		                   FROM TMT_CD_MSTD TCM 
		                   WHERE  TCM.L_CD = 'MT' 
		                      AND TCM.M_CD = 'CATGTP' 
		                   AND TCM.S_CD = (SELECT NVL(S.CATG_CD,NULL) FROM TMT_SHIPG_NOTE S
		                                    WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
		                                    AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID))    AS CATGNM,
		              NVL(SUM(J.PKG_QTY), 0)                                                    AS PKGQTY,
		               NVL(SUM(J.WGT), 0)                                                        AS WGT,
		               NVL(SUM(J.MSRMT), 0)                                                              AS MSRMT,
		               (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.STS_YN ='Y')                                         AS STSYN,
		               R.RHDL_MODE                                                      AS RHDLMODE,
		                (SELECT S_CD_NM FROMTMT_CD_MSTD 
		                WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE)  AS RHDLMODENM,
		               NVL(TO_NUMBER(SUM(R.PKG_QTY)),0)                                 AS RHDLPKGQTY,
		               NVL(TO_NUMBER(REPLACE(NVL(SUM(R.WGT),0),',','')),0)              AS RHDLWGT,
		               NVL(TO_NUMBER(SUM(R.MSRMT)),0)                                   AS RHDLMSRMT,
		               0                                                                AS BALPKGQTY,
		               0.0                                                              AS BALWGT,
		               0.0                                                              AS BALMSRMT,
		               F_GET_RHDL_NOS(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO)                                      AS RHDLNO,
		               ''		    		   			  								AS USERID,
			           ''																AS UPDDT,
		               ''                                                               AS CGCOCD,
		               <!-- F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
		                              R.RHDL_GROUP_NO,
		                              'CG')                                             AS CGCONM, -->
		               '' AS CGCONM,
		               'Y'                                                              AS RHDLCHK,
		               ''                                                               AS JOBNO,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'S')                                      AS SHUYN,
		              (SELECT DECODE(COUNT(*),0,NULL,'Y')
		                  FROM TMT_RHDL_CG RH
		                  WHERE RH.RHDL_GROUP_NO = R.RHDL_GROUP_NO
		                  AND   RH.VSL_CALL_ID = R.VSL_CALL_ID
		                  AND   RH.ORG_REF_NO = R.ORG_REF_NO
		                  AND   RH.CG_CO_CD = 'D')                                      AS DMGYN,
		              ''                                                                AS SPCACOCD,
		             <!--  F_GET_RHDL_CODES(R.NX_VSL_CALL_ID,
		                              R.NX_REF_NO,
		                              R.NX_CG_NO,
	                              R.RHDL_GROUP_NO,
	                              'SP')                                             AS SPCACONM, -->
	                              
	              '' AS SPCACONM,
	              DECODE((SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO),NULL,NULL,
	              (SELECT S.CG_TP_CD FROM TMT_SHIPG_NOTE S WHERE S.VSL_CALL_ID = R.NX_VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.NX_REF_NO)) CGTPCD,
	              R.NX_CG_NO                                                        AS NXCGNO,
	              R.VSL_CALL_ID                                                     AS ORGVSLCALLID,
	              R.ORG_REF_NO                                                      AS ORGBLSN,
	              /* GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C')          AS STAT, */	/* this is commented out because the GET_RHDL_STATUS is very slow, and STAT is not used on screen CT215 */
	             <!-- (SELECT TCM.S_CD_NM FROM TMT_CD_MSTD TCM 
	                       WHERE  TCM.L_CD = 'MT'
	                       AND TCM.M_CD ='CGSTATUS'
	                       AND TCM.S_CD = F_GET_RHDL_STATUS(NULL, R.NX_VSL_CALL_ID, R.NX_CG_NO, R.RHDL_GROUP_NO,'C'))     AS STATNM, -->
	             'N'    AS FNLHOYN, 
	             NVL(MAX(J.FNL_OPE_YN), 'N')  								AS FNLLOADYN,
	              R.RHDL_GROUP_NO                                                   AS RHDLGROUPNO,
	              F_GET_SN_LINKED(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS LINKED,
			F_GET_INV_WH(R.NX_VSL_CALL_ID, R.NX_REF_NO) AS WHLOCIDS,
			'' 					AS DELVTPCD,
			J.ST_RHDL AS stRhdl,
			J.END_RHDL AS endRhdl
	        FROM TMT_RHDL_CG R
	        		, (
	                SELECT      NVL (SUM (j1.pkg_qty), 0)    AS PKG_QTY
	                            , NVL (SUM (j1.wgt), 0)      AS WGT
	                            , NVL (SUM (j1.msrmt), 0)    AS MSRMT
	                            , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
	                            , J1.VSL_CALL_ID
	                            , J1.CG_NO
	                            , J1.RHDL_GROUP_NO
	                            , J1.RHDL_NO
	                        	, TO_CHAR(J1.WORK_ST_DT,'DD/MM/YYYY') AS ST_RHDL 
                        		, TO_CHAR(J1.WORK_END_DT,'DD/MM/YYYY') AS END_RHDL
	                FROM        TMT_JOB J1
	                WHERE       J1.RHDL_MODE = 'C'
	                            AND J1.JOB_PURP_CD IN ('AV')
	                            AND RHDL_NO IS NOT NULL
	                            <if test="stRhdl != null and stRhdl != ''">
                             AND
								 	 TO_DATE(J1.WORK_ST_DT,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
					                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
								</if>
								<if test="vslCallId != null and vslCallId != ''">
        AND
									   J1.VSL_CALL_ID = #{vslCallId}
								</if>
	                GROUP BY    J1.VSL_CALL_ID, J1.CG_NO, J1.RHDL_GROUP_NO, J1.RHDL_NO, J1.RHDL_MODE, J1.JOB_PURP_CD, J1.WORK_ST_DT, J1.WORK_END_DT
	            ) J	
	        WHERE    R.NX_VSL_CALL_ID IS NOT NULL
            		AND    R.RHDL_MODE = 'C'
            		AND R.NX_VSL_CALL_ID = J.VSL_CALL_ID(+)
            		AND R.NX_CG_NO = J.CG_NO(+)
            		AND R.RHDL_NO = J.RHDL_NO(+)
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
		 	 	 R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
		 		 R.NX_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			<if test="stRhdl != null and stRhdl != ''">
   AND
			 	 TO_DATE(J.ST_RHDL,'DD/MM/YYYY') BETWEEN TO_DATE(#{stRhdl},'DD/MM/YYYY') 
                	AND TO_DATE(#{endRhdl},'DD/MM/YYYY')
			</if>
		GROUP BY R.NX_VSL_CALL_ID, R.NX_REF_NO, R.NX_CG_NO, R.RHDL_GROUP_NO, R.RHDL_MODE,R.VSL_CALL_ID,R.ORG_REF_NO,J.ST_RHDL,J.END_RHDL
		ORDER BY VSLCALLID ASC,ORGREFNO ASC,ORGGRNO ASC , BALWGT DESC
	</sql>
	
	<sql id ="dynamic_rh_popup">	<!-- 6 -->
		SELECT R.VSL_CALL_ID          VSLCALLID,
			   R.CG_NO				AS CGNO,
               R.ORG_REF_NO           ORGREFNO,
               R.ORG_GR_NO            ORGGRNO,
               R.NX_VSL_CALL_ID       NXVSLCALLID,
               R.NX_REF_NO            NXREFNO,
               R.OPE_CLASS_CD         OPECLASSCD,
               (SELECT TCM.S_CD_NM 
                   FROM TMT_CD_MSTD TCM 
                   WHERE  TCM.L_CD = 'MT' 
                      AND TCM.M_CD = 'CATGTP' 
                   AND TCM.S_CD = R.OPE_CLASS_CD )                                    AS CATGNM,
               CASE 
               WHEN R.OPE_CLASS_CD = 'T'
               THEN NVL((SELECT BL.PKG_QTY
						   FROM TMT_VSL_SCH SCH, TMT_BL BL
						  WHERE SCH.VSL_CALL_ID = R.VSL_CALL_ID
							AND SCH.VSL_CD = BL.VSL_CD
							AND SCH.CALL_YEAR = BL.CALL_YEAR
							AND SCH.CALL_SEQ = BL.CALL_SEQ
							AND BL.BL_NO = R.ORG_REF_NO
							AND BL.MF_DOC_ID = 'K6'), 0)
               WHEN R.OPE_CLASS_CD = 'E'
               THEN NVL((SELECT G.PKG_QTY FROM TMT_JOB G
						  WHERE G.JOB_NO = R.JOB_NO AND G.VSL_CALL_ID =  #{vslCallId}),0)
               WHEN R.OPE_CLASS_CD = 'S'
               THEN NVL((SELECT G.PKG_QTY FROM TMT_JOB G
						  WHERE G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
							AND ROWNUM  = 1),0)
               WHEN R.OPE_CLASS_CD = 'I'
               THEN NVL((SELECT C.PKG_QTY FROM TMT_CG_MST C
						  WHERE C.VSL_CALL_ID = R.VSL_CALL_ID
							AND C.CG_NO = R.ORG_REF_NO
							AND C.VSL_CALL_ID =  #{vslCallId}
							AND R.OPE_CLASS_CD = 'I'), 0)
               ELSE 0 END AS PKGQTY,
               CASE 
               WHEN R.OPE_CLASS_CD = 'T'
               THEN NVL((SELECT BL.WGT
						   FROM TMT_VSL_SCH SCH, TMT_BL BL
						  WHERE SCH.VSL_CALL_ID = R.VSL_CALL_ID
						  	AND SCH.VSL_CALL_ID =  #{vslCallId}
							AND SCH.VSL_CD = BL.VSL_CD
							AND SCH.CALL_YEAR = BL.CALL_YEAR
							AND SCH.CALL_SEQ = BL.CALL_SEQ
							AND BL.BL_NO = R.ORG_REF_NO 
							AND BL.MF_DOC_ID = 'K6'), 0.0)
               WHEN R.OPE_CLASS_CD = 'E'
               THEN NVL((SELECT G.WGT FROM TMT_JOB G
						  WHERE G.JOB_NO = R.JOB_NO and G.VSL_CALL_ID =  #{vslCallId}), 0.0)
               WHEN R.OPE_CLASS_CD = 'S'
               THEN NVL((SELECT G.PKG_QTY FROM TMT_JOB G
						  WHERE G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
							AND ROWNUM = 1), 0)
               WHEN R.OPE_CLASS_CD = 'I'
               THEN NVL((SELECT C.WGT FROM TMT_CG_MST C
						  WHERE C.VSL_CALL_ID = R.VSL_CALL_ID
							AND C.CG_NO = R.ORG_REF_NO
							AND C.VSL_CALL_ID =  #{vslCallId}
							AND R.OPE_CLASS_CD = 'I'), 0.0)                                                                   
               ELSE 0 END AS WGT,
               CASE 
               WHEN R.OPE_CLASS_CD = 'T'
               THEN NVL((SELECT BL.VOL
						   FROM TMT_VSL_SCH SCH, TMT_BL BL
						  WHERE SCH.VSL_CALL_ID = R.VSL_CALL_ID
							AND SCH.VSL_CD = BL.VSL_CD
							AND SCH.CALL_YEAR = BL.CALL_YEAR
							AND SCH.CALL_SEQ = BL.CALL_SEQ
							AND BL.BL_NO = R.ORG_REF_NO 
							AND BL.MF_DOC_ID = 'K6'), 0.0)
               WHEN R.OPE_CLASS_CD = 'E'
               THEN NVL((SELECT G.MSRMT FROM TMT_JOB G
						  WHERE G.JOB_NO = R.JOB_NO AND G.VSL_CALL_ID =  #{vslCallId}), 0.0)
               WHEN R.OPE_CLASS_CD = 'S'
               THEN NVL((SELECT G.PKG_QTY FROM TMT_JOB G
						  WHERE G.RHDL_NO = R.RHDL_NO AND G.VSL_CALL_ID =  #{vslCallId}
							AND ROWNUM = 1), 0)
               WHEN R.OPE_CLASS_CD = 'I'
               THEN NVL((SELECT C.MSRMT FROM TMT_CG_MST C
						  WHERE C.VSL_CALL_ID = R.VSL_CALL_ID AND C.VSL_CALL_ID =  #{vslCallId}
							AND C.CG_NO = R.ORG_REF_NO
							AND R.OPE_CLASS_CD = 'I'), 0.0)
               ELSE 0
               END                                                      AS MSRMT,
               R.STS_YN               STSYN,
               R.RHDL_MODE            RHDLMODE,
			   (SELECT S_CD_NM FROM TMT_CD_MSTD 
				 WHERE L_CD = 'MT' AND M_CD ='RHDLMODE' AND S_CD = R.RHDL_MODE
				 GROUP BY S_CD_NM)    RHDLMODENM,
               NVL(TO_NUMBER(R.PKG_QTY),0)                         RHDLPKGQTY,
               NVL(TO_NUMBER(REPLACE(NVL(R.WGT,0),',','')),0)        RHDLWGT,
               NVL(TO_NUMBER(R.MSRMT),0)                           RHDLMSRMT,
               0   BALPKGQTY,
               0.0 BALWGT,
               0.0 BALMSRMT,
               R.RHDL_NO              RHDLNO,
               R.STAFF_CD USERID,
               R.CG_CO_CD AS CGCOCD,
               DECODE(R.CG_CO_CD,'S','SHUT-OUT','D','DAMAGE','G','NORMAL','NORMAL') AS CGCONM,
               'Y' AS RHDLCHK,
               DECODE(R.CG_CO_CD, 'S','Y','N') AS SHUYN,
               DECODE(R.CG_CO_CD, 'D','Y','N') AS DMGYN,    
               R.JOB_NO AS JOBNO,
               (SELECT J.RHDL_NO FROM TMT_JOB J WHERE J.RHDL_NO = R.RHDL_NO AND J.VSL_CALL_ID =  #{vslCallId} GROUP BY J.RHDL_NO) AS JOBRHDLNO
		FROM TMT_RHDL_CG R
		WHERE  R.VSL_CALL_ID = #{vslCallId}
		AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.VSL_CALL_ID =  #{vslCallId})
			<if test="orgRefNo != null and orgRefNo != ''">
   AND
			      R.ORG_REF_NO = #{orgRefNo}
			</if>
			<if test="nxRefNo != null and nxRefNo != ''">
   AND
				  R.NX_REF_NO = #{nxRefNo}
			</if>
			<if test="nxVslCallId != null and nxVslCallId != ''">
   AND
				  R.NX_VSL_CALL_ID = #{nxVslCallId}
			</if>
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				  R.OPE_CLASS_CD = #{opeClassCd}
			</if>
			<if test="rhdlMode != null and rhdlMode != ''">
   AND
				  R.RHDL_MODE = #{rhdlMode}
			</if>
			<if test="cgNo != null and cgNo != ''">
   AND
				  R.CG_NO = #{cgNo}
			</if>
<!--         ORDER BY VSLCALLID,ORGREFNO-->
	</sql>  
	<select id="selectCargoRhdlBlSnCombo"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
	   SELECT DISTINCT CASE 
			   WHEN R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL 
			   THEN R.NX_REF_NO 
			   WHEN R.RHDL_MODE = 'R' 
			   THEN R.ORG_REF_NO 
			   END AS BLSN 
		FROM TMT_RHDL_CG R
		WHERE (R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL) OR R.RHDL_MODE = 'R'
		AND EXISTS (SELECT R.VSL_CALL_ID FROM TMT_RHDL_CG S WHERE S.RHDL_NO = R.RHDL_NO AND S.RHDL_MODE = 'R' AND S.VSL_CALL_ID =  #{vslCallId})
		AND EXISTS (SELECT R.VSL_CALL_ID FROM TMT_RHDL_CG S WHERE S.RHDL_NO = R.RHDL_NO AND S.RHDL_MODE = 'C' AND S.NX_VSL_CALL_ID IS NOT NULL AND S.VSL_CALL_ID =  #{vslCallId})
	</select>
	
	<select id="selectCargoRhdlOpBlSnCombo"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
	   SELECT
	   		BLSN,
	   		MAX(GRNO) AS GRNO
	   FROM (
		   SELECT DISTINCT CASE 
	               WHEN R.RHDL_MODE = 'C' AND R.NX_VSL_CALL_ID IS NOT NULL 
	               THEN R.NX_REF_NO 
	               WHEN R.RHDL_MODE = 'R' 
	               THEN R.ORG_REF_NO 
	               END AS BLSN,
	               R.NX_CG_NO AS GRNO 
	        FROM TMT_RHDL_CG R
	        WHERE (R.RHDL_MODE = 'R' AND R.VSL_CALL_ID =  #{vslCallId})
	        OR (R.RHDL_MODE = 'C' AND  R.NX_VSL_CALL_ID =  #{vslCallId})
	   )
	   GROUP BY BLSN
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<select id="selectCargoRhdlOperation"  parameterType="CargoRehandlingParm" resultMap="CargoRehandlingItemMap">
	 	<if test="pageNo != 0"> 
             SELECT * FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getCargoRhdlOperation"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	 </select>
	 <select id="selectCargoRhdlOperationCount" parameterType="CargoRehandlingParm" resultType="java.lang.String">
	 	SELECT COUNT(*)
          FROM (<include refid="getCargoRhdlOperation"/>)
	 </select>
	<sql id="getCargoRhdlOperation">
		
        <if test="pageType != null and pageType != ''">
		<if test='pageType == "CRO"'>
		SELECT * FROM
		(
	    SELECT a.*, rownum r__
	    FROM
	    (
		</if>
		</if>
		
		<if test='rhdlMode == "R"'>
			<include refid="dynamic_rh_op_r"/>
		 </if>
		 <if test='rhdlMode == "C"'>
			<include refid="dynamic_rh_op_c"/>
		 </if>		 
		<if test="rhdlMode == null or rhdlMode == ''">
			<include refid="dynamic_rh_op"/>
		</if>  
			
        <if test="pageType != null and pageType != ''">
        <if test='pageType == "CRO"'>
        	<if test="currentPage != null and currentPage != ''">
       		<if test="numbPerPage != null and numbPerPage != ''">
       		) a
        		WHERE rownum <![CDATA[ < ]]> ((#{currentPage} * #{numbPerPage}) + 1 )
        		)
        		WHERE r__ <![CDATA[ >= ]]> (((#{currentPage}-1) * #{numbPerPage}) + 1)
       		</if>
       		</if>
        </if>  
        </if>
	</sql>
	
	<select id="selectNumbPage"  parameterType="CargoRehandlingParm" resultType="int">
		SELECT COUNT(*) FROM (
		<if test='rhdlMode == "R"'>
			SELECT 	   R.VSL_CALL_ID 													AS VSLCALLID
			FROM TMT_RHDL_CG R
				, (
                SELECT  NVL (SUM (j1.pkg_qty), 0)   AS PKG_QTY
                        , NVL (SUM (j1.wgt), 0)      AS WGT
                        , NVL (SUM (j1.msrmt), 0)    AS MSRMT
                        , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
                        , J1.VSL_CALL_ID            AS VSL_CALL_ID
                        , J1.CG_NO                  AS CG_NO
                        , J1.RHDL_NO                AS RHDL_NO
                        , J1.JOB_PURP_CD            AS JOB_PURP_CD
                FROM    TMT_JOB J1
                WHERE   J1.JOB_PURP_CD IN ('WG')
                GROUP BY J1.VSL_CALL_ID, J1.RHDL_NO, J1.CG_NO, J1.JOB_PURP_CD
                ) J
		WHERE   R.NX_VSL_CALL_ID IS NULL
			AND	R.RHDL_MODE = 'R'
			AND R.VSL_CALL_ID = J.VSL_CALL_ID(+)
     		AND R.RHDL_NO = J.RHDL_NO(+)
     		AND R.CG_NO = J.CG_NO(+)
		AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))	  	
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>	
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
				  R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
			 	 R.ORG_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
         ORDER BY R.VSL_CALL_ID ASC
		 </if>
		 <if test='rhdlMode == "C"'>
			SELECT R.VSL_CALL_ID                                                    AS VSLCALLID
	        FROM TMT_RHDL_CG R
	        		, (
	                SELECT      NVL (SUM (j1.pkg_qty), 0)    AS PKG_QTY
	                            , NVL (SUM (j1.wgt), 0)      AS WGT
	                            , NVL (SUM (j1.msrmt), 0)    AS MSRMT
	                            , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
	                            , J1.VSL_CALL_ID
	                            , J1.CG_NO
	                            , J1.RHDL_GROUP_NO
	                            , J1.RHDL_NO
	                        
	                FROM        TMT_JOB J1
	                WHERE       J1.RHDL_MODE = 'C'
	                            AND J1.JOB_PURP_CD IN ('AV')
	                            AND RHDL_NO IS NOT NULL
	                GROUP BY    J1.VSL_CALL_ID, J1.CG_NO, J1.RHDL_GROUP_NO, J1.RHDL_NO, J1.RHDL_MODE, J1.JOB_PURP_CD
	            ) J	
	        WHERE    R.NX_VSL_CALL_ID IS NOT NULL
            		AND    R.RHDL_MODE = 'C'
            		AND R.NX_VSL_CALL_ID = J.VSL_CALL_ID(+)
            		AND R.NX_CG_NO = J.CG_NO(+)
            		AND R.RHDL_NO = J.RHDL_NO(+)
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
		 	 	 R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
		 		 R.NX_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
			GROUP BY R.VSL_CALL_ID
			ORDER BY R.VSL_CALL_ID ASC
		 </if>		 
		<if test="rhdlMode == null or rhdlMode == ''">
			SELECT 	   R.VSL_CALL_ID 													AS VSLCALLID	
			FROM TMT_RHDL_CG R
				, (
                SELECT  NVL (SUM (j1.pkg_qty), 0)   AS PKG_QTY
                        , NVL (SUM (j1.wgt), 0)      AS WGT
                        , NVL (SUM (j1.msrmt), 0)    AS MSRMT
                        , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
                        , J1.VSL_CALL_ID            AS VSL_CALL_ID
                        , J1.CG_NO                  AS CG_NO
                        , J1.RHDL_NO                AS RHDL_NO
                        , J1.JOB_PURP_CD            AS JOB_PURP_CD
                FROM    TMT_JOB J1
                GROUP BY J1.VSL_CALL_ID, J1.RHDL_NO, J1.CG_NO, J1.JOB_PURP_CD
                ) J
			WHERE 
		    R.VSL_CALL_ID = J.VSL_CALL_ID(+)
	     	AND R.RHDL_NO = J.RHDL_NO(+)
	     	AND R.CG_NO = J.CG_NO(+)
			AND NOT EXISTS (SELECT * FROM TMT_JOB C WHERE R.JOB_NO IS NOT NULL AND C.JOB_NO = R.JOB_NO AND C.RHDL_MODE = 'R' AND C.JOB_PURP_CD IN ('AG'))
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
				  R.VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
			 	 R.ORG_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
		UNION
			SELECT R.VSL_CALL_ID                                                AS VSLCALLID
	        FROM TMT_RHDL_CG R
	        		, (
		                SELECT      NVL (SUM (j1.pkg_qty), 0)    AS PKG_QTY
		                            , NVL (SUM (j1.wgt), 0)      AS WGT
		                            , NVL (SUM (j1.msrmt), 0)    AS MSRMT
		                            , DECODE(MAX(DECODE(J1.FNL_OPE_YN, 'Y', 1, 0)), 1, 'Y', 'N') AS FNL_OPE_YN
		                            , J1.VSL_CALL_ID
		                            , J1.CG_NO
		                            , J1.RHDL_GROUP_NO	
		                        	, J1.RHDL_NO
		                        
		                FROM        TMT_JOB J1
		                WHERE       J1.RHDL_MODE = 'C'
		                            AND J1.JOB_PURP_CD IN ('AV')
		                            AND RHDL_NO IS NOT NULL
		                GROUP BY    J1.VSL_CALL_ID, J1.CG_NO, J1.RHDL_GROUP_NO, J1.RHDL_NO, J1.RHDL_MODE, J1.JOB_PURP_CD
		            ) J
	        WHERE    R.NX_VSL_CALL_ID IS NOT NULL
            AND    R.RHDL_MODE = 'C'
            		AND R.NX_VSL_CALL_ID = J.VSL_CALL_ID(+)
            		AND R.NX_CG_NO = J.CG_NO(+)
            		AND R.RHDL_NO = J.RHDL_NO(+)
			<if test="opeClassCd != null and opeClassCd != ''">
   AND
				<if test='opeClassCd == "R"'>
					EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID 
	                AND  S.CATG_CD = #{opeClassCd})
				</if>
				<if test='opeClassCd != "R"'>
					R.OPE_CLASS_CD = #{opeClassCd}
					AND NOT EXISTS (SELECT R.RHDL_NO FROM TMT_SHIPG_NOTE S
	                WHERE S.SHIPG_NOTE_NO = R.NX_REF_NO
	                AND   S.VSL_CALL_ID = R.NX_VSL_CALL_ID
	                AND	  S.CATG_CD = 'R')
				</if>				
			</if>
			<if test="vslCallId != null and vslCallId != ''">
   AND
		 	 	 R.NX_VSL_CALL_ID = #{vslCallId}
			</if>
			<if test="blSn != null and blSn != ''">
   AND
		 		 R.NX_REF_NO = #{blSn}
			</if>
			<if test="cgCoCd != null and cgCoCd != ''">
   AND
			 	 R.CG_CO_CD = #{cgCoCd}
			</if>
			<if test="spCaCoCd != null and spCaCoCd != ''">
   AND
			 	 R.SP_CA_CO_CD = #{spCaCoCd}
			</if>
			<if test="hhtFnlMode == 'HHT_RHLDFN'">
   AND
				 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_OPE_YN = 'Y' )
			</if>
			<if test="hhtFnlMode == 'HHT_RHHOFN'">
   AND
			 	 NOT EXISTS (SELECT R.RHDL_NO FROM TMT_JOB J
                    WHERE J.RHDL_NO = R.RHDL_NO
                    AND J.FNL_DELV_YN = 'Y')
			</if>
		</if>
			)
	</select>
	
	<select id="selectCargoRhdlOperationNonJPVC"  parameterType="CargoRehandlingParm" resultMap="CargoRehandlingItemMap">
		<if test='rhdlMode == "R"'>
			<include refid="dynamic_rh_op_r"/>
		 </if>
		 <if test='rhdlMode == "C"'>
			<include refid="dynamic_rh_op_c"/>
		 </if>		 
		<if test="rhdlMode == null or rhdlMode == ''">
			<include refid="dynamic_rh_op_nonJPVC"/>
		</if>
	</select>	
	<select id="selectCargoRehandlingPopupList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
			<include refid="dynamic_rh_popup"/>	  	
	</select>	
	
	
	<select id="selectRhShippingNoteComboList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
		 SELECT S.SHIPG_NOTE_NO    AS SHIPGNOTENO
	       FROM TMT_SHIPG_NOTE S
		   WHERE  <!--NOT EXISTS (SELECT S.SHIPG_NOTE_NO FROM TMT_RHDL_CG R WHERE R.NX_VSL_CALL_ID = S.VSL_CALL_ID AND R.NX_REF_NO = S.SHIPG_NOTE_NO) -->
		       S.STAT_CD IN ('FS', 'AP')
			<if test="vslCallId != null and vslCallId != ''">
   AND
				S.VSL_CALL_ID = #{vslCallId} 
			</if>
			<if test="vslCallId == null or vslCallId == ''">
   AND
				S.VSL_CALL_ID &lt;&gt; 'NonCallId'
			</if>
			<if test="arrvDtFm != null and arrvDtFm != ''">
				AND S.EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
                                      AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
			</if>
			<if test='opeClassCd == "T"'>
   AND
				S.CATG_CD  = 'T'
			</if>
			<if test='opeClassCd != "T"'>
   AND
				S.CATG_CD  = 'R'
			</if>		 	  
		  GROUP BY S.SHIPG_NOTE_NO
		  ORDER BY S.SHIPG_NOTE_NO
	</select>
	
	 <select id="selectRhGrNoComboList"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
		 SELECT GR_NO    AS NXCGNO
	       FROM TMT_GR
		 WHERE VSL_CALL_ID = #{vslCallId} 
		 AND SHIPG_NOTE_NO  = #{shipgNoteNo}
		 AND ROWNUM = 1
			<if test="arrvDtFm != null and arrvDtFm != ''">
				AND EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
                                      AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
			</if>
		  GROUP BY GR_NO
		  ORDER BY GR_NO
	</select>
	
	<select id="selectIsRhdlGroups"  parameterType="CargoRehandlingParm" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM TMT_RHDL_CG<!-- if NOT-NULL is  '1'-->
		WHERE NX_VSL_CALL_ID = #{nxVslCallId} AND NX_REF_NO = #{nxRefNo}
	</select>
	
	<select id="selectCargoRhdlGroupNo" parameterType="CargoRehandlingParm" resultType="java.lang.String">
	 	SELECT NVL(MAX(TO_NUMBER(S.RHDL_GROUP_NO)),0)+1 AS RHDLGROUPNO FROM TMT_RHDL_CG S
	 	WHERE S.VSL_CALL_ID = #{vslCallId} AND S.ORG_REF_NO = #{orgRefNo}
	 </select>	
	 
	 <select id="selectCargoRhdlStorageSnCombo"  parameterType="CargoRehandlingParm" resultType="CargoRehandlingItem">
	  SELECT G.SHIPG_NOTE_NO AS ORGBLSN
           FROM TMT_SHIPG_NOTE S, TMT_GR G,TMT_CG_MST C
           WHERE C.CG_NO = G.GR_NO
             AND C.VSL_CALL_ID = G.VSL_CALL_ID
             AND S.VSL_CALL_ID = G.VSL_CALL_ID
             AND S.SHIPG_NOTE_NO = G.SHIPG_NOTE_NO        
             AND S.CATG_CD IN ('S')
             AND NVL(C.WH_FNL_DELV_YN,'N') &lt;&gt;'Y'  
           	<if test="arrvDtFm != null and arrvDtFm != ''">
			 AND S.EST_ARRV_DT BETWEEN TO_DATE (#{arrvDtFm}||' 00:00','DD/MM/YYYY HH24:MI') 
                                      AND TO_DATE (#{arrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
			</if>              
           GROUP BY G.SHIPG_NOTE_NO
           ORDER BY G.SHIPG_NOTE_NO		
	</select>
	
	<update id="updateJobItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_JOB A
		   SET 			
						A.PKG_QTY = #{rhdlPkgQty},
						A.CG_WGT = #{rhdlWgt},
						A.CG_VOL = #{rhdlMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.VSL_CALL_ID = #{nxVslCallId} AND A.CG_NO = #{nxCgNo} AND A.JOB_NO = #{jobNo}
	</update>
	
	<update id="updateCgMstItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_CG_MST A
		   SET 			
						A.PKG_QTY = #{sumChgVslUpdateQty},
						A.CG_WGT = #{sumChgVslUpdateWgt},
						A.CG_VOL = #{sumChgVslUpdateMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.VSL_CALL_ID = #{nxVslCallId} AND A.SHIPG_NOTE_NO = #{nxRefNo} AND A.CG_NO = #{nxCgNo}
	</update>
	
	<update id="updateInvItemsForUpdateOrgVsl"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_INV_LOC A
		   SET 			
						A.PKG_QTY = -(#{rhdlPkgQty}),
						A.CG_WGT = -(#{rhdlWgt}),
						A.CG_VOL = -(#{rhdlMsrmt}),
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}
		 WHERE	A.VSL_CALL_ID = #{vslCallId} AND A.JOB_NO = #{jobNo}
	</update>
	
	<update id="updateInvItemsForUpdateNxVsl"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_INV_LOC A
		   SET 			
						A.PKG_QTY = #{rhdlPkgQty},
						A.CG_WGT = #{rhdlWgt},
						A.CG_VOL = #{rhdlMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}
		 WHERE	A.VSL_CALL_ID = #{nxVslCallId} AND A.JOB_NO = #{jobNo}
	</update>
	
	<update id="updateShpgNoteAmtItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_SHIPG_NOTE_AMT A
		   SET 			
						A.PKG_QTY = #{sumChgVslUpdateQty},
						A.CG_WGT = #{sumChgVslUpdateWgt},
						A.CG_VOL = #{sumChgVslUpdateMsrmt},
						A.I_QTY = #{sumChgVslUpdateQty},
						A.I_MT = #{sumChgVslUpdateWgt},
						A.I_M3 = #{sumChgVslUpdateMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE	
		 WHERE	A.VSL_CALL_ID = #{nxVslCallId} AND A.SHIPG_NOTE_NO = #{nxRefNo}
	</update>
	
	<update id="updateShpgNoteItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_SHIPG_NOTE A
		   SET 			
						A.PKG_QTY = #{sumChgVslUpdateQty},
						A.CG_WGT = #{sumChgVslUpdateWgt},
						A.CG_VOL = #{sumChgVslUpdateMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.VSL_CALL_ID = #{nxVslCallId} AND A.SHIPG_NOTE_NO = #{nxRefNo}
	</update>
	
	<update id="updateGrForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_GR GR
		   SET 			
						GR.PKG_QTY = #{sumChgVslUpdateQty},
						GR.CG_WGT = #{sumChgVslUpdateWgt},
						GR.CG_VOL = #{sumChgVslUpdateMsrmt},
						GR.STAFF_CD = #{userId},
						GR.UPDATE_TIME = SYSDATE,
						GR.VERSION = #{newVersion}	
		 WHERE	GR.VSL_CALL_ID = #{nxVslCallId} AND GR.SHIPG_NOTE_NO = #{nxRefNo} AND GR.GR_NO = #{nxCgNo}
	</update>
	
	<update id="updateCargoRehandlingRTSItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_RHDL_CG A
		   SET 			
						A.PKG_QTY = #{rhdlPkgQty},
						A.CG_WGT = #{rhdlWgt},
						A.CG_VOL = #{rhdlMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.RHDL_NO = #{rhdlNo}
	</update>
	
	<update id="updateCargoRehandlingChgVslItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_RHDL_CG A
		   SET 			
						A.PKG_QTY = #{sumChgVslUpdateQty},
						A.CG_WGT = #{sumChgVslUpdateWgt},
						A.CG_VOL = #{sumChgVslUpdateMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.RHDL_NO = #{rhdlNo} 
	</update>
	
	<update id="updateCargoRehandlingDetailItemsForUpdate"  parameterType="CargoRehandlingItem">
		UPDATE	TMT_RHDL_CG_DTL A
		   SET	
						A.PKG_QTY = #{rhdlPkgQty},
						A.CG_WGT = #{rhdlWgt},
						A.CG_VOL = #{rhdlMsrmt},
						A.STAFF_CD = #{userId},
						A.UPDATE_TIME = SYSDATE,
						A.VERSION = #{newVersion}	
		 WHERE	A.RHDL_NO = #{rhdlNo} AND A.SEQ = #{seq}
	</update>
</mapper>
