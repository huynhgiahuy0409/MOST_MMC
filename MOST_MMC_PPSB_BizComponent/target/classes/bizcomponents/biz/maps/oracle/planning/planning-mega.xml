<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mega">
    <resultMap type="megaItem" id="EquipmentMap">
    	<result property="megaNo"               column="MEGANO"/>
		<result property="seq"                  column="SEQ"/>
		<result property="divCd"                column="DIVCD"/>
		<result property="eqDivCd"              column="EQDIVCD"/>
		<result property="eqDivCdNm"            column="EQDIVCDNM"/>
		<result property="capaCd"               column="CAPACD"/>
		<result property="capaDescr"            column="CAPADESCR"/>
		<result property="locId"                column="LOCID"/>
		<result property="reqTime"              column="REQTIME"/>
		<result property="reqMin"               column="REQMIN"/>
		<result property="dspReqhhmm"           column="DSPREQHHMM"/>
		<result property="reqQty"               column="REQQTY"/>
		<result property="flStatus"             column="flStatus"/>
		<result property="refNo"               	column="REFNO"/>
		<result property="confmQty"             column="CONFMQTY"/>
		<result property="whQty"                column="WHQTY"/>
		<result property="colColor"             column="COLCOLOR"/>
		<result property="workStDt"             column="WORKSTDT"/>
		<result property="workEndDt"             column="WORKENDDT"/>
		<collection property="operInfoItems" 
				javaType="ArrayList" select="mega.selectOperInfo" 
				column="megaNo=MEGANO, eqDivCd=EQDIVCD, capaCd=CAPACD, megaIdx=SEQ, copyType=COPYTYPE"/>
    </resultMap>
    <resultMap type="megaItem" id="EquipmentMapForReport">
    	<result property="megaNo"               column="MEGANO"/>
		<result property="seq"                  column="SEQ"/>
		<result property="reqQty"               column="reqQty"/>
		<result property="confmQty"             column="confmQty"/>
		<result property="divCd"                column="DIVCD"/>
		<result property="eqDivCd"              column="EQDIVCD"/>
		<result property="eqDivCdNm"            column="EQDIVCDNM"/>
		<result property="capaCd"               column="CAPACD"/>
		<result property="capaDescr"            column="CAPADESCR"/>
		<result property="locId"                column="LOCID"/>
		<result property="reqTime"              column="REQTIME"/>
		<result property="reqMin"               column="REQMIN"/>
		<result property="dspReqhhmm"           column="DSPREQHHMM"/>
		<result property="reqQty"               column="REQQTY"/>
		<result property="confmQty"             column="CONFMQTY"/>
		<result property="whQty"                column="WHQTY"/>
		<result property="colColor"             column="COLCOLOR"/>
		<result property="CRUD"                 column="CRUD"/>
		<result property="shftId"               column="shftid"/>
		<result property="submitBy"             column="submitBy"/>
		<result property="shftNm"               column="SHFTNM"/>
		<result property="shftIdx"              column="SHFTIDX"/>
		<result property="purpTpCd"             column="PURPTPCD"/>
		<result property="rmk"                  column="rmk"/>
		<result property="rejRmk"               column="rejRmk"/>
		<result property="apprvBy"              column="apprvBy"/>
		<result property="statCd"               column="statCd"/>
		<result property="statCdNm"             column="statCdNm"/>
		<result property="purpTpCdNm"           column="PURPTPCDNM"/>
		<result property="workYmd"              column="WORKYMD"/>
		<result property="purpType"             column="PURPTYPE"/>
		<result property="berthLoc"				column="BERTHLOC"/>
    </resultMap>
    
    <resultMap type="megaItem" id="EquipmentMapForReport2">
    	<result property="megaNo"               column="MEGANO"/>
		<result property="seq"                  column="SEQ"/>
		<result property="reqQty"               column="reqQty"/>
		<result property="confmQty"             column="confmQty"/>
		<result property="divCd"                column="DIVCD"/>
		<result property="eqDivCd"              column="EQDIVCD"/>
		<result property="eqDivCdNm"            column="EQDIVCDNM"/>
		<result property="capaCd"               column="CAPACD"/>
		<result property="capaDescr"            column="CAPADESCR"/>
		<result property="locId"                column="LOCID"/>
		<result property="reqTime"              column="REQTIME"/>
		<result property="reqMin"               column="REQMIN"/>
		<result property="dspReqhhmm"           column="DSPREQHHMM"/>
		<result property="reqQty"               column="REQQTY"/>
		<result property="confmQty"             column="CONFMQTY"/>
		<result property="whQty"                column="WHQTY"/>
		<result property="colColor"             column="COLCOLOR"/>
		<result property="CRUD"                 column="CRUD"/>
		<result property="shftId"               column="shftid"/>
		<result property="submitBy"             column="submitBy"/>
		<result property="shftNm"               column="SHFTNM"/>
		<result property="shftIdx"              column="SHFTIDX"/>
		<result property="purpTpCd"             column="PURPTPCD"/>
		<result property="rmk"                 	column="rmk"/>
		<result property="rejRmk"               column="rejRmk"/>
		<result property="apprvBy"              column="apprvBy"/>
		<result property="statCd"               column="statCd"/>
		<result property="statCdNm"             column="statCdNm"/>
		<result property="purpTpCdNm"           column="PURPTPCDNM"/>
		<result property="workYmd"              column="WORKYMD"/>
		<result property="purpType"             column="PURPTYPE"/>
		<result property="berthLoc"				column="BERTHLOC"/>
    </resultMap>

    <resultMap type="megaItem" id="OperInfoMap">
		<result property="megaNo"               column="MEGANO"/>
		<result property="megaIdx"              column="MEGAIDX"/>
		<result property="seq"                  column="SEQ"/>
		<result property="eqDivCd"              column="EQDIVCD"/>
		<result property="capaCd"               column="CAPACD"/>
		<result property="opeDivCd"             column="OPEDIVCD"/>
		<result property="opeCompCd"            column="OPECOMPCD"/>
		<result property="opeCompNm"            column="OPECOMPNM"/>
		<result property="nofOpe"               column="NOFOPE"/>
		<result property="CRUD"                 column="CRUD"/>
    </resultMap>
    
    <resultMap type="megaItem" id="ConfirmationSlipDetailMap">
    	<result property="vslCallId"         	column="VSLCALLID"/>
		<result property="seq"               	column="SEQ"/>
		<result property="cgTpCd"				column="CGTPCD"/>
		<result property="opeTpCd"      	    column="OPETPCD"/>
		<result property="cgTpNm"            	column="CGTPNM"/>
		<result property="cmdtCd"            	column="CMDTCD"/>
		<result property="cmdtCdNm"          	column="CMDTCDNM"/>
		<result property="cmdtGrCd"          	column="CMDTGRCD"/>
		<result property="cmdtGr"          	 	column="CMDTGR"/>
		<result property="opeHr"             	column="OPEHR"/>
		<result property="workDd"            	column="WORKDD"/>
		<result property="workHatchNo"       	column="WORKHATCHNO"/>
		<result property="wgt"               	column="WGT"/>
		<result property="msrmt"             	column="MSRMT"/>
		<result property="qty"               	column="QTY"/>
		<result property="pkgTpCd"           	column="PKGTPCD"/>
		<result property="clnCd"             	column="CLNCD"/>
		<result property="topCgCd"           	column="TOPCGCD"/>
		<result property="topCln"            	column="TOPCLN"/>
		<result property="tmnlOpr"           	column="TMNLOPR"/>
		<result property="shprCnsne"         	column="SHPRCNSNE"/>
		<result property="cnsne"				column="CNSNE"/>
		<result property="unno"              	column="UNNO"/>
		<result property="imdg"              	column="IMDG"/>
		<result property="pol"             		column="POL"/>
		<result property="fdest"             	column="FDEST"/>
		<result property="crc"               	column="CRC"/>
		<result property="tkNo"              	column="TKNO"/>
		<result property="blNo"              	column="BLNO"/>
		<result property="cgOptTpCd"         	column="CGOPTTPCD"/>
		<result property="cgOptTpNm"         	column="CGOPTTPNM"/>
		<result property="dgSeq"         	 	column="DGSEQ"/>
		<result property="dgChk"         	 	column="DGCHK"/>
		<result property="opeType"         	 	column="opeType"/>
		<result property="cnsneNm"         	 	column="cnsneNm"/>
		<result property="cnsneAddr"         	column="cnsneAddr"/>
		<result property="shpNm"         	 	column="shpNm"/>
		<result property="shpAddr"         	 	column="shpAddr"/>
		<result property="pkgTpNm"         	 	column="pkgTpNm"/>
		<association property="dgItems" 
				select="ConfirmationSlipMap.selectCFDGDeclaration" 
				column="{seq=DGSEQ}"/>
    </resultMap>
    
    <sql id="selectMegaSql">
		SELECT 
			A.MEGA_NO              MEGANO,
			A.STAT_CD              STATCD,
			CASE
				WHEN A.STAT_CD = 'SU' THEN 'Submitted'
				WHEN A.STAT_CD = 'AP' THEN 'Approved'
				WHEN A.STAT_CD = 'RC' THEN 'Cancellation Request'
				WHEN A.STAT_CD = 'RJ' THEN 'Rejected'
				WHEN A.STAT_CD = 'CR' THEN 'Created'
				WHEN A.STAT_CD = 'CF' THEN 'Confirmed'
           		WHEN A.STAT_CD = 'CA' THEN 'Canceled'
       			ELSE null
   			END AS STATCDNM,
			CASE
				WHEN (
					SELECT MAX(SR.REF_NO)
					FROM TMT_VSL_SVC_RPT SR
					WHERE SR.REF_NO = A.MEGA_NO
					AND SR.VSL_CALL_ID = A.VSL_CALL_ID
				) IS NOT NULL
					THEN 'Y'
	            ELSE 'N'
	        END AS deployed,
			A.VSL_CALL_ID          VSLCALLID,
			(SELECT VSL_NM FROM TMT_VSL_PART WHERE VSL_CD = C.VSL_CD) VSLNM,
			A.SUMIT_BY             REQR,
			NVL(
				(SELECT A.ENG_SNM
				FROM TMT_PTNR A , TMT_PTNR_USER B
				WHERE B.USER_ID = A.SUMIT_BY
				AND A.PTNR_CODE = B.PTNR_CODE
				AND ROWNUM = 1
			), A.SUMIT_BY) REQRNM,
			A.SUMIT_DT AS REQDT,
			C.ARRV_SA_ID           SAID,
			A.WORK_YMD             SVCDATE,
			TO_DATE(A.WORK_YMD , 'YYYYMMDD') WORKYMD,
			A.SHFT_ID              SHFTID,
			(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = A.SHFT_ID) SHFTNM,
			(SELECT SHFT_IDX FROM TMT_SHFT WHERE SHFT_ID = A.SHFT_ID) SHFTIDX,
			A.PURP_TP_CD           PURPTPCD,
			F_CM_012('MT', 'MGPURP', A.PURP_TP_CD) PURPTPCDNM,
			(SELECT S_CD_LGV FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='MGPURP' AND S_CD=A.PURP_TP_CD) PURPTYPE,
			(
				SELECT 'Y' FROM TMT_DEPY 
				WHERE USE_YN = 'Y' 
				AND (
					CASE 
						WHEN A.VSL_CALL_ID = 'STRG' THEN SUBSTR (VSL_CALL_ID, 3, 9) 
						ELSE VSL_CALL_ID 
					END
				) = A.VSL_CALL_ID
				AND WORK_YMD = A.WORK_YMD
				AND PURP_TP_CD = A.PURP_TP_CD
				AND SHFT_ID = A.SHFT_ID 
				AND A.STAT_CD = 'AP' AND ROWNUM = 1
			) DEPYYN,
			(SELECT S_CD_NM FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='CGTP' AND S_CD=B.CG_TP_CD) CGTPNM, 
			B.CG_TP_CD             CGTPCD,
			B.CG_TON               CGTON,
			(
				SELECT 'Y' FROM TMT_MEGA_DTL 
				WHERE MEGA_NO = A.MEGA_NO
				AND DIV_CD = 'EQ'
				AND EQ_DIV_CD IN ('CH','CY', 'EH', 'EX', 'FN', 'GR', 'PIP', 'RP', 'RS', 'WB', 'YT') 
				AND ROWNUM = 1
			) GEARSYN,
			(
				SELECT 'Y' FROM TMT_MEGA_DTL 
				WHERE MEGA_NO = A.MEGA_NO
				AND DIV_CD = 'EQ'
				AND EQ_DIV_CD IN ('FL') 
				AND ROWNUM = 1
			) FORKLIFTYN,
			(
				SELECT 'Y' FROM TMT_MEGA_DTL 
				WHERE MEGA_NO = A.MEGA_NO
				AND DIV_CD = 'EQ'
				AND EQ_DIV_CD = 'TR' 
				AND ROWNUM = 1
			) TRAILERYN,
			(
				SELECT 'Y' FROM TMT_MEGA_DTL B
				WHERE B.MEGA_NO = A.MEGA_NO
				AND B.DIV_CD = 'EQ'
				AND EQ_DIV_CD NOT IN ('CH','CY', 'EH', 'EX', 'FN', 'GR', 'PIP', 'RP', 'RS', 'WB', 'YT', 'FL', 'TR','TC','QC', 'SC', 'HG', 'RT', 'SR') 
				AND ROWNUM = 1
			) MECHANICALYN, 
			(
				SELECT 'Y' FROM TMT_MEGA_DTL B
				WHERE B.MEGA_NO = A.MEGA_NO
				AND B.DIV_CD = 'EQ'
				AND (
					B.EQ_DIV_CD = 'SR' 
					OR EXISTS (
						SELECT S_CD FROM TMT_CD_MSTD
						WHERE L_CD = 'MT' 
						AND M_CD = 'EQFCTPCD'
						AND S_CD = B.EQ_DIV_CD
						AND S_CD_VAL = 'PC' 
					)
				)
				AND ROWNUM = 1
			) PORTCRNYN, 
			(SELECT 'Y' FROM TMT_MEGA_DTL WHERE MEGA_NO = A.MEGA_NO AND DIV_CD = 'CD' AND ROWNUM = 1) CGDTLYN,
			(SELECT STVD_COMP FROM TMT_MEGA_DTL  WHERE MEGA_NO = B.MEGA_NO AND DIV_CD = 'SD' AND STVD_COMP IS NOT NULL AND ROWNUM =1) STVDCOMP,
			(
				SELECT F.ENG_SNM 
				FROM TMT_MEGA_DTL E, TMT_PTNR F 
				WHERE E.MEGA_NO = B.MEGA_NO
				AND E.DIV_CD = 'SD'
				AND E.STVD_COMP = F.PTNR_CODE
				AND F.PTNR_TYPE = 'STV'
				AND ROWNUM =1
			) STVDCOMPNM,
			(SELECT TRMG_COMP FROM TMT_MEGA_DTL WHERE MEGA_NO = B.MEGA_NO AND DIV_CD = 'SD' AND TRMG_COMP IS NOT NULL AND ROWNUM =1) TRMGCOMP,
			(
				SELECT F.ENG_SNM 
				FROM TMT_MEGA_DTL E, TMT_PTNR F 
				WHERE E.MEGA_NO = B.MEGA_NO
				AND E.DIV_CD = 'SD'
				AND E.TRMG_COMP = F.PTNR_CODE
				AND F.PTNR_TYPE = 'TRM'
				AND ROWNUM =1
			) TRMGCOMPNM,
			NVL(
				(
					SELECT (USER_ID || '/' || ENG_NM) 
					FROM TMT_USER_INFO 
					WHERE USER_ID = A.APPRV_BY
				), NVL(A.APPRV_BY, ' ')
			) APPR,
			A.APPRV_DT AS APPDT,
			NVL(
				(
					SELECT (USER_ID || '/' || ENG_NM) 
					FROM TMT_USER_INFO
					WHERE USER_ID = A.REJ_BY
				), NVL(A.REJ_BY, ' ')
			) REJBY,
			NVL2(A.REJ_BY, 'Y', 'N') REJYN,
			A.REJ_DT AS REJDT,
			NVL(
				(
					SELECT (USER_ID || '/' || ENG_NM) 
			        FROM TMT_USER_INFO
					WHERE USER_ID = A.CNCL_BY
				), A.CNCL_BY
			) CNCLBY,
			A.CNCL_DT AS CNCLDT,
			C.ETW AS ETW,	
			NVL(A.WH_APPRV_YN, 'N') WHAPPRYN,
			NVL(A.MEGA_WH_YN, 'N') MEGAWHYN,
			A.MEGA_TP_CD           MEGATPCD,
			F_CM_012('MT', 'MGTPCD', A.MEGA_TP_CD) MEGATPCDNM,
			B.CMDT                 CMDT,
			DECODE(A.SUMIT_BY, #{userId}, 'Y', 'N')        USERMEGAYN,
			NVL(A.PENALTY, 'N') as penaltyCd,	   
			A.RMK AS                             rmk,
			A.REJ_RMK                            rejRmk,
			A.CRT_BY								crtBy,		   
			A.VERSION              VERSION,
			NVL (
				(
					SELECT D.NX_BERTH_NO
					FROM TMT_VSL_SHFT D
					WHERE C.VSL_CALL_ID = D.VSL_CALL_ID
					AND D.SEQ = (SELECT MAX(E.SEQ) FROM TMT_VSL_SHFT E WHERE D.VSL_CALL_ID = E.VSL_CALL_ID)
				), C.BERTH_LOC
			) AS BERTHLOC
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_VSL_SCH C
		WHERE A.MEGA_NO = B.MEGA_NO
		AND B.DIV_CD = 'VO'
		AND A.VSL_CALL_ID = C.VSL_CALL_ID(+)
		<if test="vslCallId == null or vslCallId == ''">
			AND A.VSL_CALL_ID &lt;&gt; 'STRG'
		</if>
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test="megaNo != null and megaNo != ''">
			AND A.MEGA_NO LIKE  '%' || #{megaNo} || '%' 
		</if>
		<if test='vslCallId == "STRG"'>
			<if test="etaFrom != null and etaFrom != ''">
				AND	TO_DATE(A.WORK_YMD,'YYYYMMDD') BETWEEN TO_DATE(#{etaFrom},'DD/MM/YYYY') AND TO_DATE(#{etaTo},'DD/MM/YYYY')
			</if>
		</if>
		<if test='vslCallId != "STRG"'>
			<if test="etaFrom != null and etaFrom != ''">
				AND TO_DATE(C.ETA) BETWEEN TO_DATE(#{etaFrom},'DD/MM/YYYY') AND TO_DATE(#{etaTo},'DD/MM/YYYY')
			</if>
			<if test="etw != null and etw != ''">
				AND TO_DATE(A.WORK_YMD,'YYYYMMDD') = TO_DATE(#{etw},'DD/MM/YYYY')
			</if>
			<if test="saId != null and saId != ''">
				AND C.ARRV_SA_ID = #{saId}
			</if>
		</if>
		<if test="cmdt != null and cmdt != ''">
			AND B.CMDT = #{cmdt}
		</if>
		<if test="purpTpCd != null and purpTpCd != ''">
			AND A.PURP_TP_CD = #{purpTpCd}
		</if>
		<if test="shftId != null and shftId != ''">
			AND A.SHFT_ID = #{shftId}
		</if>
		<if test="statCd != null and statCd != ''">
			AND A.STAT_CD = #{statCd}
		</if>
		<if test='depyYn == "Y"'>
			AND EXISTS (
				SELECT 'Y' 
				FROM TMT_DEPY 
				WHERE USE_YN = 'Y' 
				AND (
					CASE 
						WHEN A.VSL_CALL_ID = 'STRG' THEN SUBSTR (VSL_CALL_ID, 3, 9) 
						ELSE VSL_CALL_ID 
					END
				) = A.VSL_CALL_ID 
				AND WORK_YMD = A.WORK_YMD
				AND PURP_TP_CD = A.PURP_TP_CD 
				AND SHFT_ID = A.SHFT_ID AND ROWNUM = 1
			)
		</if>
		<if test='depyYn == "N"'>
			AND NOT EXISTS (
				SELECT 'Y' FROM TMT_DEPY 
				WHERE USE_YN = 'Y'
				AND (
					CASE 
						WHEN A.VSL_CALL_ID = 'STRG' THEN SUBSTR (VSL_CALL_ID, 3, 9) 
						ELSE VSL_CALL_ID 
					END
				) = A.VSL_CALL_ID 
		       AND WORK_YMD = A.WORK_YMD
		       AND PURP_TP_CD = A.PURP_TP_CD 
		       AND SHFT_ID = A.SHFT_ID 
		       AND ROWNUM = 1
			)
		</if>
		<if  test="alertYn eq 'Y'.toString()">
			<if  test="alertTp eq 'M'.toString()">
				AND STAT_CD in  ('SU','CF')
				<if test='vslCallId != "STRG"'>
					AND c.SUMMIT_STAT NOT IN ('CC','RC')
				</if>
			</if>
			<if test="alertTp eq 'S'.toString()">
				AND NOT EXISTS (
					SELECT 'Y' FROM TMT_DEPY 
					WHERE USE_YN = 'Y'
					AND (
						CASE 
							WHEN A.VSL_CALL_ID = 'STRG' THEN SUBSTR (VSL_CALL_ID, 3, 9) 
							ELSE VSL_CALL_ID 
						END
					) = A.VSL_CALL_ID 
					AND WORK_YMD = A.WORK_YMD
					AND PURP_TP_CD = A.PURP_TP_CD 
					AND SHFT_ID = A.SHFT_ID 
					AND ROWNUM = 1
				)
				AND STAT_CD = 'AP'
			</if>
			AND (SYSDATE - TO_DATE(A.WORK_YMD , 'YYYYMMDD')) &lt;= 180 
		</if>
    </sql>
    
    <select id="selectMegaList" parameterType="megaParm" resultType="megaItem">
	 	<if test="pageNo != 0"> 
             SELECT /*mega.selectMegaList*/
             	* FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getMega"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	</select>
	 
	<select id="selectMegaListCount" parameterType="megaParm" resultType="java.lang.String">
	 	SELECT COUNT(*)
			FROM (<include refid="getMega"/>)
	</select>
	
	<sql id="getMega">
		<include refid="selectMegaSql" />
		AND (A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD &lt;&gt; 'H')
		AND A.REQR = (SELECT DISTINCT D.PTNR_CODE FROM TMT_PTNR_USER D WHERE D.USER_ID = #{userId})
		<if test='userRole == "CS"'>
			UNION ALL
			<include refid="selectMegaSql" />
		    AND (
		    	A.SUMIT_BY &lt;&gt; #{userId}
				AND NOT EXISTS (
					SELECT '1' 
					FROM TMT_PTNR_USER A, TMT_PTNR_USER B 
					WHERE A.USER_ID = A.SUMIT_BY
					AND A.PTNR_CODE = B.PTNR_CODE
					AND B.USER_ID = #{userId}
				)
			)
			AND A.STAT_CD &lt;&gt; 'CR'
			AND (A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD &lt;&gt; 'H')
			AND (
		    	A.PURP_TP_CD IN (
					SELECT S_CD
					FROM TMT_CD_MSTD 
					WHERE L_CD='MT'
					AND M_CD='MGPURP'
					AND S_CD_LGV IN ('NP', 'VP')
				)
				OR A.MEGA_WH_YN = 'Y'
			)
		</if>
		<if test='userRole == "WS"'>
			UNION ALL
			<include refid="selectMegaSql" />
		    AND (
		    	A.SUMIT_BY &lt;&gt; #{userId}
				AND NOT EXISTS (
					SELECT '1' 
					FROM TMT_PTNR_USER A, TMT_PTNR_USER B 
					WHERE A.USER_ID = A.SUMIT_BY
					AND A.PTNR_CODE = B.PTNR_CODE
					AND B.USER_ID = #{userId}
				)
			)
			AND A.STAT_CD &lt;&gt; 'CR'
			AND (A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD &lt;&gt; 'H')
			AND A.PURP_TP_CD IN (
				SELECT S_CD
				FROM TMT_CD_MSTD 
				WHERE L_CD='MT'
				AND M_CD='MGPURP'
				AND S_CD_LGV = 'MP'
			)
		</if>
		<if test='userRole == "BS"'>
			UNION ALL
			<include refid="selectMegaSql" />
			AND (A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD &lt;&gt; 'H')
		</if>
		<if test="userRole == null">
			<if test="ptnrCd == null">
				<if test="ptnrType == null or ptnrType == ''">
					UNION ALL
					<include refid="selectMegaSql" />
			    	AND (
			    		A.SUMIT_BY &lt;&gt; #{userId}
						AND NOT EXISTS (
							SELECT '1' 
							FROM TMT_PTNR_USER A, TMT_PTNR_USER B 
							WHERE A.USER_ID = A.SUMIT_BY
							AND A.PTNR_CODE = B.PTNR_CODE
							AND B.USER_ID = #{userId}
						)
					)
					AND (A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD &lt;&gt; 'H')
				</if>
			</if>
		</if>
		ORDER BY SVCDATE DESC, SHFTIDX DESC, MEGANO DESC, PURPTPCD
	</sql>
	
	<select id="selectMegaDetail" parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectMegaDetail*/
			A.MEGA_NO              MEGANO,		       
			A.PURP_TP_CD           PURPTPCD,
			A.REF_NO               REFNO,
			B.DIV_CD               DIVCD,
			F_CM_012('MT', 'MGPURP', A.PURP_TP_CD) PURPTPCDNM,
			TO_DATE(A.WORK_YMD , 'YYYYMMDD') WORKYMD,
			A.STAT_CD              STATCD,
			F_CM_012('MT', 'MEGASTAT', A.STAT_CD) STATCDNM,
			A.VSL_CALL_ID          VSLCALLID,
			A.SHFT_ID              SHFTID,
			NVL(A.MEGA_WH_YN, 'N') MEGAWHYN,
			B.CMDT                 CMDT,
			NVL((SELECT  DISTINCT D.CMDT_GRP_CD
					FROM TMT_CMDT D
					WHERE D.CMDT_CD = B.CMDT), ' ') AS CMDTGRCD,
		       NVL((SELECT  DISTINCT D.CMDT_GRP_DESC
					FROM TMT_CMDT D
					WHERE D.CMDT_CD = B.CMDT), ' ') AS CMDTGR,
			B.CG_TP_CD             CGTPCD,
			B.CG_TON               CGTON,
	        NVL((SELECT A.ENG_SNM
				FROM TMT_PTNR A , TMT_PTNR_USER B
				WHERE B.USER_ID = A.SUMIT_BY
				AND A.PTNR_CODE = B.PTNR_CODE
				AND ROWNUM = 1
			), A.SUMIT_BY) REQCOMP,
			A.SUMIT_DT AS REQDT,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.SUMIT_BY
			),A.SUMIT_BY ) AS REQR,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.APPRV_BY
			), A.APPRV_BY)  APPR,
			A.RMK                  RMK,
			A.REJ_RMK              REJRMK,
			B.LOC_DIV_CD           LOCDIVCD,
			F_GET_MEGA_DTL_LOC(A.MEGA_NO) LOCID,
			B.SHIPG_NOTE_NOS       SHIPGNOTENO,
			B.DO_NOS               DONO,
			(
				SELECT F_INTERVAL_OF_HOUR('', TO_DATE(A.WORK_YMD || SH.FM_HHMM, 'YYYYMMDD HH24:MI'), SYSDATE) 
				FROM TMT_SHFT SH
				WHERE SH.SHFT_METH_CD = 'Standard'
				AND SH.VLD_YN = 'Y'
				AND SH.SHFT_ID = A.SHFT_ID
			) AS HOUR,
			A.VERSION              VERSION
		FROM TMT_MEGA A, TMT_MEGA_DTL B
		WHERE A.MEGA_NO = B.MEGA_NO
		AND A.MEGA_NO = #{megaNo}
		AND B.DIV_CD = 'VO'
	</select>
	
	<select id="selectShippingNote"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /*mega.selectShippingNote*/
			SHIPG_NOTE_NO AS SHIPGNOTENO 
		FROM TMT_SHIPG_NOTE
		WHERE VSL_CALL_ID = #{vslCallId} 
		AND STAT_CD IN ('CF', 'FS')
		AND SHIPG_NOTE_NO IS NOT NULL
		<if test='ptnrType == "SHA"'>
			AND SHIPG_AGNCY = #{ptnrCd}
		</if>
		<if test='ptnrType == "FWD"'>
			AND FWRD = #{ptnrCd}
		</if>
		<if test='ptnrType == "BOTH"'>
			AND (SHIPG_AGNCY = #{ptnrCd} OR FWRD = #{ptnrCd})
		</if>
		ORDER BY SHIPG_NOTE_NO
	</select>
	
	<select id="selectDeliveryOrder"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /*mega.selectDeliveryOrder*/
			DO_NO AS DONO 
		FROM TMT_DO
		WHERE VSL_CALL_ID = #{vslCallId} 
		AND DO_NO IS NOT NULL
		ORDER BY DO_NO
	</select>
	
	<select id="selectPenaltyCode"  parameterType="megaParm" resultType="megaItem">
		<if test="penaltyTp == 'C_MEGA'">
			SELECT /*mega.selectPenaltyCode*/
				NVL(F_GET_MEGA_PENALTY_LB(#{workYmd},#{shftId},#{purpTpCd},#{nofGang}), 'N') AS PENALTYCD, 
				NVL((SELECT S_CD_NM FROM TMT_CD_MSTD 
					WHERE M_CD ='PNTYTP' 
					AND S_CD = F_GET_MEGA_PENALTY_LB(#{workYmd},#{shftId},#{purpTpCd},#{nofGang})
				), ' ') AS PENALTYNM
			FROM DUAL
		</if>
		<if test="penaltyTp != 'C_MEGA'">
            SELECT /*mega.selectPenaltyCode*/
            	NVL(F_GET_MEGA_PENALTY(#{megaNo},#{workYmd},#{shftId},#{nofGang},#{penaltyTp}), 'N') AS PENALTYCD, 
				NVL( (SELECT S_CD_NM FROM TMT_CD_MSTD 
				   		  WHERE M_CD ='PNTYTP' 
						    AND S_CD = F_GET_MEGA_PENALTY(#{megaNo},#{workYmd},#{shftId},#{nofGang},#{penaltyTp})), ' ') AS PENALTYNM
			FROM DUAL
		</if>
	</select>
	
	<select id="selectMegaStevedoreList"  parameterType="megaParm" resultType="megaItem">
		SELECT /* mega.selectMegaStevedore */
			A.MEGA_NO              MEGANO,
			A.SEQ                  SEQ,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 1, 2), 0) REQTIME,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 3, 2), 0) REQMIN,
			A.SHIP_CLEW_YN         SHIPCLEWYN, 
			A.STVD_COMP            STVDCOMP,	      
			A.NOF_GANG             NOFGANG,
			A.NOF_OPR_SPRR         NOFOPRSPRR,
			A.NOF_OPR_CLERK        NOFOPRCLERK,
			A.NOF_STVD_SPRR        NOFSTVDSPRR,
			A.NOF_WCHMN            NOFWCHMN,
			A.NOF_STVD_GWKER       NOFSTVDGWKER,
			A.STVD_NON_TON         STVDNONTON,
			A.TRMG_COMP            TRMGCOMP,
			A.NOF_HATCH            NOFHATCH,
			A.NOF_TRMG_SPRR        NOFTRMGSPRR,
			A.NOF_SGLMN            NOFSGLMN,
			A.NOF_DEKMN            NOFDEKMN,
			A.NOF_HOPMN            NOFHOPMN,
			A.NOF_TRMG_GWKER       NOFTRMGGWKER,
			A.TRMG_NON_TON         TRMGNONTON,
			A.LOC_ID               LOCID
		FROM TMT_MEGA_DTL A
		WHERE A.MEGA_NO = #{megaNo}
		AND A.DIV_CD = 'SD'
	</select>
	
	<sql id="sqlMegaCntt">
		SELECT DISTINCT /* Mega.xml  selectMegaCntt  PN123 */
			A.VSL_CALL_ID 							AS VSLCALLID,  
			(
				SELECT PT.VSL_NM 
				FROM TMT_VSL_SCH SH, TMT_VSL_PART PT
				WHERE SH.VSL_CALL_ID = A.VSL_CALL_ID AND SH.VSL_CD = PT.VSL_CD
			) 										AS VSLNM,
			F_CM_012('MT', 'MGPURP', A.PURP_TP_CD) 	AS PURPTPCDNM,
			TO_DATE(A.WORK_YMD , 'YYYYMMDD') 		AS WORKYMD, 
			A.SHFT_ID     							AS SHFTID, 
			(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = A.SHFT_ID) AS SHFTNM,
			A.MEGA_NO     							AS MEGANO,
			B.SEQ 									AS SEQ,
			B.EQ_DIV_CD 							AS eqDivCd, 
			A.STAT_CD     							AS STATCD, 
			F_CM_012('MT', 'MEGASTAT', A.STAT_CD) 	AS STATCDNM,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.SUMIT_BY
			), A.SUMIT_BY) 							AS REQRNM,
			TO_CHAR(A.SUMIT_DT, 'DD/MM/YYYY HH24:MI') AS REQDT,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.APPRV_BY
			), NVL(A.APPRV_BY, ' ')) 				AS APPR,
			TO_CHAR(A.APPRV_DT, 'DD/MM/YYYY HH24:MI') AS APPDT,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.CNCL_BY
			), A.CNCL_BY) 							AS CNCLBY, 
			TO_CHAR(A.CNCL_DT, 'DD/MM/YYYY HH24:MI') AS CNCLDT,
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
				FROM TMT_USER_INFO
				WHERE USER_ID = A.REJ_BY
			), NVL(A.REJ_BY, ' ')) 					AS REJBY, 
			TO_CHAR(A.REJ_DT, 'DD/MM/YYYY HH24:MI') AS REJDT,
			(
				SELECT 'Y' FROM TMT_DEPY 
				WHERE USE_YN = 'Y' 
				AND VSL_CALL_ID = A.VSL_CALL_ID
				AND WORK_YMD = A.WORK_YMD
				AND PURP_TP_CD = A.PURP_TP_CD
				AND SHFT_ID = A.SHFT_ID 
				AND A.STAT_CD = 'AP' AND ROWNUM = 1
			) 										AS DEPYYN,
	</sql>
	
	<sql id="sqlMegaCondition">
		<if test="vslCallId == null or vslCallId == ''">
			<if test="etaFrom != null and etaFrom != ''">
				AND TO_DATE(A.WORK_YMD, 'YYYYMMDD') BETWEEN TO_DATE(#{etaFrom}, 'DD/MM/YYYY') AND TO_DATE(#{etaTo}, 'DD/MM/YYYY')
			</if>
		</if>
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test="cmdt != null and cmdt != ''">
			AND B.CMDT = #{cmdt}
		</if>
		<if test="purpTpCd != null and purpTpCd != ''">
			AND A.PURP_TP_CD = #{purpTpCd}
		</if>
		<if test="shftId != null and shftId != ''">
			AND A.SHFT_ID = #{shftId}
		</if>
		<if test="statCd != null and statCd != ''">
			AND A.STAT_CD = #{statCd}
		</if>
		<if test="saId != null and saId != ''">
			AND EXISTS (SELECT '1' FROM TMT_VSL_SCH WHERE VSL_CALL_ID = A.VSL_CALL_ID AND ARRV_SA_ID = #{saId})
		</if>
		<if test='depyYn == "Y"'>
			AND EXISTS (
		   		SELECT 'Y' FROM TMT_DEPY 
				WHERE USE_YN = 'Y' 
				AND VSL_CALL_ID = A.VSL_CALL_ID 
				AND WORK_YMD = A.WORK_YMD
				AND PURP_TP_CD = A.PURP_TP_CD 
				AND SHFT_ID = A.SHFT_ID 
				AND ROWNUM = 1
			)
		</if>
		<if test='depyYn == "N"'>
			AND NOT EXISTS (
				SELECT 'Y' FROM TMT_DEPY 
				WHERE USE_YN = 'Y' 
				AND VSL_CALL_ID = A.VSL_CALL_ID 
				AND WORK_YMD = A.WORK_YMD
				AND PURP_TP_CD = A.PURP_TP_CD 
				AND SHFT_ID = A.SHFT_ID 
				AND ROWNUM = 1
			)
		</if>
	</sql>
	
	<select id="selectMegaCnttList"  parameterType="megaParm" resultType="megaItem">
	 	<if test="pageNo != 0"> 
             SELECT 
             	* FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getMegaCntt"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	</select>
	
	<select id="selectMegaCnttCount" parameterType="megaParm" resultType="java.lang.String">
		SELECT COUNT(*)
			FROM (<include refid="getMegaCntt"/>)
	</select>
	
	<sql id="getMegaCntt">
		<include refid="sqlMegaCntt"/>
			' '           AS OPECOMPNM,
			F_CM_012('MT', 'EQFCTPCD', C.EQ_DIV_CD) EQDIVCDNM, 
			(SELECT CAPA_DESCR FROM TMT_EQ_CAPA WHERE CAPA_CD = C.CAPA_CD AND EQ_TP_CD = C.EQ_DIV_CD) CAPADESCR,
			C.OPE_COMP    AS OPECOMPCD,
			C.NOF_OPE     AS NOFOPE, 
			0             AS NOFGANG,
			0             AS NOFOPRSPRR,
			0             AS NOFOPRCLERK,
			0             AS NOFSTVDSPRR,
			0             AS NOFWCHMN,
			0             AS NOFSTVDGWKER,
			0             AS STVDNONTON,
			0             AS NOFHATCH,
			0             AS NOFTRMGSPRR,
			0             AS NOFSGLMN,
			0             AS NOFDEKMN,
			0             AS NOFHOPMN,
			0             AS NOFTRMGGWKER
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_MEGA_DTL_OPE C, TMT_PTNR D 
		WHERE C.OPE_DIV_CD = 'C'
		AND A.STAT_CD IN ('CA', 'RJ', 'AP')
		AND C.MEGA_NO = A.MEGA_NO
		AND A.MEGA_NO = B.MEGA_NO
		AND B.SEQ = C.MEGA_IDX
		AND C.OPE_COMP = D.PTNR_CODE
	 	<if test='isMPTSBBBilling == "Y"'>
	 		<if test="opeCompCd != null and opeCompCd != ''">
	 			AND D.PTNR_TYPE = 'CTT' AND D.PTNR_CODE = #{opeCompCd}
	 		</if>
	 		<if test="opeCompCd == null or opeCompCd == ''">
	 			AND D.PTNR_TYPE = 'CTT'
	 		</if>
	 	</if>
	 	<if test='isMPTSBBBilling == "N"'>
			AND
	 		<if test="opeCompCd != null and opeCompCd != ''">
	 			C.OPE_COMP = (SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE PTNR_TYPE = 'CTT' AND USER_ID = #{userId})
	 		</if>
	 		<if test="opeCompCd == null or opeCompCd == ''">
	 			 D.PTNR_TYPE = 'CTT'
	 		</if>
	 	</if>
		<include refid="sqlMegaCondition"/>
		UNION ALL
		<include refid="sqlMegaCntt"/>
			'Stevedore'  AS OPECOMPNM,
			' '              AS EQDIVCD, 
			' '              AS CAPADESCR, 
			B.STVD_COMP               AS OPECOMP, 
			0                AS NOFOPE, 
			B.NOF_GANG       AS NOFGANG,
			B.NOF_OPR_SPRR   AS NOFOPRSPRR,
			B.NOF_OPR_CLERK  AS NOFOPRCLERK,
			B.NOF_STVD_SPRR  AS NOFSTVDSPRR,
			B.NOF_WCHMN      AS NOFWCHMN,
			B.NOF_STVD_GWKER AS NOFSTVDGWKER,
			B.STVD_NON_TON   AS STVDNONTON,
			B.NOF_HATCH      AS NOFHATCH,
			B.NOF_TRMG_SPRR  AS NOFTRMGSPRR,
			B.NOF_SGLMN      AS NOFSGLMN,
			B.NOF_DEKMN      AS NOFDEKMN,
			B.NOF_HOPMN      AS NOFHOPMN,
			B.NOF_TRMG_GWKER AS NOFTRMGGWKER
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_PTNR D 
		WHERE B.DIV_CD = 'SD'
		AND A.STAT_CD IN ('CA', 'RJ', 'AP')
  		AND A.MEGA_NO = B.MEGA_NO
  		AND B.STVD_COMP = D.PTNR_CODE
   		<if test='isMPTSBBBilling == "Y"'>
 			<if test="opeCompCd != null and opeCompCd != ''">
 				AND D.PTNR_TYPE = 'STV' AND D.PTNR_CODE = #{opeCompCd}
 			</if>
 			<if test="opeCompCd == null or opeCompCd == ''">
 				AND D.PTNR_TYPE = 'STV'
 			</if>
 		</if>
 		<if test='isMPTSBBBilling == "N"'>
			AND B.STVD_COMP = (SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE PTNR_TYPE = 'STV' AND USER_ID = #{userId})
 		</if>
		<include refid="sqlMegaCondition"/>
		UNION ALL
		<include refid="sqlMegaCntt"/>
			'Trimming'       AS OPECOMPNM,
			' '              AS EQDIVCD, 
			' '              AS CAPADESCR, 
			' '              AS OPECOMP, 
			0                AS NOFOPE, 
			B.NOF_GANG       AS NOFGANG,
			B.NOF_OPR_SPRR   AS NOFOPRSPRR,
			B.NOF_OPR_CLERK  AS NOFOPRCLERK,
			B.NOF_STVD_SPRR  AS NOFSTVDSPRR,
			B.NOF_WCHMN      AS NOFWCHMN,
			B.NOF_STVD_GWKER AS NOFSTVDGWKER,
			B.STVD_NON_TON   AS STVDNONTON,
			B.NOF_HATCH      AS NOFHATCH,
			B.NOF_TRMG_SPRR  AS NOFTRMGSPRR,
			B.NOF_SGLMN      AS NOFSGLMN,
			B.NOF_DEKMN      AS NOFDEKMN,
			B.NOF_HOPMN      AS NOFHOPMN,
			B.NOF_TRMG_GWKER AS NOFTRMGGWKER
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_PTNR D 
		WHERE B.DIV_CD = 'SD'
		AND A.STAT_CD IN ('CA', 'RJ', 'AP')
		AND A.MEGA_NO = B.MEGA_NO
		AND B.TRMG_COMP = D.PTNR_CODE
 		<if test='isMPTSBBBilling == "Y"'>
 			<if test="opeCompCd != null and opeCompCd != ''">
 				AND D.PTNR_TYPE = 'TRM' AND D.PTNR_CODE = #{opeCompCd}
 			</if>
 			<if test="opeCompCd == null or opeCompCd == ''">
 				AND D.PTNR_TYPE = 'TRM'
 			</if>
 		</if>
 		<if test='isMPTSBBBilling == "N"'>
			AND	B.TRMG_COMP = (SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE PTNR_TYPE = 'TRM' AND USER_ID = #{userId})
 		</if>
		<include refid="sqlMegaCondition"/>
		UNION ALL
		<include refid="sqlMegaCntt"/>
			'Tally'  AS OPECOMPNM,
			' '              AS EQDIVCD, 
			' '              AS CAPADESCR, 
			B.STVD_COMP      AS OPECOMP, 
			0                AS NOFOPE, 
			B.NOF_GANG       AS NOFGANG,
			B.NOF_OPR_SPRR   AS NOFOPRSPRR,
			B.NOF_OPR_CLERK  AS NOFOPRCLERK,
			B.NOF_STVD_SPRR  AS NOFSTVDSPRR,
			B.NOF_WCHMN      AS NOFWCHMN,
			B.NOF_STVD_GWKER AS NOFSTVDGWKER,
			B.STVD_NON_TON   AS STVDNONTON,
			B.NOF_HATCH      AS NOFHATCH,
			B.NOF_TRMG_SPRR  AS NOFTRMGSPRR,
			B.NOF_SGLMN      AS NOFSGLMN,
			B.NOF_DEKMN      AS NOFDEKMN,
			B.NOF_HOPMN      AS NOFHOPMN,
			B.NOF_TRMG_GWKER AS NOFTRMGGWKER
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_PTNR D 
		WHERE B.DIV_CD = 'SD'
 		AND A.STAT_CD IN ('CA', 'RJ', 'AP')
   		AND A.MEGA_NO = B.MEGA_NO
   		AND B.STVD_COMP = D.PTNR_CODE
   		<if test='isMPTSBBBilling == "Y"'>
 			<if test="opeCompCd != null and opeCompCd != ''">
 				AND D.PTNR_TYPE = 'TLY' AND D.PTNR_CODE = #{opeCompCd}
 			</if>
 			<if test="opeCompCd == null or opeCompCd == ''">
 				AND D.PTNR_TYPE = 'TLY'
 			</if>
 		</if>
 		<if test='isMPTSBBBilling == "N"'>
		AND B.STVD_COMP = (SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE PTNR_TYPE = 'STV' AND USER_ID = #{userId})
 		</if>
		<include refid="sqlMegaCondition"/>
		ORDER BY VSLCALLID, MEGANO
	</sql>
	
	<select id="selectMegaEquipment" parameterType="megaParm" resultMap="EquipmentMap">
		SELECT /*mega.selectMegaEquipment*/
			A.MEGA_NO                         MEGANO,
			A.SEQ                             SEQ,
			A.DIV_CD                          DIVCD,
			A.EQ_DIV_CD                       EQDIVCD,
			F_CM_012('MT', 'EQFCTPCD', A.EQ_DIV_CD) EQDIVCDNM,
			NVL(A.CAPA_CD, '')               CAPACD,
			DECODE(
				A.EQ_DIV_CD,
				'SR',
				'-',
				(SELECT CAPA_DESCR FROM TMT_EQ_CAPA 
				WHERE CAPA_CD = A.CAPA_CD
				AND EQ_TP_CD = A.EQ_DIV_CD)
			) CAPADESCR,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 1, 2), 0) REQTIME,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 3, 2), 0) REQMIN,
			TO_CHAR(TO_DATE(A.REQ_HHMM, 'HH24MI'), 'HH24MI') DSPREQHHMM, 
			DECODE(A.REQ_QTY, null, 0, A.REQ_QTY) REQQTY,
			START_DATE WORKSTDT,
			END_DATE WORKENDDT,
			FL_STATUS           flStatus,
			<if test='copyType != null and copyType == "C"'>
				0                               CONFMQTY,
				0                               WHQTY,
			</if>
			<if test='copyType != null and copyType != "C"'> 
				DECODE(A.CONFM_QTY, 0, 0, A.CONFM_QTY) CONFMQTY,
				DECODE(A.WH_QTY, 0, 0, A.WH_QTY) WHQTY,
			</if>
				NVL(A.LOC_ID, ' ')                LOCID,
				' '                               COLCOLOR,
				#{copyType ,jdbcType=VARCHAR}		COPYTYPE
		FROM TMT_MEGA_DTL A
		WHERE A.MEGA_NO = #{megaNo}
		AND A.DIV_CD = #{divCd}
		<if test = 'eqDivCdType != null'>
			<if test='eqDivCdType == "GR"'>
			   AND EQ_DIV_CD IN ('CH','CY', 'EH', 'EX', 'FN', 'GR', 'PIP', 'RP', 'RS', 'WB', 'YT')  <!-- Harry fixed iss show wrong grid gear list--> 
			</if>
			<if test='eqDivCdType == "FL"'>
			   AND A.EQ_DIV_CD = #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "TR"'>
			   AND A.EQ_DIV_CD = #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "MC"'>
				AND EQ_DIV_CD NOT IN ('CH','CY', 'EH', 'EX', 'FN', 'GR', 'PIP', 'RP', 'RS', 'WB', 'YT', 'FL', 'TR','TC','QC', 'SC', 'HG', 'RT', 'SR') <!-- Harry fixed iss show wrong grid gear list--> 
			</if>
			<if test='eqDivCdType == "PC"'>
				AND (A.EQ_DIV_CD = 'SR' 
					OR EXISTS ( 
						SELECT S_CD FROM TMT_CD_MSTD
						WHERE L_CD = 'MT' 
						AND M_CD = 'EQFCTPCD'
						AND S_CD = A.EQ_DIV_CD
						AND S_CD_VAL = 'PC' 
					)
				)
			</if>
		</if>
		ORDER BY SEQ ASC
	</select>
	
    <select id="selectMegaEquipmentForReport" parameterType="megaParm" resultMap="EquipmentMapForReport2">
		SELECT /*mega.selectMegaEquipmentForReport*/
			ROWNUM AS NO,
			A.MEGA_NO                         MEGANO,
			A.SEQ                             SEQ,
			DECODE (A.req_qty, NULL,0, A.req_qty) reqqty,
			DECODE (A.confm_qty, NULL,0, A.confm_qty) confmqty,
			A.DIV_CD                          DIVCD,
			A.EQ_DIV_CD                       EQDIVCD,
			F_CM_012('MT', 'EQFCTPCD', A.EQ_DIV_CD) EQDIVCDNM,
			NVL(A.CAPA_CD, ' ')               CAPACD,
			DECODE(
				A.EQ_DIV_CD,
				'SR',
				'-',
				(SELECT CAPA_DESCR FROM TMT_EQ_CAPA 
				WHERE CAPA_CD = A.CAPA_CD
				AND EQ_TP_CD = A.EQ_DIV_CD)
			) CAPADESCR,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 1, 2), 0) REQTIME,
			NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 3, 2), 0) REQMIN,
			TO_CHAR(TO_DATE(A.REQ_HHMM, 'HH24MI'), 'HH24MI') DSPREQHHMM, 
			DECODE(A.REQ_QTY, null, ' ', A.REQ_QTY) REQQTY,
			<if test='copyType == "C"'>
				' '                               CONFMQTY,
				' '                               WHQTY,
			</if>
			<if test="copyType != 'C'"> 
				DECODE(A.CONFM_QTY, null, ' ', A.CONFM_QTY) CONFMQTY,
				NVL(A.WH_QTY, 0) AS WHQTY,
			</if>
			NVL(A.LOC_ID, ' ')                LOCID,
			' '                               COLCOLOR,
			#{copyType}                        COPYTYPE
			,B.SHFT_ID              SHFTID,
               B.SUMIT_BY              submitBy,
			(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) SHFTNM,
			(SELECT SHFT_IDX FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) SHFTIDX,
			B.PURP_TP_CD           PURPTPCD,
			B.RMK AS                             rmk,
			B.REJ_RMK                            rejRmk,
			B.APPRV_BY                           apprvBy,
			B.STAT_CD                            statCd,
			F_CM_012('MT', 'MGPURP', B.PURP_TP_CD) PURPTPCDNM,
			TO_CHAR(TO_DATE(B.WORK_YMD , 'YYYYMMDD'), 'DD/MM/YYYY') WORKYMD,
			F_CM_012('MT', 'MEGASTAT', B.STAT_CD) STATCDNM,
			(SELECT S_CD_LGV FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='MGPURP' AND S_CD=B.PURP_TP_CD) PURPTYPE,
			'' AS BERTHLOC
		FROM TMT_MEGA_DTL A, TMT_MEGA B
		WHERE A.MEGA_NO = B.MEGA_NO
		AND B.VSL_CALL_ID = #{vslCallId}
		AND A.DIV_CD = #{divCd}
		<if test='vslCallId == "STRG"'>
			<if test="etaFrom != null and etaFrom != ''">
				AND TO_DATE(B.WORK_YMD,'YYYYMMDD') = TO_DATE(#{etaFrom},'DD/MM/YYYY')
			</if>
		</if>
		<if test='eqDivCdType == "GR"'>
			AND A.EQ_DIV_CD = #{eqDivCdType}
		</if>
		<if test='eqDivCdType == "FL"'>
			AND A.EQ_DIV_CD = #{eqDivCdType}
		</if>
		<if test='eqDivCdType == "TR"'>
			AND A.EQ_DIV_CD = #{eqDivCdType}
		</if>
		<if test='eqDivCdType == "MC"'>
			AND EQ_DIV_CD NOT IN ('GR', 'FL', 'TR','BG','CU','LL','PC','TX','SR')
		</if>
		<if test='eqDivCdType == "PC"'>
			AND (A.EQ_DIV_CD = 'SR' 
				OR EXISTS (
					SELECT S_CD FROM TMT_CD_MSTD
					WHERE L_CD = 'MT' 
					AND M_CD = 'EQFCTPCD'
					AND S_CD = A.EQ_DIV_CD
					AND S_CD_VAL = 'PC'
				)
			)
		</if>
		<if test='ptnrType == "SHA"'>
			AND B.REQR = (SELECT DISTINCT C.PTNR_CODE FROM TMT_PTNR_USER C WHERE C.USER_ID = #{userId} AND ROWNUM=1)
		</if>
		<if test="megaList != null and !megaList.isEmpty">
			AND A.MEGA_NO IN
			<foreach item="item" index="index" collection="megaList" separator="," open="(" close=")">
		         ${item}
			</foreach>
		</if>
		ORDER BY MEGANO, WORKYMD, SHFTNM 
    </select>
    
	<select id="selectOperInfo" resultMap="OperInfoMap">
		SELECT /*mega.selectOperInfo*/
			MEGA_NO              MEGANO,
			MEGA_IDX             MEGAIDX,
			SEQ                  SEQ,
			EQ_DIV_CD            EQDIVCD,
			NVL(CAPA_CD, ' ')    CAPACD,
			OPE_DIV_CD           OPEDIVCD,
			NVL(OPE_COMP, ' ')   OPECOMPCD,
			NVL(OPE_COMP, 'JPB') OPECOMPNM,
			NOF_OPE              NOFOPE
		FROM TMT_MEGA_DTL_OPE
		WHERE MEGA_NO = #{megaNo}
		AND MEGA_IDX = ${megaIdx}
		AND EQ_DIV_CD = #{eqDivCd}
		<if test="capaCd != null and capaCd != ''">
			AND CAPA_CD = #{capaCd}
		</if>
		<if test='copyType == "C"'>
			AND 1 &lt;&gt; 1
		</if>
	</select>
	
	<sql id="sqlInternalMega">
		SELECT /* Mega.xml  selectInternalMegaList  PN117 */
			A.MEGA_NO                                      MEGANO, 
			B.SEQ                                          SEQ,
			TO_DATE(A.WORK_YMD , 'YYYYMMDD')				  WORKYMD,
			B.DIV_CD                                       DIVCD, 
			NVL((SELECT (USER_ID || '/' || ENG_NM) 
			  	FROM TMT_USER_INFO
				WHERE USER_ID = A.SUMIT_BY
			), A.SUMIT_BY) AS REQR,
			A.SUMIT_DT AS REQDT,
			(SELECT SHFT_NM FROM TMT_SHFT 
			WHERE SHFT_ID = A.SHFT_ID)                       SHFTNM,
			B.LOC_DIV_CD                                   LOCDIVCD, 
			B.LOC_ID                                       LOCID, 
			(
				SELECT MAX(SHIPG_NOTE_NOS||DO_NOS) 
				FROM TMT_MEGA_DTL 
				WHERE DIV_CD = 'VO' 
				AND MEGA_NO = A.MEGA_NO
			)                   SNDO,
			B.EQ_DIV_CD 									eqDivCd,
			F_CM_012('MT', 'EQFCTPCD', B.EQ_DIV_CD) AS  				eqDivCdNm,
			B.CAPA_CD CAPACD,
			(SELECT CAPA_DESCR FROM TMT_EQ_CAPA WHERE CAPA_CD = B.CAPA_CD AND EQ_TP_CD = B.EQ_DIV_CD) AS CAPADESCR,
			NVL(B.REQ_QTY, 0)                              REQQTY, 
			CASE 
				WHEN B.WH_QTY IS NULL OR B.WH_QTY = 0 THEN NVL(B.REQ_QTY, 0)
				ELSE NVL(B.CONFM_QTY, 0)
			END AS CONFMQTY,
			NVL(B.WH_QTY, 0)                               WHQTY,
			NVL2(B.WH_QTY, ' ', #{colColor})                COLCOLOR,
			A.VERSION                                      VERSION,
	</sql>
	
	<sql id="sqlInternalMegaParm">
		AND A.STAT_CD IN ('RV','SU','CF')
		AND A.WH_APPRV_YN = 'Y'
		AND A.PURP_TP_CD IN (
			SELECT S_CD
			FROM TMT_CD_MSTD 
			WHERE L_CD='MT'
			AND M_CD='MGPURP'
			AND S_CD_LGV IN ('MP')
		)
		AND B.DIV_CD = 'EQ'
		<choose>
			<when test="eqDivCd == 'FL'">
				AND B.EQ_DIV_CD = 'FL'
		   	</when>
		   	<otherwise>
		   		AND B.EQ_DIV_CD NOT IN ('GR', 'FL', 'TR','BG','CU','LL','PC','TX','SR')
		   	</otherwise>
		</choose>
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test="purpTpCd != null and purpTpCd != ''">
			AND A.PURP_TP_CD = #{purpTpCd}
		</if>
		<if test="reqDtFrom != null and reqDtFrom != ''">
			AND TO_DATE(A.WORK_YMD, 'YYYYMMDD') BETWEEN TO_DATE(#{reqDtFrom},'DD/MM/YYYY') AND TO_DATE(#{reqDtTo},'DD/MM/YYYY')
   		</if>
		<if test="statCd != null and statCd != ''">
			AND A.STAT_CD = #{statCd}
		</if>
		<if test="shftId != null and shftId != ''">
			AND A.SHFT_ID = #{shftId}
		</if>
		<if test="locId != null and locId != ''">
			AND B.LOC_ID = #{locId}
		</if>
		<if test="saAgent != null and saAgent != ''">
			AND EXISTS (
				SELECT USER_ID FROM TMT_PTNR_USER 
				WHERE PTNR_TYPE = 'SHA' 
				AND PTNR_CODE = #{saAgent}
				AND USER_ID = A.SUMIT_BY
			)
		</if>
		<if test="fwAgent != null and fwAgent != ''">
			AND EXISTS (
				SELECT USER_ID FROM TMT_PTNR_USER 
				WHERE PTNR_TYPE = 'FWD' 
				AND PTNR_CODE = #{fwAgent}
				AND USER_ID = A.SUMIT_BY
			)
		</if>
	</sql>
	
	<sql id="sqlAlertInternalMegaCondition">
		<if test="alertYn eq 'Y'.toString()">
			AND NVL(B.WH_QTY, 0) = 0
			AND (SYSDATE - TO_DATE(A.WORK_YMD , 'YYYYMMDD')) &lt;= 180
		</if>
	</sql>
	
	<select id="selectMegaInternalList" parameterType="megaParm" resultType="megaItem">
		<if test="pageNo != 0"> 
             SELECT /*mega.selectMegaInternalList*/
             	* FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getInternalMegaList"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	</select>
	
	<select id="selectMegaInternalListCount"  parameterType="megaParm" resultType="java.lang.String">
		SELECT COUNT(*)
			FROM (<include refid="getInternalMegaList"/>)
	</select>
	
	<sql id="getInternalMegaList">
		<include refid="sqlInternalMega"/>
			A.VSL_CALL_ID                                  VSLCALLID,
			D.VSL_NM                                       VSLNM
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_VSL_SCH C, TMT_VSL_PART D
		WHERE A.MEGA_NO = B.MEGA_NO
		AND A.VSL_CALL_ID = C.VSL_CALL_ID
		AND A.VSL_CALL_ID &lt;&gt; 'STRG'
		AND C.VSL_CD = D.VSL_CD
		<include refid="sqlInternalMegaParm"/>
		<include refid="sqlAlertInternalMegaCondition"/>
		UNION
		<include refid="sqlInternalMega"/>
			'-'                                            VSLCALLID,
			' '                                            VSLNM
		FROM TMT_MEGA A, TMT_MEGA_DTL B
		WHERE A.MEGA_NO = B.MEGA_NO
		AND A.VSL_CALL_ID = 'STRG'
		<include refid="sqlInternalMegaParm"/>
		<include refid="sqlAlertInternalMegaCondition"/>
		ORDER BY MEGANO DESC
	</sql>
	
	<select id="selectMegaCgDtlList"  parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectMegaCgDtlList*/
			A.MEGA_NO                      MEGANO,
			A.SEQ                          SEQ,
			A.HATCH_NO                     HATCHNO, 
			A.CG_DESC                      CGDESCCD,
			F_CM_012('MT', 'CGDESC', A.CG_DESC) CGDESCNM,
			NVL(A.CG_DESC_VAL, ' ')        CGDESCVAL
		FROM TMT_MEGA_DTL A
		WHERE A.MEGA_NO = #{megaNo}
		AND A.DIV_CD = 'CD' 
	</select>
	
	<select id="selectMaxMegaNo"  parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectMaxMegaNo*/
			F_GET_MEGA_NO AS MEGANO, 
			(SELECT S_CD_LGV FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='MGPURP' AND S_CD=#{purpTpCd}) PURPTYPE
		FROM dual
	</select>
	
	<select id="selectMaxSeqNo"  parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectMaxSeqNo*/
			NVL(MAX(SEQ), 0)+1 AS SEQ FROM TMT_MEGA_DTL WHERE MEGA_NO = #{megaNo}
	</select>
	
	<sql id="sqlMegaComp">
		FROM TMT_MEGA A, TMT_MEGA_DTL B, TMT_PTNR C
		WHERE A.MEGA_NO = B.MEGA_NO
		AND A.STAT_CD = 'AP'
		AND B.DIV_CD = 'SD'
		AND C.PTNR_TYPE = #{ptnrType} 
		<if test="megaCompCd != null and megaCompCd != ''">
			AND C.PTNR_CODE = #{megaCompCd}
		</if>
		<if test="megaCompNm != null and megaCompNm != ''">
			AND UPPER(C.ENG_SNM) LIKE UPPER('%${megaCompNm}%')
		</if>
	</sql>
	
	<select id="selectMegaComp"  parameterType="megaParm" resultType="megaItem">
		<if test='ptnrType == "STV"'>
			SELECT B.STVD_COMP MEGACOMPCD, C.ENG_SNM MEGACOMPNM
			<include refid="sqlMegaComp"/>
			AND B.STVD_COMP = C.PTNR_CODE
			AND B.STVD_COMP IS NOT NULL
			GROUP BY B.STVD_COMP, C.ENG_SNM 
		</if>
		<if test='ptnrType == "TRM"'>
			SELECT B.TRMG_COMP MEGACOMPCD, C.ENG_SNM MEGACOMPNM
			<include refid="sqlMegaComp"/>
			AND B.TRMG_COMP = C.PTNR_CODE
			AND B.TRMG_COMP IS NOT NULL
			GROUP BY B.TRMG_COMP, C.ENG_SNM  
		</if>
	</select>
	
	<select id="selectCompanyInfo"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /*mega.selectCompanyInfo*/
			(SELECT A.ACC_NO AS ACCNO FROM TMT_AGENCY_INFO A WHERE A.AGENCY_CODE = C.ARRV_SA_ID) AS ACCOUNTNO,
			(SELECT A.ENG_SNM AS ENGSNM FROM TMT_AGENCY_INFO A WHERE A.AGENCY_CODE = C.ARRV_SA_ID) AS ENGNM,
			(SELECT VSL_NM FROM TMT_VSL_PART WHERE VSL_CD = C.VSL_CD) VSLNM,
			ROWNUM AS NO    
		FROM TMT_MEGA_DTL A, TMT_MEGA B ,TMT_VSL_SCH C
		WHERE A.MEGA_NO = B.MEGA_NO  
		AND B.VSL_CALL_ID = C.VSL_CALL_ID
		AND A.NOF_OPR_SPRR IS NOT NULL
		<if test="vslCallId != null and vslCallId != ''">
			AND B.VSL_CALL_ID = #{vslCallId}
		</if>
	</select>
	
	<select id="selectMegaReportForStevedore"  parameterType="megaParm" resultType="megaItem" >
		SELECT /*mega.selectMegaReportForStevedore*/
			ROWNUM AS NO,
			A.MEGA_NO              MEGANO,
			A.SEQ                  SEQ,
			DECODE (A.REQ_QTY, NULL,0, A.REQ_QTY) reqQty,
			DECODE (A.CONFM_QTY, NULL,0, A.CONFM_QTY) confmQty,
			TO_NUMBER(NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 1, 2), 0)) REQTIME,
			TO_NUMBER(NVL2(A.REQ_HHMM, SUBSTR(A.REQ_HHMM, 3, 2), 0)) REQMIN,
			A.SHIP_CLEW_YN         SHIPCLEWYN, 
			NVL(A.STVD_COMP, '')            STVDCOMP,         
			A.NOF_GANG             NOFGANG,
			A.NOF_OPR_SPRR         NOFOPRSPRR,
			A.NOF_OPR_CLERK        NOFOPRCLERK,
			A.NOF_STVD_SPRR        NOFSTVDSPRR,
			A.NOF_WCHMN            NOFWCHMN,
			A.NOF_STVD_GWKER       NOFSTVDGWKER,
			A.STVD_NON_TON         STVDNONTON,
			A.TRMG_COMP            TRMGCOMP,
			A.NOF_HATCH            NOFHATCH,
			A.NOF_TRMG_SPRR        NOFTRMGSPRR,
			A.NOF_SGLMN            NOFSGLMN,
			A.NOF_DEKMN            NOFDEKMN,
			A.NOF_HOPMN            NOFHOPMN,
			A.NOF_TRMG_GWKER       NOFTRMGGWKER,
			A.TRMG_NON_TON         TRMGNONTON,
			A.LOC_ID               LOCID,
			B.SHFT_ID              SHFTID,
			B.SUMIT_BY              submitBy,
			B.RMK AS                             rmk,
			NVL(B.REJ_RMK,''  )                          rejRmk,
			B.APPRV_BY                           apprvBy,
			B.STAT_CD                            statCd,
			(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) SHFTNM,
			(SELECT SHFT_IDX FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) SHFTIDX,
			B.PURP_TP_CD           PURPTPCD,
			F_CM_012('MT', 'MGPURP', B.PURP_TP_CD) PURPTPCDNM,
			TO_DATE(TO_CHAR(TO_DATE(B.WORK_YMD , 'YYYYMMDD'), 'DD/MM/YYYY'),'DD/MM/YYYY') WORKYMD,
			F_CM_012('MT', 'MEGASTAT', B.STAT_CD) STATCDNM,     
			(SELECT S_CD_LGV FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='MGPURP' AND S_CD=B.PURP_TP_CD) PURPTYPE
		FROM TMT_MEGA_DTL A, TMT_MEGA B
		WHERE A.MEGA_NO = B.MEGA_NO  
		AND A.DIV_CD = 'SD'
        <if test="vslCallId != null and vslCallId != ''">
			AND B.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test='vslCallId == "STRG"'>
			<if test="etaFrom != null and etaFrom != ''">
				AND TO_DATE(B.WORK_YMD,'YYYYMMDD') = TO_DATE(#{etaFrom},'DD/MM/YYYY')
			</if>
		</if>
		<if test="megaList != null and !megaList.isEmpty">
			AND A.MEGA_NO IN
			<foreach item="item" index="index" collection="megaList" separator="," open="(" close=")">
				${item}
			</foreach>
		</if>
		<if test='ptnrType == "SHA"'>
			AND (B.SUMIT_BY LIKE  '%' || #{userId} || '%' 
				OR EXISTS (
					SELECT '1'
					FROM TMT_PTNR_USER C, TMT_PTNR_USER D
					WHERE C.USER_ID = B.SUMIT_BY
					AND C.PTNR_CODE = D.PTNR_CODE
					AND C.USER_ID = #{userId}
				)
			)
		</if>
		AND (A.STVD_COMP IS NOT NULL OR A.LOC_ID IS NOT NULL OR A.NOF_GANG != 0 OR A.NOF_STVD_SPRR != 0 OR A.STVD_NON_TON != 0)
		ORDER BY MEGANO, WORKYMD, SHFTNM
	</select>
	
	<insert id="insertMegaItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaItems*/
		INTO TMT_MEGA(
			MEGA_NO,
			PURP_TP_CD,
			WORK_YMD,
			SHFT_ID,
			STAT_CD,
			VSL_CALL_ID,
			CRT_BY,
			CRT_DT,
			SUMIT_BY,
			SUMIT_DT,
			WH_APPRV_YN,
			MEGA_WH_YN,
			MEGA_TP_CD,
			C_MEGA_NO,
			PAYER,
			RMK,
			PENALTY,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			REQR
		) VALUES (
			#{megaNo}
			,#{purpTpCd}
			,TO_CHAR(#{workYmd}, 'YYYYMMDD')
			,#{shftId}
			,#{statCd}
			,#{vslCallId}
			,#{userId}
			,SYSDATE
			<choose>
				<when test="statCd == 'SU' and (reqr == null or reqr == '')">
					,#{userId}
					,SYSDATE
				</when>
				<otherwise>
					,UPPER(#{reqr})
					,SYSDATE
				</otherwise>
			</choose>
			,#{whApprYn}
			,#{megaWhYn}
			,#{megaTpCd}
			,#{copyMegaNo}
			,(SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE USER_ID = #{reqr} AND ROWNUM = 1)
			,#{rmk}
			,#{penaltyCd}
			,SYSDATE
			,#{userId}
			, #{newVersion}
			<choose>
				<when test="statCd == 'SU' and (reqr == null or reqr == '')">
					,(SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE USER_ID = UPPER(#{userId}) AND ROWNUM = 1)
				</when>
				<otherwise>
					,(SELECT PTNR_CODE FROM TMT_PTNR_USER WHERE USER_ID = UPPER(#{reqr}) AND ROWNUM = 1)
				</otherwise>
			</choose>
		)
	</insert>
	
	<insert id="insertMegaDetailItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaDetailItems*/
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			CMDT,
			CG_TP_CD,
			CG_TON,
		    SHIPG_NOTE_NOS,
		    DO_NOS,		
			LOC_DIV_CD,
			UPDATE_TIME,
			STAFF_CD
		) VALUES (
			#{megaNo}
			, (SELECT NVL(MAX(SEQ), 0)+1 FROM TMT_MEGA_DTL WHERE MEGA_NO = #{megaNo})
			, 'VO'
			, #{cmdt}
			, #{cgTpCd}
			, #{cgTon}
			, #{shipgNoteNo}
			, #{dono}
			, #{locDivCd},
			SYSDATE, #{userId}
		)
	</insert>

	<insert id="insertMegaStevedoreItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaStevedoreItems*/
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			REQ_HHMM,
			SHIP_CLEW_YN,
			STVD_COMP,
			NOF_GANG,
			NOF_OPR_SPRR,
			NOF_OPR_CLERK,
			NOF_STVD_SPRR,
			NOF_WCHMN,
			NOF_STVD_GWKER,
			STVD_NON_TON,
			TRMG_COMP,
			NOF_HATCH,
			NOF_TRMG_SPRR,
			NOF_SGLMN,
			NOF_DEKMN,
			NOF_HOPMN,
			NOF_TRMG_GWKER,
			TRMG_NON_TON,
			LOC_ID,
			UPDATE_TIME,
			STAFF_CD
		) VALUES (
			#{megaNo}, 
			(SELECT NVL(MAX(SEQ), 0)+1 FROM TMT_MEGA_DTL WHERE MEGA_NO = #{megaNo}), 
			'SD', 
			LPAD(#{reqTime}, 2, '0')||LPAD(#{reqMin}, 2, '0'), 
			#{shipClewYn},
			#{stvdComp}, 
			#{nofGang}, 
			#{nofOprSprr}, 
			#{nofOprClerk}, 
			#{nofStvdSprr}, 
			#{nofWchmn}, 
			#{nofStvdGwker}, 
			#{stvdNonTon}, 
			#{trmgComp}, 
			#{nofHatch}, 
			#{nofTrmgSprr}, 
			#{nofSglmn}, 
			#{nofDekmn}, 
			#{nofHopmn}, 
			#{nofTrmgGwker}, 
			#{trmgNonTon}, 
			#{locId},
			SYSDATE, 
			#{userId}
		)
	</insert>
	
	<insert id="insertMegaEquipmentItem"  parameterType="megaItem">
		INSERT /*mega.insertMegaEquipmentItem*/
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			EQ_DIV_CD,
			CAPA_CD,
			LOC_DIV_CD,
			LOC_ID,
			REQ_HHMM,
			REQ_QTY,
			CONFM_QTY,
			WH_CHG_YN,
			WH_QTY,
			OPE_COMP,
			FL_STATUS,
			UPDATE_TIME,
			STAFF_CD,
			START_DATE,
			END_DATE
		) VALUES (
			#{megaNo}, #{seq}, #{divCd}, 
			#{eqDivCd}, #{capaCd}, #{locDivCd}, #{locId}
			, #{dspReqhhmm}, #{reqQty}, #{confmQty},
			#{whChgYn}, #{whQty}, #{opeCompCd},#{flStatus}, SYSDATE, #{userId}, TO_DATE(#{workStDt}, 'dd/mm/yyyy hh24:mi'), TO_DATE(#{workEndDt}, 'dd/mm/yyyy hh24:mi')
		)
	</insert>

	<insert id="insertMegaOperItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaOperItems*/
		INTO TMT_MEGA_DTL_OPE(
			MEGA_NO,
			MEGA_IDX,
			SEQ,
			EQ_DIV_CD,
			CAPA_CD,
			OPE_DIV_CD,
			OPE_COMP,
			NOF_OPE,
			UPDATE_TIME,
			STAFF_CD
		) VALUES (
			#{megaNo}, #{megaIdx}, 
			(SELECT NVL(MAX(SEQ), 0)+1 FROM TMT_MEGA_DTL_OPE WHERE MEGA_NO = #{megaNo}),
			#{eqDivCd}, #{capaCd}, #{opeDivCd},
			#{opeCompCd}, #{nofOpe}, SYSDATE, #{userId}
		)
	</insert>
	
	<insert id="insertMegaCgDtlItems"  parameterType="megaItem">
		CALL PRC_MEGA_DTL_CGDTL(#{megaNo}, #{divCd}, #{hatchNo}, #{cgDescCd}, #{cgDescVal}, #{userId})
	</insert>
	
	<update id="updateMegaItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaItems*/
		TMT_MEGA SET 
			<if test="statCd != null">
				STAT_CD  = #{statCd},
			</if>
			<if test='statCd == "CR"'>
				WORK_YMD = TO_CHAR(#{workYmd}, 'YYYYMMDD'),
				SHFT_ID  = #{shftId},
				SUMIT_BY = #{userId},
				SUMIT_DT = SYSDATE,
			</if>
			<if test='rejYn == "N"'>
				<if test='statCd == "SU"'>
					<if test="amdBy == null">
						WORK_YMD = TO_CHAR(#{workYmd}, 'YYYYMMDD'),
						SHFT_ID  = #{shftId},
						SUMIT_BY = #{userId},
						SUMIT_DT = SYSDATE,
					</if>
				</if>
			</if>
			<if test='statCd == "CA"'>
				CNCL_BY = #{userId},
				CNCL_DT = SYSDATE,
			</if>
			<if test='statCd == "AP"'>
				APPRV_BY = #{userId},
				APPRV_DT = SYSDATE,
			</if>
			<if test='statCd == "RJ"'>
				REJ_BY   = #{userId},
				REJ_DT   = SYSDATE,
			</if>
			<if test="rmk != null">
				RMK      = #{rmk},
			</if>
			<if test="rejRmk != null">
				REJ_RMK  = #{rejRmk},
			</if>
			<if test="penaltyCd != null">
				<if test="penaltyCd != null and penaltyCd != ''" >
					PENALTY  = #{penaltyCd},
				</if>
			</if>
			UPDATE_TIME   = SYSDATE,
			STAFF_CD = #{userId},
			VERSION = #{newVersion}
		WHERE MEGA_NO = #{megaNo}
		<if test="version != null and version != ''">
			AND VERSION = #{version} 
	   </if>
	</update>
			
	<update id="updateMegaDetailItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaDetailItems*/
		TMT_MEGA_DTL SET 
			CMDT        = #{cmdt},
			CG_TP_CD    = #{cgTpCd},
			CG_TON      = #{cgTon},
			SHIPG_NOTE_NOS = #{shipgNoteNo},
			DO_NOS      = #{dono},
			LOC_DIV_CD  = #{locDivCd},
			UPDATE_TIME      = SYSDATE,
			STAFF_CD = #{userId}
		WHERE MEGA_NO = #{megaNo}
		AND DIV_CD = 'VO'
	</update>

	<update id="updateMegaStevedoreItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaStevedoreItems*/
		TMT_MEGA_DTL SET 
			REQ_HHMM        = LPAD(#{reqTime}, 2, '0')||LPAD(#{reqMin}, 2, '0'),
			SHIP_CLEW_YN    = #{shipClewYn, jdbcType=VARCHAR},
			STVD_COMP       = #{stvdComp, jdbcType=VARCHAR},
			NOF_GANG        = #{nofGang, jdbcType=NUMERIC},
			NOF_OPR_SPRR    = #{nofOprSprr, jdbcType=NUMERIC},
			NOF_OPR_CLERK   = #{nofOprClerk, jdbcType=NUMERIC},
			NOF_STVD_SPRR   = #{nofStvdSprr, jdbcType=NUMERIC},
			NOF_WCHMN       = #{nofWchmn, jdbcType=NUMERIC},
			NOF_STVD_GWKER  = #{nofStvdGwker, jdbcType=NUMERIC},
			STVD_NON_TON    = #{stvdNonTon, jdbcType=NUMERIC},
			TRMG_COMP       = #{trmgComp, jdbcType=VARCHAR},
			NOF_HATCH       = #{nofHatch, jdbcType=NUMERIC},
			NOF_TRMG_SPRR   = #{nofTrmgSprr, jdbcType=NUMERIC},
			NOF_SGLMN       = #{nofSglmn, jdbcType=NUMERIC},
			NOF_DEKMN       = #{nofDekmn, jdbcType=NUMERIC},
			NOF_HOPMN       = #{nofHopmn, jdbcType=NUMERIC},
			NOF_TRMG_GWKER  = #{nofTrmgGwker, jdbcType=VARCHAR},
			TRMG_NON_TON    = #{trmgNonTon, jdbcType=NUMERIC},
			LOC_ID          = #{locId, jdbcType=VARCHAR},
			UPDATE_TIME     = SYSDATE,
			STAFF_CD     	= #{userId, jdbcType=VARCHAR}
		WHERE MEGA_NO = #{megaNo}
		AND SEQ = #{seq}
		AND DIV_CD = 'SD'
	</update>
		
	<update id="updateMegaEquipmentItem"  parameterType="megaItem">
		UPDATE /*mega.updateMegaEquipmentItem*/
		TMT_MEGA_DTL SET 
			EQ_DIV_CD       = #{eqDivCd},
			CAPA_CD         = #{capaCd},
			LOC_DIV_CD      = #{locDivCd},
			LOC_ID          = #{locId},
			REQ_HHMM        = #{dspReqhhmm},
			REQ_QTY         = #{reqQty},
			CONFM_QTY       = #{confmQty},
			WH_CHG_YN       = #{whChgYn},
			WH_QTY          = #{whQty},
			OPE_COMP        = #{opeCompCd},
			UPDATE_TIME     = SYSDATE,
			STAFF_CD     	= #{userId},
			FL_STATUS       = #{flStatus},
			START_DATE 		= TO_DATE(#{workStDt}, 'dd/mm/yyyy hh24:mi'),
			END_DATE 		= TO_DATE(#{workEndDt}, 'dd/mm/yyyy hh24:mi')
		WHERE MEGA_NO = #{megaNo}
		AND DIV_CD = #{divCd}
		AND SEQ = #{seq}
	</update>

	<update id="updateMegaOperItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaOperItems*/
		TMT_MEGA_DTL_OPE SET 
			EQ_DIV_CD       = #{eqDivCd},
			CAPA_CD         = #{capaCd},
			OPE_DIV_CD      = #{opeDivCd},
			OPE_COMP        = #{opeCompCd},
			NOF_OPE         = #{nofOpe},
			UPDATE_TIME     = SYSDATE,
			STAFF_CD     	= #{userId}
		WHERE MEGA_NO = #{megaNo}
		AND MEGA_IDX = #{megaIdx}
		AND SEQ = #{seq}
	</update>
		
	<update id="updateMegaInternalEquipmentItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaInternalEquipmentItems*/
		TMT_MEGA_DTL SET 
			CONFM_QTY       = #{confmQty},
			WH_CHG_YN       = #{whChgYn},
			WH_QTY          = #{whQty},
			UPDATE_TIME          = SYSDATE,
			STAFF_CD     = #{userId}
		WHERE MEGA_NO = #{megaNo}
		AND SEQ = #{seq}
	</update>
	
	<update id="updateMegaHistoryMasterItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaHistoryMasterItems*/
		TMT_MEGA SET  
			UPDATE_TIME  = SYSDATE,
			STAFF_CD     = #{userId}
		WHERE MEGA_NO = #{megaNo}
	</update>
	
	<sql id="sqlUpdateMegaInternal">
		(
			SELECT COUNT(B.MEGA_NO)
			FROM TMT_MEGA A, TMT_MEGA_DTL B
			WHERE A.STAT_CD IN ('SU','RV')
			AND A.PURP_TP_CD IN (
				SELECT S_CD FROM TMT_CD_MSTD 
				WHERE L_CD='MT' 
				AND M_CD='MGPURP'
				AND S_CD_LGV IN ('MP')
			)
			AND A.MEGA_NO = B.MEGA_NO
			AND B.DIV_CD = 'EQ'
			AND (B.EQ_DIV_CD = 'FL' OR B.EQ_DIV_CD NOT IN ('GR', 'FL', 'TR','BG','CU','LL','PC','TX','SR'))
			AND B.MEGA_NO = #{megaNo}
			AND NVL(B.WH_QTY, 0) = 0
		)
	</sql>
	
	<update id="updateMegaInternalMasterItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaInternalMasterItems*/
		TMT_MEGA SET 
			UPDATE_TIME          = SYSDATE,
			STAFF_CD     = #{userId},
			VERSION         = #{newVersion},
			STAT_CD = (DECODE(<include refid="sqlUpdateMegaInternal"/>,0,'AP','RV')),
			MEGA_WH_YN = (DECODE(<include refid="sqlUpdateMegaInternal"/>,0,'Y',' '))
		WHERE MEGA_NO = #{megaNo}
	</update>

	<update id="updateCargoTonItems" parameterType="megaItem">
		UPDATE /*mega.updateCargoTonItems*/
		TMT_MEGA_DTL A SET 
			A.CG_TON = (
				SELECT SUM(CG_DESC_VAL) FROM TMT_MEGA_DTL
				WHERE MEGA_NO = A.MEGA_NO 
				AND DIV_CD = 'CD'
				AND CG_DESC IN ('DCG', 'LCG')
			),
			UPDATE_TIME      = SYSDATE,
			STAFF_CD = #{userId}
		WHERE A.MEGA_NO = #{megaNo}
		AND A.DIV_CD = 'VO'
	</update>
	
	<delete id="deleteMegaItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaItems*/
		FROM TMT_MEGA
		WHERE MEGA_NO = #{megaNo}
		<if test="version != null and version != ''">
			AND VERSION = #{version} 
		</if>
	</delete>
	
	<delete id="deleteMegaDetailItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaDetailItems*/
		FROM TMT_MEGA_DTL
		WHERE MEGA_NO = #{megaNo}
	</delete>
	
	<delete id="deleteMegaDtlOperItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaDtlOperItems*/
		FROM TMT_MEGA_DTL_OPE
		WHERE MEGA_NO = #{megaNo}
	</delete>
		
	<delete id="deleteMegaEquipmentItem"  parameterType="megaItem">
		DELETE /*mega.deleteMegaEquipmentItem*/
		FROM TMT_MEGA_DTL
		WHERE MEGA_NO = #{megaNo} 
		AND DIV_CD = #{divCd}
		AND SEQ = #{seq}
	</delete>
	
	<delete id="deleteMegaFlOperItem"  parameterType="megaItem">
		DELETE /*mega.deleteMegaFlOperItem*/
		FROM TMT_MEGA_DTL_OPE
		WHERE MEGA_NO = #{megaNo}
		AND MEGA_IDX = #{seq}
		AND EQ_DIV_CD = #{eqDivCd}
	</delete>
	
	<delete id="deleteMegaOperItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaOperItems*/
		FROM TMT_MEGA_DTL_OPE
		WHERE MEGA_NO = #{megaNo}
		AND MEGA_IDX = #{megaIdx}
		AND SEQ = #{seq}
	</delete>

	<delete id="deleteMegaCgDtlItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaCgDtlItems*/
		FROM TMT_MEGA_DTL
		WHERE MEGA_NO = #{megaNo}
		AND HATCH_NO = #{hatchNo}
		AND CG_DESC = #{cgDescCd}
	</delete>	
	
	<select id="selectOldPenaltyCd"  parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectOldPenaltyCd*/
			MEGA_NO AS MEGANO, PENALTY AS oldPenaltyCd
		FROM TMT_MEGA
		WHERE MEGA_NO = #{megaNo}
	</select>   
	
	<sql id="sqlMegaDtlRpt4EQ">
		SELECT 
        	A.MEGA_NO megaNo
	        ,TO_CHAR (TO_DATE (B.WORK_YMD, 'YYYYMMDD'), 'DD/MM/YYYY') workYmd
	        ,B.SHFT_ID shftId
	        ,(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) shftNm
	        ,B.PURP_TP_CD purpTpCd
	        ,F_CM_012 ('MT', 'MGPURP', B.PURP_TP_CD) purpTpCdNm
	        ,B.STAT_CD statCd
	        ,F_CM_012 ('MT', 'MEGASTAT', B.STAT_CD) statCdNm
	        <if test='vslCallId != "STRG"'>
		    	,B.VSL_CALL_ID vslCallId
		        ,(SELECT VSL_NM FROM TMT_VSL_PART WHERE VSL_CD = C.VSL_CD) vslNm
	    	</if>
	    	<if test='vslCallId == "STRG"'>
		    	,'STRG' vslCallId
		        ,'STRG' vslNm
	    	</if>
        	,NVL ((SELECT (USER_ID || '/' || ENG_NM)
				FROM TMT_USER_INFO
				WHERE USER_ID = B.SUMIT_BY
			),B.SUMIT_BY) AS reqr
        	,NVL ((SELECT A1.ENG_SNM
				FROM TMT_PTNR A1, TMT_PTNR_USER B1
				WHERE     B1.USER_ID = B.SUMIT_BY
				AND A1.PTNR_CODE = B1.PTNR_CODE
				AND ROWNUM = 1
			), B.SUMIT_BY) reqComp
	        ,B.RMK AS rmk
	        ,TO_CHAR (B.SUMIT_DT, 'DD/MM/YYYY HH24:MI') reqDt
	        ,TO_CHAR (B.AMD_DT, 'DD/MM/YYYY HH24:MI') amdDt
	        ,B.AMD_BY amdBy
	        ,B.APPRV_BY appr
	        ,TO_CHAR (B.APPRV_DT, 'DD/MM/YYYY HH24:MI') appDt
	        ,B.PENALTY penaltyCd
        	,NVL((SELECT S_CD_NM FROM TMT_CD_MSTD 
				WHERE M_CD ='PNTYTP' 
				AND S_CD = B.PENALTY
			), ' ') AS penaltyNm
	        ,B.CNCL_BY cnclBy
	        ,TO_CHAR (B.CNCL_DT, 'DD/MM/YYYY HH24:MI') cnclDt
	        ,B.REJ_BY rejBy
	        ,TO_CHAR (B.REJ_DT, 'DD/MM/YYYY HH24:MI') rejDt
	        ,B.REJ_RMK rejRmk
	        ,A.SEQ seq
			,A.DIV_CD divCd
			,A.EQ_DIV_CD eqDivCd
			,F_CM_012 ('MT', 'EQFCTPCD', A.EQ_DIV_CD) eqDivCdNm
			,NVL (A.CAPA_CD, ' ') capaCd,
			DECODE (A.EQ_DIV_CD,
                 'SR', 
                 '-',
                 (SELECT CAPA_DESCR FROM TMT_EQ_CAPA WHERE CAPA_CD = A.CAPA_CD AND EQ_TP_CD = A.EQ_DIV_CD)
			) capaDescr,
			TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm,
			DECODE (A.REQ_QTY, NULL, ' ', A.REQ_QTY) REQQTY,
			DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY,
			DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY,
			NVL (A.LOC_ID, ' ') LOCID,
			DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
   		<if test='vslCallId != "STRG"'>
   			,TMT_VSL_SCH C
   		</if>
		WHERE A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID = C.VSL_CALL_ID
  		</if>
		AND A.DIV_CD = 'EQ'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO = #{megaStr} 
		</if>
	</sql>
	
	<sql id="sqlMegaDtlRpt4SD">
	/*STEVEDORE*/
		SELECT 
			A.MEGA_NO megaNo
			,TO_CHAR (TO_DATE (B.WORK_YMD, 'YYYYMMDD'), 'DD/MM/YYYY') workYmd
			,B.SHFT_ID shftId
			,(SELECT SHFT_NM FROM TMT_SHFT WHERE SHFT_ID = B.SHFT_ID) shftNm
			,B.PURP_TP_CD purpTpCd
			,F_CM_012 ('MT', 'MGPURP', B.PURP_TP_CD) purpTpCdNm
			,B.STAT_CD statCd
			,F_CM_012 ('MT', 'MEGASTAT', B.STAT_CD) statCdNm
			<if test='vslCallId != "STRG"'>
				,B.VSL_CALL_ID vslCallId
				,(SELECT VSL_NM FROM TMT_VSL_PART WHERE VSL_CD = C.VSL_CD) vslNm
			</if>
			<if test='vslCallId == "STRG"'>
				,'STRG' vslCallId
				,'STRG' vslNm
			</if>
			,NVL ((SELECT (USER_ID || '/' || ENG_NM)
				FROM TMT_USER_INFO
				WHERE USER_ID = B.SUMIT_BY
			), B.SUMIT_BY) AS reqr
			,NVL ((SELECT A1.ENG_SNM
				FROM TMT_PTNR A1, TMT_PTNR_USER B1
				WHERE B1.USER_ID = B.SUMIT_BY
		        AND A1.PTNR_CODE = B1.PTNR_CODE
		        AND ROWNUM = 1
			), B.SUMIT_BY) reqComp
			,B.RMK AS rmk
			,TO_CHAR (B.SUMIT_DT, 'DD/MM/YYYY HH24:MI') reqDt
			,TO_CHAR (B.AMD_DT, 'DD/MM/YYYY HH24:MI') amdDt
			,B.AMD_BY amdBy
			,B.APPRV_BY appr
			,TO_CHAR (B.APPRV_DT, 'DD/MM/YYYY HH24:MI') appDt
			,B.PENALTY penaltyCd
			,NVL((SELECT S_CD_NM FROM TMT_CD_MSTD 
				WHERE M_CD ='PNTYTP' 
				AND S_CD = B.PENALTY
			), ' ') AS penaltyNm
			,B.CNCL_BY cnclBy
			,TO_CHAR (B.CNCL_DT, 'DD/MM/YYYY HH24:MI') cnclDt
			,B.REJ_BY rejBy
			,TO_CHAR (B.REJ_DT, 'DD/MM/YYYY HH24:MI') rejDt
			,B.REJ_RMK rejRmk
			,A.SEQ seq
			,A.DIV_CD divCd
			,A.EQ_DIV_CD eqDivCd
	</sql>
	
	<select id="selectMegaDtlRpt" parameterType="megaParm" resultType="megaItem">
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD = 'FL'
		UNION ALL
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD = 'TR'
		UNION ALL
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD = 'GR'
		UNION ALL
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD NOT IN ('GR', 'FL', 'TR', 'BG', 'CU', 'LL', 'PC', 'TX', 'SR')
        UNION ALL
        <include refid="sqlMegaDtlRpt4EQ" />
		AND (
			A.EQ_DIV_CD = 'SR' 
			OR EXISTS (
				SELECT S_CD FROM TMT_CD_MSTD
				WHERE L_CD = 'MT' 
				AND M_CD = 'EQFCTPCD'
				AND S_CD = A.EQ_DIV_CD
				AND S_CD_VAL = 'PC'
			)
		)      
        UNION ALL
        <include refid="sqlMegaDtlRpt4SD" />
			,'STEVEDORE' eqDivCdNm,
			,NVL (A.CAPA_CD, ' ') capaCd
			,A.STVD_COMP capaDescr
			,TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm
			,TO_CHAR(A.NOF_GANG) REQQTY
			,DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY
			,DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY
			,NVL (A.LOC_ID, ' ') LOCID
			,DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
		<if test='vslCallId != "STRG"'>
			,TMT_VSL_SCH C
		</if>
		WHERE A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID = C.VSL_CALL_ID
   		</if>
		AND A.DIV_CD = 'SD'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO = #{megaStr} 
		</if>
		AND A.NOF_OPR_SPRR IS NOT NULL
		AND (A.STVD_COMP IS NOT NULL
			OR A.LOC_ID IS NOT NULL
			OR A.NOF_GANG != 0
			OR A.NOF_STVD_SPRR != 0
			OR A.STVD_NON_TON != 0
		)
		UNION ALL
		<include refid="sqlMegaDtlRpt4SD" />
			,'STEVEDORE' eqDivCdNm
			,NVL (A.CAPA_CD, ' ') capaCd
			,'ADDITIONAL SUPERVISOR' capaDescr
			,TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm
			,TO_CHAR(A.NOF_STVD_SPRR) REQQTY
			,DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY
			,DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY
			,NVL (A.LOC_ID, ' ') LOCID
			, DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
   		<if test='vslCallId != "STRG"'>
   			, TMT_VSL_SCH C
   		</if>
		WHERE A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID = C.VSL_CALL_ID
   		</if>
		AND A.DIV_CD = 'SD'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO = #{megaStr} 
		</if>
		AND A.NOF_OPR_SPRR IS NOT NULL
		AND ( A.STVD_COMP IS NOT NULL
			OR A.LOC_ID IS NOT NULL
			OR A.NOF_GANG != 0
			OR A.NOF_STVD_SPRR != 0
			OR A.STVD_NON_TON != 0
		)
		AND A.NOF_STVD_SPRR != 0
		UNION ALL
        <include refid="sqlMegaDtlRpt4SD" />
			,'STEVEDORE' eqDivCdNm
			,NVL (A.CAPA_CD, ' ') capaCd
			,'ADDITIONAL NON TONNAGE' capaDescr
			,TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm
			,TO_CHAR(A.STVD_NON_TON) REQQTY
			,DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY
			,DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY
			,NVL (A.LOC_ID, ' ') LOCID
			,DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
  		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH C
   		</if>
		WHERE     A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID = C.VSL_CALL_ID
   		</if>
		AND A.DIV_CD = 'SD'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
            AND A.MEGA_NO = #{megaStr} 
		</if>
		AND A.NOF_OPR_SPRR IS NOT NULL
		AND (A.STVD_COMP IS NOT NULL
			OR A.LOC_ID IS NOT NULL
			OR A.NOF_GANG != 0
			OR A.NOF_STVD_SPRR != 0
			OR A.STVD_NON_TON != 0
		)
		AND A.STVD_NON_TON != 0
        UNION ALL
        <include refid="sqlMegaDtlRpt4SD" />
			,'TALLY' eqDivCdNm
			,NVL (A.CAPA_CD, ' ') capaCd
			,A.STVD_COMP capaDescr
			,TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm
			,TO_CHAR(A.STVD_NON_TON) REQQTY
			,DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY
			,DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY
			,NVL (A.LOC_ID, ' ') LOCID
			, DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
   		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH C
   		</if>
		WHERE A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID = C.VSL_CALL_ID
		</if>
		AND A.DIV_CD = 'SD'
		AND NVL(A.TALLY_YN, 'N') = 'Y'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO = #{megaStr} 
		</if>
		UNION ALL
        <include refid="sqlMegaDtlRpt4SD" />
			,'LASHING/UNLASHING/CHOKING' eqDivCdNm
			,NVL (A.CAPA_CD, ' ') capaCd
			,A.STVD_COMP capaDescr
			,TO_CHAR (TO_DATE (A.REQ_HHMM, 'HH24MI'), 'HH24MI') dspReqhhmm
			,TO_CHAR(A.NOF_GANG) REQQTY
			,DECODE (A.CONFM_QTY, NULL, ' ', A.CONFM_QTY) CONFMQTY
			,DECODE (A.WH_QTY, NULL, ' ', A.WH_QTY) WHQTY
			,NVL (A.LOC_ID, ' ') LOCID
			,DECODE(A.FL_STATUS, 'Y', 'YES', 'N', 'NO') FLSTATUS
		FROM TMT_MEGA_DTL A, TMT_MEGA B
   		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH C
   		</if>
		WHERE A.MEGA_NO = B.MEGA_NO
		<if test='vslCallId != "STRG"'>
			AND B.VSL_CALL_ID = C.VSL_CALL_ID
		</if>
		AND A.DIV_CD = 'SD'
		AND NVL(A.LASHING_YN, 'N') = 'Y'
		AND B.VSL_CALL_ID = #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO = #{megaStr} 
		</if>
	</select>
	
	<select id="selectValidationCode" parameterType="megaParm" resultType="megaItem">
		<if test='tyCd == "checkMegaPayer"'>
			SELECT /*mega.selectValidationCode*/
				DECODE(US.USER_TYPE, 
					'E', (SELECT DECODE(COUNT(*), 0, 'N', 'Y') FROM TMT_PTNR_USER WHERE USER_ID = US.USER_ID), 
					'Y') AS ISVALIDATED 
			FROM TMT_USER_INFO US
			WHERE US.USER_ID = #{userId} 
		</if>
		<if test='tyCd == "checkShipgAgent"'>
			SELECT DECODE( /*mega.selectValidationCode*/
				US.USER_TYPE, 
				'E', DECODE(
					(
						SELECT DECODE(COUNT(*), 0, 'N', 'Y') 
						FROM TMT_PTNR_USER 
						WHERE PTNR_TYPE IN ( 'FWD' , 'CNS' )
						AND USER_ID = US.USER_ID), 'N', 
						(
							SELECT DECODE(COUNT(*), 0, 'N', 'Y') FROM TMT_VSL_SCH SH
							WHERE VSL_CALL_ID = #{vslCallId}
							AND EXISTS (
								SELECT '1' 
								FROM TMT_AGENCY_INFO 
								WHERE PTNR_TYPE = 'SHA' 
								AND USER_ID = US.USER_ID
								AND AGENCY_CODE = SH.ARRV_SA_ID
							)
						), 'Y'),
				'Y')  AS ISVALIDATED 
			FROM TMT_USER_INFO US
			WHERE US.USER_ID = #{userId}
		</if>
		<if test='tyCd == "createDocument"'>
			<if test="vslCallId != null and vslCallId != ''">
				<if test='cgTpCd == "CTR"'>
					SELECT /*mega.selectValidationCode*/
						CASE 
							WHEN (ETA - SYSDATE) > 0 THEN
	             				CASE 
	             					WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL(
										(SELECT KEY_VAL
										FROM TMT_CFG_DTL
		                                WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
	                				ELSE 'N'
	             				END
             			ELSE 
             				CASE
                				WHEN (
                					SELECT KEY_VAL
                        			FROM TMT_CFG_DTL
                       				WHERE SYS_CD = 'MPTS'
                             		AND KEY_NM = #{cgTpCd}
                             		AND ROWNUM = 1) = 0 THEN 'Y'
								ELSE 'N'
							END
             			END AS isValidated
                    FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "DBE"'>
					SELECT /*mega.selectValidationCode*/
						CASE
          					WHEN (ETA - SYSDATE) > 0 THEN
             					CASE
                					WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                              			(SELECT KEY_VAL
                                 		FROM TMT_CFG_DTL
                                		WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
                					ELSE 'N'
								END
						ELSE
							CASE
				                WHEN (
				                	SELECT KEY_VAL
									FROM TMT_CFG_DTL
									WHERE SYS_CD = 'MPTS'
									AND KEY_NM = #{cgTpCd}
									AND ROWNUM = 1) = 0 THEN 'Y'
				                ELSE 'N'
							END
						END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "DBN"'>
					SELECT /*mega.selectValidationCode*/
						CASE
          					WHEN (ETA - SYSDATE) > 0 THEN
             					CASE
                					WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                              			(SELECT KEY_VAL
                               			FROM TMT_CFG_DTL
                               			WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
                					ELSE 'N'
             					END
         					ELSE
             					CASE
                					WHEN (
                						SELECT KEY_VAL
                        				FROM TMT_CFG_DTL
										WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1) = 0 THEN 'Y'
                					ELSE 'N'
								END
             				END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "BBK"'>
					SELECT /*mega.selectValidationCode*/
						CASE
							WHEN (ETA - SYSDATE) > 0 THEN
             					CASE
                					WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                              			(SELECT KEY_VAL
										FROM TMT_CFG_DTL
										WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
									ELSE 'N'
             					END
						ELSE
             				CASE
								WHEN (
									SELECT KEY_VAL
									FROM TMT_CFG_DTL
									WHERE     SYS_CD = 'MPTS'
									AND KEY_NM = #{cgTpCd}
									AND ROWNUM = 1) = 0 THEN 'Y'
								ELSE 'N'
							END
						END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "LQE"'>
					SELECT /*mega.selectValidationCode*/
						CASE
          					WHEN (ETA - SYSDATE) > 0 THEN
             					CASE
                					WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                              			(SELECT KEY_VAL
                                 		FROM TMT_CFG_DTL
                                		WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
               						ELSE 'N'
             					END
         					ELSE
            					CASE
               					WHEN (
               						SELECT KEY_VAL
                       				FROM TMT_CFG_DTL
                      					WHERE SYS_CD = 'MPTS'
									AND KEY_NM = #{cgTpCd}
									AND ROWNUM = 1) = 0 THEN 'Y'
               					ELSE 'N'
                				END
            				END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "LQN"'>
					SELECT /*mega.selectValidationCode*/
						CASE
        						WHEN (ETA - SYSDATE) > 0 THEN
            						CASE
               						WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                             				(SELECT KEY_VAL
                                			FROM TMT_CFG_DTL
                               			WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
               						ELSE 'N'
            						END
         						ELSE
            						CASE
					                WHEN (
					                	SELECT KEY_VAL
				                        FROM TMT_CFG_DTL
				                       	WHERE     SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1) = 0 THEN 'Y'
               						ELSE 'N'
                					END
							END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "OIMR"'>
					SELECT /*mega.selectValidationCode*/
						CASE
         						WHEN (ETA - SYSDATE) > 0 THEN
            						CASE
               						WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
                             				(SELECT KEY_VAL
										FROM TMT_CFG_DTL
		                                WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
               						ELSE 'N'
            						END
         						ELSE
	             				CASE
					                WHEN (
					                	SELECT KEY_VAL
				                        FROM TMT_CFG_DTL
										WHERE     SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1) = 0 THEN 'Y'
	                				ELSE 'N'
	                 			END
	             			END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
				<if test='ptnrCode == "BT"'>
					SELECT /*mega.selectValidationCode*/
						CASE
							WHEN (ETA - SYSDATE) > 0 THEN
								CASE
									WHEN (ETA - SYSDATE) <![CDATA[>=]]> (NVL (
										(SELECT KEY_VAL
										FROM TMT_CFG_DTL
										WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1), 0) / 24) THEN 'Y'
               						ELSE 'N'
           						END
         						ELSE
            						CASE
					                WHEN (
					                	SELECT KEY_VAL
				                        FROM TMT_CFG_DTL
										WHERE SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
										AND ROWNUM = 1) = 0 THEN 'Y'
               						ELSE 'N'
                					END
							END AS isValidated
					FROM TMT_VSL_SCH WHERE VSL_CALL_ID = #{vslCallId}
				</if>
			</if>
		</if>
		<if test='tyCd == "EXISTED_ACCOUNTNO_PTNR_VALIDATION"'>
			WITH PTNR_INFO AS
			(
			    SELECT  PTNR_CODE, ACC_NO
			    FROM    TMT_PTNR
			    WHERE   PTNR_CODE = #{ptnrCode}
			            AND ACC_NO IS NOT NULL
			    UNION
			    SELECT  AGENCY_CODE PTNR_CODE, ACC_NO
			    FROM    TMT_AGENCY_INFO
			    WHERE   AGENCY_CODE = #{ptnrCode}
			            AND ACC_NO IS NOT NULL
			)
			SELECT /*mega.selectValidationCode*/
				CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END AS isValidated
			FROM    PTNR_INFO
		</if>	
	</select>
	
	<select id="selectConfirmationSlipDryBreakBulk"  parameterType="megaParm" resultMap="ConfirmationSlipDetailMap"> 
		SELECT A.VSL_CALL_ID                          AS VSLCALLID, 
		       B.SEQ                                  AS SEQ, 
		       B.CG_TP_CD                             AS CGTPCD, 
		       NVL(B.OPE_TP_CD,' ')                   AS OPETPCD,
		       (SELECT S_CD_NM FROM TMT_CD_MSTD WHERE L_CD='MT' AND M_CD='CGTP' AND S_CD=B.CG_TP_CD) AS CGTPNM, 
		       NVL(B.CMDT_CD,' ')                     AS CMDTCD,
		       NVL((SELECT  DISTINCT D.CMDT_GRP_CD
					FROM TMT_CMDT D
					WHERE D.CMDT_CD = B.CMDT_CD), ' ') AS CMDTGRCD,
		       NVL((SELECT  DISTINCT D.CMDT_GRP_DESC
					FROM TMT_CMDT D
					WHERE D.CMDT_CD = B.CMDT_CD), ' ') AS CMDTGR,
		       NVL(B.PKG_TP_CD,' ')					  AS PKGTPCD,
		       NVL(B.OPE_HR,0)                        AS OPEHR, 
		       NVL(B.WORK_DD,0)                       AS WORKDD, 
		       NVL(B.WORK_HATCH_NO,' ')               AS WORKHATCHNO, 
		       NVL(B.QTY,0)                           AS QTY, 
		       B.CLN_CD                               AS CLNCD, 
		       B.TOP_CG_CD                            AS TOPCGCD, 
		       (CASE WHEN  B.CLN_CD='Y' THEN 'CLEAN' 
		       		 WHEN  B.TOP_CG_CD ='Y' THEN 'TOP' ELSE 
		       '' END )						  		  AS TOPCLN,
		       B.TMNL_OPR                             AS TMNLOPR, 
		       B.SHPR_CNSNE                           AS SHPRCNSNE, 
		       B.CNSNE                           	  AS CNSNE, 
		       B.UNNO                                 AS UNNO, 
		       B.IMDG                                 AS IMDG,
		       B.POL	                              AS POL, 
		       B.FDEST                                AS FDEST, 
		       NVL(B.CRC,0)                           AS CRC, 
		       NVL(B.BL_NO,' ')                       AS BLNO,
		       B.CG_OPT_TP_CD                         AS CGOPTTPCD,
		       F_CM_012('MT', 'CGOPETP', B.CG_OPT_TP_CD) CGOPTTPNM,
		       B.DG_SEQ								  AS DGSEQ,
		       (CASE WHEN C.SEQ IS NULL THEN 'N'
					 ELSE 'Y'
				END) 								  AS DGCHK,
				OPE_CATEGORY                          AS opeType,
				B.RMK 								  AS remark,
				F_GET_PARTNER_INFO(B.CNSNE, 'ENG_SNM')	AS CNSNENM,
				F_GET_PARTNER_INFO(B.CNSNE, 'ADDR')	AS CNSNEADDR,
				F_GET_PARTNER_INFO(B.SHPR_CNSNE, 'ENG_SNM')	AS SHPNM,
				F_GET_PARTNER_INFO(B.SHPR_CNSNE, 'ADDR')	AS SHPADDR,
				F_CM_012('MT', 'PKGTP', B.PKG_TP_CD) AS PKGTPNM
		  FROM TMT_CONFM_SLP A, TMT_CONFM_SLP_DTL B, TMT_DG C 
		 WHERE A.VSL_CALL_ID = B.VSL_CALL_ID
		   AND B.DG_SEQ = C.SEQ(+)
		   AND A.VSL_CALL_ID = #{vslCallId}
		<if test="cargoType != 'LIQUID'">
			AND B.CG_TP_CD IN ('BBK','DBE','DBN', 'CTR')
		</if>
		<if test="cargoType == 'LIQUID'">
			AND B.CG_TP_CD IN ('LQE','LQN')
		</if>
	</select>
</mapper>
