<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="serviceOrder">

	<resultMap id= "ServiceOrderMap" 				type= "serviceOrderItem">
		<result column= "ODR_NO" 					property= "odrNo"/>
		<result column= "CATEGORY1" 				property= "category1"/>
		<result column= "CATEGORY1_NM" 				property= "category1Nm"/>
		<result column= "CATEGORY2" 				property= "category2"/>
		<result column= "CATEGORY2_NM" 				property= "category2Nm"/>
		<result column= "CATEGORY3" 				property= "category3"/>
		<result column= "CATEGORY3_NM" 				property= "category3Nm"/>
		<result column= "SVC_DT_FMT" 				property= "svcDtFmt"/>
		<result column= "SVC_DT_TP" 				property= "svcDtTp"/>
		<result column= "DT1_CHK" 					property= "dt1Chk"/>
		<result column= "DT1_TIT" 					property= "dt1Tit"/>
		<result column= "DT1_FMT" 					property= "dt1Fmt"/>
		<result column= "DT1_TP" 					property= "dt1Tp"/>
		<result column= "DT2_CHK" 					property= "dt2Chk"/>
		<result column= "DT2_TIT" 					property= "dt2Tit"/>
		<result column= "DT2_FMT" 					property= "dt2Fmt"/>
		<result column= "DT2_TP" 					property= "dt2Tp"/>
		<result column= "SHFT_CHK" 					property= "shftChk"/>
		<result column= "UNIT_TIT" 					property= "unitTit"/>
		<result column= "UNIT_UOM" 					property= "unitUom"/>
		<result column= "UNIT_UOM_NM" 				property= "unitUomNm"/>
		<result column= "UNIT_DEC" 					property= "unitDec"/>
		<result column= "UNIT1_CHK" 				property= "unit1Chk"/>
		<result column= "UNIT1_TIT" 				property= "unit1Tit"/>
		<result column= "UNIT1_UOM" 				property= "unit1Uom"/>
		<result column= "UNIT1_UOM_NM" 				property= "unit1UomNm"/>
		<result column= "UNIT1_DEC" 				property= "unit1Dec"/>
		<result column= "UNIT2_CHK" 				property= "unit2Chk"/>
		<result column= "UNIT2_TIT" 				property= "unit2Tit"/>
		<result column= "UNIT2_UOM" 				property= "unit2Uom"/>
		<result column= "UNIT2_UOM_NM" 				property= "unit2UomNm"/>
		<result column= "UNIT2_DEC" 				property= "unit2Dec"/>
		<result column= "PAY_TP_CD" 				property= "payTpCd"/>
		<result column= "PAY_TP_NM" 				property= "payTpNm"/>
		<result column= "PRC_TP_CD" 				property= "prcTpCd"/>
		<result column= "PRC_TP_NM" 				property= "prcTpNm"/>
		<result column= "PRC_TP_DESC" 				property= "prcTpDesc"/>
		<result column= "LOC_CHK" 					property= "locChk"/>
		<result column= "RMK_CHK" 					property= "rmkChk"/>
		<result column= "CMDTY_CHK" 				property= "cmdtyChk"/>
		<result column= "EQ_DIV_CD" 				property= "eqDivCd"/>
		<result column= "EQ_DIV_CD_NM" 				property= "eqDivCdNm"/>
		<result column= "ODR_NO" 					property= "odrNo"/>
		<result column= "VSL_CALL_ID" 				property= "vslCallId"/>
		<result column= "VSL_NM" 					property= "vslNm"/>
		<result column= "STAT_CD" 					property= "statCd"/>
		<result column= "STAT_NM" 					property= "statNm"/>
		<result column= "PAYER" 					property= "payer"/>
		<result column= "PAYER_NM" 					property= "payerNm"/>
		<result column= "SVC_DT_FM" 				property= "svcDtFm"/>
		<result column= "SVC_DT_TO" 				property= "svcDtTo"/>
		<result column= "DT1_FM" 					property= "dt1Fm"/>
		<result column= "DT1_TO" 					property= "dt1To"/>
		<result column= "DT2_FM" 					property= "dt2Fm"/>
		<result column= "DT2_TO" 					property= "dt2To"/>
		<result column= "SHFT_ID" 					property= "shftId"/>
		<result column= "SHFT_NM" 					property= "shftNm"/>
		<result column= "UNIT" 						property= "unit"/>
		<result column= "UNIT1" 					property= "unit1"/>
		<result column= "UNIT2" 					property= "unit2"/>
		<result column= "CAPA_CD" 					property= "capaCd"/>
		<result column= "CAPA_DESCR" 				property= "capaDescr"/>
		<result column= "LOC" 						property= "loc"/>
		<result column= "LOC_ID" 					property= "locId"/>
		<result column= "CMDTY_CD" 					property= "cmdtyCd"/>
		<result column= "CMDTY_NM" 					property= "cmdtyNm"/>
		<result column= "COM_CMDTY_CD" 				property= "comCmdtyCd"/>
		<result column= "COM_CMDTY_NM" 				property= "comCmdtyNm"/>
		<result column= "REQ_RMK" 					property= "reqRmk"/>
		<result column= "RMK" 						property= "rmk"/>
		<result column= "COM_CHK" 					property= "comChk"/>
		<result column= "COM_SVC_DT_FM" 			property= "comSvcDtFm"/>
		<result column= "COM_SVC_DT_TO" 			property= "comSvcDtTo"/>
		<result column= "COM_DT1_FM" 				property= "comDt1Fm"/>
		<result column= "COM_DT1_TO" 				property= "comDt1To"/>
		<result column= "COM_DT2_FM" 				property= "comDt2Fm"/>
		<result column= "COM_DT2_TO" 				property= "comDt2To"/>
		<result column= "COM_SHFT_ID" 				property= "comShftId"/>
		<result column= "COM_SHFT_NM" 				property= "comShftNm"/>
		<result column= "COM_UNIT" 					property= "comUnit"/>
		<result column= "COM_UNIT1" 				property= "comUnit1"/>
		<result column= "COM_UNIT2" 				property= "comUnit2"/>
		<result column= "COM_CAPA_CD" 				property= "comCapaCd"/>
		<result column= "COM_CAPA_DESCR" 			property= "comCapaDescr"/>
		<result column= "COM_LOC" 					property= "comLoc"/>
		<result column= "COM_RMK" 					property= "comRmk"/>
		<result column= "SUMIT_BY" 					property= "sumitBy"/>
		<result column= "SUMIT_DT" 					property= "sumitDt"/>
		<result column= "APPRV_BY" 					property= "apprvBy"/>
		<result column= "APPRV_DT" 					property= "apprvDt"/>
		<result column= "REJ_BY" 					property= "rejBy"/>
		<result column= "REJ_DT" 					property= "rejDt"/>
		<result column= "CNCL_BY" 					property= "cnclBy"/>
		<result column= "CNCL_DT" 					property= "cnclDt"/>
		<result column= "COM_BY" 					property= "comBy"/>
		<result column= "COM_DT" 					property= "comDt"/>
		<result column= "OWNER_YN" 					property= "ownerYn"/>
		<result column= "VIEW_TYPE" 				property= "viewType"/>
		<result column= "USER_ROLE" 				property= "userRole"/>
		<result column= "COM_LOC_ID" 				property= "comLocId"/>
		<result column= "REQ_DOC_NO" 				property= "reqDocNo"/>
		<result column= "REQ_UNIT_NO" 				property= "reqUnitNo"/>
		<result column= "COM_DOC_NO" 				property= "comDocNo"/>
		<result column= "COM_UNIT_NO" 				property= "comUnitNo"/>
		<result column= "STAFF_CD" 					property= "userId"/>
	</resultMap>

	<select id="selectSvcOdrNo" parameterType="serviceOrderParm" resultMap="ServiceOrderMap">
		SELECT
			('ODR' + FORMAT(SYSDATETIME(), 'yyMM')
			     +
			 '-'
			     + TRIM(FORMAT(ISNULL(MAX(CAST(SUBSTRING(ODR_NO, 9, 4) AS INT) + 1), 1), '0000'))
			    ) 				AS ODR_NO
		FROM
		    TMT_SVC_ODR
		WHERE
			SUBSTRING(ODR_NO, 1, 7) = ('ODR' + FORMAT(SYSDATETIME(), 'yyMM'))
	</select>

	<sql id="sqlServiceOrderInfo">
		SELECT /*serviceOrder.sqlServiceOrderInfo*/
			A.ODR_NO,
			A.VSL_CALL_ID,
			(SELECT
				VSL_NM
			FROM
				TMT_VSL_SCH VS,
				TMT_VSL_PART VP
			WHERE
				VS.VSL_CALL_ID 							= A.VSL_CALL_ID
				AND VS.VSL_CD 							= VP.VSL_CD
			) 											AS VSL_NM,
			STAT_CD,
			DBO.F_CM_CODE_NM('MT', 
							'DOCSTAT', 
							STAT_CD) 					AS STAT_NM,
			ISNULL((
				SELECT
					(USER_ID + '/' + ENG_NM) 
				FROM 
				    TMT_USER_INFO 
				WHERE
				    USER_ID 							= SUMIT_BY
				)
			, SUMIT_BY) 								AS SUMIT_BY,
			FORMAT(SUMIT_DT, 'dd/MM/yyyy HH:mm') 		AS SUMIT_DT,
			ISNULL((
				SELECT
					(USER_ID + '/' + ENG_NM)
				FROM
				    TMT_USER_INFO
				WHERE
				    USER_ID 							= APPRV_BY
				)
			, APPRV_BY) 								AS APPRV_BY,
			FORMAT(APPRV_DT, 'dd/MM/yyyy HH:mm') 		AS APPRV_DT,
			ISNULL((
				SELECT
					(USER_ID + '/' + ENG_NM)
				FROM
				    TMT_USER_INFO
				WHERE
				    USER_ID 							= REJ_BY
				)
			, REJ_BY) 									AS REJ_BY,
			FORMAT(REJ_DT, 'dd/MM/yyyy HH:mm') 			AS REJ_DT,
			ISNULL((
				SELECT
					(USER_ID + '/' + ENG_NM)
				FROM
				    TMT_USER_INFO
				WHERE
				    USER_ID 							= CNCL_BY
				)
			, CNCL_BY) 									AS CNCL_BY,
			FORMAT(CNCL_DT, 'dd/MM/yyyy HH:mm') 		AS CNCL_DT,
			ISNULL((
				SELECT
					(USER_ID + '/' + ENG_NM)
				FROM
				    TMT_USER_INFO
				WHERE
				    USER_ID 							= COM_BY
				)
			, COM_BY) 									AS COM_BY,
			FORMAT(COM_DT, 'dd/MM/yyyy HH:mm') 				AS COM_DT,
			PAYER,
			ISNULL((
				SELECT
				    MAX(ENG_SNM)
				FROM
				    TMT_AGENCY_INFO
				WHERE
				    AGENCY_CODE 						= PAYER)
			, ISNULL((
				SELECT
				    MAX(ENG_SNM)
				FROM
				    TMT_PTNR
				WHERE
				    PTNR_CODE 							= PAYER
				)
			, ' ')) 									AS PAYER_NM,
			CATEGORY1,
			DBO.F_CM_CODE_NM('MT',
							'SVCORDCTG1',
							CATEGORY1) 					AS CATEGORY1_NM,
			CATEGORY2,
			DBO.F_CM_CODE_NM('MT',
							'SVCORDCTG2',
							CATEGORY2) 					AS CATEGORY2_NM,
			CATEGORY3,
			DBO.F_CM_CODE_NM('MT',
							'SVCORDCTG3',
							CATEGORY3) 					AS CATEGORY3_NM,
			SVC_DT_FMT,
			SVC_DT_TP,
			DT1_CHK,
			DT1_TIT,
			DT1_FMT,
			DT1_TP,
			DT2_CHK,
			DT2_TIT,
			DT2_FMT,
			DT2_TP,
			SHFT_CHK,
			UNIT_TIT,
			UNIT_UOM,
			DBO.F_CM_CODE_NM('MT',
							'UOMTP',
							UNIT_UOM) 					AS UNIT_UOM_NM,
			UNIT_DEC,
			UNIT1_CHK,
			UNIT1_TIT,
			UNIT1_UOM,
			DBO.F_CM_CODE_NM('MT',
							'UOMTP',
							UNIT1_UOM) 					AS UNIT1_UOM_NM,
			UNIT1_DEC,
			UNIT2_CHK,
			UNIT2_TIT,
			UNIT2_UOM,
			DBO.F_CM_CODE_NM('MT',
							'UOMTP',
							UNIT2_UOM) 					AS UNIT2_UOM_NM,
			UNIT2_DEC,
			EQ_DIV_CD,
			DBO.F_CM_CODE_NM('MT',
							'EQFCTPCD',
							A.EQ_DIV_CD)				AS EQ_DIV_CD_NM,
			ISNULL(CAPA_CD, '') 						AS CAPA_CD,
			(SELECT
				CAPA_DESCR
			FROM
				TMT_EQ_CAPA
			WHERE
				CAPA_CD 								= A.CAPA_CD
				AND EQ_TP_CD 							= A.EQ_DIV_CD
			) 											AS CAPA_DESCR,
			PAY_TP_CD,
			DBO.F_CM_CODE_NM('MT',
							'PAYTP',
							PAY_TP_CD)					AS PAY_TP_NM,
			PRC_TP_CD,
			DBO.F_CM_CODE_NM('MT',
							'ODRPRCTP',
							PRC_TP_CD)					AS PRC_TP_NM,
			(SELECT
				S_CD_DESC
			FROM
				TMT_CD_MSTD
			WHERE
				L_CD 									= 'MT'
				AND M_CD 								= 'ODRPRCTP'
				AND S_CD 								= PRC_TP_CD
			) 											AS PRC_TP_DESC,
			LOC_CHK,
			RMK_CHK,
			CMDTY_CHK,
			(CASE SVC_DT_FMT
				WHEN 'd/m/Y' THEN FORMAT(SVC_DT_FM, 'dd/MM/yyyy')
				ELSE FORMAT(SVC_DT_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS SVC_DT_FM,
			(CASE SVC_DT_FMT
				WHEN 'd/m/Y' THEN FORMAT(SVC_DT_TO, 'dd/MM/yyyy')
				ELSE FORMAT(SVC_DT_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS SVC_DT_TO,
			(CASE DT1_FMT
				WHEN 'd/m/Y' THEN FORMAT(DT1_FM, 'dd/MM/yyyy')
				ELSE FORMAT(DT1_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS DT1_FM,
			(CASE DT1_FMT
				WHEN 'd/m/Y' THEN FORMAT(DT1_TO, 'dd/MM/yyyy')
				ELSE FORMAT(DT1_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS DT1_TO,
		    (CASE DT2_FMT
				WHEN 'd/m/Y' THEN FORMAT(DT1_TO, 'dd/MM/yyyy')
				ELSE FORMAT(DT2_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS DT2_FM,
		    (CASE DT2_FMT
				WHEN 'd/m/Y' THEN FORMAT(DT1_TO, 'dd/MM/yyyy')
				ELSE FORMAT(DT2_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS DT2_TO,
			SHFT_ID,
			(SELECT
			    SH.SHFT_NM
			FROM
			    TMT_SHFT SH
			WHERE
				SH.SHFT_ID 								= A.SHFT_ID
			) 											AS SHFT_NM,
			UNIT,
			UNIT1,
			UNIT2,
			LOC_ID,
			REQ_RMK,
			COM_CHK,
			CMDTY_CD,
			DBO.F_GET_CMDT_DESC(CMDTY_CD) 				AS CMDTY_NM,
			COM_CMDTY_CD 								AS COM_CMDTY_CD,
			DBO.F_GET_CMDT_DESC(COM_CMDTY_CD) 			AS COM_CMDTY_NM,
			(CASE 
				WHEN SVC_DT_FMT = 'd/m/Y' AND (COM_SVC_DT_FM IS NOT NULL AND COM_SVC_DT_FM != '') THEN FORMAT(COM_SVC_DT_FM, 'dd/MM/yyyy')
				WHEN (COM_SVC_DT_FM IS NOT NULL AND COM_SVC_DT_FM != '') THEN FORMAT(COM_SVC_DT_FM, 'dd/MM/yyyy HH:mm')
				ELSE FORMAT(COM_SVC_DT_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_SVC_DT_FM,
		    (CASE
				WHEN SVC_DT_FMT = 'd/m/Y' AND (COM_SVC_DT_TO IS NOT NULL AND COM_SVC_DT_TO != '') THEN FORMAT(COM_SVC_DT_TO, 'dd/MM/yyyy')
				WHEN (COM_SVC_DT_TO IS NOT NULL AND COM_SVC_DT_TO != '') THEN FORMAT(COM_SVC_DT_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_SVC_DT_TO,

		    (CASE
				WHEN SVC_DT_FMT = 'd/m/Y' AND (COM_DT1_FM IS NOT NULL AND COM_DT1_FM != '') THEN FORMAT(COM_DT1_FM, 'dd/MM/yyyy')
				WHEN (COM_DT1_FM IS NOT NULL AND COM_DT1_FM != '') THEN FORMAT(COM_DT1_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_DT1_FM,
		    (CASE
				WHEN DT1_FMT = 'd/m/Y' AND (COM_DT1_TO IS NOT NULL AND COM_DT1_TO != '') THEN FORMAT(COM_DT1_TO, 'dd/MM/yyyy')
				WHEN (COM_DT1_TO IS NOT NULL AND COM_DT1_TO != '') THEN FORMAT(COM_DT1_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_DT1_TO,
		    (CASE
				WHEN DT2_FMT = 'd/m/Y' AND (COM_DT2_FM IS NOT NULL AND COM_DT2_FM != '') THEN FORMAT(COM_DT2_FM, 'dd/MM/yyyy')
				WHEN (COM_DT2_FM IS NOT NULL AND COM_DT2_FM != '') THEN FORMAT(COM_DT2_FM, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_DT2_FM,
		    (CASE
				WHEN DT2_FMT = 'd/m/Y' AND (COM_DT2_TO IS NOT NULL AND COM_DT2_TO != '') THEN FORMAT(COM_DT2_TO, 'dd/MM/yyyy')
				WHEN (COM_DT2_TO IS NOT NULL AND COM_DT2_TO != '') THEN FORMAT(COM_DT2_TO, 'dd/MM/yyyy HH:mm')
			END) 										AS COM_DT2_TO,
			ISNULL (com_shft_id,
				(CASE
					WHEN (com_svc_dt_fm IS NULL OR com_svc_dt_fm = '') THEN NULL
					ELSE DBO.F_GET_SHIFT_CD (com_svc_dt_fm,'')
				END)
			)											AS COM_SHFT_ID,
			(SELECT
				MAX (SH.SHFT_NM)
			FROM
			    TMT_SHFT SH
			WHERE
			    SH.SHFT_ID =
			    			ISNULL(A.COM_SHFT_ID,
        						(CASE
        							WHEN (A.COM_SVC_DT_FM IS NULL OR A.COM_SVC_DT_FM = '')
        								THEN NULL
        							ELSE DBO.F_GET_SHIFT_CD(A.COM_SVC_DT_FM,'')
        						END)
        					)
			) 											AS COM_SHFT_NM,
			COM_UNIT,
			COM_UNIT1,
			COM_UNIT2,
			ISNULL(COM_CAPA_CD, '') 					AS COM_CAPA_CD,
			(SELECT
				CAPA_DESCR
			FROM
				TMT_EQ_CAPA
			WHERE
				CAPA_CD 								= A.COM_CAPA_CD
				AND EQ_TP_CD 							= A.EQ_DIV_CD
			) 											AS COM_CAPA_DESCR,
			COM_LOC_ID,
			COM_RMK,
			RMK,
			(CASE CRT_BY
				WHEN #{userId} THEN 'Y'
				ELSE 'N'
			END) 										AS OWNER_YN,
			VERSION,
			REQ_DOC_NO,
			COM_DOC_NO,
			REQ_UNIT_NO,
			COM_UNIT_NO,
			STAFF_CD
		FROM
			TMT_SVC_ODR A
		WHERE
			(A.ODR_NO IS NOT NULL AND A.ODR_NO <![CDATA[<>]]> '')
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID 							= #{vslCallId}
		</if>
		<if test="scn != null and scn != ''">
			AND A.SHIP_CALL_NO 							= #{scn}
		</if>
		<if test="svcDtFm != null and svcDtFm != ''">
			<if test="svcDtTo != null and svcDtTo != ''">
				AND SVC_DT_FM
					BETWEEN
				    	CONVERT(DATETIME, #{svcDtFm} + ' 00:00',103)
				    	AND
						CONVERT(DATETIME, #{svcDtTo} + ' 23:59',103)
			</if>
			<if test="svcDtTo == null or svcDtTo == ''">
				AND SVC_DT_FM
				    <![CDATA[ > ]]>
				    	CONVERT(DATETIME, #{svcDtFm} + ' 00:00',103)
			</if>
		</if>
		<if test="svcDtFm == null or svcDtFm == ''">
			<if test="svcDtTo != null and svcDtTo != ''">
				AND SVC_DT_FM
					<![CDATA[ < ]]>
						CONVERT(DATETIME, #{svcDtTo} + ' 23:59',103)
			</if>
		</if>
		<if test="shftId != null and shftId != ''">
			AND SHFT_ID 								= #{shftId}
		</if>
		<if test="statCd != null and statCd != ''">
			AND STAT_CD 								= #{statCd}
		</if>
		<if test="category1 != null and category1 != ''">
			AND CATEGORY1 								= #{category1}
		</if>
		<if test="category2 != null and category2 != ''">
			AND CATEGORY2 								= #{category2}
		</if>
		<if test="category3 != null and category3 != ''">
			AND CATEGORY3 								= #{category3}
		</if>
		<if test="alertYn == 'Y'">
			AND STAT_CD									= 'SU'
			AND DATEDIFF(DAY, SUMIT_DT, SYSDATETIME()) <![CDATA[ <= ]]> 180
		</if>
	</sql>

	<select id="selectRoadBunkeringList" parameterType="serviceOrderParm" resultMap="ServiceOrderMap">
		<include refid="sqlServiceOrderInfo"/>
			AND CATEGORY1 								= 'SM'
			AND CATEGORY2 								= 'MSM003'
			AND STAT_CD IN ('AP', 'CP')
			AND PRC_TP_CD IN ('A','C')
	</select>

	<select id="selectServiceOrderInfo" parameterType="serviceOrderParm" resultMap="ServiceOrderMap">
		<include refid="sqlServiceOrderInfo"/>
			AND SUMIT_BY = #{userId} 
		<if test="userRole == 'CS'">
			UNION ALL
			<include refid="sqlServiceOrderInfo"/>
				AND SUMIT_BY <![CDATA[ <> ]]> #{userId}
				AND STAT_CD <![CDATA[ <> ]]> 'CA'
				AND PRC_TP_CD IN ('A','C')
		</if>
		<if test="userRole == 'PS'">
			UNION ALL
			<include refid="sqlServiceOrderInfo"/>
				AND SUMIT_BY <![CDATA[ <> ]]> #{userId}
				AND STAT_CD <![CDATA[ <> ]]> 'CA'
				AND PRC_TP_CD IN ('B','C')
		</if>
		<if test="userRole == 'BS'">
			UNION ALL
			<include refid="sqlServiceOrderInfo"/>
				AND STAT_CD <![CDATA[ <> ]]> 'CA'
				AND SUMIT_BY <![CDATA[ <> ]]> #{userId}
		</if>
		ORDER BY
			A.ODR_NO DESC
	</select>

	<select id="selectServiceOrderItem" parameterType="serviceOrderParm" resultMap="ServiceOrderMap">
		/*serviceOrder.selectServiceOrderItem*/
		<include refid="sqlServiceOrderInfo"/>
			AND A.ODR_NO 								= #{odrNo}
	</select>
	
	<select id = "selectShippingNoteItems"  parameterType = "serviceOrderParm" resultType = "serviceOrderItem">
		SELECT /*serviceOrder.selectShippingNoteItems*/
			SHIPG_NOTE_NO								AS CD,
			SHIPG_NOTE_NO								AS CDNM
		FROM
			TMT_SHIPG_NOTE S
		WHERE
			VSL_CALL_ID									= #{vslCallId}
			AND S.CG_TP_CD NOT IN ('RCV','RMA')
	</select>

	<select id = "selectBLItems"  parameterType = "serviceOrderParm" resultType = "serviceOrderItem">
		SELECT /*serviceOrder.selectBLItems*/
			ISNULL(B.PARENT_ID, BL_NO)					AS CD,
			ISNULL(B.PARENT_ID, BL_NO)					AS CDNM
		FROM
			TMT_VSL_SCH A,
			TMT_BL B
		WHERE
			A.VSL_CALL_ID 								= #{vslCallId}
			AND A.VSL_CALL_ID 							= B.VSL_CALL_ID
			AND A.CALL_SEQ 								= B.CALL_SEQ
			AND A.CALL_YEAR 							= B.CALL_YEAR
			AND A.VSL_CD 								= B.VSL_CD
			AND B.CG_TP_CD NOT IN ('RCV','RMA')
	</select>

	<select id = "selectBLSNItems"  parameterType = "serviceOrderParm" resultType = "serviceOrderItem">
		SELECT /*serviceOrder.selectBLSNItems*/
			VSL_CALL_ID									AS VSLCALLID,
			BL_NO										AS BLSNNO
		FROM
			TMT_BL
		WHERE
			PARENT_ID 									= #{blSNNo}
			AND CG_TP_CD 								= 'RBK'

		UNION ALL 

		SELECT
			VSL_CALL_ID 								AS VSLCALLID,
			<!-- PARENT_ID											AS BLSNNO -->
			''											AS BLSNNO
		FROM
			TMT_SHIPG_NOTE
		WHERE
			SHIPG_NOTE_NO 								= #{blSNNo}
			AND CG_TP_CD 								= 'RBK'
	</select>

	<insert id="insertServiceOrderItem"  parameterType="serviceOrderItem">
		INSERT /*serviceOrder.insertServiceOrderItem*/
			INTO
			    TMT_SVC_ODR(
			    	SHIP_CALL_NO,
					ODR_NO,
					CATEGORY1,
					CATEGORY2,
					CATEGORY3,
					SVC_DT_FMT,
					SVC_DT_TP,
					DT1_CHK,
					DT1_TIT,
					DT1_FMT,
					DT1_TP,
					DT2_CHK,
					DT2_TIT,
					DT2_FMT,
					DT2_TP,
					SHFT_CHK,
					UNIT_TIT,
					UNIT_UOM,
					UNIT_DEC,
					UNIT1_CHK,
					UNIT1_TIT,
					UNIT1_UOM,
					UNIT1_DEC,
					UNIT2_CHK,
					UNIT2_TIT,
					UNIT2_UOM,
					UNIT2_DEC,
					PAY_TP_CD,
					PRC_TP_CD,
					LOC_CHK,
					RMK_CHK,
					CMDTY_CHK,
					VSL_CALL_ID,
			        CALL_SEQ,
			        CALL_YEAR,
			        VSL_CD,
					PAYER,
					STAT_CD,
					CRT_BY,
					CRT_DT,
					SUMIT_BY,
					SUMIT_DT,
					SVC_DT_FM,
					SVC_DT_TO,
					DT1_FM,
					DT1_TO,
					DT2_FM,
					DT2_TO,
					SHFT_ID,
					UNIT,
					UNIT1,
					UNIT2,
					EQ_DIV_CD,
					CAPA_CD,
					LOC_ID,
					REQ_RMK,
					CMDTY_CD,
					OPE_CLASS_CD,
					REQ_DOC_NO,
					COM_DOC_NO,
					REQ_UNIT_NO,
					COM_UNIT_NO,
					UPDATE_TIME,
					STAFF_CD,
					VERSION,
			        RMK
				) VALUES (
					#{scn},
					#{odrNo},
				    #{category1},
				    #{category2},
				    #{category3},
				    #{svcDtFmt},
				    #{svcDtTp},
					#{dt1Chk},
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt1Tit}
				        ELSE NULL
				    END),
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt1Fmt}
				        ELSE NULL
				    END),
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt1Tp}
				        ELSE NULL
				    END),
					#{dt2Chk},
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt2Tit}
				        ELSE NULL
				    END),
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt2Fmt}
				        ELSE NULL
				    END),
				    (CASE #{dt1Chk}
				    	WHEN 'Y' THEN #{dt2Tp}
				        ELSE NULL
				    END),
	        		#{shftChk},
				    #{unitTit},
				    #{unitUom},
				    #{unitDec},
					#{unit1Chk},
				    (CASE #{unit1Chk}
				    	WHEN 'Y' THEN #{unit1Tit}
				        ELSE NULL
				    END),
				    (CASE #{unit1Chk}
				    	WHEN 'Y' THEN #{unit1Uom}
				        ELSE NULL
				    END),
				    (CASE #{unit1Chk}
				    	WHEN 'Y' THEN #{unit1Dec}
				        ELSE NULL
				    END),
					#{unit2Chk},
				    (CASE #{unit2Chk}
				    	WHEN 'Y' THEN #{unit2Tit}
				        ELSE NULL
				    END),
				    (CASE #{unit2Chk}
				    	WHEN 'Y' THEN #{unit2Uom}
				        ELSE NULL
				    END),
				    (CASE #{unit2Chk}
				    	WHEN 'Y' THEN #{unit2Dec}
				        ELSE NULL
				    END),
					#{payTpCd},
				    #{prcTpCd},
				    #{locChk},
				    #{rmkChk},
				    #{cmdtyChk},
					#{vslCallId},
					#{callSeq},
					#{callYear},
					#{vslCd},
				    #{payer},
				    #{statCd},
				    #{userId},
				    SYSDATETIME(),
				    #{userId},
				    SYSDATETIME(),
					CONVERT(DATETIME, #{svcDtFm},103),
					(CASE #{svcDtTp}
						WHEN 'Y' THEN CONVERT(DATETIME, #{svcDtTo},103)
					    ELSE NULL
					END),
					(CASE #{dt1Chk}
						 WHEN 'Y' THEN CONVERT(DATETIME, #{dt1Fm},103)
						 ELSE NULL
					END),
					(CASE #{dt1Chk}
						 WHEN 'Y' THEN (
						     			CASE #{dt1Tp}
											WHEN 'Y' THEN CONVERT(DATETIME, #{dt1To},103)
											ELSE NULL
							 			END)
						 ELSE NULL
					END),
					(CASE #{dt2Chk}
						 WHEN 'Y' THEN CONVERT(DATETIME, #{dt2Fm},103)
						 ELSE NULL
					END),
					(CASE #{dt2Chk}
						 WHEN 'Y' THEN (
						     			CASE #{dt2Tp}
								 			WHEN 'Y' THEN CONVERT(DATETIME, #{dt2To},103)
								 			ELSE NULL
										END)
						 ELSE NULL
					END),
				    (CASE #{shftChk}
				    	WHEN 'Y' THEN #{shftId}
				        ELSE NULL
				    END),
	        		#{unit},
				    (CASE #{unit1Chk}
				    	WHEN 'Y' THEN #{unit1}
				        ELSE NULL
				    END),
				    (CASE #{unit2Chk}
				    	WHEN 'Y' THEN #{unit2}
				        ELSE NULL
				    END),
	        		#{eqDivCd},
				    #{capaCd},
				    #{locId},
				    #{reqRmk},
				    #{cmdtyCd},
	        		#{opeClassCd},
				    #{reqDocNo},
				    #{comDocNo},
				    #{reqUnitNo},
				    #{comUnitNo},
					SYSDATETIME(),
				    #{userId},
				    #{newVersion},
				    #{rmk}
		)
	</insert>
	
	<update id="updateServiceOrderItem"  parameterType="serviceOrderItem">
		UPDATE /*serviceOrder.updateServiceOrderItem*/
			TMT_SVC_ODR
		SET
			STAT_CD 						= #{statCd},
			<if test="statCd == 'SU'">
				PAYER 						= #{payer},
				SVC_DT_FM 					= CONVERT(DATETIME, #{svcDtFm},103),
				SVC_DT_TO 					= CONVERT(DATETIME, #{svcDtTo},103),
				DT1_FM 						= CONVERT(DATETIME, #{dt1Fm},103),
				DT1_TO 						= CONVERT(DATETIME, #{dt1To},103),
				DT2_FM 						= CONVERT(DATETIME, #{dt2Fm},103),
				DT2_TO 						= CONVERT(DATETIME, #{dt2To},103),
				SHFT_ID 					= #{shftId},
				UNIT 						= #{unit},
				UNIT1 						= #{unit1},
				UNIT2 						= #{unit2},
				EQ_DIV_CD 					= #{eqDivCd},
				CAPA_CD 					= #{capaCd},
				LOC_ID 						= #{locId},
				REQ_RMK 					= #{reqRmk},
				CMDTY_CD 					= #{cmdtyCd},
				SUMIT_BY 					= #{userId},
				SUMIT_DT 					= SYSDATETIME(),
			</if>
			<if test="statCd == 'CA'">
				CNCL_BY 					= #{userId},
				CNCL_DT 					= SYSDATETIME(),
			</if>
			<if test="statCd == 'AP'">
				RMK 						= #{rmk},
				APPRV_BY 					= #{userId},
				APPRV_DT 					= SYSDATETIME(),
			</if>
			<if test="statCd == 'RJ'">
				RMK 						= #{rmk},
				REJ_BY 						= #{userId},
				REJ_DT 						= SYSDATETIME(),
			</if>
			<if test="statCd == 'CP'">
				COM_CHK 					= #{comChk},
				COM_SVC_DT_FM 				= CONVERT(DATETIME, #{comSvcDtFm},103),
				COM_SVC_DT_TO 				= CONVERT(DATETIME, #{comSvcDtTo},103),
				COM_DT1_FM 					= CONVERT(DATETIME, #{comDt1Fm},103),
				COM_DT1_TO 					= CONVERT(DATETIME, #{comDt1To},103),
				COM_DT2_FM 					= CONVERT(DATETIME, #{comDt2Fm},103),
				COM_DT2_TO 					= CONVERT(DATETIME, #{comDt2To},103),
				<if test="comShftId != null and comShftId != ''">
					COM_SHFT_ID 			= #{comShftId},
				</if>
				<if test="comShftId == null or comShftId == ''">
					<if test="comSvcDtFm != null and comSvcDtFm != ''">
						COM_SHFT_ID 		= DBO.F_GET_SHIFT_CD(CONVERT(DATETIME, #{comSvcDtFm},103),''),
					</if>
				</if>
				COM_UNIT 					= #{comUnit},
				COM_UNIT1 					= #{comUnit1},
				COM_UNIT2 					= #{comUnit2},
				COM_CAPA_CD 				= #{comCapaCd},
				COM_LOC_ID 					= #{comLocId},
				COM_RMK 					= #{comRmk},
				COM_BY 						= #{userId},
				COM_CMDTY_CD 				= #{comCmdtyCd},
				COM_DT 						= SYSDATETIME(),
			</if>
			COM_DOC_NO						= #{comDocNo},
			COM_UNIT_NO 					= #{comUnitNo},
			UPDATE_TIME 					= SYSDATETIME(),
			STAFF_CD 						= #{userId},
			VERSION 						= #{newVersion}
		WHERE
		    ODR_NO 							= #{odrNo}
	</update>

	<delete id="deleteServiceOrderItem"  parameterType="serviceOrderItem">
		DELETE FROM
			TMT_SVC_ODR
		WHERE
			ODR_NO 							= #{odrNo}
	</delete>
</mapper>
