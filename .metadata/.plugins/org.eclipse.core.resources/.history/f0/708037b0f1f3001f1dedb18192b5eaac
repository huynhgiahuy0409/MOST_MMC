<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cargoManualCtlExport">
	
	<!--  ############################## Query Statement Define ############################## -->
	<sql id="getCargoExportListbyGR">
		SELECT DISTINCT /* cargoManualCtlExport.getCargoExportListbyGR */
			G.VSL_CALL_ID         	  														AS VSLCALLID,
			G.SHIP_CALL_NO																	AS SCN,
			G.GR_NO         	  	  														AS CGNO,
			G.GR_NO         	  	  														AS GRNO,
			MAX(G.SHIPG_NOTE_NO)      														AS SHIPGNOTENO,
			MAX(A.SHPR)               														AS SHPR,
			MAX(A.SHPR_NM)            														AS SHPRNM,
			(SELECT 
				MAX(P.VSL_NM) 
			FROM 
				TMT_VSL_PART 			P
			WHERE 
				P.VSL_CD 				= B.VSL_CD
			) 			   																	AS VSLNM,
			(SELECT TOP(1)
				A.LORRY_NO
			FROM 
				TMT_CG_ARRV_DELV A
			WHERE    
				A.LORRY_NO 				= #{lorryNo}
				AND A.VSL_CALL_ID 		= G.VSL_CALL_ID
				AND A.CG_NO 			= G.GR_NO 
			) 																				AS LORRYNO,
			(SELECT TOP(1)
				A.DRIVER_ID
			FROM 
				TMT_CG_ARRV_DELV A
			WHERE    
				A.LORRY_NO 				= #{lorryNo}
				AND A.VSL_CALL_ID 		= G.VSL_CALL_ID
				AND A.CG_NO 			= G.GR_NO 
			) 																				AS DRIVERID,
			(SELECT TOP(1)
				A.GATE_TXN_NO
			FROM 
				TMT_CG_ARRV_DELV A
			WHERE     
				A.LORRY_NO 				= #{lorryNo}
				AND A.VSL_CALL_ID 		= G.VSL_CALL_ID
				AND A.CG_NO 			= G.GR_NO
			) 																				AS GATETXNNO,	
			MAX(C.STAT_CD)				  													AS STAT,
			dbo.F_GET_CARGO_STAT(
				G.VSL_CALL_ID,
				MAX(G.SHIPG_NOTE_NO)
			) 																				AS hiddenStatus,
			ISNULL(MAX(C.STAT_CD),'RS') 													AS STATCD,
			dbo.F_CM_CODE_NM(
				'MT', 
				'CGSTATUS', 
				ISNULL(MAX(C.STAT_CD),
				'RS')
			)																				AS STATNM,
			ISNULL(MAX(C.pkg_qty), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'DC' THEN -J.PKG_QTY
							WHEN 'IC' THEN J.PKG_QTY
							ELSE 0
						END 
						)
					, 0) 																	AS PKGQTY,
			ISNULL(MAX(C.CG_WGT), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'DC' THEN -J.CG_WGT
							WHEN 'IC' THEN J.CG_WGT
							ELSE 0
						END 
					)
				, 0) 																		AS WGT,
			ISNULL(MAX(C.CG_VOL), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'DC' THEN -J.CG_VOL
							WHEN 'IC' THEN J.CG_VOL
							ELSE 0
						END 
					)
					, 0) 																	AS MSRMT,
			ISNULL(MAX(C.LD_DMG_QTY), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'GD' THEN J.PKG_QTY
							WHEN 'DG' THEN -J.PKG_QTY
							ELSE 0
						END 
					)
				, 0)
				+ ISNULL(
					SUM(
						CASE
							WHEN 	
								(J.JOB_CO_CD = 'D' 
								AND J.JOB_PURP_CD IN ('AW', 'VW', 'GW', 'VG', 'GV') 
								AND J.RC_CO_CD IS NULL) 
									THEN J.PKG_QTY
							ELSE 0
						END
						)
				, 0) 																		AS DMGQTY,
			ISNULL(MAX(C.LD_DMG_MT), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'GD' THEN J.CG_WGT
							WHEN 'DG' THEN J.CG_WGT
							ELSE 0
						END 
					)
				, 0)
				+ ISNULL(
					SUM((CASE
							WHEN 
								(J.JOB_CO_CD = 'D' 
								AND J.JOB_PURP_CD IN ('AW', 'VW', 'GW', 'VG', 'GV') 
								AND J.RC_CO_CD IS NULL) 
									THEN J.CG_WGT
							ELSE 0
						END)
					)
				, 0) 																		AS DMGWGT,
			ISNULL(MAX(C.LD_DMG_M3), 0) 
				+ ISNULL(
					SUM(
						CASE J.RC_CO_CD
							WHEN 'GD' THEN J.CG_VOL
							WHEN 'DG' THEN -J.CG_VOL
							ELSE 0
						END 
					)
				, 0)
				+  ISNULL(
					SUM((CASE
							WHEN 
								(J.JOB_CO_CD = 'D' 
								AND J.JOB_PURP_CD IN ('AW', 'VW', 'GW', 'VG', 'GV') 
								AND J.RC_CO_CD IS NULL) 
									THEN J.CG_VOL
							ELSE 0
						END)
					)
				, 0) 																		AS DMGM3,
			MAX(C.LOAD_CNCL_MODE)	  	  													AS LOADCNCLMODE,									
			CASE 
				(SUM(
					CASE J.JOB_CO_CD
						WHEN 'D' THEN 1
						ELSE 0
					END 
					)
				)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END 																			AS DMGYN,														
			CASE COUNT(J.RC_CO_CD)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END 																			AS RCYN,											
			CASE dbo.F_GET_INV_LOC(G.VSL_CALL_ID, G.GR_NO)
				WHEN ' ' THEN 'N'
				ELSE 'Y'
			END																				AS ISEXISTEDCARGO,

			CASE 
				(SUM(
					CASE J.JOB_CO_CD
						WHEN 'S' THEN 1
						ELSE 0
					END 
					)
				)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END 																			AS SHUYN,	 								
			CASE 
				WHEN MAX(C.RHDL_MODE) IS NULL 	THEN 'N'
				WHEN MAX(C.RHDL_MODE) = '' 		THEN 'N'
				WHEN MAX(C.RHDL_MODE) = 'N' 	THEN 'N'
				ELSE 'Y'
			END 																			AS RHDLMODE,
			MAX(C.PREV_LOC_ID)         	  													AS PREVPOS,
			MAX(C.CURR_LOC_ID)		  	  													AS CURRPOS,			   
			MAX(C.NX_LOC_ID)	 		  	  												AS NXPOS,
			MAX(C.CG_OPE_STAT)		  	  													AS CGOPESTAT,
			<if test="vslCallId != null and vslCallId != ''">
				<if test="vslCallId == 'STRG'"> 
					MIN(
						ISNULL(
							CASE
								WHEN J.JOB_PURP_CD 	<![CDATA[ <> ]]> 'GW' THEN NULL
								WHEN (J.WORK_END_DT IS NULL OR J.WORK_END_DT = '') 
									THEN NULL
								ELSE FORMAT(J.WORK_END_DT, 'dd/MM/yyyy HH:mm')
							END,
							(CASE 
								WHEN C.HDL_IN_END_DT IS NULL THEN NULL
								ELSE FORMAT(C.HDL_IN_END_DT, 'dd/MM/yyyy HH:mm')
							END)
						)
					) 																		AS HDLINDT,
				</if>
				<if test="vslCallId != 'STRG'">								
					CASE 
						WHEN MAX(C.HDL_IN_END_DT) IS NULL THEN NULL
						ELSE FORMAT(MAX(C.HDL_IN_END_DT), 'dd/MM/yyyy HH:mm')
					END 																	AS HDLINDT,    			
				</if>
			</if>
			<if test="vslCallId == null or vslCallId == ''">
				MIN(
					ISNULL(
						CASE
							WHEN 
								J.JOB_PURP_CD <![CDATA[ <> ]]> 'GW' 
									THEN NULL
							WHEN (J.WORK_END_DT IS NULL OR J.WORK_END_DT = '') 
								THEN NULL
							ELSE FORMAT(J.WORK_END_DT, 'dd/MM/yyyy HH:mm')
						END,
						(CASE
							WHEN C.HDL_IN_END_DT IS NULL THEN NULL
							ELSE FORMAT(C.HDL_IN_END_DT, 'dd/MM/yyyy HH:mm')
						END)
					)
				) 																			AS HDLINDT,
			</if>			    
			MAX(A.DELV_TP_CD)	  															AS DELVTPCD,
			(SELECT 
				MAX(TCM.S_CD_NM) 
			FROM 
				TMT_CD_MSTD 				TCM
			WHERE  	
				TCM.L_CD 					= 'MT' 
				AND TCM.M_CD 				= 'DELVTP'
				AND TCM.S_CD 				= A.DELV_TP_CD
			) 																				AS DELVTPNM,
			(
			CASE 
				WHEN C.OPE_CLASS_CD IS NULL
					THEN 
						(SELECT 
							MAX(S.CATG_CD)
						FROM 
							TMT_SHIPG_NOTE 	S
						WHERE 
							S.SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
							AND  S.VSL_CALL_ID 	= G.VSL_CALL_ID
						)
				ELSE MAX(C.OPE_CLASS_CD)
			END 
			) 																				AS CATGCD,
			(SELECT 
				MAX(TCM.S_CD_NM)
			FROM 
				TMT_CD_MSTD 				TCM 
			WHERE  
				TCM.L_CD 					= 'MT' 
				AND TCM.M_CD 				= 'CATGTP' 
				AND TCM.S_CD 				= 	(SELECT TOP(1)
													S.CATG_CD 
												FROM 
													TMT_SHIPG_NOTE 		S
												WHERE 
													S.SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
													AND S.VSL_CALL_ID 	= G.VSL_CALL_ID
												)
			)																				AS CATGNM,
			(SELECT 
				MAX(S.CG_TP_CD)
			FROM 
				TMT_SHIPG_NOTE 				S
			WHERE 
				S.VSL_CALL_ID 				= G.VSL_CALL_ID 
				AND S.SHIPG_NOTE_NO 		= G.SHIPG_NOTE_NO
			) 																				AS CGTPCD,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.CG_WGT
					WHEN 'GV' THEN J.CG_WGT
					WHEN 'BV' THEN J.CG_WGT
					ELSE 0
				END
			) 																				AS ACCLOADMT,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.CG_VOL
					WHEN 'GV' THEN J.CG_VOL
					WHEN 'BV' THEN J.CG_VOL
					ELSE 0
				END
			) 																				AS ACCLOADM3,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.PKG_QTY
					WHEN 'GV' THEN J.PKG_QTY
					WHEN 'BV' THEN J.PKG_QTY
					ELSE 0
				END
			) 																				AS ACCLOADQTY,
			MAX(G.CG_VOL) 																	AS DOCM3,
			MAX(G.PKG_QTY) 																	AS DOCQTY,
			MAX(G.CG_WGT) 																	AS DOCMT,														
			CASE
				WHEN MAX(C.LOAD_END_DT) IS NULL THEN 'N'
				ELSE 'Y'
			END 																			AS FNLOPEYN,													
			CASE
				WHEN MAX(C.HDL_IN_END_DT) IS NULL THEN 'N'
				ELSE 'Y'
			END 																			AS HIFNLYN,
			dbo.F_GET_INV_LOC(G.VSL_CALL_ID, G.GR_NO) 										AS WHLOCIDS,
			MAX(ISNULL(J.PKG_NO, ' ')) 														AS PKGNO,
			MAX(C.LOAD_END_DT) 																AS LOADENDDT,
			MAX(C.HDL_IN_END_DT) 															AS HDLINENDDT,
			MAX(A.SHIPG_AGNCY ) 															AS SHACD,
			dbo.F_GET_PARTNER_INFO(
				MAX(A.SHIPG_AGNCY), 
				'ENG_SNM') 																	AS SHANM,
			MAX(A.FWRD ) 																	AS FWDCD,
			dbo.F_GET_PARTNER_INFO(MAX(A.FWRD ), 'ENG_SNM') 								AS FWDNM,
			MAX(A.CMDT_GRP_CD )  															AS CMDTGRPCD,
			MAX(A.CMDT_CD )  																AS CMDTCD,
			(SELECT
				MAX(M.CMDT_GRP_DESC)  
			FROM 
				TMT_CMDT_GRP 			M
			WHERE 
				M.CMDT_GRP_CD 			= A.CMDT_GRP_CD 	
			) 																				AS cmdtGrpNm,
			(SELECT
				MAX(CMDT.CMDT_DESC) 
			FROM 
				TMT_CMDT 				CMDT
			WHERE 
				CMDT.CMDT_CD 			= A.CMDT_CD
			) 																				AS CMDTNM,
			MAX(A.PKG_TP_CD )  																AS PKGTPCD,
			dbo.F_CM_CODE_NM('MT', 'PKGTP', MAX(A.PKG_TP_CD )) 								AS PKGTPNM,
			dbo.F_CM_CODE_NM('MT', 'CGTP', MAX(A.CG_TP_CD )) 								AS CGTPCDNM,
			MAX(A.SHPR ) + ' / ' + MAX(A.CNSNE ) 											AS SHPCNSCD,
			dbo.F_GET_PARTNER_INFO(
				MAX(A.SHPR ), 
				'ENG_SNM') 
				+ ' / ' 
				+ dbo.F_GET_PARTNER_INFO(
					MAX(A.CNSNE ), 
					'ENG_SNM') 																AS SHPCNSNM,
			MAX(A.EACH_WGT) 																AS EACHMT,
			MAX(A.EACH_VOL) 																AS EACHM3,
			MAX(A.LENGTH) 																	AS LENGTH,
			MAX(A.WIDTH) 																	AS WIDTH,
			MAX(A.HEIGHT) 																	AS HEIGHT,
			MAX(A.MARK_NO) 																	AS MARKSNO,
			MAX(A.GDS_RMK) 																	AS GOODSRMK,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.PKG_QTY
					ELSE 0
				END
			) 																				AS storedQty,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.CG_WGT
					ELSE 0
				END
			) 																				AS storedMt,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.CG_VOL
					ELSE 0
				END				
			) 																				AS storedM3,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.PKG_QTY
					WHEN 'GV' THEN J.PKG_QTY
					WHEN 'BV' THEN J.PKG_QTY
					ELSE 0
				END						
			) 																				AS loadedQty,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.CG_WGT
					WHEN 'GV' THEN J.CG_WGT
					WHEN 'BV' THEN J.CG_WGT
					ELSE 0
				END	
			) 																				AS loadedMt,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.CG_VOL
					WHEN 'GV' THEN J.CG_VOL
					WHEN 'BV' THEN J.CG_VOL
					ELSE 0
				END	
			) 																				AS loadedM3,
			(SELECT TOP(1)
				STRING_AGG(HATCH_NO, ', ') 
					WITHIN GROUP (ORDER BY HATCH_NO) 
			FROM 
				(SELECT DISTINCT 
					HATCH_NO 
				FROM 
					TMT_JOB 
				WHERE 
					VSL_CALL_ID 		= G.VSL_CALL_ID  
					AND CG_NO 			= G.GR_NO
				)						AS TEMPTB
			) 																				AS HATCHNO,
			MAX(D.wgt) 																		AS GateInMt,
			MAX(D.PKG_QTY) 																	AS gateInQty,
			MAX(D.MSRMT) 																	AS gateInM3,
			MAX(A.LOT_NO) 																	AS userRefNo,
			B.ATB																			AS atb,
			A.PROJECT_CARGO                                                      			AS PROJECTCARGO
		FROM 
			TMT_SHIPG_NOTE 																	A, 
			TMT_GR 																			G
		LEFT OUTER JOIN
			TMT_CG_MST 																		C
				ON 	G.GR_NO = C.CG_NO
				AND G.VSL_CALL_ID = C.VSL_CALL_ID
		LEFT OUTER JOIN 
			TMT_VSL_SCH 																	B
				ON G.VSL_CALL_ID = B.VSL_CALL_ID
		LEFT OUTER JOIN
			TMT_JOB 																		J
				ON G.VSL_CALL_ID 															= J.VSL_CALL_ID
				AND G.GR_NO 																= J.CG_NO
		LEFT OUTER JOIN
			(SELECT 	
				VSL_CALL_ID,
				CG_NO,
				MAX(LORRY_NO) 			AS LORRY_NO,
				MAX(CG_WGT) 			AS WGT,  
				MAX(PKG_QTY) 			AS PKG_QTY,  
				MAX(CG_VOL) 			AS MSRMT
			FROM	
				TMT_CG_ARRV_DELV 
			WHERE 	
				1 = 1
				<if test="lorryNo != null and lorryNo != ''">
					AND LORRY_NO 		= #{lorryNo}
				</if>
			GROUP BY 
				VSL_CALL_ID, 
				CG_NO
			) 																				D
				ON 	G.VSL_CALL_ID 		= D.VSL_CALL_ID
				AND G.GR_NO 			= D.CG_NO
		LEFT OUTER JOIN
			TMT_CG_ARRV_DELV 																CG
				ON G.VSL_CALL_ID 															= CG.VSL_CALL_ID
				AND G.GR_NO 																= CG.GR_NO
		WHERE	
			A.SHIPG_NOTE_NO 																= G.SHIPG_NOTE_NO
			AND A.VSL_CALL_ID 																= G.VSL_CALL_ID
			AND A.CG_TP_CD 																	<![CDATA[<>]]> 'RCV'
			AND (CG.GATE_OUT_DT IS NULL														OR CG.GATE_OUT_DT = '')	
			<if test="vslCallId != null and vslCallId != ''">
				AND B.VSL_CALL_ID 															= #{vslCallId}
				AND G.VSL_CALL_ID 															= #{vslCallId}
			</if>
			<if test="scn != null and scn != ''">
				AND B.SHIP_CALL_NO 															= #{scn}
				AND G.SHIP_CALL_NO 															= #{scn}
			</if>
			<if test="vslCallId == null or vslCallId == ''">
				AND G.VSL_CALL_ID 															&lt;&gt; 'STRG'
			</if>
			<if test="shipgNoteNo != null and shipgNoteNo != ''">
				AND G.SHIPG_NOTE_NO															= #{shipgNoteNo}
			</if>
			<if test="bookingNo != null and bookingNo != ''">
				AND A.MF_DOC_ID																= #{bookingNo}
			</if>
			<if test="cgNo != null and cgNo != ''">
				AND G.GR_NO 																LIKE '%' + #{cgNo} + '%'
			</if>
			<if test="arrvDtFm != null and arrvDtFm != ''">
				AND A.EST_ARRV_DT 															<![CDATA[ >= ]]> CONVERT(DATETIME, #{arrvDtFm} + ' 00:00', 103)   
			</if>
			<if test="arrvDtTo != null and arrvDtTo != ''">
				AND A.EST_ARRV_DT 															<![CDATA[ <= ]]> CONVERT(DATETIME, #{arrvDtTo} + ' 23:59', 103) 
			</if>
			<if test="hhtFnlMode == 'HHT_LDFN'">
				AND C.LOAD_END_DT IS NULL
			</if>
			<if test="hhtFnlMode == 'HHT_HIFN'">
				AND C.HDL_IN_END_DT IS NULL
			</if>
			<if test="lorryNo != null and lorryNo != ''">
				AND EXISTS ( 
					SELECT 
						A.UPDATE_TIME,
						A.LORRY_NO,
						A.VSL_CALL_ID,
						A.CG_NO
					FROM 
						TMT_CG_ARRV_DELV 	A
					WHERE    
						A.LORRY_NO 			= #{lorryNo}
						AND A.VSL_CALL_ID 	= G.VSL_CALL_ID
						AND A.CG_NO 		= G.GR_NO )
			</if>
			<if test="startDt != null and startDt != ''">
				AND C.HDL_IN_END_DT 														<![CDATA[ >= ]]>  CONVERT(DATETIME, #{startDt} + ' 00:00', 103)
				AND J.WORK_END_DT 															<![CDATA[ >= ]]>  CONVERT(DATETIME, #{startDt} + ' 00:00', 103)					        
			</if>
			<if test="endDt != null and endDt != ''">
				AND C.HDL_IN_END_DT  														<![CDATA[ <= ]]> CONVERT(DATETIME, #{endDt} + ' 23:59', 103) 
				AND J.WORK_END_DT  															<![CDATA[ <= ]]> CONVERT(DATETIME, #{endDt} + ' 23:59', 103) 
			</if>
			<if test="hhtFnlMode == 'AC'">
				<if test="cgNo == null or cgNo == ''"> 
					AND (
						(A.DELV_TP_CD = 'I'
						AND (   
							(
								CASE 	
									WHEN 
										(SELECT 
											ISNULL(MAX(HDL_IN_END_DT), '')
										FROM 
											TMT_CG_MST
										WHERE     
											VSL_CALL_ID 		= G.VSL_CALL_ID
											AND SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
											AND DELV_TP_CD 		= 'I'
										) IS NULL
											THEN 'N'
									ELSE 'Y'
								END = 'Y'
								AND ISNULL(C.STAT_CD, 'RS') 	IN ('RS', 'OS', 'ST')
							)
							OR 
							(  
								CASE	
									WHEN 
										(SELECT 
											MAX(HDL_IN_END_DT)
										FROM 
											TMT_CG_MST
										WHERE     
											VSL_CALL_ID			= G.VSL_CALL_ID
											AND SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
											AND DELV_TP_CD 		= 'I'
										) IS NULL 
											THEN 'N'
								END = 'N'
								AND ISNULL(C.STAT_CD, 'RS') 	NOT IN ('RS','OS','ST','OL')
							)

							)
						OR 	(A.DELV_TP_CD = 'D' 
							AND ISNULL(C.STAT_CD, 'RS') IN ('RS'))
						)
					)
					</if>
			</if>
			<if test="hhtFnlMode == 'WC'"> 
				<if test="cgNo == null or cgNo == ''"> 
					AND ( 
							(A.DELV_TP_CD = 'I'
								AND (   
									(
										(
											CASE 	
												WHEN
													(SELECT 
														MAX(HDL_IN_END_DT)
													FROM 
														TMT_CG_MST
													WHERE     
														VSL_CALL_ID 		= G.VSL_CALL_ID
														AND SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
														AND DELV_TP_CD 		= 'I'
													) IS NULL 
														THEN 'N'
												ELSE 'Y'
											END = 'Y'
											AND ISNULL(C.STAT_CD, 'RS') IN('RS')
										)
										OR 
										( 
											CASE 
												WHEN 
													(SELECT 
														MAX(HDL_IN_END_DT)
													FROM 
														TMT_CG_MST
													WHERE     
														VSL_CALL_ID 		= G.VSL_CALL_ID
														AND SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
														AND DELV_TP_CD 		= 'I'
													) IS NULL
														THEN 'N'
												ELSE 'Y'
											END = 'N'
											AND ISNULL(C.STAT_CD, 'RS') IN ('RS')
										)
									)
								)
							)
					)
				</if>
			</if>
			
			<if test="userRefNo != null and userRefNo != ''">
				AND A.LOT_NO 									LIKE '%' + #{userRefNo} + '%'
			</if>
			<if test="pkgNo != null and pkgNo != ''">
				AND EXISTS (
					SELECT		
						P.PKG_NO
					FROM 	
						TMT_PKG_INFO 		P
					WHERE  	
						P.PKG_NO 			LIKE '%' + #{pkgNo} + '%'
						AND P.VSL_CALL_ID 	= A.VSL_CALL_ID
						AND P.REF_NO 		= A.SHIPG_NOTE_NO 
					)
			</if>
			
			<choose>
				<when test='bargeCheckYn eq "Y".toString()'>
					AND A.DELV_TP_CD 							= 'D'
					AND G.TSPT_TP_CD 							= 'SE'
				</when>
				<otherwise>
					AND G.TSPT_TP_CD 							!= 'SE'
				</otherwise>
			</choose>
        GROUP BY 
			G.GR_NO, 
			G.VSL_CALL_ID,
			G.SHIP_CALL_NO,
			C.LORRY_NO,
			A.CMDT_CD,
			C.OPE_CLASS_CD,
			B.VSL_CD,
			A.DELV_TP_CD,
			G.SHIPG_NOTE_NO,
			A.CMDT_GRP_CD,
			B.ATB,
			A.PROJECT_CARGO
	</sql>
	
	<sql id="getCargoExportListbySN">		
		SELECT DISTINCT /* cargoManualCtlExport.getCargoExportListbySN */
		    A.VSL_CALL_ID 												AS VSLCALLID,
		    A.SHIP_CALL_NO												AS SCN,
		    CASE 
				WHEN 
					(
						(SELECT TOP(1)
							GR_NO 
						FROM 
							TMT_GR
						WHERE 
							VSL_CALL_ID 			= A.VSL_CALL_ID 
							AND SHIPG_NOTE_NO 		= A.SHIPG_NOTE_NO 
							AND TSPT_TP_CD 			= 'GI') IS NOT NULL
						AND 
						(SELECT TOP(1)
							GR_NO 
						FROM 
							TMT_GR
						WHERE 
							VSL_CALL_ID 			= A.VSL_CALL_ID 
							AND SHIPG_NOTE_NO 		= A.SHIPG_NOTE_NO 
							AND TSPT_TP_CD = 'GI') 	<![CDATA[<>]]> ''
					)
		        	   	THEN 
							(SELECT 
								MIN(GR_NO)
		        	   		FROM 
								TMT_GR
		        			WHERE 
								VSL_CALL_ID 		= A.VSL_CALL_ID 
		        				AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO 
		        				AND TSPT_TP_CD 		<![CDATA[ <> ]]> 'GI'
							)
		        	ELSE MIN(GR.GR_NO)
		    END 														AS CGNO,
		    CASE 
				WHEN 
					(SELECT TOP(1)
						GR_NO 
					FROM 
						TMT_GR
					WHERE 
						VSL_CALL_ID 				= A.VSL_CALL_ID 
						AND SHIPG_NOTE_NO 			= A.SHIPG_NOTE_NO 
						AND TSPT_TP_CD 				= 'GI'
					) IS NOT NULL
		        	   	THEN 
					   		(SELECT 
								MIN(GR_NO)
		        	   		FROM 
								TMT_GR
		        			WHERE 
								VSL_CALL_ID 		= A.VSL_CALL_ID 
								AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO 
								AND TSPT_TP_CD 		<![CDATA[ <> ]]> 'GI')
		        		ELSE MIN (GR.GR_NO)
		    END 														AS GRNO,
			A.SHIPG_NOTE_NO 											AS SHIPGNOTENO,
			MAX(A.CATG_CD) 												AS CATGCD,
			dbo.F_CM_CODE_NM('MT','CATGTP', MAX(A.CATG_CD))				AS CATGNM,
			MAX(A.DELV_TP_CD) 											AS DELVTPCD,
			dbo.F_CM_CODE_NM('MT','DELVTP', MAX(A.DELV_TP_CD)) 			AS DELVTPNM,
			MAX(A.SHIPG_AGNCY) 											AS SHACD,
			dbo.F_GET_PARTNER_INFO (MAX(A.SHIPG_AGNCY), 'ENG_SNM') 		AS SHANM,
			MAX(A.FWRD) 												AS FWDCD,
			dbo.F_GET_PARTNER_INFO (MAX(A.FWRD), 'ENG_SNM') 			AS FWDNM,
			MAX(A.CG_TP_CD) 											AS CGTPCD,
			MAX(A.CMDT_CD) 												AS CMDTCD,
			(SELECT  
				MAX(M.CMDT_GRP_DESC)
			FROM 
				TMT_CMDT_GRP						M,
				TMT_SHIPG_NOTE						S
			WHERE 
				M.CMDT_GRP_CD 						= S.CMDT_GRP_CD
			) 															AS cmdtGrpNm,
			(SELECT TOP(1)
				MAX(CMDT.CMDT_DESC) 
			FROM 
				TMT_CMDT 							CMDT,
				TMT_SHIPG_NOTE						S
			WHERE 
				CMDT.CMDT_CD 						= S.CMDT_CD
			) 															AS CMDTNM,
			MAX(A.PKG_TP_CD) 											AS PKGTPCD,
			dbo.F_CM_CODE_NM ('MT', 'PKGTP', MAX(A.PKG_TP_CD)) 			AS PKGTPNM,
			dbo.F_CM_CODE_NM ('MT', 'CGTP', MAX(A.CG_TP_CD)) 			AS CGTPCDNM,
			MAX(A.SHPR) + ' / ' + MAX(A.CNSNE) 							AS SHPCNSCD,
			dbo.F_GET_PARTNER_INFO(MAX(A.SHPR), 'ENG_SNM') 
			+ ' / ' + 
			dbo.F_GET_PARTNER_INFO (MAX(A.CNSNE), 'ENG_SNM') 			AS SHPCNSNM,
			MAX(A.GDS_RMK) 												AS GOODSRMK,
			MAX(A.MARK_NO) 												AS MARKSNO,
			(SELECT
				STRING_AGG(PKG_NO, ', ')
					WITHIN GROUP (ORDER BY PKG_NO)
			FROM (
				SELECT DISTINCT
					PKG_NO
				FROM
					TMT_PKG_INFO P
				WHERE
					P.VSL_CALL_ID 										= A.VSL_CALL_ID
					AND P.REF_NO 										= A.SHIPG_NOTE_NO
					)
				AS TEMPTB
			) 															AS PKGNO,
			MAX(A.LOT_NO) 												AS userRefNo,
			CASE
				WHEN 
					(SELECT 
						SUM (CGWGT)
					FROM 
						(SELECT 
							ISNULL(CG_WGT, 0) AS CGWGT
						FROM 
							TMT_INV_LOC
						WHERE 
							CG_NO IN 	(SELECT 
											GR_NO
										FROM 
											TMT_GR
										WHERE 
											VSL_CALL_ID 		= A.VSL_CALL_ID 
											AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO)
							AND VSL_CALL_ID = A.VSL_CALL_ID
							)									AS TEMPT 
						) 	<![CDATA[ <> ]]> 0
				THEN 'Y'
				ELSE 'N'
			END 														AS ISEXISTEDCARGO,
			(SELECT 
				TSPT_TP_CD
			FROM 
				TMT_GR
			WHERE   
				VSL_CALL_ID 				= A.VSL_CALL_ID
				AND SHIPG_NOTE_NO 			= A.SHIPG_NOTE_NO
				AND GR_NO = CASE
								WHEN 
									(SELECT TOP(1)
										GR_NO
									FROM 
										TMT_GR
									WHERE 
										VSL_CALL_ID 		= A.VSL_CALL_ID
										AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO
										AND TSPT_TP_CD 		= 'GI'
									) IS NOT NULL
								THEN
									(SELECT 
										MIN (GR_NO)
									FROM 
										TMT_GR
									WHERE 
										VSL_CALL_ID 		= A.VSL_CALL_ID
										AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO
										AND TSPT_TP_CD 		<![CDATA[ <> ]]> 'GI')
								ELSE
									(SELECT 
										MIN (GR_NO)
									FROM 
										TMT_GR
									WHERE 
										VSL_CALL_ID 		= A.VSL_CALL_ID
										AND SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO)
							END
			) 															AS tsptTpCd,
			(SELECT 
				grNoPlStr
			FROM
				(SELECT 
					STRING_AGG(GR_NO, ', ') 
						WITHIN GROUP (ORDER BY GR_NO ASC) 				AS grNoPlStr
				FROM 
					TMT_GR
				WHERE 
					VSL_CALL_ID 				= A.VSL_CALL_ID 
					AND SHIPG_NOTE_NO 			= A.SHIPG_NOTE_NO 
					AND TSPT_TP_CD 				= 'PL'
				)								AS TEMPT
			) 															AS grNoPlStr
			,SCH.ATB													AS atb	,
			A.PROJECT_CARGO                                             AS projectCargo
		FROM 
			TMT_VSL_SCH SCH,
		    TMT_SHIPG_NOTE A
		INNER JOIN 
			TMT_GR GR
		    	ON GR.VSL_CALL_ID 										= A.VSL_CALL_ID
		    	AND GR.SHIPG_NOTE_NO 									= A.SHIPG_NOTE_NO
		<where>
			1 = 1
			<if test="vslCallId != null and vslCallId != ''">
				AND A.VSL_CALL_ID 										= #{vslCallId}
				AND A.VSL_CALL_ID 										= SCH.VSL_CALL_ID
			</if>
			<if test="scn != null and scn != ''">
				AND A.SHIP_CALL_NO 										= #{scn}
				AND A.SHIP_CALL_NO 										= SCH.SHIP_CALL_NO
			</if>
			<if test="shipgNoteNo != null and shipgNoteNo != ''">
				AND A.SHIPG_NOTE_NO 									= #{shipgNoteNo}
			</if>
			<if test="bookingNo != null and bookingNo != ''">
				AND
					A.MF_DOC_ID											= #{bookingNo}
			</if>
			<if test="truckType == 1">
				<if test="lorryNo != null and lorryNo != ''">
					AND EXISTS (
						SELECT 
							SHIPG_NOTE_NO
						FROM 
							TMT_ASSIGN_TRANSPORT 	AT
						WHERE 
							AT.VSL_CALL_ID 			= A.VSL_CALL_ID 
							AND AT.SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO
							AND AT.LORRY_NO 		= #{lorryNo}
						)
				</if>
			</if>
			<if test="truckType == 0">
				<if test="lorryNo != null and lorryNo != ''">
					AND EXISTS (
						SELECT 
							GR_NO
						FROM 
							TMT_CG_ARRV_DELV 		GT
						WHERE 
							GT.VSL_CALL_ID 			= A.VSL_CALL_ID 
							AND GT.CG_NO 			= GR.GR_NO
							AND GT.LORRY_NO			= #{lorryNo}
						)
				</if>
			</if>
			
			<if test="userRefNo != null and userRefNo != ''">
				AND A.LOT_NO 									LIKE '%' + #{userRefNo} + '%'
			</if>
			<if test="pkgNo != null and pkgNo != ''">
				AND EXISTS (
					SELECT		
						P.PKG_NO
					FROM 	
						TMT_PKG_INFO 			P
					WHERE  	
						P.PKG_NO 				LIKE '%' + #{pkgNo} + '%'
						AND P.VSL_CALL_ID 		= A.VSL_CALL_ID
						AND P.REF_NO 			= A.SHIPG_NOTE_NO 
					)
			</if>
			AND A.CG_TP_CD 						<![CDATA[<>]]> 'RCV'
		</where>
		GROUP BY
		    A.VSL_CALL_ID,
		    A.SHIP_CALL_NO,
		    A.SHIPG_NOTE_NO,  
			GR.TSPT_TP_CD,
			SCH.ATB,
			A.PROJECT_CARGO
	</sql>
	 
	<sql id="getCargoExportListbyJobWA">
		SELECT DISTINCT /* cargoManualCtlExport.getCargoExportListbyJobWA */
			ISNULL(A.CG_WGT, 0) 								AS DOCMT,
			ISNULL(A.CG_VOL, 0) 								AS DOCM3,
			ISNULL(A.PKG_QTY, 0) 								AS DOCQTY,
			J.JOB_NO 											AS JOBNO,
			J.JOB_GROUP 										AS jobGroup,
			J.OPE_CLASS_CD 										AS OPECLASSCD,
			J.VSL_CALL_ID 										AS VSLCALLID,
			J.SHIP_CALL_NO										AS SCN,
			PT.VSL_NM 											AS VSLNM,
			J.CG_NO 											AS CGNO,
			G.GR_NO 											AS GRNO,
			A.CATG_CD 											AS CATGCD,
			J.DRIVER_ID                                      	AS DRIVERID,
			J.LORRY_NO 											AS LORRYNO,
			J.LORRY_NO 											AS TRUCKNO,
			dbo.F_CM_CODE_NM('MT','CATGTP', A.CATG_CD ) 		AS CATGNM,
			A.DELV_TP_CD 										AS DELVTPCD,
			dbo.F_CM_CODE_NM('MT','DELVTP', A.DELV_TP_CD) 		AS DELVTPNM,
			A.SHIPG_NOTE_NO 									AS SHIPGNOTENO,
			A.SHIPG_AGNCY 										AS SHACD,
			dbo.F_GET_PARTNER_INFO (A.SHIPG_AGNCY, 'ENG_SNM') 	AS SHANM,
			A.FWRD 												AS FWDCD,
			dbo.F_GET_PARTNER_INFO (A.FWRD, 'ENG_SNM') 			AS FWDNM,
			A.CG_TP_CD 											AS CGTPCD,
			A.CMDT_CD 											AS CMDTCD,
			(SELECT TOP(1)  
				M.CMDT_GRP_DESC  
			FROM 
				TMT_CMDT_GRP 			M 
			WHERE 
				M.CMDT_GRP_CD 			= A.CMDT_GRP_CD) 		AS cmdtGrpNm,
			(SELECT 
				CMDT.CMDT_DESC 
			FROM 
				TMT_CMDT 				CMDT 
			WHERE 
				CMDT.CMDT_CD 			= A.CMDT_CD) 			AS CMDTNM,
			A.PKG_TP_CD 										AS PKGTPCD,
			dbo.F_CM_CODE_NM ('MT', 'PKGTP', A.PKG_TP_CD) 		AS PKGTPNM,
			dbo.F_CM_CODE_NM ('MT', 'CGTP', A.CG_TP_CD) 		AS CGTPCDNM,
			A.SHPR + ' / ' + A.CNSNE 							AS SHPCNSCD,
			dbo.F_GET_PARTNER_INFO (A.SHPR, 'ENG_SNM')
				+ ' / '
				+ dbo.F_GET_PARTNER_INFO (A.CNSNE, 'ENG_SNM')  	AS SHPCNSNM,
			A.GDS_RMK 											AS GOODSRMK,
			A.MARK_NO 											AS MARKSNO,
			A.PKG_NO 											AS PKGNO,
			J.CG_WGT 											AS YARDTRUCKMT,
			J.CG_VOL 											AS YARDTRUCKM3,
			J.PKG_QTY 											AS YARDTRUCKQTY,
			TO_LOC_ID 											AS whLocIds,
			WORK_ST_DT 											AS startDt,
			WORK_END_DT 										AS endDt,
			'Lorry' 											AS modeOperation,
			(SELECT 
				CASE
					WHEN (CUS.DOC_NO IS NULL OR CUS.DOC_NO = '')
						THEN 'HOLD'
					WHEN ((CUS.DOC_NO IS NOT NULL 
							OR CUS.DOC_NO = '') 
						AND (CUS.RELEASE_MT IS NULL 
								OR CUS.RELEASE_MT = ''))
					THEN 'RELEASE' 
					ELSE 'RELEASE' 
				END 					AS status
			FROM 
				TMT_SHIPG_NOTE 			SN
			LEFT OUTER JOIN 
				(SELECT 
					DOC_NO,
					REF_NO,
					VSL_CALL_ID,
					SUM (RELEASE_MT) 	AS RELEASE_MT,
					SUM (RELEASE_QTY) 	AS RELEASE_QTY
				FROM 
					TMT_CUSTOMS_RELEASE
				GROUP BY 
					DOC_NO, REF_NO, 
					VSL_CALL_ID
				) 												CUS
					ON CUS.VSL_CALL_ID 							= SN.VSL_CALL_ID
					AND (
						((CUS.REF_NO IS NULL 
							OR CUS.REF_NO = '')
						AND CUS.DOC_NO = SN.MF_DOC_ID)
						OR ((CUS.REF_NO IS NOT NULL 
								OR CUS.REF_NO = '')
							AND CUS.REF_NO = SN.SHIPG_NOTE_NO)
					)
			WHERE 
				SN.VSL_CALL_ID 			= A.VSL_CALL_ID 
				AND SN.SHIPG_NOTE_NO 	= A.SHIPG_NOTE_NO
			)  													AS CUSTMODE,
			A.LOT_NO AS userRefNo,
			J.WB_TRANSACTION_NO 								AS wbTransactionNo
			<!--
			ISNULL(WB.SECOND_WGT, 0) 							AS secondWgt
			-->
			,SC.ATB												AS atb,
			A.PROJECT_CARGO										AS projectCargo
        FROM 
			TMT_JOB J
		INNER JOIN 
			TMT_GR G
				ON J.VSL_CALL_ID  								= G.VSL_CALL_ID 
				AND J.CG_NO  									= G.GR_NO
		INNER JOIN 
			TMT_SHIPG_NOTE A
				ON J.VSL_CALL_ID  								= A.VSL_CALL_ID 
				AND A.SHIPG_NOTE_NO  							= G.SHIPG_NOTE_NO
				AND A.CG_TP_CD 									<![CDATA[<>]]> 'RCV'
		INNER JOIN 
			TMT_VSL_SCH SC 
				ON A.VSL_CD  									= SC.VSL_CD 
				AND A.VSL_CALL_ID  								= SC.VSL_CALL_ID 
				AND A.CALL_YEAR  								= SC.CALL_YEAR
		INNER JOIN 
			TMT_VSL_PART PT 
				ON SC.VSL_CD  									= PT.VSL_CD
		<!-- LEFT OUTER JOIN 
			TMT_WEIGHTBRIDGE WB 
				ON WB.VSL_CALL_ID 								= J.VSL_CALL_ID 
				AND WB.GR_NO  									= J.CG_NO 
				AND WB.TRANSACTION_NO  							= J.WB_TRANSACTION_NO -->
        WHERE
			J.JOB_PURP_CD  										= 'WA'
			AND (J.NEXT_JOB_NO IS NULL							OR J.NEXT_JOB_NO = '')
			<if test="vslCallId != null and vslCallId != ''">
				AND	A.VSL_CALL_ID  								= #{vslCallId}
			</if>
			<if test="scn != null and scn != ''">
				AND	A.SHIP_CALL_NO 								= #{scn}
			</if>
			<if test="shipgNoteNo != null and shipgNoteNo != ''">
				AND A.SHIPG_NOTE_NO  							= #{shipgNoteNo}
			</if>
			<if test="lorryNo != null and lorryNo != ''">
				AND (J.LORRY_NO = #{lorryNo}  					OR J.LORRY_NO = 'TBA')
			</if>	
			<if test="userRefNo != null and userRefNo != ''">
				AND A.LOT_NO  									LIKE '%' + #{userRefNo} + '%'
			</if>
				<if test="pkgNo != null and pkgNo != ''">
				AND EXISTS ( 
					SELECT		
						P.PKG_NO
					FROM 	
						TMT_PKG_INFO P
					WHERE  	
						P.PKG_NO 			LIKE '%' + #{pkgNo} + '%'
						AND P.VSL_CALL_ID 	= A.VSL_CALL_ID
						AND P.REF_NO 		= A.SHIPG_NOTE_NO )
			</if>
		<!--
		ORDER BY 	
			J.VSL_CALL_ID,
		    J.JOB_NO
		-->	 		
	</sql>
	  
	<select id="selectCargoExportList"  parameterType="cargoExportParm" resultType="cargoExportItem">
		<if test="pageNo != 0"> 
			<if test="listType !=null and listType == 'SN'">
				SELECT /* cargoManualCtlExport.selectCargoExportList SN */
             		*
				FROM 
					(SELECT 
						ROW_NUMBER() OVER(ORDER BY VSLCALLID) AS ROW_NUM,
						innerTable.*
					FROM ( 
			</if>

			<if test="listType !=null and listType == 'GR'">
				SELECT /* cargoManualCtlExport.selectCargoExportList GR */
             		*
				FROM 
					(SELECT 
						ROW_NUMBER() OVER(ORDER BY VSLCALLID) AS ROW_NUM,
						innerTable.*
					FROM ( 
			</if>

			<if test="listType !=null and listType == 'JOBWA'">
				SELECT /* cargoManualCtlExport.selectCargoExportList JOBWA */
             	*
			FROM 
				(SELECT 
					ROW_NUMBER() OVER(ORDER BY VSLCALLID, JOBNO) AS ROW_NUM,
					innerTable.*
				FROM ( 
			</if>
		</if>

		<if test="listType !=null and listType == 'SN'">
			<include refid="getCargoExportListbySN"/>
		</if>
		<if test="listType !=null and listType == 'GR'">
			<include refid="getCargoExportListbyGR"/>
		</if>
		<if test="listType !=null and listType == 'JOBWA'">
			<include refid="getCargoExportListbyJobWA"/>
		</if>
		
		<if test="pageNo != 0"> 
				) AS innerTable 
			) AS innerTable
			WHERE 
				innerTable.ROW_NUM 		<![CDATA[>]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT) - 1) 	* CAST(#{sizePerPage} AS INT)  
		  		AND	innerTable.ROW_NUM 	<![CDATA[<=]]> 	CAST((CASE WHEN #{pageNo}  = '0' THEN '1' ELSE #{pageNo} END) AS INT) 		* CAST(#{sizePerPage} AS INT)
		</if>
	</select>
	
	<select id="selectCargoExportListCount"  parameterType="cargoExportParm" resultType="java.lang.String">
		SELECT /* cargoManualCtlExport.selectCargoExportListCount */
			COUNT(*)
		FROM (
				<if test="listType !=null and listType == 'SN'">
					<include refid="getCargoExportListbySN"/>
				</if>
				
				<if test="listType !=null and listType == 'GR'">
					<include refid="getCargoExportListbyGR"/>
				</if>
				
				<if test="listType !=null and listType == 'JOBWA'">
					<include refid="getCargoExportListbyJobWA"/>
				</if>
			) AS TEMPTB
	</select>
	
	<select id="selectCargoExportForROROList"  parameterType="cargoExportParm" resultType="cargoExportItem">
		<if test="pageNo != 0"> 
			SELECT /* cargoManualCtlExport.selectCargoExportForROROList */
             	*
			FROM 
				(SELECT 
					ROW_NUMBER() OVER(ORDER BY SHIPGNOTENO) 	AS ROW_NUM,
					innerTable.*
				FROM ( 
		</if>
		<if test="listType !=null and listType == 'SN'">
			<include refid="getCargoExportForROROListbySN"/>
		</if>
		<if test="listType !=null and listType == 'GR'">
			<include refid="getCargoExportListForRORObyGR"/>
		</if>
		<if test="pageNo != 0"> 
				) AS innerTable 
			) AS innerTable
			WHERE 
				innerTable.ROW_NUM 		<![CDATA[>]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT) - 1) 	* CAST(#{sizePerPage} AS INT)  
		  		AND	innerTable.ROW_NUM 	<![CDATA[<=]]> 	CAST((CASE WHEN #{pageNo}  = '0' THEN '1' ELSE #{pageNo} END) AS INT) 		* CAST(#{sizePerPage} AS INT)
		</if>
	</select>
	
	<select id="selectCargoExportForROROListCount"  parameterType="cargoExportParm" resultType="java.lang.String">
		SELECT 
			COUNT(*)
		FROM 
			(
			<if test="listType !=null and listType == 'SN'">
				<include refid="getCargoExportForROROListbySN"/>
			</if>
			<if test="listType !=null and listType == 'GR'">
				<include refid="getCargoExportListForRORObyGR"/>
			</if>
			) AS TEMPTABLE
	</select>
	
	<sql id="getCargoExportListForRORObyGR">
		SELECT /* cargoManualCtlExport.getCargoExportListForRORObyGR */
			G.VSL_CALL_ID 												AS VSLCALLID, 
			G.GR_NO 													AS CGNO,
			G.GR_NO 													AS GRNO,
			MAX(G.SHIPG_NOTE_NO) 										AS SHIPGNOTENO,
			MAX(A.SHPR) 												AS SHPR,
			MAX(A.SHPR_NM) 												AS SHPRNM,
			(SELECT 
				MAX(VSL_NM)
			FROM 
				TMT_VSL_PART			P
			WHERE 
				P.VSL_CD 					= B.VSL_CD
			)															AS VSLNM,
			(SELECT TOP(1)
				A.LORRY_NO
			FROM 
				TMT_CG_ARRV_DELV 										A
			WHERE    
				1 = 1
				<if test="lorryNo != null and lorryNo != ''">
					AND A.LORRY_NO 		= #{lorryNo}
				</if>
					AND A.VSL_CALL_ID 	= G.VSL_CALL_ID
					AND A.CG_NO 		= G.GR_NO
			)															AS LORRYNO,
			(SELECT TOP(1)
				A.GATE_TXN_NO
			FROM 
				TMT_CG_ARRV_DELV 		A
			WHERE    
				1 = 1
				<if test="lorryNo != null and lorryNo != ''">
					AND A.LORRY_NO 		= #{lorryNo}
				</if>
					AND A.VSL_CALL_ID 	= G.VSL_CALL_ID
					AND A.CG_NO 		= G.GR_NO
			) 															AS GATETXNNO,
			MAX(C.STAT_CD) 												AS STAT,
			dbo.F_GET_CARGO_STAT(
				G.VSL_CALL_ID, 
				MAX(G.SHIPG_NOTE_NO)
			) 															AS hiddenStatus,
			ISNULL(MAX(C.STAT_CD), 'RS') 								AS STATCD,
			dbo.F_CM_CODE_NM (
				'MT', 
				'CGSTATUS', 
				ISNULL(MAX(C.STAT_CD), 
				'RS')
			)															AS STATNM,
			(SELECT 
				COUNT(R.CHASSIS_NO)
			FROM 
				TMT_RORO_MST 			R
			WHERE     
				R.VSL_CALL_ID 			= G.VSL_CALL_ID
				AND R.CG_NO 			= A.SHIPG_NOTE_NO
				AND R.GR_NO 			= G.GR_NO
				AND R.IX_CD 			= 'X'
			GROUP BY 
				R.GR_NO
			) 															AS PKGQTY,
			ISNULL (MAX(C.DOC_WGT), 0)
			+ ISNULL(
				SUM(
					CASE J.RC_CO_CD
						WHEN 'DC' THEN -J.CG_WGT
						WHEN 'IC' THEN J.CG_WGT
						ELSE 0
					END 
				),
				0)														AS WGT,
			ISNULL (MAX(C.CBM), 0)
			+ ISNULL(
				SUM(
					CASE J.RC_CO_CD
						WHEN 'DC' THEN -J.CG_VOL
						WHEN 'IC' THEN J.CG_VOL
						ELSE 0
					END 
				),	
				0)														AS MSRMT,
			CASE 
				SUM(
					CASE J.JOB_CO_CD
						WHEN 'D' THEN 1
						ELSE 0
					END 
				)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END 														AS DMGYN,
			CASE COUNT(J.RC_CO_CD)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END															AS RCYN,
			CASE dbo.F_GET_INV_LOC (G.VSL_CALL_ID, G.GR_NO)
				WHEN ' ' THEN 'N'
			END 														AS ISEXISTEDCARGO,
			CASE 
				SUM(
					CASE J.JOB_CO_CD
						WHEN 'S' THEN 1
						ELSE 0
					END
				)
				WHEN 0 THEN 'N'
				ELSE 'Y'
			END 														AS SHUYN,
			CASE 
				WHEN MAX(C.RHDL_MODE) IS NULL 	THEN 'N'
				WHEN MAX(C.RHDL_MODE) = '' 		THEN 'N'
				WHEN MAX(C.RHDL_MODE) = 'N' 	THEN 'N'
				ELSE 'Y'
			END 														AS RHDLMODE,

			<!-- Invalid column name HDL_IN_END_DT 
			<if test="vslCallId == null or vslCallId == ''">
				MIN(
					ISNULL(
						CASE
							WHEN J.JOB_PURP_CD <![CDATA[ <> ]]> 'GW' 
								THEN NULL
							WHEN (J.WORK_END_DT IS NULL 
									OR J.WORK_END_DT = '')
								THEN NULL
							ELSE 
								FORMAT(J.WORK_END_DT, 'dd/MM/yyyy HH:mm')
						END
					, 	CASE 
							WHEN C.HDL_IN_END_DT IS NULL THEN NULL
							ELSE 
								FORMAT(C.HDL_IN_END_DT, 'dd/MM/yyyy HH:mm')
						END 
					)
				) 														AS HDLINDT,
			</if>
			--> 
			MAX(A.DELV_TP_CD) 											AS DELVTPCD,
			(SELECT 
				MAX(TCM.S_CD_NM)
			FROM 
				TMT_CD_MSTD 				TCM
			WHERE     
				TCM.L_CD 					= 'MT'
				AND TCM.M_CD				= 'DELVTP'
				AND TCM.S_CD 				= A.DELV_TP_CD
			) 															AS DELVTPNM,
			MAX(C.CATG_CD) 												AS CATGCD,
			(SELECT 
				MAX(TCM.S_CD_NM)
			FROM 
				TMT_CD_MSTD TCM
			WHERE     
				TCM.L_CD 			= 'MT'
				AND TCM.M_CD 		= 'CATGTP'
				AND TCM.S_CD 		=
						(SELECT TOP(1)
							S.CATG_CD
						FROM 
							TMT_SHIPG_NOTE 		S
						WHERE     
							S.SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
							AND S.VSL_CALL_ID 	= G.VSL_CALL_ID
						)
				
			) 															AS CATGNM,
			(SELECT 
				MAX(S.CG_TP_CD)
			FROM 
				TMT_SHIPG_NOTE 			S
			WHERE     
				S.VSL_CALL_ID 			= G.VSL_CALL_ID
				AND S.SHIPG_NOTE_NO 	= G.SHIPG_NOTE_NO
			) 															AS CGTPCD,
			SUM (
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.CG_WGT
					WHEN 'GV' THEN J.CG_WGT
					WHEN 'BV' THEN J.CG_WGT
					ELSE 0
				END
			) 															AS ACCLOADMT,
			SUM (
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.CG_VOL
					WHEN 'GV' THEN J.CG_VOL
					WHEN 'BV' THEN J.CG_VOL
					ELSE 0
				END
			) 															AS ACCLOADM3,
			SUM (
				CASE J.JOB_PURP_CD
					WHEN 'WV' THEN J.PKG_QTY
					WHEN 'GV' THEN J.PKG_QTY
					WHEN 'BV' THEN J.PKG_QTY
					ELSE 0
				END
			)															AS ACCLOADQTY,
			MAX(G.CG_VOL) 												AS DOCM3,
			MAX(G.PKG_QTY) 												AS DOCQTY,
			MAX(G.CG_WGT) 												AS DOCMT,
			dbo.F_GET_INV_LOC (G.VSL_CALL_ID, G.GR_NO) 					AS WHLOCIDS,
			MAX(ISNULL(J.PKG_NO, ' ')) 									AS PKGNO,
			MAX(A.SHIPG_AGNCY)											AS SHACD,
			dbo.F_GET_PARTNER_INFO (MAX(A.SHIPG_AGNCY), 'ENG_SNM') 		AS SHANM,
			MAX(A.FWRD) 												AS FWDCD,
			dbo.F_GET_PARTNER_INFO (MAX(A.FWRD), 'ENG_SNM') 			AS FWDNM,
			MAX(A.CMDT_GRP_CD) 											AS CMDTGRPCD,
			MAX(A.CMDT_CD) 												AS CMDTCD,
			(SELECT
				MAX(M.CMDT_GRP_DESC)
			FROM 
				TMT_CMDT_GRP 			M
			WHERE 
				M.CMDT_GRP_CD 			= A.CMDT_GRP_CD
			) 															AS cmdtGrpNm,
			(SELECT TOP(1)
				MAX(CMDT.CMDT_DESC)
			FROM 
				TMT_CMDT 				CMDT,
				TMT_SHIPG_NOTE			S
			WHERE 
				CMDT.CMDT_CD 		= S.CMDT_CD
			) 															AS CMDTNM,
			MAX(A.PKG_TP_CD) 											AS PKGTPCD,
			dbo.F_CM_CODE_NM('MT', 'PKGTP', MAX(A.PKG_TP_CD)) 			AS PKGTPNM,
			dbo.F_CM_CODE_NM('MT', 'CGTP', MAX(A.CG_TP_CD))				AS CGTPCDNM,
			MAX(A.SHPR) + ' / ' + MAX(A.CNSNE) 							AS SHPCNSCD,
			dbo.F_GET_PARTNER_INFO (MAX(A.SHPR), 'ENG_SNM')
			+ ' / '
			+ dbo.F_GET_PARTNER_INFO (MAX(A.CNSNE), 'ENG_SNM') 			AS SHPCNSNM,
			MAX(A.EACH_WGT) 											AS EACHMT,
			MAX(A.EACH_VOL) 											AS EACHM3,
			MAX(A.LENGTH) 												AS LENGTH,
			MAX(A.WIDTH) 												AS WIDTH,
			MAX(A.HEIGHT) 												AS HEIGHT,
			MAX(A.MARK_NO) 												AS MARKSNO,
			MAX(A.GDS_RMK) 												AS GOODSRMK,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.PKG_QTY
					ELSE 0
				END 
			) 															AS storedQty,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.CG_WGT
					ELSE 0
				END 
			) 															AS storedMt,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'GW' THEN J.CG_VOL
					ELSE 0
				END 
			) 															AS storedM3,
			SUM(
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.PKG_QTY
					WHEN 'GV' THEN J.PKG_QTY
					WHEN 'BV' THEN J.PKG_QTY
					ELSE 0
				END
			)															AS loadedQty,
			SUM (
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.CG_WGT
					WHEN 'GV' THEN J.CG_WGT
					WHEN 'BV' THEN J.CG_WGT
					ELSE 0
				END 
			) 															AS loadedMt,
			SUM (
				CASE J.JOB_PURP_CD
					WHEN 'AV' THEN J.CG_VOL
					WHEN 'GV' THEN J.CG_VOL
					WHEN 'BV' THEN J.CG_VOL
					ELSE 0
				END 
			) 															AS loadedM3,
			MAX(D.WGT) 													AS GateInMt,
			MAX(D.PKG_QTY) 												AS gateInQty,
			MAX(D.MSRMT) 												AS gateInM3,
			MAX(A.LOT_NO) 												AS userRefNo
		FROM 
			TMT_SHIPG_NOTE 												A, 
			TMT_GR 														G
		LEFT OUTER JOIN
			TMT_RORO_MST 												C
				ON G.VSL_CALL_ID 										= C.VSL_CALL_ID
		LEFT OUTER JOIN 
			TMT_VSL_SCH 												B
				ON G.VSL_CALL_ID 										= B.VSL_CALL_ID	
		LEFT OUTER JOIN
			TMT_JOB 													J
				ON G.VSL_CALL_ID 										= J.VSL_CALL_ID
		LEFT OUTER JOIN
			(SELECT 	
				VSL_CALL_ID,
				CG_NO,
				MAX(LORRY_NO) 				AS LORRY_NO,
				MAX(CG_WGT) 				AS WGT,  
				MAX(PKG_QTY) 				AS PKG_QTY,  
				MAX(CG_VOL) 				AS MSRMT
			FROM	
				TMT_CG_ARRV_DELV 
			WHERE 	
				1 = 1
				<if test="lorryNo != null and lorryNo != ''">
					AND LORRY_NO 			= #{lorryNo}
				</if>
				<if test="driverId != null and driverId != ''">
					AND DRIVER_ID 			= #{driverId}
				</if>
			GROUP BY 
				VSL_CALL_ID, 
				CG_NO) 													D
					ON G.VSL_CALL_ID 									= D.VSL_CALL_ID
					AND G.GR_NO 										= D.CG_NO
		WHERE	
			A.SHIPG_NOTE_NO 											= G.SHIPG_NOTE_NO
			AND A.VSL_CALL_ID 											= G.VSL_CALL_ID
			AND G.SHIPG_NOTE_NO 										= C.CG_NO
			AND G.GR_NO 												= J.CG_NO		
			<if test="vslCallId != null and vslCallId != ''">
				AND G.VSL_CALL_ID 										= #{vslCallId}
			</if>
			<if test="vslCallId == null or vslCallId == ''">
				AND G.VSL_CALL_ID 										&lt;&gt; 'STRG'
			</if>
			<if test="shipgNoteNo != null and shipgNoteNo != ''">
				AND G.SHIPG_NOTE_NO										= #{shipgNoteNo}
			</if>
			<if test="bookingNo != null and bookingNo != ''">
				AND A.MF_DOC_ID											= #{bookingNo}
			</if>
			<if test="cgNo != null and cgNo != ''">
				AND G.GR_NO 											LIKE '%' + #{cgNo} + '%'
			</if>
			<if test="lorryNo != null and lorryNo != ''">
				AND EXISTS ( 
					SELECT 
						A.UPDATE_TIME,
						A.LORRY_NO,
						A.VSL_CALL_ID,
						A.CG_NO
					FROM 
						TMT_CG_ARRV_DELV 	A
					WHERE    
						A.LORRY_NO 			= #{lorryNo}
						AND A.VSL_CALL_ID 	= G.VSL_CALL_ID
						AND A.GR_NO 		= G.GR_NO )
			</if>
			<if test="driverId != null and driverId != ''">
				AND EXISTS ( 
					SELECT 
						A.UPDATE_TIME,
						A.DRIVER_ID,
						A.VSL_CALL_ID,
						A.CG_NO
					FROM 
						TMT_CG_ARRV_DELV 	A
					WHERE    
						A.DRIVER_ID 		= #{driverId}
						AND A.VSL_CALL_ID 	= G.VSL_CALL_ID
						AND A.GR_NO 		= G.GR_NO )
			</if>
			<if test="userRefNo != null and userRefNo != ''">
				AND A.LOT_NO 											LIKE '%' + #{userRefNo} + '%'
			</if>
			<if test="pkgNo != null and pkgNo != ''">
				AND EXISTS ( 
					SELECT		
						P.PKG_NO
					FROM 	
						TMT_PKG_INFO 		P
					WHERE  	
						P.PKG_NO 			LIKE '%' + #{pkgNo} + '%'
						AND P.VSL_CALL_ID 	= A.VSL_CALL_ID
						AND P.REF_NO 		= A.SHIPG_NOTE_NO )
			</if>
			<choose>
				<when test='bargeCheckYn eq "Y".toString()'>
					AND A.DELV_TP_CD 									= 'D'
					AND G.TSPT_TP_CD 									= 'SE'
				</when>
				<otherwise>
					AND G.TSPT_TP_CD !									= 'SE'
				</otherwise>
			</choose>
		GROUP BY 
			G.GR_NO, 
			G.VSL_CALL_ID,
			A.CMDT_CD, 
			A.SHIPG_NOTE_NO,
			G.SHIPG_NOTE_NO,
			B.VSL_CD,
			A.DELV_TP_CD,
			A.CMDT_GRP_CD
	</sql>
	  
	<sql id="getCargoExportForROROListbySN">
		SELECT DISTINCT /* cargoManualCtlExport.getCargoExportForROROListbySN */
			A.VSL_CALL_ID 										AS VSLCALLID, 
			<if test="(lorryNo != null and lorryNo != '') or (driverId != null and driverId != '')">
				MIN(GR.GR_NO) 									AS CGNO,
				MIN(GR.GR_NO) 									AS GRNO,
				ISNULL(
				(S.REMAIN_VIN - ISNULL(STORED.CHAS_NO, 0))
				, 0) 											AS remainUnit,
			</if>  
			A.SHIPG_NOTE_NO 									AS SHIPGNOTENO,
			MAX(A.CATG_CD) 										AS CATGCD,
			dbo.F_CM_CODE_NM('MT','CATGTP', MAX(A.CATG_CD)) 	AS CATGNM,
			MAX(A.DELV_TP_CD) 									AS DELVTPCD,
			dbo.F_CM_CODE_NM('MT','DELVTP', MAX(A.DELV_TP_CD)) 	AS DELVTPNM,
			MAX(A.SHIPG_AGNCY) 									AS SHACD,
			dbo.F_GET_PARTNER_INFO(
				MAX(A.SHIPG_AGNCY), 
				'ENG_SNM'
			) 													AS SHANM,
			MAX(A.FWRD) 										AS FWDCD,
			dbo.F_GET_PARTNER_INFO (MAX(A.FWRD), 'ENG_SNM') 	AS FWDNM,
			MAX(A.CG_TP_CD) 									AS CGTPCD,
			MAX(A.CMDT_CD) 										AS CMDTCD,
			(SELECT  
				MAX(M.CMDT_GRP_DESC)
			FROM 
				TMT_CMDT_GRP	M,
				TMT_SHIPG_NOTE	S
			WHERE 
				M.CMDT_GRP_CD 		= S.CMDT_GRP_CD
			) 													AS cmdtGrpNm,
			A.CG_WGT 											AS WGT,
			A.CG_VOL 											AS MSRMT,
			A.PKG_QTY 											AS PKGQTY,
			A.HEIGHT 											AS height,
			A.WIDTH 											AS width,
			A.LENGTH 											AS LENGTH,
			(SELECT 
				MAX(CMDT.CMDT_DESC) 
			FROM 
				TMT_CMDT 			CMDT,
				TMT_SHIPG_NOTE		S
			WHERE 
				CMDT.CMDT_CD 		= S.CMDT_CD
			) 													AS CMDTNM,
			MAX(A.PKG_TP_CD) 									AS PKGTPCD,
			dbo.F_CM_CODE_NM('MT', 'PKGTP', MAX(A.PKG_TP_CD)) 	AS PKGTPNM,
			dbo.F_CM_CODE_NM('MT', 'CGTP', MAX(A.CG_TP_CD)) 	AS CGTPCDNM,
			MAX(A.SHPR) + ' / ' + MAX(A.CNSNE) 					AS SHPCNSCD,
			dbo.F_GET_PARTNER_INFO(
				MAX(A.SHPR), 'ENG_SNM') 
				+ ' / ' + 
				dbo.F_GET_PARTNER_INFO(
					MAX(A.CNSNE), 
					'ENG_SNM'
				) 												AS SHPCNSNM,
			MAX(A.GDS_RMK) 										AS GOODSRMK,
			MAX(A.MARK_NO) 										AS MARKSNO,
			MAX(A.PKG_NO) 										AS PKGNO,
			MAX(A.LOT_NO) 										AS userRefNo,
			dbo.F_GET_INV_LOC(GR.VSL_CALL_ID, GR.GR_NO)     	AS WHLOCIDS, 
			BR.BRAND_NM 										AS brandNm,
			M.MODEL_NM 											AS modelNm, 
			dbo.F_CM_CODE_NM (
				'MT', 
				'CGSTATUS', 
				ISNULL(MAX(C.STAT_CD), 
				'RS')
			)													AS STATNM
		FROM 
			TMT_SHIPG_NOTE 										A
		INNER JOIN 
			TMT_GR												GR
				ON GR.VSL_CALL_ID 								= A.VSL_CALL_ID
				AND GR.SHIPG_NOTE_NO 							= A.SHIPG_NOTE_NO
		<!-- Show status when the list type is 'SN'. -->
		LEFT OUTER JOIN (
			SELECT
				CG_NO,
				GR_NO,
				VSL_CALL_ID,
				BRAND_CD,
				MODEL_CD,
				GATE_IN_DTM,
				MAX(STAT_CD) OVER(ORDER BY UPDATE_TIME DESC)	AS STAT_CD
			FROM 
				TMT_RORO_MST 
		) 														C 
			ON A.SHIPG_NOTE_NO 									= C.CG_NO   
			AND C.VSL_CALL_ID 									= A.VSL_CALL_ID
		LEFT OUTER JOIN 
			TMT_BRAND BR 
				ON C.BRAND_CD 									= BR.BRAND_CD
		LEFT OUTER JOIN 
			TMT_BRAND_DTL M 
				ON C.MODEL_CD 									= M.MODEL_CD 
				AND C.BRAND_CD 									= M.BRAND_CD
		LEFT OUTER JOIN 
			(SELECT 
				COUNT(R1.CHASSIS_NO) 	AS REMAIN_VIN,
				R1.VSL_CALL_ID,
				R1.MF_DOC_ID,
				R1.CG_NO
			FROM 
				TMT_RORO_MST 			R1
			WHERE     
				R1.VSL_CALL_ID 			= #{vslCallId}
				AND (R1.IN_DTM IS NULL 	OR R1.IN_DTM = '')
				AND (R1.OUT_DTM IS NULL OR R1.OUT_DTM = '')
				AND R1.CG_TP_CD 		IN ('RCV')
			GROUP BY 
				R1.VSL_CALL_ID, 
				R1.MF_DOC_ID, 
				R1.CG_NO
			) 													S  
				ON A.VSL_CALL_ID 								= S.VSL_CALL_ID 
				AND A.SHIPG_NOTE_NO 							= S.CG_NO
		LEFT OUTER JOIN 
			(SELECT
				SUM (JO.CG_WGT) 		AS MT,
				SUM (JO.CG_VOL) 		AS M3,
				SUM (JO.PKG_QTY) 		AS QTY,
				JO.VSL_CALL_ID 			AS VSL_CALL_ID,
				JO.CG_NO 				AS CG_NO,
				<!-- TODO -->
				<!--
				ISNULL(
					dbo.REGEXP_COUNT(JO.CHAS_NO, ',') + 1
				, 0) 
				-->					
				1						AS CHAS_NO
			FROM 
				TMT_JOB 				JO
			WHERE     
				JO.VSL_CALL_ID 			= #{vslCallId}
				AND JO.JOB_PURP_CD 		= 'GW'
			GROUP BY 
				JO.VSL_CALL_ID, 
				JO.CG_NO,
				JO.CHAS_NO
			) 													STORED 
				ON A.VSL_CALL_ID 		= STORED.VSL_CALL_ID 
				AND GR.GR_NO 			= STORED.CG_NO
		<where>
				(C.GATE_IN_DTM IS NOT NULL AND C.GATE_IN_DTM <![CDATA[<>]]> '')
				<if test="vslCallId != null and vslCallId != ''">
					AND A.VSL_CALL_ID 							= #{vslCallId}
				</if>

				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND A.SHIPG_NOTE_NO 						= #{shipgNoteNo}
				</if>
				<if test="bookingNo != null and bookingNo != ''">
					AND A.MF_DOC_ID							 	= #{bookingNo}
				</if>
				<if test="truckType == 1">
					<if test="lorryNo != null and lorryNo != ''">
						AND EXISTS (
				            SELECT 
								SHIPG_NOTE_NO
				            FROM 
								TMT_ASSIGN_TRANSPORT AT
				            WHERE 
								AT.VSL_CALL_ID 		= A.VSL_CALL_ID 
								AND AT.SHIPG_NOTE_NO= A.SHIPG_NOTE_NO
				                AND AT.LORRY_NO 	= #{lorryNo})
					</if>
				</if>
				<if test="truckType == 0">
					<if test="lorryNo != null and lorryNo != ''">
						AND EXISTS (
				            SELECT 
								GR_NO
				            FROM 
								TMT_CG_ARRV_DELV 	GT
				            WHERE 
								GT.VSL_CALL_ID 		= A.VSL_CALL_ID 
								AND GT.CG_NO 		= GR.GR_NO
				                AND GT.LORRY_NO 	= #{lorryNo})
					</if>
				</if>
				
				<if test="userRefNo != null and userRefNo != ''">
		        	AND A.LOT_NO 								LIKE '%' + #{userRefNo} + '%'
		        </if>
		         <if test="pkgNo != null and pkgNo != ''">
		        	AND EXISTS ( 
						SELECT 
							P.PKG_NO
		                FROM 	
							TMT_PKG_INFO 			P
		                WHERE  	
							P.PKG_NO 				LIKE '%' + #{pkgNo} + '%'
							AND P.VSL_CALL_ID 		= A.VSL_CALL_ID
							AND P.REF_NO 			= A.SHIPG_NOTE_NO )
		        </if>
		</where>
		GROUP BY
		    A.VSL_CALL_ID,
		    A.SHIPG_NOTE_NO, 
            A.CG_WGT,
            A.CG_VOL,
            A.PKG_QTY,
            A.HEIGHT,
            A.WIDTH,
            A.LENGTH,
            GR.VSL_CALL_ID,
			GR.GR_NO,
            BR.BRAND_NM,
	        M.MODEL_NM,
	        S.REMAIN_VIN,
	        STORED.CHAS_NO	 
	</sql>
	
	<update id="updatingYardTruckIndirectLoading"  parameterType="cargoExportItem">
		UPDATE /* cargoManualCtlExport.updatingYardTruckIndirectLoading */
			TMT_JOB
		SET 
			WORK_ST_DT 											= CONVERT(DATETIME, #{startDtStr}, 103),
			WORK_END_DT 										= CONVERT(DATETIME, #{endDtStr}, 103),
			LORRY_NO 											= #{lorryNo},
			STAFF_CD 											= #{userId},
			UPDATE_TIME 										= SYSDATETIME()
		WHERE	
			VSL_CALL_ID 										= #{vslCallId}
		 	AND CG_NO 											= #{cgNo}
		 	AND JOB_NO 											= #{jobNo}
		 	AND JOB_PURP_CD 									= 'WA'
	</update>
	
</mapper>
