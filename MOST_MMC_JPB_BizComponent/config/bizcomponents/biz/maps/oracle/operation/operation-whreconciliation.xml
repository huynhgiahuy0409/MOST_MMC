<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="whReconciliation">
	<resultMap id="whReconciliationMap"	type="whReconciliationItem">
    	<result property="vslCallId"		column="VSL_CALL_ID"/>
    	<result property="vslNm"			column="VSL_NM"/>
    	<result property="masterBlNo"		column="M_BL_NO"/>
    	<result property="blNo"				column="BL_NO"/>
    	<result property="bookingNo"		column="BOOKING_NO"/>
    	<result property="shipgNoteNo"		column="SHIPG_NOTE_NO"/>
    	<result property="cgNo"				column="CG_NO"/>
    	<result property="opeClassCd"		column="OPE_CLASS_CD"/>
    	<result property="opeClassNm"		column="OPE_CLASS_NM"/>
    	<result property="rcCoNm"			column="RC_CO_NM"/>
    	<result property="rhdlYn"			column="RHDLYN"/>
    	<result property="whTpCd"			column="WH_TP_CD"/>
    	<result property="whTpNm"			column="WH_TP_NM"/>
    	<result property="rcYn"				column="RCYN"/>
    	<result property="storedMt"			column="STORED_MT"/>
    	<result property="storedM3"			column="STORED_M3"/>
    	<result property="storedQty"		column="STORED_QTY"/>
    	<result property="actMt"			column="ACT_MT"/>
    	<result property="actM3"			column="ACT_M3"/>
    	<result property="actQty"			column="ACT_QTY"/>
    	<result property="rcMt"				column="RC_MT"/>
    	<result property="rcM3"				column="RC_M3"/>
    	<result property="rcQty"			column="RC_QTY"/>
    	<result property="rhdlMt"			column="RHDL_MT"/>
    	<result property="rhdlM3"			column="RHDL_M3"/>
    	<result property="rhdlQty"			column="RHDL_QTY"/>
    	<result property="balMt"			column="BAL_MT"/>
    	<result property="balM3"			column="BAL_M3"/>
    	<result property="balQty"			column="BAL_QTY"/>
    	<result property="wgt"				column="BAL_MT"/>
    	<result property="msrmt"			column="BAL_M3"/>
    	<result property="pkgQty"			column="BAL_QTY"/>
    	
    	<result property="cmdtCd"			column="CMDT_CD"/>
    	<result property="cmdtNm"			column="CMDT_DESC"/>
    	<result property="lotNo"			column="LOT_NO"/>
    	<result property="whLocTp"			column="WH_LOC_TP"/>
    	<result property="whLocTpNm"		column="WH_LOC_TP_NM"/>
    	<result property="locId"			column="LOC_ID"/>
    	<result property="cnsneName"		column="CNSNE_NM"/>
    	<result property="remarks"			column="RMK"/>
    	
    	<result property="cgTpCd"			column="CG_TP_CD"/>
    	<result property="projectCargo"		column="PROJECT_CARGO"/>
    	<result property="whLocation"		column="WH_LOCATION"/>
    </resultMap>
    
    
	<sql id="sqlWHRecnParm">
		WHERE 1 = 1
		<if test="vslCallId != null and vslCallId != ''">
  			AND
			I.VSL_CALL_ID = #{vslCallId}
		</if>
		<if test="vslCallId == null or vslCallId == ''">
			<if test="category != null and category != ''">
   				AND
				I.VSL_CALL_ID &lt;&gt; 'NonCallId'
			</if>
		</if>
		<if test="whLocId != null and whLocId != ''">
  			AND
			I.WH_LOC_ID = #{whLocId}
		</if>
		<if test="mfDocId != null and mfDocId != ''">
  			AND
			(SELECT MF_DOC_ID FROM TMT_BL WHERE BL_NO = I.CG_NO) = #{mfDocId}
		</if>
		<if test="blNo != null and blNo != ''">
  			AND
			I.CG_NO = #{blNo}
		</if>
		<if test="grNo != null and grNo != ''">
  			AND
			I.CG_NO = #{grNo}
		</if>
		<if test="category == 'S'.toString()">
			<if test="estArrvDtFrom != null and estArrvDtFrom != ''">
				<if test="snNo != null and snNo != ''">
				AND EXISTS ( SELECT SN.SHIPG_NOTE_NO, GR.GR_NO
							   FROM TMT_SHIPG_NOTE SN, TMT_GR GR
							  WHERE SN.SHIPG_NOTE_NO IS NOT NULL
								AND SN.EST_ARRV_DT BETWEEN TO_DATE (#{estArrvDtFrom}||' 00:00','DD/MM/YYYY HH24:MI') 
                                                       AND TO_DATE (#{estArrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
								AND SN.SHIPG_NOTE_NO = #{snNo}
								AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
								AND GR.GR_NO = I.CG_NO )
				</if>
				<if test="snNo == null or snNo == ''">
				AND EXISTS ( SELECT SN.SHIPG_NOTE_NO, GR.GR_NO
							   FROM TMT_SHIPG_NOTE SN, TMT_GR GR
							  WHERE SN.SHIPG_NOTE_NO IS NOT NULL
								AND SN.EST_ARRV_DT BETWEEN TO_DATE (#{estArrvDtFrom}||' 00:00','DD/MM/YYYY HH24:MI') 
                                                       AND TO_DATE (#{estArrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
								AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
								AND GR.GR_NO = I.CG_NO )
				</if>
			</if>
			<if test="estArrvDtFrom == null or estArrvDtFrom == ''">
				<if test="snNo != null and snNo != ''">
				AND EXISTS ( SELECT SN.SHIPG_NOTE_NO, GR.GR_NO
							   FROM TMT_SHIPG_NOTE SN, TMT_GR GR
							  WHERE SN.SHIPG_NOTE_NO IS NOT NULL
								AND SN.SHIPG_NOTE_NO = #{snNo}
								AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
								AND GR.GR_NO = I.CG_NO )
				</if>
			</if>
		</if>
		<if test="category != 'S'.toString()">
			<if test="snNo != null and snNo != ''">
			AND	EXISTS ( SELECT GR.SHIPG_NOTE_NO FROM TMT_GR GR
						  WHERE GR.GR_NO = I.CG_NO 
							AND GR.SHIPG_NOTE_NO = #{snNo} )
			</if>
		</if>
	</sql>

	<sql id="getWHRecnList">
		SELECT 	C.OPE_CLASS_CD OPECLASSCD, 
			   	F_CM_012('MT', 'CATGTP', C.OPE_CLASS_CD) OPECLASSNM, 
				A.VSLCALLID VSLCALLID, 
				DECODE(A.VSLCALLID, 'NonCallId', '-', A.VSLCALLID) VSLCALLIDDSP, 
				(SELECT DECODE(COUNT(*),0, A.CGNO, MAX(SHIPG_NOTE_NO)) FROM TMT_GR WHERE GR_NO = A.CGNO) SNBLNO,
				(SELECT MF_DOC_ID FROM TMT_BL WHERE BL_NO = (SELECT DECODE (COUNT (*), 0, A.CGNO, MAX (SHIPG_NOTE_NO))
          		FROM TMT_GR WHERE GR_NO = A.CGNO) AND ROWNUM = 1) AS MFDOCID,
				(SELECT DECODE(COUNT(*),0, '', A.CGNO) FROM TMT_GR WHERE GR_NO = A.CGNO) GRNO,
				A.CGNO CGNO,
				A.WHTPCD WHTPCD, 
				F_CM_012('MT', 'CGCOCD', A.WHTPCD) WHTPNM, 
				B.SPCACOCD SPCACOCD, 
				B.RCYN RCYN, 
				F_CM_012('MT', 'SPCACOCD', B.SPCACOCD) SPCACONM, 
				C.FWR_AGNT FWRAGNT,
				B.WGT WGT, 
				B.MSRMT MSRMT, 
				B.PKGQTY PKGQTY, 
				A.LOCID LOCID,
			   	CASE WHEN C.OPE_CLASS_CD = 'I' THEN ( select  SHPR from tmt_bl WHERE BL_NO = B.CGNO and rownum =1) ELSE ( select  SHPR from TMT_SHIPG_NOTE WHERE SHIPG_NOTE_NO = (SELECT DECODE (COUNT (*),
                                       0, A.CGNO,
                                       MAX (SHIPG_NOTE_NO))
                          FROM TMT_GR
                         WHERE GR_NO = A.CGNO) and rownum =1) END AS shpr,
			   			   CASE WHEN C.OPE_CLASS_CD = 'I' THEN ( select  SHPR_NM from tmt_bl WHERE BL_NO = B.CGNO and rownum =1) ELSE ( select  SHPR_NM from TMT_SHIPG_NOTE WHERE SHIPG_NOTE_NO = (SELECT DECODE (COUNT (*),
                                       0, A.CGNO,
                                       MAX (SHIPG_NOTE_NO))
                          FROM TMT_GR
                         WHERE GR_NO = A.CGNO) and rownum =1) END AS shprName,
				CASE WHEN C.OPE_CLASS_CD = 'I' THEN ( select  CNSNE from tmt_bl WHERE BL_NO = B.CGNO and rownum =1) ELSE ( select  CNSNE from TMT_SHIPG_NOTE WHERE SHIPG_NOTE_NO = (SELECT DECODE (COUNT (*),
                                       0, A.CGNO,
                                       MAX (SHIPG_NOTE_NO))
                          FROM TMT_GR
                         WHERE GR_NO = A.CGNO) and rownum =1) END AS cnsne,
				CASE WHEN C.OPE_CLASS_CD = 'I' THEN ( select  CNSNE_NM from tmt_bl WHERE BL_NO = B.CGNO and rownum =1) ELSE ( select  CNSNE_NM from TMT_SHIPG_NOTE WHERE SHIPG_NOTE_NO = (SELECT DECODE (COUNT (*),
                                       0, A.CGNO,
                                       MAX (SHIPG_NOTE_NO))
                          FROM TMT_GR
                         WHERE GR_NO = A.CGNO) and rownum =1) END AS cnsneName,
			   	(SELECT 'Y' FROM TMT_RHDL_CG
				 WHERE CG_CO_CD = A.WHTPCD  
				   AND SP_CA_CO_CD = B.SPCACOCD 
				   AND VSL_CALL_ID = A.VSLCALLID 
				   AND CG_NO = A.CGNO 
				   AND ROWNUM = 1) RHDLYN
		FROM	(
			 	    SELECT VSLCALLID, CGNO, WHTPCD, SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOCID, ',')),2) LOCID 
				      FROM (
					  	     SELECT VSLCALLID, CGNO, WHTPCD, LOCID, 
							 		ROW_NUMBER() OVER(PARTITION BY VSLCALLID, CGNO, WHTPCD ORDER BY LOCID) CNT
							   FROM (
										SELECT VSLCALLID, CGNO, WHTPCD, LOCID
										  FROM (
											  SELECT I.VSL_CALL_ID VSLCALLID, 
													 I.CG_NO CGNO, 
													 I.WH_TP_CD WHTPCD, 
													 I.WH_LOC_ID LOCID,
													 SUM(I.CG_WGT) WGT,
								 					 SUM(I.CG_VOL) MSRMT, 
								 					 SUM(I.PKG_QTY) PKGQTY
												FROM TMT_INV_LOC I, TMT_JOB J 
												<include refid="sqlWHRecnParm"/>
												 AND I.JOB_NO = J.JOB_NO
											   GROUP BY I.VSL_CALL_ID, I.CG_NO, I.WH_TP_CD, I.WH_LOC_ID 
											    )
										 WHERE (WGT &lt;&gt; 0 OR MSRMT &lt;&gt; 0 OR PKGQTY &lt;&gt; 0)
									) 
							)
					 START WITH CNT = 1
				   CONNECT BY PRIOR CNT = CNT -1 
				   	   AND PRIOR VSLCALLID = VSLCALLID 
				   	   AND PRIOR CGNO = CGNO 
					   AND PRIOR WHTPCD = WHTPCD
					 GROUP BY VSLCALLID, CGNO, WHTPCD
				) A, 
				( 
					SELECT VSLCALLID, CGNO, WHTPCD, WGT, MSRMT, PKGQTY,
						   NVL((SELECT MAX(SP_CA_CO_CD) FROM TMT_JOB 
						     WHERE VSL_CALL_ID = VSLCALLID 
						       AND CG_NO = CGNO 
						       AND JOB_CO_CD = WHTPCD 
						       AND SP_CA_CO_CD IS NOT NULL), ' ') SPCACOCD, 
						   NVL((SELECT MAX('Y') FROM TMT_JOB 
						     WHERE VSL_CALL_ID = VSLCALLID 
						       AND CG_NO = CGNO 
						       AND JOB_CO_CD = WHTPCD 
						       AND JOB_TP_CD = 'RC'), 'N') RCYN
					  FROM (
						  SELECT I.VSL_CALL_ID VSLCALLID, I.CG_NO CGNO, I.WH_TP_CD WHTPCD, 
						  		 SUM(I.CG_WGT) WGT,
								 SUM(I.CG_VOL) MSRMT, 
								 SUM(I.PKG_QTY) PKGQTY
							FROM TMT_INV_LOC I, TMT_JOB J 
							<include refid="sqlWHRecnParm"/>
							 AND I.JOB_NO = J.JOB_NO
						   GROUP BY I.VSL_CALL_ID, I.CG_NO, I.WH_TP_CD
						    )
					 WHERE (WGT &lt;&gt; 0 OR MSRMT &lt;&gt; 0 OR PKGQTY &lt;&gt; 0)
				) B, 
				TMT_CG_MST C
		WHERE 	A.VSLCALLID = B.VSLCALLID
		  		AND A.CGNO = B.CGNO
		  		AND A.WHTPCD = B.WHTPCD
				AND B.VSLCALLID = C.VSL_CALL_ID
				AND B.CGNO = C.CG_NO   
				<if test="category != null and category != ''">
		  			AND
					C.OPE_CLASS_CD = #{category}
				</if>
				<if test="fwAgent != null and fwAgent != ''">
		  			AND
					C.FWR_AGNT = #{fwAgent}
				</if>
				<if test="cnsne != null and cnsne != ''">
		  			AND
					C.CNSNE = #{cnsne}
				</if>
				<if test="shpr != null and shpr != ''">
		  			AND
					C.SHPR = #{shpr}
				</if>
				<if test="vslCallId != null and vslCallId != ''">
		  			AND
					C.VSL_CALL_ID = #{vslCallId}
				</if>
	</sql>
	
	<sql id="getWarehouseReconcileItems">
		WITH  CHANGE_VSL_INFO 
		     	AS (
		     		SELECT R.VSL_CALL_ID,
		     				R.ORG_REF_NO,
		     				SUM(INV.CG_WGT) WGT,
		     				SUM(INV.CG_VOL) MSRMT,
		     				SUM (INV.PKG_QTY) PKGQTY,
		     				INV.LOC_ID,
		     				INV.CG_NO
		     		FROM TMT_RHDL_CG R INNER JOIN TMT_INV_LOC INV ON INV.VSL_CALL_ID = R.NX_VSL_CALL_ID AND INV.REF_NO = R.NX_REF_NO
		     		WHERE R.RHDL_MODE = 'C'
		     		GROUP BY R.VSL_CALL_ID, R.ORG_REF_NO, INV.LOC_ID, INV.CG_NO
		     	),
		     	
		WH_BALANCE
		     AS (
		     	SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  SUM (I.CG_WGT) WGT,
		                  SUM (I.CG_VOL) MSRMT,
		                  SUM (I.PKG_QTY) PKGQTY,
		                  I.LOC_ID LOC_ID
		             FROM TMT_INV_LOC I
		             
		            <where>
		            	<if test="vslCallId != null and vslCallId != ''">
				  			AND I.VSL_CALL_ID = #{vslCallId}
						</if>
		            </where>
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD
		           HAVING    SUM (I.CG_WGT) != 0
		                  OR SUM (I.CG_VOL) != 0
		                  OR SUM (I.PKG_QTY) != 0),
		     
		     WH_BALANCE_RC
		     AS (
		     	SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  SUM (I.CG_WGT) WGT,
		                  SUM (I.CG_VOL) MSRMT,
		                  SUM (I.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON I.VSL_CALL_ID = J.VSL_CALL_ID AND I.CG_NO = J.CG_NO AND I.JOB_NO = J.JOB_NO
		             
		            <where>
		            	<if test="vslCallId != null and vslCallId != ''">
				  			AND I.VSL_CALL_ID = #{vslCallId}
						</if>
		            </where>
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD),
		      
		     JOB_INFO
		     AS (  SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_TP_CD,
		                  SUM (I.CG_WGT) WGT,
		                  SUM (I.CG_VOL) MSRMT,
		                  SUM (I.PKG_QTY) PKGQTY,
		                  NVL (
		                     (SELECT MAX ('Y')
		                        FROM TMT_JOB
		                       WHERE     VSL_CALL_ID = I.VSL_CALL_ID
		                             AND CG_NO = I.CG_NO
		                             AND JOB_TP_CD = 'RC'),
		                     'N')
		                     RCYN
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON I.JOB_NO = J.JOB_NO
		            <where>
		            	<if test="vslCallId != null and vslCallId != ''">
				  			AND I.VSL_CALL_ID = #{vslCallId}
						</if>
		            </where>
		         GROUP BY I.VSL_CALL_ID, I.CG_NO,I.WH_TP_CD),
		         
		RC_JOB_INFO
		     AS (  SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  J.RC_CO_CD,
		                  MAX(J.RMK) AS RMK,
		                  SUM(I.CG_WGT) WGT,
		                  SUM(I.CG_VOL) MSRMT,
		                  SUM(I.PKG_QTY) PKGQTY
		             FROM TMT_JOB J INNER JOIN TMT_INV_LOC I ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   JOB_TP_CD = 'RC'
		                  	<if test="vslCallId != null and vslCallId != ''">
				  				AND I.VSL_CALL_ID = #{vslCallId}
							</if>
		         GROUP BY I.VSL_CALL_ID, I.CG_NO, J.RC_CO_CD),
		IN_JOB_INFO AS
		(
			SELECT AA.VSL_CALL_ID,
			       AA.CG_NO,
			       AA.WH_LOC_ID,
			       AA.WH_TP_CD,
			       AA.WGT,
			       AA.MSRMT,
			       AA.PKGQTY,
			       (SELECT MAX(WH_LOC_TP)
			        FROM TMT_INV_LOC
			        WHERE  VSL_CALL_ID = AA.VSL_CALL_ID
			               AND CG_NO = AA.CG_NO
			               AND WH_LOC_ID = AA.WH_LOC_ID) WH_LOC_TP,
			       AA.LOC_ID
			  FROM (SELECT I.VSL_CALL_ID,
				                  I.CG_NO,
				                  I.WH_LOC_ID,
				                  I.WH_TP_CD,
				                  SUM(I.CG_WGT) WGT,
				                  SUM(I.CG_VOL) MSRMT,
				                  SUM(I.PKG_QTY) PKGQTY,
				                  I.LOC_ID
				             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
				            WHERE   1=1
				            		<if test="vslCallId != null and vslCallId != ''">
						  				AND I.VSL_CALL_ID = #{vslCallId}
									</if>
				                    AND (J.JOB_PURP_CD IN ('AW', 'GW') 
				                    	OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'MV')
				                    	OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'RC'))
				         GROUP BY I.VSL_CALL_ID,
				                  I.CG_NO,
				                  I.WH_LOC_ID,
				                  I.WH_TP_CD,
				                  I.LOC_ID) AA
		),
		
		IN_JOB_INFO_RC AS
		(
		    SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP,
		                  SUM(I.CG_WGT) WGT,
		                  SUM(I.CG_VOL) MSRMT,
		                  SUM(I.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   1=1
		            		<if test="vslCallId != null and vslCallId != ''">
				  				AND I.VSL_CALL_ID = #{vslCallId}
							</if>
		                    AND (J.JOB_PURP_CD IN ('AW', 'GW') 
		                    	OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'MV')
		                    	OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'RC'))
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP
		),
		
		OUT_JOB_INFO AS
		(
		    SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  SUM (J.CG_WGT) WGT,
		                  SUM (J.CG_VOL) MSRMT,
		                  SUM (J.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   J.JOB_PURP_CD IN ('WG', 'WA')
		            		<if test="vslCallId != null and vslCallId != ''">
				  				AND I.VSL_CALL_ID = #{vslCallId}
							</if>
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD
		),
		
		OUT_JOB_INFO_RC AS
		(
		    SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD,
		                  SUM (J.CG_WGT) WGT,
		                  SUM (J.CG_VOL) MSRMT,
		                  SUM (J.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   J.JOB_PURP_CD IN ('WG', 'WA')
		            		<if test="vslCallId != null and vslCallId != ''">
				  				AND I.VSL_CALL_ID = #{vslCallId}
							</if>
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.WH_TP_CD
		),
		
		RHDL_JOB_INFO AS
		(
		    SELECT  I.VSL_CALL_ID,
		        I.CG_NO,
		        I.WH_LOC_ID,
		        I.WH_TP_CD,
		        SUM(J.CG_WGT) AS WGT,
		        SUM (J.CG_VOL) MSRMT,
		        SUM (J.PKG_QTY) PKGQTY
		
		FROM    TMT_RHDL_CG R 
		        INNER JOIN TMT_JOB J ON R.RHDL_NO = J.RHDL_NO
		        INNER JOIN TMT_INV_LOC I ON J.JOB_NO = I.JOB_NO
		        
		
		WHERE   J.JOB_PURP_CD IN ('GW')
				 AND ((R.RHDL_MODE = 'R' AND I.CG_NO NOT IN (SELECT GR_NO FROM TMT_GR WHERE RHDL_MODE = 'R'))
            			OR (R.RHDL_MODE = 'C'))
<!-- 				AND I.CG_NO NOT IN (SELECT GR_NO FROM TMT_GR WHERE RHDL_MODE IS NOT NULL)				 -->
				<if test="vslCallId != null and vslCallId != ''">
					AND (R.VSL_CALL_ID = #{vslCallId} OR R.NX_VSL_CALL_ID = #{vslCallId})
				</if>
		        
		GROUP BY 
		        I.VSL_CALL_ID,
		        I.CG_NO,
		        I.WH_LOC_ID,
		        I.WH_TP_CD
		)
		
		SELECT  DISTINCT
				C.VSL_CALL_ID,
		        P.VSL_NM,
		        C.OPE_CLASS_CD,
		        F_CM_012 ('MT', 'CATGTP', C.OPE_CLASS_CD) OPE_CLASS_NM,
		        B.BL_NO,
		        B.MF_DOC_ID AS M_BL_NO,
		        S.SHIPG_NOTE_NO,
		        S.MF_DOC_ID AS BOOKING_NO,
		        C.CG_NO,
		        J.RCYN,
		        J.WH_TP_CD,
		        F_CM_012 ('MT', 'CGCOCD', J.WH_TP_CD) WH_TP_NM,
		        R.RC_CO_CD,
		        F_CM_012 ('MT', 'RCCOCD', R.RC_CO_CD) RC_CO_NM,
		        
		        NVL(B.CMDT_CD, S.CMDT_CD) AS CMDT_CD,
        		F_GET_CMDT_DESC (NVL(B.CMDT_CD, S.CMDT_CD)) AS CMDT_DESC,
        		NVL(B.LOT_NO, S.LOT_NO) AS LOT_NO,
        		I.WH_LOC_TP,
        		F_CM_012 ('MT', 'WHTP', I.WH_LOC_TP) WH_LOC_TP_NM,
		        
		        NVL(I.WGT, 0) AS STORED_MT,
		        NVL(I.MSRMT, 0) AS STORED_M3,
		        NVL(I.PKGQTY, 0) AS STORED_QTY,
		        
		        CASE WHEN NVL (O.WGT, 0) = 0 THEN NVL (ORC.WGT, 0)
            		ELSE NVL (O.WGT, 0)
       			END AS ACT_MT,
			    CASE WHEN NVL (O.MSRMT, 0) = 0 THEN NVL (ORC.MSRMT, 0)
			         ELSE NVL (O.MSRMT, 0)
			    END AS ACT_M3,
			    CASE WHEN NVL (O.PKGQTY, 0) = 0 THEN NVL (ORC.PKGQTY, 0)
			         ELSE NVL (O.PKGQTY, 0)
			    END AS ACT_QTY,
		        
		        NVL(R.WGT, 0) AS RC_MT,
		        NVL(R.MSRMT, 0) AS RC_M3,
		        NVL(R.PKGQTY, 0) AS RC_QTY,
		        
<!-- 		        NVL(R1.WGT, 0) AS RHDL_MT, -->
<!-- 		        NVL(R1.MSRMT, 0) AS RHDL_M3, -->
<!-- 		        NVL(R1.PKGQTY, 0) AS RHDL_QTY, -->
				NVL((SELECT CG_WGT FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = C.VSL_CALL_ID AND (ORG_REF_NO = C.BL_NO OR ORG_REF_NO = C.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDL_MT,
        		NVL((SELECT CG_VOL FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = C.VSL_CALL_ID AND (ORG_REF_NO = C.BL_NO OR ORG_REF_NO = C.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDL_M3,
        		NVL((SELECT PKG_QTY FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = C.VSL_CALL_ID AND (ORG_REF_NO = C.BL_NO OR ORG_REF_NO = C.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDL_QTY,
		        
<!-- 		        NVL(I.WGT, 0) - NVL(O.WGT, 0) - NVL(R1.WGT, 0) AS BAL_MT, -->
<!-- 		        NVL(I.MSRMT, 0) - NVL(O.MSRMT, 0) - NVL(R1.MSRMT, 0) AS BAL_M3, -->
<!-- 		        NVL(I.PKGQTY, 0) - NVL(O.PKGQTY, 0) - NVL(R1.PKGQTY, 0) AS BAL_QTY, -->
<!--			NVL(W.WGT, 0) - NVL(CHGVSL.WGT, 0) AS BAL_MT,
        		NVL(W.MSRMT, 0) - NVL(CHGVSL.MSRMT, 0) AS BAL_M3,
        		NVL(W.PKGQTY, 0) - NVL(CHGVSL.PKGQTY, 0) AS BAL_QTY,-->
        		NVL(W.WGT, 0) AS BAL_MT,
				NVL(W.MSRMT, 0) AS BAL_M3,
				NVL(W.PKGQTY, 0) AS BAL_QTY,
		        
		        (SELECT LISTAGG(W1.WH_LOC_ID, ', ') WITHIN GROUP (ORDER BY W1.VSL_CALL_ID, W1.CG_NO) AS LOC_ID FROM IN_JOB_INFO W1 WHERE W1.VSL_CALL_ID = C.VSL_CALL_ID AND W1.CG_NO = C.CG_NO) AS LOC_ID,
		        NVL(B.SHPR, S.SHPR) AS SHPR,
		        F_GET_PARTNER_INFO(NVL(B.SHPR, S.SHPR), 'ENG_SNM') AS SHPR_NM,
		        NVL(B.CG_TP_CD, S.CG_TP_CD) AS CG_TP_CD,
        		NVL(B.PROJECT_CARGO , S.PROJECT_CARGO) AS PROJECT_CARGO,
		        
		        NVL(B.CNSNE, S.CNSNE) AS CNSNE,
		        F_GET_PARTNER_INFO(NVL(B.CNSNE, S.CNSNE), 'ENG_SNM') AS CNSNE_NM,
				NVL((SELECT 'Y' FROM TMT_RHDL_CG WHERE  NX_VSL_CALL_ID = C.VSL_CALL_ID AND (NX_REF_NO = C.BL_NO OR NX_REF_NO = C.SHIPG_NOTE_NO) AND ROWNUM = 1), 'N') RHDLYN,
		        R.RMK,
		        I.LOC_ID AS WH_LOCATION
		FROM    TMT_CG_MST C
		        LEFT OUTER JOIN WH_BALANCE W ON C.VSL_CALL_ID = W.VSL_CALL_ID AND C.CG_NO = W.CG_NO
		        LEFT OUTER JOIN WH_BALANCE_RC WRC ON C.VSL_CALL_ID = WRC.VSL_CALL_ID AND C.CG_NO = WRC.CG_NO
		        LEFT OUTER JOIN RC_JOB_INFO R ON C.VSL_CALL_ID = R.VSL_CALL_ID AND C.CG_NO = R.CG_NO
		        LEFT OUTER JOIN IN_JOB_INFO I ON C.VSL_CALL_ID = I.VSL_CALL_ID AND C.CG_NO = I.CG_NO AND W.WH_LOC_ID = I.WH_LOC_ID
		        LEFT OUTER JOIN IN_JOB_INFO_RC IRC ON C.VSL_CALL_ID = IRC.VSL_CALL_ID AND C.CG_NO = IRC.CG_NO AND IRC.WH_LOC_ID = IRC.WH_LOC_ID
		        LEFT OUTER JOIN OUT_JOB_INFO O ON C.VSL_CALL_ID = O.VSL_CALL_ID AND C.CG_NO = O.CG_NO AND I.WH_LOC_ID = O.WH_LOC_ID
		        LEFT OUTER JOIN OUT_JOB_INFO_RC ORC ON C.VSL_CALL_ID = ORC.VSL_CALL_ID AND C.CG_NO = ORC.CG_NO AND IRC.WH_LOC_ID = ORC.WH_LOC_ID
		        LEFT OUTER JOIN RHDL_JOB_INFO R1 ON C.VSL_CALL_ID = R1.VSL_CALL_ID AND C.CG_NO = R1.CG_NO
		        LEFT OUTER JOIN JOB_INFO J ON C.VSL_CALL_ID = J.VSL_CALL_ID AND C.CG_NO = J.CG_NO	        
		        LEFT OUTER JOIN TMT_BL B ON C.VSL_CALL_ID = B.VSL_CALL_ID AND C.CG_NO = B.BL_NO
		        LEFT OUTER JOIN TMT_SHIPG_NOTE S ON C.VSL_CALL_ID = S.VSL_CALL_ID AND C.SHIPG_NOTE_NO = S.SHIPG_NOTE_NO
		        LEFT OUTER JOIN TMT_VSL_SCH V ON C.VSL_CALL_ID = V.VSL_CALL_ID
		        LEFT OUTER JOIN TMT_VSL_PART P ON V.VSL_CD = P.VSL_CD
		        LEFT OUTER JOIN CHANGE_VSL_INFO CHGVSL ON I.VSL_CALL_ID = CHGVSL.VSL_CALL_ID 
		             		AND (CASE WHEN C.SHIPG_NOTE_NO IS NOT NULL THEN C.SHIPG_NOTE_NO
		             				 ELSE C.BL_NO 
		             			END) = CHGVSL.ORG_REF_NO
		        
		WHERE   1=1
				AND (W.CG_NO IS NOT NULL OR (W.CG_NO IS NULL AND R.CG_NO IS NOT NULL)) AND C.CG_NO NOT LIKE 'RTS' || '%'
				<if test="vslCallId != null and vslCallId != ''">
					 AND C.VSL_CALL_ID = #{vslCallId}
				</if>
				<if test="category != null and category != ''">
		  			AND C.OPE_CLASS_CD = #{category}
				</if>
				<if test="cnsne != null and cnsne != ''">
		  			AND C.CNSNE LIKE '%' || #{cnsne} || '%'
				</if>
				<if test="cmdtCd != null and cmdtCd != ''">
		  			AND C.CMDT_CD LIKE '%' || #{cmdtCd} || '%'
				</if>
				<if test="masterBlNo != null and masterBlNo != ''">
		  			AND B.MF_DOC_ID = #{masterBlNo}
				</if>
				<if test="blNo != null and blNo != ''">
		  			AND B.BL_NO = #{blNo}
				</if>
				<if test="bookingNo != null and bookingNo != ''">
		  			AND S.MF_DOC_ID = #{bookingNo}
				</if>
				<if test="snNo != null and snNo != ''">
		  			AND S.SHIPG_NOTE_NO = #{snNo}
				</if>
				<if test="lotNo != null and lotNo != ''">
		  			AND (S.LOT_NO = #{lotNo} OR B.LOT_NO = #{lotNo})
				</if>
		        <if test="whLocId != null and whLocId != ''">
		  			AND W.WH_LOC_ID LIKE '%' || #{whLocId} || '%'
				</if>
				<if test="whTpCd != null and whTpCd != ''">
		  			AND I.WH_LOC_TP LIKE '%' || #{whTpCd} || '%'
				</if>
	</sql>
	
	<select id="selectWHRecnList"  parameterType="whReconciliationParm" resultMap="whReconciliationMap">
		<if test="pageNo != 0"> 
             SELECT * FROM (SELECT inner.*, rownum row_num FROM ( 
		</if>
				<include refid="getWarehouseReconcileItems"/>
		<if test="pageNo != 0"> 
				)inner 
			)inner 
			WHERE inner.row_num <![CDATA[>]]> (TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo}))-1)* TO_NUMBER(#{sizePerPage}) 
		  	AND inner.row_num <![CDATA[<=]]> TO_NUMBER(DECODE(#{pageNo},'0', '1', #{pageNo})) * TO_NUMBER(#{sizePerPage})
		</if>
	</select>
	
	<select id="selectWHRecnListCount"  parameterType="whReconciliationParm" resultType="java.lang.String">
		SELECT COUNT(*)
          FROM (<include refid="getWarehouseReconcileItems"/>)
	</select>
	
	<select id="selectWHRecnDtl" parameterType="whReconciliationParm" resultType="whReconciliationItem">
		WITH CHANGE_VSL_INFO 
		     	AS (
		     		SELECT VSL_CALL_ID,
		     				ORG_REF_NO,
		     				SUM(CG_WGT) WGT,
		     				SUM(CG_VOL) MSRMT,
		     				SUM (PKG_QTY) PKGQTY
		     		FROM TMT_RHDL_CG
		     		WHERE RHDL_MODE = 'C'
		     		GROUP BY VSL_CALL_ID, ORG_REF_NO
		     	),
		
		WH_BALANCE
		     AS (SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP,
		                  SUM (I.CG_WGT) WGT,
		                  SUM (I.CG_VOL) MSRMT,
		                  SUM (I.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I
		            WHERE I.VSL_CALL_ID = #{vslCallId}
		                    AND I.CG_NO = #{cgNo} 
		                    AND I.WH_TP_CD = #{whTpCd}
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP
		           HAVING    SUM (I.CG_WGT) != 0
		                  OR SUM (I.CG_VOL) != 0
		                  OR SUM (I.PKG_QTY) != 0),
		IN_JOB_INFO AS
		(
		    SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP,
		                  SUM(I.CG_WGT) WGT,
		                  SUM(I.CG_VOL) MSRMT,
		                  SUM(I.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   I.VSL_CALL_ID = #{vslCallId} 
		                    AND I.CG_NO = #{cgNo} 
		                    AND I.WH_TP_CD = #{whTpCd}
		                    AND (J.JOB_PURP_CD IN ('AW', 'GW') OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'MV') OR (J.JOB_PURP_CD IN ('WW') AND J.JOB_TP_CD = 'RC'))
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD,
		                  I.WH_LOC_TP
		),
		
		OUT_JOB_INFO AS
		(
		    SELECT I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD,
		                  SUM (I.CG_WGT) WGT,
		                  SUM (I.CG_VOL) MSRMT,
		                  SUM (I.PKG_QTY) PKGQTY
		             FROM TMT_INV_LOC I INNER JOIN TMT_JOB J ON J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO AND J.JOB_NO = I.JOB_NO
		            WHERE   I.VSL_CALL_ID = #{vslCallId} 
		                    AND I.CG_NO = #{cgNo} 
		                    AND I.WH_TP_CD = #{whTpCd}
		                    AND J.JOB_PURP_CD IN ('WG', 'WA')
		         GROUP BY I.VSL_CALL_ID,
		                  I.CG_NO,
		                  I.WH_LOC_ID,
		                  I.LOC_ID,
		                  I.WH_TP_CD
		),
		
		RHDL_JOB_INFO AS
		(
		    SELECT  I.VSL_CALL_ID,
		        I.CG_NO,
		        I.WH_LOC_ID,
		        I.LOC_ID,
		        I.WH_TP_CD,
		        SUM(J.CG_WGT) AS WGT,
		        SUM (J.CG_VOL) MSRMT,
		        SUM (J.PKG_QTY) PKGQTY
		
		FROM    TMT_RHDL_CG R 
		        INNER JOIN TMT_JOB J ON R.RHDL_NO = J.RHDL_NO
		        INNER JOIN TMT_INV_LOC I ON J.JOB_NO = I.JOB_NO AND J.VSL_CALL_ID = I.VSL_CALL_ID AND J.CG_NO = I.CG_NO
		        
		
		WHERE   J.JOB_PURP_CD IN ('GW')
		        AND (R.VSL_CALL_ID = #{vslCallId} OR R.NX_VSL_CALL_ID = #{vslCallId})
<!-- 		        AND I.CG_NO NOT IN (SELECT GR_NO FROM TMT_GR WHERE RHDL_MODE IS NOT NULL) -->
				 AND ((R.RHDL_MODE = 'R' AND I.CG_NO NOT IN (SELECT GR_NO FROM TMT_GR WHERE RHDL_MODE = 'R'))
            		OR (R.RHDL_MODE = 'C'))
		GROUP BY 
		        I.VSL_CALL_ID,
		        I.CG_NO,
		        I.WH_LOC_ID,
		        I.LOC_ID,
		        I.WH_TP_CD
		)
		
		SELECT  DISTINCT
				W.VSL_CALL_ID       AS VSLCALLID,
		        P.VSL_NM            AS VSLNM,
		        W.LOC_ID            AS LOCID,
		        W.WH_TP_CD          AS WHTPCD,
		        W.WH_LOC_TP			AS WHLOCTP,
		        W.CG_NO				AS CGNO,
		        G.GR_NO             AS GRNO,
		        B.MF_DOC_ID         AS MASTERBLNO,
		        B.BL_NO             AS BLNO,
		        S.MF_DOC_ID         AS BOOKINGNO,
		        S.SHIPG_NOTE_NO     AS SHIPGNOTENO,
		        NVL((SELECT 'Y' FROM TMT_RHDL_CG WHERE  NX_VSL_CALL_ID = W.VSL_CALL_ID AND (NX_REF_NO = B.BL_NO OR NX_REF_NO = S.SHIPG_NOTE_NO) AND ROWNUM = 1), 'N') RHDLYN,
		        
		        NVL(I.WGT, 0)       AS STOREDMT,
		        NVL(I.MSRMT, 0)     AS STOREDM3,
		        NVL(I.PKGQTY, 0)    AS STOREDQTY,
		        
		        NVL(O.WGT, 0)       AS ACTMT,
		        NVL(O.MSRMT, 0)     AS ACTM3,
		        NVL(O.PKGQTY, 0)    AS ACTQTY,
<!-- 		        NVL(R.WGT, 0)       AS RHDLMT, -->
<!-- 		        NVL(R.MSRMT, 0)     AS RHDLM3, -->
<!-- 		        NVL(R.PKGQTY, 0)    AS RHDLQTY, -->
				NVL((SELECT CG_WGT FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = W.VSL_CALL_ID AND (ORG_REF_NO = B.BL_NO OR ORG_REF_NO = S.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDLMT,
        		NVL((SELECT CG_VOL FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = W.VSL_CALL_ID AND (ORG_REF_NO = B.BL_NO OR ORG_REF_NO = S.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDLM3,
        		NVL((SELECT PKG_QTY FROM TMT_RHDL_CG WHERE  VSL_CALL_ID = W.VSL_CALL_ID AND (ORG_REF_NO = B.BL_NO OR ORG_REF_NO = S.SHIPG_NOTE_NO) AND ROWNUM = 1), 0) RHDLQTY,
		        
		        NVL(W.WGT, 0)     AS BALMT,
		        NVL(W.MSRMT, 0)  AS BALM3,
		        NVL(W.PKGQTY, 0)  AS BALQTY,
		        NVL(W.WGT, 0)       AS WGT,
		        NVL(W.MSRMT, 0)     AS MSRMT,
		        NVL(W.PKGQTY, 0)    AS PKGQTY
		        
		FROM    WH_BALANCE W
		        LEFT OUTER JOIN IN_JOB_INFO I ON W.VSL_CALL_ID = I.VSL_CALL_ID AND W.CG_NO = I.CG_NO AND W.LOC_ID = I.LOC_ID
		        LEFT OUTER JOIN OUT_JOB_INFO O ON W.VSL_CALL_ID = O.VSL_CALL_ID AND W.CG_NO = O.CG_NO AND W.LOC_ID = O.LOC_ID
		        LEFT OUTER JOIN RHDL_JOB_INFO R ON W.VSL_CALL_ID = R.VSL_CALL_ID AND W.CG_NO = R.CG_NO AND W.LOC_ID = R.LOC_ID
		        LEFT OUTER JOIN TMT_GR G ON W.VSL_CALL_ID = G.VSL_CALL_ID AND W.CG_NO = G.GR_NO
		        LEFT OUTER JOIN TMT_SHIPG_NOTE S ON S.VSL_CALL_ID = G.VSL_CALL_ID AND S.SHIPG_NOTE_NO = G.SHIPG_NOTE_NO
		        LEFT OUTER JOIN TMT_BL B ON W.VSL_CALL_ID = B.VSL_CALL_ID AND W.CG_NO = B.BL_NO
		        LEFT OUTER JOIN TMT_VSL_SCH V ON W.VSL_CALL_ID = V.VSL_CALL_ID
		        LEFT OUTER JOIN TMT_VSL_PART P ON V.VSL_CD = P.VSL_CD
		        LEFT OUTER JOIN CHANGE_VSL_INFO CHGVSL ON I.VSL_CALL_ID = CHGVSL.VSL_CALL_ID 
		             		AND (CASE WHEN S.SHIPG_NOTE_NO IS NOT NULL THEN S.SHIPG_NOTE_NO
		             				 ELSE B.BL_NO 
		             			END) = CHGVSL.ORG_REF_NO

	</select>
	
	<select id="selectWHRecnDocList" parameterType="whReconciliationParm" resultType="whReconciliationItem">
		<if test="divCd == 'BL'">
			SELECT	BL.BL_NO DOCNO, BL.VSL_CALL_ID VSLCALLID
			FROM 	TMT_BL BL, TMT_CG_MST CM
			WHERE 	BL.VSL_CALL_ID = CM.VSL_CALL_ID
			   		AND BL.BL_NO = CM.BL_NO
					<if test="vslCallId != null and vslCallId != ''">
		   				AND
						BL.VSL_CALL_ID = #{vslCallId} 
					</if>
					<if test="vslCallId == null or vslCallId == ''">
		   				AND
						BL.VSL_CALL_ID &lt;&gt; 'NonCallId'
					</if>
					<if test="fwAgent != null and fwAgent != ''">
		   				AND
						CM.FWR_AGNT = #{fwAgent}
					</if>
					<if test="category != null and category != ''">
		   				AND
						CM.OPE_CLASS_CD = #{category}
					</if>
		</if>
		<if test="divCd == 'SN'">
			SELECT	SHIPG_NOTE_NO DOCNO, VSL_CALL_ID VSLCALLID
			FROM 	TMT_SHIPG_NOTE
			WHERE 	VSL_CALL_ID IS NOT NULL
					<if test="vslCallId != null and vslCallId != ''">
		   				AND
						VSL_CALL_ID = #{vslCallId} 
					</if>
					<if test="vslCallId == null or vslCallId == ''">
		   				AND
						VSL_CALL_ID &lt;&gt; 'NonCallId'
					</if>
					<if test="fwAgent != null and fwAgent != ''">
		   				AND
						FWRD = #{fwAgent}
					</if>
					<if test="estArrvDtFrom != null and estArrvDtFrom != ''">
						AND EST_ARRV_DT BETWEEN TO_DATE (#{estArrvDtFrom}||' 00:00','DD/MM/YYYY HH24:MI') 
		                                    AND TO_DATE (#{estArrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
					</if>
		</if>
		<if test="divCd == 'GR'">
			SELECT 	GR.GR_NO DOCNO , SN.VSL_CALL_ID VSLCALLID
			FROM 	TMT_SHIPG_NOTE SN, TMT_GR GR
			WHERE 	SN.VSL_CALL_ID IS NOT NULL
					<if test="vslCallId != null and vslCallId != ''">
		   				AND
						SN.VSL_CALL_ID = #{vslCallId} 
					</if>
					<if test="vslCallId == null or vslCallId == ''">
		   				AND
						SN.VSL_CALL_ID &lt;&gt; 'NonCallId'
					</if>
					<if test="fwAgent != null and fwAgent != ''">
		   				AND
						SN.FWRD = #{fwAgent}
					</if>
					<if test="snNo != null and snNo != ''">
		   				AND
						SN.SHIPG_NOTE_NO = #{snNo}
					</if>
					<if test="estArrvDtFrom != null and estArrvDtFrom != ''">
						AND SN.EST_ARRV_DT BETWEEN TO_DATE (#{estArrvDtFrom}||' 00:00','DD/MM/YYYY HH24:MI') 
		                                       AND TO_DATE (#{estArrvDtTo}||' 23:59','DD/MM/YYYY HH24:MI')
					</if>
			  		AND SN.VSL_CALL_ID = GR.VSL_CALL_ID
			  		AND SN.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
		</if>
	</select>
	<select id="selectWHRecnListPivot" parameterType="whReconciliationPivotParm" resultType="whReconciliationPivotItem">
      SELECT /*WHReconciliationMap.selectPivotList*/
      		 OPECLASSCD, 
      		 OPECLASSNM, 
      		 VSLCALLID, 
      		 CMDTCD, 
      		 CMDTGRPCD,
             LOCID,
             SPCACOCD,
             SPCACONM,
             FWRAGNT,
             SHPR,
             SHPRNAME,
             CNSNE,
             CNSNENAME,
             <if test="aggregate != null and aggregate == 'mt'">
	  			 SUM (WGT) AS TOTAL
			 </if>
			 <if test="aggregate != null and aggregate == 'm3'">
	  			 SUM (MSRMT) AS TOTAL
			 </if>
			 <if test="aggregate != null and aggregate == 'qty'">
	  			 SUM (PKGQTY) AS TOTAL
			 </if>
			 <if test="aggregate != null and aggregate == 'fton'">
	  			 SUM (FREIGHTTON) AS TOTAL
			 </if>
        FROM (SELECT C.OPE_CLASS_CD OPECLASSCD,
                     F_CM_012 ('MT', 'CATGTP', C.OPE_CLASS_CD) OPECLASSNM,
                     A.VSLCALLID VSLCALLID,
                     B.SPCACOCD SPCACOCD,
                     F_CM_012 ('MT', 'SPCACOCD', B.SPCACOCD) SPCACONM,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT BL.FWRD
                              FROM tmt_bl BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SN.FWRD
                              FROM TMT_SHIPG_NOTE SN
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS FWRAGNT,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT BL.CMDT_CD
                              FROM tmt_bl BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SN.CMDT_CD
                              FROM TMT_SHIPG_NOTE SN
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS CMDTCD,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT BL.CMDT_GRP_CD
                              FROM tmt_bl BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SN.CMDT_GRP_CD
                              FROM TMT_SHIPG_NOTE SN
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS CMDTGRPCD,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT BL.CG_TP_CD
                              FROM tmt_bl BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SN.CG_TP_CD
                              FROM TMT_SHIPG_NOTE SN
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS CGTPCD,
                     B.WGT WGT,
                     B.MSRMT MSRMT,
                     B.PKGQTY PKGQTY,
                     GREATEST (B.WGT, B.MSRMT) AS FREIGHTTON,
                     A.LOCID LOCID,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT SHPR
                              FROM TMT_BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SHPR
                              FROM TMT_SHIPG_NOTE
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS SHPR,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT SHPR_NM
                              FROM TMT_BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT SHPR_NM
                              FROM TMT_SHIPG_NOTE
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS SHPRNAME,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT CNSNE
                              FROM TMT_BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT CNSNE
                              FROM TMT_SHIPG_NOTE
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS CNSNE,
                     CASE
                        WHEN C.OPE_CLASS_CD = 'I'
                        THEN
                           (SELECT CNSNE_NM
                              FROM TMT_BL
                             WHERE     BL_NO = B.CGNO
                                   AND VSL_CALL_ID = B.VSLCALLID
                                   AND ROWNUM = 1)
                        ELSE
                           (SELECT CNSNE_NM
                              FROM TMT_SHIPG_NOTE
                             WHERE     SHIPG_NOTE_NO =
                                          (SELECT SHIPG_NOTE_NO
                                             FROM TMT_GR
                                            WHERE     GR_NO = A.CGNO
                                                  AND VSL_CALL_ID = B.VSLCALLID)
                                   AND ROWNUM = 1)
                     END
                        AS CNSNENAME
                FROM (    SELECT VSLCALLID,
                                 CGNO,
                                 WHTPCD,
                                 SUBSTR (MAX (SYS_CONNECT_BY_PATH (LOCID, ',')), 2)
                                    LOCID
                            FROM (SELECT VSLCALLID,
                                         CGNO,
                                         WHTPCD,
                                         LOCID,
                                         ROW_NUMBER ()
                                         OVER (PARTITION BY VSLCALLID, CGNO, WHTPCD
                                               ORDER BY LOCID)
                                            CNT
                                    FROM (SELECT VSLCALLID,
                                                 CGNO,
                                                 WHTPCD,
                                                 LOCID
                                            FROM (  SELECT I.VSL_CALL_ID VSLCALLID,
                                                           I.CG_NO CGNO,
                                                           I.WH_TP_CD WHTPCD,
                                                           I.WH_LOC_ID LOCID,
                                                           SUM (I.CG_WGT) WGT,
                                                           SUM (I.CG_VOL) MSRMT,
                                                           SUM (I.PKG_QTY) PKGQTY
                                                      FROM TMT_INV_LOC I, TMT_JOB J
                                                     WHERE 1 = 1 AND I.JOB_NO = J.JOB_NO
                                                  GROUP BY I.VSL_CALL_ID,
                                                           I.CG_NO,
                                                           I.WH_TP_CD,
                                                           I.WH_LOC_ID)
                                           WHERE (WGT <![CDATA[<>]]> 0 OR MSRMT <![CDATA[<>]]> 0 OR PKGQTY <![CDATA[<>]]> 0)))
                      START WITH CNT = 1
                      CONNECT BY     PRIOR CNT = CNT - 1
                                 AND PRIOR VSLCALLID = VSLCALLID
                                 AND PRIOR CGNO = CGNO
                                 AND PRIOR WHTPCD = WHTPCD
                        GROUP BY VSLCALLID, CGNO, WHTPCD) A,
                     (SELECT VSLCALLID,
                             CGNO,
                             WHTPCD,
                             WGT,
                             MSRMT,
                             PKGQTY,
                             YARDINDT,
                             LORRYNO,
                             NVL (
                                (SELECT MAX (SP_CA_CO_CD)
                                   FROM TMT_JOB
                                  WHERE     VSL_CALL_ID = VSLCALLID
                                        AND CG_NO = CGNO
                                        AND JOB_CO_CD = WHTPCD
                                        AND SP_CA_CO_CD IS NOT NULL),
                                ' ')
                                SPCACOCD,
                             NVL (
                                (SELECT MAX ('Y')
                                   FROM TMT_JOB
                                  WHERE     VSL_CALL_ID = VSLCALLID
                                        AND CG_NO = CGNO
                                        AND JOB_CO_CD = WHTPCD
                                        AND JOB_TP_CD = 'RC'),
                                'N')
                                RCYN
                        FROM (  SELECT I.VSL_CALL_ID VSLCALLID,
                                       I.CG_NO CGNO,
                                       I.WH_TP_CD WHTPCD,
                                       MIN (J.WORK_END_DT) YARDINDT,
                                       MAX (J.LORRY_NO) LORRYNO,
                                       SUM (I.CG_WGT) WGT,
                                       SUM (I.CG_VOL) MSRMT,
                                       SUM (I.PKG_QTY) PKGQTY
                                  FROM TMT_INV_LOC I, TMT_JOB J
                                 WHERE 1 = 1 AND I.JOB_NO = J.JOB_NO
                              GROUP BY I.VSL_CALL_ID, I.CG_NO, I.WH_TP_CD)
                       WHERE (WGT <![CDATA[<>]]> 0 OR MSRMT <![CDATA[<>]]> 0 OR PKGQTY <![CDATA[<>]]> 0)) B,
                     TMT_CG_MST C
               WHERE     A.VSLCALLID = B.VSLCALLID
                     AND A.CGNO = B.CGNO
                     AND A.WHTPCD = B.WHTPCD
                     AND A.VSLCALLID = C.VSL_CALL_ID
                     AND A.CGNO = C.CG_NO
                     ) T
        WHERE 1=1
        <if test="category != null and category != ''">
  			 AND T.OPECLASSCD = #{category}
		</if>
		<if test="fwAgent != null and fwAgent != ''">
  			 AND T.FWRAGNT = #{fwAgent}
		</if>
		<if test="cnsne != null and cnsne != ''">
  			 AND T.CNSNE = #{cnsne}
		</if>
		<if test="shpr != null and shpr != ''">
  			 AND T.SHPR = #{shpr}
		</if>
		<if test="vslCallId != null and vslCallId != ''">
  			 AND T.VSLCALLID = #{vslCallId}
		</if>
		<if test="pkgNo != null and pkgNo != ''">
  			 AND T.PKGNO like '%' || #{pkgNo} || '%'
		</if>
		<if test="cmdtCd != null and cmdtCd != ''">
  			 AND T.CMDTCD = #{cmdtCd}
		</if>
		<if test="cmdtGrpCd != null and cmdtGrpCd != ''">
  			 AND T.CMDTGRPCD = #{cmdtGrpCd}
		</if>
		<if test="fromDt != null and fromDt != ''">
  			 AND T.YARDINDT &gt; TO_DATE(#{fromDt}, 'DD/MM/YYYY')
		</if>
		<if test="toDt != null and toDt != ''">
  			 AND T.YARDINDT &lt; TO_DATE(#{toDt}, 'DD/MM/YYYY')
		</if>
	    GROUP BY OPECLASSCD,
	             OPECLASSNM,
	             VSLCALLID,
	             CMDTCD,
	             CMDTGRPCD,
	             LOCID,
	             SPCACOCD,
	             SPCACONM,
	             FWRAGNT,
	             SHPR,
	             SHPRNAME,
	             CNSNE,
	             CNSNENAME
	</select>
	<insert id="insertJobItems"  parameterType="whReconciliationItem">
		INSERT INTO TMT_JOB(
			JOB_NO, 
			JOB_TP_CD, 
			CG_NO, 
			VSL_CALL_ID, 
			JOB_GROUP, 
			JOB_PURP_CD, 
			JOB_CO_CD, 
			SP_CA_CO_CD, 
			RC_CO_CD, 
			DELV_TP_CD, 
			OPE_CLASS_CD, 
			WORK_ST_DT, 
			WORK_END_DT, 
			SHFT_ID,
			SHFT_DT,
			CG_WGT, 
			CG_VOL, 
			PKG_QTY, 
			TO_LOC_ID, 
			STAT_CD, 
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			RMK
		) VALUES (
			('J' || TO_CHAR(SYSDATE, 'YYMMDD') 
				 || (SELECT NVL(TRIM(TO_CHAR(SUBSTR(MAX(JOB_NO) ,-9,9)+1, '000000000')),'000000000')
				       FROM TMT_JOB)), 
			#{jobTpCd}, 
			#{cgNo}, 
			#{vslCallId}, 
			#{jobGroup}, 
			#{jobPurpCd}, 
			#{jobCoCd}, 
			#{spCaCoCd}, 
			<if test="chgRcCoCd == null or chgRcCoCd == ''"> #{rcCoCd}, </if>
			<if test="chgRcCoCd != null and chgRcCoCd != ''"> #{chgRcCoCd}, </if>
			#{delvTpCd}, 
			#{opeClassCd}, 
			SYSDATE, 
			SYSDATE, 
			F_GET_SHIFT_CD(SYSDATE),
			F_GET_SHFT_DATE(SYSDATE),
			ABS(#{wgt}), 
			ABS(#{msrmt}), 
			ABS(#{pkgQty}), 
			#{toLocId}, 
			#{statCd}, 
			SYSDATE, 
			#{userId}, 
			#{newVersion},
			#{remarks}
		)
	</insert>
	
	<insert id="insertInvLocItems"  parameterType="whReconciliationItem">
		<selectKey order="BEFORE" resultType="String" keyProperty="jobNo" >
			SELECT 	J.JOB_NO AS jobNo 
			FROM 	TMT_JOB J
			WHERE 	J.VSL_CALL_ID = #{vslCallId}
				   	AND J.CG_NO = #{cgNo}
				   	AND J.JOB_GROUP = #{jobGroup}
				   	AND ROWNUM = 1
		</selectKey>
		INSERT INTO TMT_INV_LOC(
			VSL_CALL_ID, 
			LOC_ID, 
			CG_NO, 
			JOB_NO, 
			WH_LOC_ID, 
			SEQ,
			CG_WGT,
			CG_VOL,
			PKG_QTY,
			WH_TP_CD,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			WH_LOC_TP
		) VALUES (
			#{vslCallId}, 
			#{locId}, 
			#{cgNo}, 
			#{jobNo}, 
			SUBSTR(#{locId}, 0, INSTR(#{locId}, '-')-1),		 
			(SELECT NVL(MAX(SEQ), 0)+1 
			   FROM TMT_INV_LOC
			  WHERE VSL_CALL_ID = #{vslCallId} 
			    AND LOC_ID = #{locId} 
			    AND CG_NO = #{cgNo} 
			    AND JOB_NO = #{jobNo}), 
			#{wgt}, 
			#{msrmt}, 
			#{pkgQty}, 
			#{jobCoCd},
			SYSDATE,
			#{userId},
			#{newVersion},
			#{whLocTp}
		)
	</insert>
</mapper>
