<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="confirmHandlingInOfRORO">
	<resultMap 	id="resultComboList" 	type="confirmHandlingInOfROROItem">
   		<result property = "cd"			column = "CD"/>
   		<result property = "cdNm"		column = "CD_NM"/>
 	</resultMap>
 	
 	<resultMap 	id="resultCargoMap" type="confirmHandlingInOfROROItem">
   		<result property = "vslCallId"		column = "VSL_CALL_ID"/>
		<result property = "catgCd" 		column = "CATG_CD"/>
		<result property = "catgNm" 		column = "CATG_NM"/>
		<result property = "bookingNo" 		column = "MF_DOC_ID"/>
		<result property = "shipgNoteNo" 	column = "CG_NO"/>
		<result property = "grNo" 			column = "GR_NO"/>
		<result property = "snQty" 			column = "SNQTY"/>
		<result property = "snMt" 			column = "SNMT"/>
		<result property = "snM3" 			column = "SNM3"/>
		<result property = "grQty" 			column = "GRQTY"/>
		<result property = "grMt" 			column = "GRMT"/>
		<result property = "grM3" 			column = "GRM3"/>
		<result property = "remainedHI" 	column = "REMAINED_HI"/>
		<result property = "toDoHI" 		column = "TODO_HI"/>
		<result property = "brandCd" 		column = "BRAND_CD"/>
		<result property = "brandNm" 		column = "BRAND_NM"/>
		<result property = "modelCd" 		column = "MODEL_CD"/>
		<result property = "modelNm" 		column = "MODEL_NM"/>
		<result property = "delvTpCd" 		column = "DELV_TP_CD"/>
		<result property = "delvTpNm" 		column = "DELV_TP_NM"/>
		<result property = "cgTpCd" 		column = "CG_TP_CD"/>
		<result property = "cgTpNm" 		column = "CG_TP_NM"/>
		<result property = "pkgQty" 		column = "PKGQTY"/>
		<result property = "wgt" 			column = "WGT"/>
		<result property = "msrmt" 			column = "MSRMT"/>
		<result property = "balQty" 		column = "BALQTY"/>
		<result property = "balMt" 			column = "BALMT"/>
		<result property = "balM3" 			column = "BALM3"/>
		<result property = "tsptCompCd" 	column = "TSPT_COMP"/>
		<result property = "pkgTpCd" 		column = "PKG_TP_CD"/>
		<result property = "accuSumQty" 	column = "ACCUSUMQTY"/>
		<result property = "accuSumWgt" 	column = "ACCUSUMWGT"/>
		<result property = "accuSumMsrmt" 	column = "ACCUSUMMSRMT"/>
		<result property = "eachWgt" 		column = "EACH_WGT"/>
		<result property = "eachMsrmt" 		column = "EACH_VOL"/>
		<result property = "cmdtGrpCd" 		column = "CMDT_GRP_CD"/>
		<result property = "unitNo" 		column = "CHASNO"/>

 	</resultMap>
 	
 	<resultMap 	id="resultGateInMap" type="confirmHandlingInOfROROItem">
 		<result property = "vslCd"			column = "VSL_CD"/>
		<result property = "callYear" 		column = "CALL_YEAR"/>
		<result property = "callSeq" 		column = "CALL_SEQ"/>
   		<result property = "vslCallId"		column = "VSL_CALL_ID"/>
		<result property = "bookingNo" 		column = "MF_DOC_ID"/>
		<result property = "shipgNoteNo" 	column = "CG_NO"/>
		<result property = "unitNo" 		column = "CHAS_NO"/>
		<result property = "gateInDate" 	column = "GATE_IN_DTM"/>
		<result property = "grNo" 			column = "GR_NO"/>
		<result property = "roroSeq" 		column = "RORO_SEQ"/>
		<result property = "driverId" 		column = "DRIVER_ID"/>
		<result property = "driverNm" 		column = "DRIVER_NM"/>
		<result property = "driverLicense" 	column = "DRIVER_LICENSE"/>
		<result property = "truckNo" 		column = "TRUCK_NO"/>
		<result property = "yardPlanLoc" 	column = "PLAN_LOC_ID"/>
		<result property = "gateTicketNo" 	column = "GATE_TICKET_NO"/>
		
		<result property = "ixCd" 			column = "IX_CD"/>
		<result property = "catgCd" 		column = "CATG_CD"/>
		<result property = "newYn" 			column = "NEW_YN"/>
		<result property = "cgTpCd" 		column = "CG_TP_CD"/>
		<result property = "docWgt" 		column = "DOC_WGT"/>
		<result property = "cbm" 			column = "CBM"/>
		<result property = "brandCd" 		column = "BRAND_CD"/>
		<result property = "modelCd" 		column = "MODEL_CD"/>
 	</resultMap>
 	
 	<resultMap 	id="resultHandlingInMap" type="confirmHandlingInOfROROItem">
   		<result property = "vslCallId"		column = "VSL_CALL_ID"/>
   		<result property = "vslCd"			column = "VSL_CD"/>
   		<result property = "callSeq"		column = "CALL_SEQ"/>
   		<result property = "callYear"		column = "CALL_YEAR"/>
		<result property = "bookingNo" 		column = "MF_DOC_ID"/>
		<result property = "shipgNoteNo" 	column = "CG_NO"/>
		<result property = "unitNo" 		column = "CHAS_NO"/>
		<result property = "roroSeq" 		column = "RORO_SEQ"/>
		<result property = "gateInDate" 	column = "GATE_IN_DTM"/>
		<result property = "inDate" 		column = "IN_DTM"/>
		<result property = "outDate" 		column = "OUT_DTM"/>
		<result property = "yardLoc" 		column = "LOC_ID"/>
		<result property = "driverId" 		column = "DRIVER_ID"/>
		<result property = "driverNm" 		column = "DRIVER_NM"/>
		<result property = "driverLicense" 	column = "DRIVER_LICENSE"/>
		<result property = "truckNo" 		column = "TRUCK_NO"/>	
		<result property = "hiRemarks" 		column = "HI_RMK"/>
		<result property = "delvTpCd" 		column = "DELV_TP_CD"/>
		<result property = "grNo" 			column = "GR_NO"/>
		<result property = "gateTicketNo" 	column = "GATE_TICKET_NO"/>
		<result property = "rhdlNo" 		column = "RHDL_NO"/>
		<result property = "brandCd" 		column = "BRAND_CD"/>
		<result property = "brandNm" 		column = "BRAND_NM"/>
		<result property = "modelCd" 		column = "MODEL_CD"/>
		<result property = "modelNm" 		column = "MODEL_NM"/>		
		<result property = "brandDesc" 		column = "BRAND_DESC"/>
		<result property = "ixCd" 			column = "IX_CD"/>
		<result property = "yardPlanLoc"	column = "PLAN_LOC_ID"/>
		<result property = "gateOutDate" 	column = "GATE_OUT_DTM"/>
 	</resultMap>
 	
 	<select id="selectBookingNoComboBoxItems" parameterType="confirmHandlingInOfROROParm" resultMap="resultComboList">
		SELECT	/* confirmHandlingInOfRORO.selectBookingNoComboBoxItems */
				DISTINCT
				BOOKING_NO CD,
				BOOKING_NO CD_NM
		FROM	TMT_SHIPG_NOTE
		WHERE	VSL_CALL_ID = #{vslCallId}
				AND STAT_CD = 'AP'
				AND CG_TP_CD IN ('RCV')
	</select>
	
	<select id="selectShipgNoteNoComboBoxItems" parameterType="confirmHandlingInOfROROParm" resultMap="resultComboList">
		SELECT	/* confirmHandlingInOfRORO.selectShipgNoteNoComboBoxItems */
				DISTINCT
				SHIPG_NOTE_NO CD,
				SHIPG_NOTE_NO CD_NM
		FROM	TMT_SHIPG_NOTE
		WHERE	VSL_CALL_ID = #{vslCallId}
				AND STAT_CD IN ('AP') 
				AND CG_TP_CD IN ('RCV')
		ORDER BY SHIPG_NOTE_NO
	</select>

	<sql id="selectSnItems">		
		SELECT                           /* confirmHandlingInOfRORO.getCargoItems */
	         DISTINCT
	         S.VSL_CALL_ID,
	         S.MF_DOC_ID,
	         S.SHIPG_NOTE_NO AS CG_NO,
	         (SELECT LISTAGG(CHAS_NO, ', ') WITHIN GROUP (ORDER BY CHAS_NO) 
                    FROM (SELECT DISTINCT CHAS_NO 
                    		FROM TMT_RORO_MST 
                    		WHERE VSL_CALL_ID = S.VSL_CALL_ID  
                    		AND CG_NO = S.SHIPG_NOTE_NO 
                    		AND GR_NO = GR.GR_NO)
             ) AS CHASNO,
	         GR.GR_NO,
	         S.CATG_CD,
	         F_CM_001 ('MT', 'CATGTP', S.CATG_CD) AS CATG_NM,
	         S.DELV_TP_CD,
	         F_CM_001 ('MT', 'DELVTP', S.DELV_TP_CD) AS DELV_TP_NM,
	         S.CG_TP_CD,
	         F_CM_001 ('MT', 'CGTP', S.CG_TP_CD) AS CG_TP_NM,
	         NVL (TO_NUMBER (S.PKG_QTY), 0) AS SNQTY,
	         NVL (TO_NUMBER (REPLACE (NVL (S.CG_WGT, 0), ',', '')), 0) AS SNMT,
	         NVL (TO_NUMBER (S.CG_VOL), 0) AS SNM3,
	         NVL (TO_NUMBER (GR.PKG_QTY), 0) AS GRQTY,
	         NVL (TO_NUMBER (REPLACE (NVL (GR.CG_WGT, 0), ',', '')), 0) AS GRMT,
	         NVL (TO_NUMBER (GR.CG_VOL), 0) AS GRM3,
	         NVL (TO_NUMBER (GR.PKG_QTY), 0) AS PKGQTY,
	         NVL (TO_NUMBER (REPLACE (NVL (GR.CG_WGT, 0), ',', '')), 0) AS WGT,
	         NVL (TO_NUMBER (GR.CG_VOL), 0) AS MSRMT,
	         S.PKG_QTY - WH_IN.PKG_QTY AS BALQTY,
	         S.CG_WGT - WH_IN.CG_WGT AS BALMT,
	         S.CG_VOL - WH_IN.CG_VOL AS BALM3,
	         NVL (G.NO_OF_GI, 0) - NVL (H.NO_OF_HI, 0) AS TODO_HI,
	         S.TSPT_COMP,
	         S.CATG_CD,
	         GR.CMDT_CD,
	         GR.PKG_TP_CD,
	         GR.PKG_TP_CD,
	         S.CG_TP_CD AS CG_TP_CD,
	         GR.TSPT_TP_CD,
	         S.FWRD,
	         S.SHIPG_AGNCY,
	         WH_IN.PKG_QTY AS ACCUSUMQTY,
	         WH_IN.CG_WGT AS ACCUSUMWGT,
	         WH_IN.CG_VOL AS ACCUSUMMSRMT,
	         S.EACH_WGT,
	         S.EACH_VOL,
	         S.CNSNE,
	         S.CNSNE_NM,
	         S.SHPR,
	         S.SHPR_NM,
	         S.CMDT_GRP_CD
		FROM	TMT_SHIPG_NOTE S
				INNER JOIN TMT_GR GR ON     S.VSL_CALL_ID = GR.VSL_CALL_ID AND S.SHIPG_NOTE_NO = GR.SHIPG_NOTE_NO
         		LEFT OUTER JOIN GI_INFO G ON S.VSL_CALL_ID = G.VSL_CALL_ID AND S.SHIPG_NOTE_NO = G.CG_NO
         		LEFT OUTER JOIN HI_INFO H ON S.VSL_CALL_ID = H.VSL_CALL_ID AND S.SHIPG_NOTE_NO = H.CG_NO
         		LEFT OUTER JOIN WH_IN ON 1 = 1
		WHERE	S.VSL_CALL_ID = #{vslCallId}
		        AND S.STAT_CD IN ('AP') 
         		AND S.CATG_CD = 'E'
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND S.SHIPG_NOTE_NO = #{shipgNoteNo}
				</if>
				<if test="unitNo != null and unitNo != ''">
					AND S.CHAS_NO LIKE CONCAT(#{unitNo}, '%')
				</if>
				
				<choose>
					<when test="cgTpCd != null and cgTpCd != ''">
						AND S.CG_TP_CD = #{cgTpCd}
					</when>
					<otherwise>AND S.CG_TP_CD IN ('RCV')</otherwise>
				</choose>
		 
		ORDER BY S.MF_DOC_ID, S.SHIPG_NOTE_NO
	</sql>

	<select id="selectCargoItems" parameterType="confirmHandlingInOfROROParm" resultMap="resultCargoMap">
		WITH GI_INFO AS
		(
			SELECT	VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
					,COUNT(CHAS_NO) AS NO_OF_GI
			FROM	TMT_RORO_MST
			WHERE	VSL_CALL_ID = #{vslCallId}
					AND GATE_IN_DTM IS NOT NULL
			GROUP BY VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
		),
		 WH_IN AS 
		 (SELECT (NVL (TO_NUMBER (SUM (J.CG_WGT)), 0)) AS CG_WGT,
                (NVL (TO_NUMBER (SUM (J.CG_VOL)), 0)) AS CG_VOL,
                (NVL (TO_NUMBER (SUM (J.PKG_QTY)), 0)) AS PKG_QTY
           FROM TMT_JOB J
           WHERE     J.VSL_CALL_ID = #{vslCallId}
                AND J.CG_NO = #{shipgNoteNo}
                AND J.JOB_PURP_CD IN ('GW', 'WW'))
		, HI_INFO AS
		(
			SELECT	VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
					,COUNT(CHAS_NO) AS NO_OF_HI
			FROM	TMT_RORO_MST
			WHERE	VSL_CALL_ID = #{vslCallId}
					AND IN_DTM IS NOT NULL
			GROUP BY VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
		)
		<include refid="selectSnItems"/>
	</select>
	
	<select id="selectCargoItemsCount" parameterType="confirmHandlingInOfROROParm" resultType="java.lang.String">
	 	WITH GI_INFO AS
		(
			SELECT	VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
					,COUNT(CHAS_NO) AS NO_OF_GI
			FROM	TMT_RORO_MST
			WHERE	VSL_CALL_ID = #{vslCallId}
					AND GATE_IN_DTM IS NOT NULL
			GROUP BY VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
		),
		 WH_IN AS 
			 (SELECT (NVL (TO_NUMBER (SUM (J.CG_WGT)), 0)) AS CG_WGT,
	                (NVL (TO_NUMBER (SUM (J.CG_VOL)), 0)) AS CG_VOL,
	                (NVL (TO_NUMBER (SUM (J.PKG_QTY)), 0)) AS PKG_QTY
	           FROM TMT_JOB J
	           WHERE     J.VSL_CALL_ID = #{vslCallId}
	                AND J.CG_NO = #{shipgNoteNo}
	                AND J.JOB_PURP_CD IN ('GW', 'WW'))
		, HI_INFO AS
		(
			SELECT	VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
					,COUNT(CHAS_NO) AS NO_OF_HI
			FROM	TMT_RORO_MST
			WHERE	VSL_CALL_ID = #{vslCallId}
					AND IN_DTM IS NOT NULL
			GROUP BY VSL_CALL_ID
					,MF_DOC_ID
					,CG_NO
					,IX_CD
		)
	 	SELECT COUNT(*)
          FROM (<include refid="selectSnItems"/>)
	 </select>
	
	<select id="selectGateInItems" parameterType="confirmHandlingInOfROROParm" resultMap="resultGateInMap">
		SELECT	/* confirmHandlingInOfRORO.selectGateInItems */
		    	D.VSL_CD,
				D.CALL_YEAR,
				D.CALL_SEQ,
				D.VSL_CALL_ID,
				D.MF_DOC_ID,
				D.SHIPG_NOTE_NO AS CG_NO,
				D.CHAS_NO,
				D.SEQ AS RORO_SEQ,
				
				D.IX_CD,
				S.CATG_CD,
				D.NEW_YN,
				D.CG_TP_CD,
				D.DOC_WGT,
				D.CBM,
				B.BRAND_CD,
				M.MODEL_CD,
				
				TO_CHAR (R.GATE_IN_DTM, 'DD/MM/YYYY HH24:MI') AS GATE_IN_DTM,
				'' AS GR_NO,
				R.DRIVER_ID,
				R.DRIVER_NM,
				R.DRIVER_LICENSE,
				NVL (R.TRUCK_NO, '') AS TRUCK_NO,
				R.PLAN_LOC_ID,
				'' AS GATE_TICKET_NO
				
		FROM	TMT_SHIPG_NOTE S
				INNER JOIN TMT_SHIPG_NOTE_DTL D
		            ON  S.VSL_CALL_ID = D.VSL_CALL_ID
		               	AND S.SHIPG_NOTE_NO = D.SHIPG_NOTE_NO
         
         		LEFT OUTER JOIN TMT_RORO_MST R
            		ON S.VSL_CALL_ID = R.VSL_CALL_ID AND S.SHIPG_NOTE_NO = R.CG_NO AND D.CHAS_NO = R.CHAS_NO AND D.SEQ = R.RORO_SEQ
            		
            	LEFT OUTER JOIN TMT_BRAND B ON D.BRAND_CD = B.BRAND_CD
				
				LEFT OUTER JOIN TMT_BRAND_DTL M
				   ON D.MODEL_CD = M.MODEL_CD AND D.BRAND_CD = M.BRAND_CD	
<!-- Temporary comment for doing CUD without WB system -->
<!-- 				INNER JOIN TMT_GR G -->
<!-- 					ON	S.VSL_CALL_ID = G.VSL_CALL_ID -->
<!-- 						AND S.SHIPG_NOTE_NO = G.SHIPG_NOTE_NO -->
<!-- 						AND R.CHAS_NO = G.UNIT_NO -->
						
						
		WHERE	S.VSL_CALL_ID = #{vslCallId}
		        AND S.STAT_CD IN ('AP')
				AND S.CG_TP_CD IN ('RCV')
				AND D.IX_CD = 'X'
				AND D.CHAS_NO IS NOT NULL
				<!-- Temporary comment for doing CUD without WB system -->
<!-- 				AND R.GATE_IN_DTM IS NOT NULL -->
				AND R.IN_DTM IS NULL
				AND R.LOADING_DTM IS NULL
				
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND S.SHIPG_NOTE_NO = #{shipgNoteNo}
				</if>
		ORDER BY R.GATE_IN_DTM, R.CHAS_NO
	</select>
	
	<select id="selectHandlingInItems" parameterType="confirmHandlingInOfROROParm" resultMap="resultHandlingInMap">
		SELECT	/* confirmHandlingInOfRORO.selectHandlingInItems */
		    	R.VSL_CALL_ID,
		    	R.VSL_CD,
				R.CALL_SEQ,
				R.CALL_YEAR,
				R.MF_DOC_ID,
				R.CG_NO,
				R.CHAS_NO,
				R.RORO_SEQ,
				R.DELV_TP_CD,
				R.HI_RMK,
				R.LOC_ID,
				R.BRAND_CD,
         		R.MODEL_CD,
				R.DRIVER_ID,
				R.DRIVER_NM,
				R.DRIVER_LICENSE,
				NVL(R.TRUCK_NO, '') AS TRUCK_NO,
				TO_CHAR(R.GATE_IN_DTM, 'DD/MM/YYYY HH24:MI') AS GATE_IN_DTM,
				TO_CHAR(R.IN_DTM, 'DD/MM/YYYY HH24:MI') AS IN_DTM,
				TO_CHAR(R.OUT_DTM, 'DD/MM/YYYY HH24:MI') AS OUT_DTM,
				'' AS GR_NO,
				'' AS GATE_TICKET_NO,
				R.RHDL_NO,
				TO_CHAR(R.GATE_OUT_DTM, 'DD/MM/YYYY HH24:MI') AS GATE_OUT_DTM
				
		FROM	TMT_SHIPG_NOTE S
				INNER JOIN TMT_RORO_MST R
					ON	S.VSL_CALL_ID = R.VSL_CALL_ID
						AND S.SHIPG_NOTE_NO = R.CG_NO
<!-- Temporary comment for doing CUD without WB system -->						
<!-- 				INNER JOIN TMT_GR G -->
<!-- 					ON	S.VSL_CALL_ID = G.VSL_CALL_ID -->
<!-- 						AND S.SHIPG_NOTE_NO = G.SHIPG_NOTE_NO -->
<!-- 						AND R.CHAS_NO = G.UNIT_NO -->

		WHERE	S.VSL_CALL_ID = #{vslCallId}
		        AND S.STAT_CD IN ('AP')
				AND S.CG_TP_CD IN ('RCV')
				AND R.IX_CD = 'X'
				AND R.IN_DTM IS NOT NULL
				
				AND ((R.STAT_CD = 'RH') OR (R.STAT_CD != 'RH' AND R.RHDL_NO IS NULL))
<!-- Temporary comment for doing CUD without WB system -->	
<!-- 				AND G.RHDL_MODE IS NULL -->
				
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND R.CG_NO = #{shipgNoteNo}
				</if>
				<if test="unitNo != null and unitNo != ''">
					AND R.CHAS_NO = #{unitNo}
				</if>
		ORDER BY R.IN_DTM, R.CHAS_NO
	</select>
	
	
	<select id="selectJobGroupNo" parameterType="roroMasterParm" resultType="java.lang.String">
	 	SELECT	NVL(MAX(TO_NUMBER(S.JOB_GROUP)),0)+1 AS JOBGROUP 
	 	FROM 	TMT_JOB S
	 	WHERE 	S.VSL_CALL_ID = #{vslCallId}
	 </select>
	
	<update id="updateConfirmHandlingInForRoRo" parameterType="confirmHandlingInOfROROItem">
		UPDATE  TMT_RORO_MST
		SET     
		        STAT_CD = #{statCd}
		        ,DELV_TP_CD = #{delvTpCd}	
				,IN_DTM =  TO_DATE(#{inDate},'DD/MM/YYYY HH24:MI')
				,HI_RMK = #{hiRemarks}
				,LOC_ID = #{locId}
		        ,WH_ID = CASE WHEN #{locId} IS NULL OR #{locId} = '' THEN NULL ELSE SUBSTR(#{locId}, 0, INSTR(#{locId}, '-')-1) END
				
		        ,STAFF_CD =  #{userId}
		        ,UPDATE_TIME = SYSDATE
		        <!-- ,CORRECTION_UNIT_YN =  #{correctionUnitNoYN}
		        ,CHAS_NO = CASE WHEN #{correctionUnitNoYN}= 'Y' THEN #{correctionNo} ELSE #{unitNo} END
 -->
		WHERE   VSL_CALL_ID = #{vslCallId}
		        AND CG_NO = #{shipgNoteNo}
		        AND CHAS_NO IN  ${unitNo}
	</update>
	
	<update id="updateGOJobWithDriverModeForRoRo" parameterType="confirmHandlingInOfROROItem">
		UPDATE  TMT_RORO
		SET     	
				GATE_OUT_DTM =  NULL
		        ,UPD_USER_ID =  #{userId}
		        ,UPDATE_TIME = SYSDATE
		WHERE   VSL_CALL_ID = #{vslCallId}
		        AND CG_NO = #{shipgNoteNo}
		        AND CHAS_NO = #{unitNo}
		        AND RORO_SEQ = #{roroSeq}
	</update>
	
<!-- 	<update id="generatingGateOutJobWithDriverModeWB" parameterType="confirmHandlingInOfROROItem"> -->
<!-- 		UPDATE	TMT_WEIGHBRIDGE -->
<!-- 		SET		GATEOUT_DT = CASE WHEN #{inDate} = '' OR #{inDate} IS NULL -->
<!-- 		                      THEN NULL -->
<!-- 		                      ELSE DATEADD(MINUTE, 1, CONVERT(DATETIME,#{inDate},#{dnY4M2D2H24M2S2withSplit})) -->
<!-- 		                  END -->
<!-- 				,LAST_UPT_BY = CASE WHEN #{userId} IS NULL -->
<!-- 		                      THEN #{updUserId} -->
<!-- 		                      ELSE #{userId} -->
<!-- 		                  END -->
<!-- 				,LAST_UPT_DT = SYSDATE -->
<!-- 				,OUT_GATE_POINT = CASE WHEN #{inDate} = '' OR #{inDate} IS NULL -->
<!-- 		                      THEN NULL -->
<!-- 		                      ELSE 'RORO' -->
<!-- 		                  END -->
<!-- 				,OUT_EX_WH_ID = CASE WHEN #{inDate} = '' OR #{inDate} IS NULL -->
<!-- 		                      THEN NULL -->
<!-- 		                      ELSE EX_WH_ID -->
<!-- 		                  END -->
<!-- 		WHERE	VSL_CALL_ID = #{vslCallId} -->
<!-- 				AND SN_NO = #{shipgNoteNo} -->
				
<!-- 				AND UNIT_NO = #{unitNo} -->
<!-- 	</update> -->
	
<!-- 	<delete id="deleteGateOutJobWithDriverModeCgArrvDelv" parameterType="confirmHandlingInOfROROItem"> -->
<!-- 		DELETE 	/* confirmHandlingInOfRORO.deleteGateOutJobWithDriverModeCgArrvDelv */   -->
<!-- 				TMT_CG_ARRV_DELV -->
<!-- 		WHERE 	VSL_CALL_ID = #{vslCallId} -->
<!-- 		  		AND UNIT_NO = #{unitNo} -->
<!-- 		  		AND CG_NO = #{grNo} -->
<!-- 		  		AND CG_IN_OUT_CD = 'O' -->
<!-- 	</delete>    -->
	
	<update id="updateCorrectionNoForGR" parameterType="confirmHandlingInOfROROItem">
		UPDATE	TMT_GR
		SET		UNIT_NO = #{correctionNo}
				,UPD_DT = SYSDATE
				,UPD_USER_ID = #{userId}
		WHERE	VSL_CALL_ID = #{vslCallId}
				AND GR_NO = #{grNo}
	</update>
	
	<update id="updateCorrectionNoForWB" parameterType="confirmHandlingInOfROROItem">
		UPDATE	TMT_WEIGHBRIDGE
		SET		UNIT_NO = #{correctionNo}
		WHERE	VSL_CALL_ID = #{vslCallId}
				AND GR_NO = #{grNo}
				AND UNIT_NO = #{unitNo}
	</update>

	
	<insert id="insertUnitCorrectionForRoRo" parameterType="confirmHandlingInOfROROItem">

		INSERT /* confirmHandlingInOfRORO.insertUnitCorrectionForRoRo */ INTO TMT_RORO_UNIT_CORRECTION (
		   VSL_CD
		  ,CALL_YEAR
		  ,CALL_SEQ
		  ,VSL_CALL_ID
		  ,DOC_NO
		  ,CG_NO
		  ,RORO_SEQ
		  ,SEQ
		  ,ORG_UNIT_NO
		  ,CORRECTION_UNIT_NO
		  ,STAFF_CD
		  ,UPDATE_TIME
		) VALUES (
			#{vslCd}
		  ,#{callYear} 
		  ,#{callSeq}
		  ,#{vslCallId}
		  ,#{bookingNo}
		  ,#{shipgNoteNo}
		  ,#{roroSeq}
		  ,(SELECT NVL(MAX(SEQ), 0) + 1 FROM TMT_RORO_UNIT_CORRECTION WHERE VSL_CALL_ID = #{vslCallId} AND CG_NO = #{shipgNoteNo} AND RORO_SEQ = #{roroSeq})
		  ,#{unitNo}
		  ,#{correctionNo}
		  ,#{userId}
		  ,SYSDATE
		)
	</insert>
	
	<select id="selectGateInItemsHHT" parameterType="confirmHandlingInOfROROParm" resultMap="resultGateInMap">
		SELECT	/* ConfirmHandlingInOfROROMAP.selectGateInItemsHHT */
		    	R.VSL_CD,
				R.CALL_YEAR,
				R.CALL_SEQ,
		    	R.VSL_CALL_ID,
				R.MF_DOC_ID,
				R.CG_NO,
				R.CHAS_NO,
				R.LOC_ID,
				R.PLAN_LOC_ID AS yardLoc,
				R.RORO_SEQ,
				TO_CHAR(R.GATE_IN_DTM, 'DD/MM/YYYY HH24:MI') AS GATE_IN_DTM,
				TO_CHAR(R.IN_DTM, 'DD/MM/YYYY HH24:MI') AS IN_DTM,
				TO_CHAR(R.OUT_DTM, 'DD/MM/YYYY HH24:MI') AS OUT_DTM,
				NVL ((SELECT DISTINCT C.GR_NO FROM TMT_GR C WHERE C.VSL_CALL_ID = S.VSL_CALL_ID AND C.SHIPG_NOTE_NO = S.SHIPG_NOTE_NO AND ROWNUM=1), ' ') AS GR_NO,
				WB.DRIVER_ID,
		        R.DRIVER_NM,
		        R.DRIVER_LICENSE,
		        NVL(WB.TRK_NO, '') AS TRUCK_NO,
		        R.PLAN_LOC_ID,
		        WB.GATE_TICKET_NO
				
		FROM	TMT_SHIPG_NOTE S
				INNER JOIN TMT_RORO_MST R
					ON	S.VSL_CALL_ID = R.VSL_CALL_ID
						AND S.SHIPG_NOTE_NO = R.CG_NO
<!-- Temporary comment for doing CUD without WB system -->
 				INNER JOIN TMT_WEIGHTBRIDGE WB 
 					ON	S.VSL_CALL_ID = WB.VSL_CALL_ID 
 						AND S.SHIPG_NOTE_NO = WB.SN_NO 
<!-- 						AND R.CHAS_NO = G.UNIT_NO -->
						
						
		WHERE	R.GATE_TICKET_NO = WB.GATE_TICKET_NO
				AND S.VSL_CALL_ID = #{vslCallId}
		        AND S.STAT_CD IN ('AP')
				AND S.CG_TP_CD IN ('RCV')
				AND R.IX_CD = 'X'
				<!-- Temporary comment for doing CUD without WB system -->
				<if test="searchType == null and searchType == ''">
					AND R.GATE_IN_DTM IS NOT NULL
					AND R.IN_DTM IS NULL
				</if>
				<if test="searchType != null and searchType != ''">
					<if test="searchType == 'YardHI'">
						AND R.GATE_IN_DTM IS NOT NULL
						AND R.IN_DTM IS NULL
					</if>
				</if>
				AND LOADING_DTM IS NULL
				
				<if test="shipgNoteNo != null and shipgNoteNo != ''">
					AND R.CG_NO = #{shipgNoteNo}
				</if>
		ORDER BY R.GATE_IN_DTM, R.CHAS_NO
	</select> 

	<select id="selectGateInTimeSeq" parameterType="confirmHandlingInOfROROParm" resultType="java.lang.String">
		SELECT	MIN(AD.SEQ) as SEQ
		FROM 	TMT_CG_ARRV_DELV AD
		WHERE 	AD.CG_NO = #{grNo}
		   		AND AD.VSL_CALL_ID = #{vslCallId}
		   		AND AD.GATE_PASS_NO IS NULL
	</select>

	<update id="updateConfirmHandlingInForRoRoHHT" parameterType="confirmHandlingInOfROROItem">
		UPDATE  TMT_RORO_MST
		SET     
		        STAT_CD = #{statCd}
		        ,DELV_TP_CD = #{delvTpCd}	
				,IN_DTM =  TO_DATE(#{inDate},'DD/MM/YYYY HH24:MI')
				,HI_RMK = #{hiRemarks}
				,LOC_ID = #{yardLoc}
		        ,WH_ID = CASE WHEN #{yardLoc} IS NULL OR #{yardLoc} = '' THEN NULL ELSE SUBSTR(#{yardLoc}, 0, INSTR(#{yardLoc}, '-')-1) END
				
				<if test="truckNo == null || truckNo == ''">
					,GATE_OUT_DTM = SYSDATE
					,OUT_DTM = SYSDATE
				</if>
				<if test="driverId != null || driverId != ''">
					,DRIVER_ID = #{driverId}
				</if>
				<if test="driverNm != null || driverNm != ''">
					,DRIVER_NM = #{driverNm}
				</if>
				<if test="truckNo != null || truckNo != ''">
					,TRUCK_NO = #{truckNo}
				</if>
		        ,STAFF_CD =  #{userId}
		        ,UPDATE_TIME = SYSDATE
		        ,CORRECTION_UNIT_YN =  #{correctionUnitNoYN}
		        ,CHAS_NO = CASE WHEN #{correctionUnitNoYN}= 'Y' THEN #{correctionNo} ELSE #{unitNo} END

		WHERE   VSL_CALL_ID = #{vslCallId}
		        AND CG_NO = #{shipgNoteNo}
		        AND CHAS_NO = #{unitNo}
		        <if test="roroSeq != null and roroSeq != ''">
					AND RORO_SEQ = #{roroSeq}
				</if>
	</update>
	
	<insert id="insertHIJobItems" parameterType="confirmHandlingInOfROROItem">
		<selectKey order="BEFORE" resultType="String" keyProperty="jobNo" >
			select 'J' || TO_CHAR(SYSDATE, 'YYMMDD') || NVL(TRIM(To_CHAR(SUBSTR(MAX(JOB_NO) ,-9,9)+1, '000000000')),'000000000') as jobNo from TMT_JOB
		</selectKey>
		INSERT INTO TMT_JOB (
			JOB_NO,
			JOB_TP_CD,
			WORK_ST_DT,
			WORK_END_DT,
			SHFT_ID,
			PKG_TP_CD,
			PKG_QTY,
			CG_VOL,
			CG_WGT,
			STAT_CD,
			CG_NO,
			VSL_CALL_ID,
			JOB_PURP_CD,
			DELV_TP_CD,
			OPE_CLASS_CD,
			SHU_YN, 
			TO_LOC_ID,
			SHFT_DT,
			JOB_GROUP,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			TSPT_TP_CD,
			JOB_CO_CD,
			SP_CA_CO_CD,
			REPKG_TYPE_CD,
			LORRY_NO,
			DRIVER_ID,
			GATE_TXN_NO,
			CHAS_NO
		) VALUES (
			#{jobNo},
			#{jobTpCd}, 
			TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'), 
			TO_DATE(#{hdlInEndDtStr}, 'DD/MM/YYYY HH24:MI'), 
			F_GET_SHIFT_CD(TO_DATE(#{hdlInEndDtStr}, 'DD/MM/YYYY HH24:MI')),
			#{pkgTpCd}, 
			#{pkgQty}, 
			#{msrmt}, 
			#{wgt}, 
			#{statCd}, 
			#{grNo}, 
			#{vslCallId}, 
			#{jobPurpCd}, 
			#{delvTpCd},
			#{catgCd},
			DECODE(#{shuYn},NULL,'N','true','Y','false','N','Y','Y','N','N'),
			#{locId},
			F_GET_SHFT_DATE(TO_DATE(#{hdlInEndDtStr}, 'DD/MM/YYYY HH24:MI')),
			#{jobGroup},
			SYSDATE,
			#{userId},
			#{newVersion},
			#{tsptTpCd},
			#{jobCoCd},
			#{spCaCoCd},
			#{rePkgTpCd},
			#{lorryId},
			#{driverId},
			#{gateTxnNo},
			#{unitNo}
		) 
	</insert>
	
	<update id="updateHIGPArrvDelvItems" parameterType="confirmHandlingInOfROROItem">
		UPDATE 	TMT_CG_ARRV_DELV
		   SET 	GATE_PASS_NO = #{gatePassNo},
				UPDATE_TIME = SYSDATE,
				STAFF_CD = #{userId}
				,VERSION = #{newVersion}
				,JOB_NO = #{jobNo}
		 WHERE 	VSL_CALL_ID=#{vslCallId} 
		   		AND CG_NO=#{shipgNoteNo} 
				AND CG_IN_OUT_CD =#{cgInOutCd}
				AND LORRY_NO = #{lorryId}
				<if test="gateTxnNo != null and gateTxnNo != ''">
					AND GATE_TXN_NO = #{gateTxnNo}
				</if>
				AND GATE_PASS_NO IS NULL
	</update>
	
	<insert id="insertHIArrvDelvItems" parameterType="confirmHandlingInOfROROItem">
		<selectKey order="BEFORE" resultType="String" keyProperty="jobNo" >
			SELECT J.JOB_NO AS jobNo FROM TMT_JOB J
			 WHERE J.VSL_CALL_ID = #{vslCallId}
			   AND J.CG_NO = #{shipgNoteNo}
			   AND J.JOB_GROUP = #{jobGroup}
			   AND J.JOB_CO_CD = #{jobCoCd}
			   AND NVL(J.SP_CA_CO_CD,' ') = NVL(#{spCaCoCd},' ')
			   AND J.RHDL_MODE = 'R' 
		</selectKey>
		INSERT INTO TMT_CG_ARRV_DELV (
			CG_NO,
			CG_IN_OUT_CD,
			SEQ,
			CG_WGT,
			CG_WGT_UNIT,
			CG_VOL,
			CG_VOL_UNIT,
			PKG_QTY,
			PKG_TP_CD,
			CMDT_CD,
			CG_TP_CD,
			GATE_IN_DT,
			GATE_OUT_DT,
			TSPT_TP_CD,
			GR_NO,
			LOC_ID,
			LORRY_NO,
			GATE_PASS_NO,
			GATE_PASS_ISSUE_DT,
			ISSUE_CNT,
			UPDATE_TIME,
			STAFF_CD,
			VSL_CALL_ID,
			JOB_NO,
			VERSION
		) VALUES (
			#{shipgNoteNo}, 
			#{cgInOutCd}, 
			(SELECT NVL(TO_NUMBER(MAX(SEQ)), 0)+1 
				FROM TMT_CG_ARRV_DELV 
				WHERE CG_NO=#{shipgNoteNo} AND CG_IN_OUT_CD =#{cgInOutCd} AND VSL_CALL_ID = #{vslCallId} ), 
			#{wgt}, 
			#{wgtUnit}, 
			#{msrmt}, 
			#{msrmtUnit}, 
			#{pkgQty}, 
			#{pkgTpCd}, 
			#{cmdtCd}, 
			#{cgTpCd},
			TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'),
			TO_DATE(#{hdlInEndDtStr}, 'DD/MM/YYYY HH24:MI'),
			#{tsptTpCd},
			#{grNo}, 
			#{locId}, 
			#{lorryId}, 
			#{gatePassNo},
			SYSDATE, 
			(SELECT NVL(MAX(ISSUE_CNT), 0)+1 
				FROM TMT_CG_ARRV_DELV
				WHERE VSL_CALL_ID=#{vslCallId} 
					AND CG_NO=#{shipgNoteNo} AND CG_IN_OUT_CD =#{cgInOutCd} 
					AND LORRY_NO = #{lorryId}), 
			SYSDATE, 
			#{userId},
			#{vslCallId},
			#{jobNo},
			#{newVersion}
		)
	</insert>
	<update id="updateHIArrvDelvItems" parameterType="confirmHandlingInOfROROItem">
		UPDATE 	TMT_CG_ARRV_DELV
		   SET 	CG_WGT = #{wgt},
				CG_WGT_UNIT = #{wgtUnit},
				CG_VOL = #{msrmt},
				CG_VOL_UNIT = #{msrmtUnit},
				PKG_QTY = #{pkgQty},
				PKG_TP_CD = #{pkgTpCd},
				CMDT_CD = #{cmdtCd},
				CG_TP_CD = #{cgTpCd},
				GATE_IN_DT = TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'),
				TSPT_TP_CD = #{tsptTpCd},
				GR_NO = #{grNo},
				LORRY_NO = #{lorryId},
				UPDATE_TIME = SYSDATE,
				STAFF_CD = #{userId},
				VERSION =#{newVersion}
		 WHERE VSL_CALL_ID=#{vslCallId} 
			   AND CG_NO=#{shipgNoteNo} AND CG_IN_OUT_CD =#{cgInOutCd}
			   AND LORRY_NO = #{lorryId}
	</update>
	
	<insert id="insertHIGeneralGateIn" parameterType="confirmHandlingInOfROROItem">
		INSERT INTO TMT_CG_ARRV_DELV (
			CG_NO,
			CG_IN_OUT_CD,
			SEQ,
			CG_WGT,
			CG_WGT_UNIT,
			CG_VOL,
			CG_VOL_UNIT,
			PKG_QTY,
			PKG_TP_CD,
			CMDT_CD,
			CG_TP_CD,
			GATE_IN_DT,
			TSPT_TP_CD,
			GR_NO,
			LOC_ID,
			RMK,
			LORRY_NO,
			UPDATE_TIME,
			STAFF_CD,
			VSL_CALL_ID,
			JOB_NO,
			VERSION
		) VALUES (
			#{shipgNoteNo}, 
			#{cgInOutCd}, 
			(SELECT NVL(TO_NUMBER(MAX(SEQ)), 0)+1 
			FROM TMT_CG_ARRV_DELV 
			WHERE CG_NO=#{shipgNoteNo} AND CG_IN_OUT_CD =#{cgInOutCd} AND VSL_CALL_ID = #{vslCallId}),
			#{wgt}, 
			#{wgtUnit}, 
			#{msrmt}, 
			#{msrmtUnit}, 
			#{pkgQty}, 
			#{pkgTpCd}, 
			#{cmdtCd}, 
			#{cgTpCd},
			TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'),
			#{tsptTpCd}, 
			#{grNo}, 
			#{locId}, 
			DECODE(#{gatePassNo},null,null,'',null,' ', null,#{rmk}), 
			#{lorryId}, 
			SYSDATE,
			#{userId},
			#{vslCallId},
			DECODE(#{jobNo},NULL,(SELECT J.JOB_NO AS jobNo 
				FROM TMT_JOB J 
				WHERE J.VSL_CALL_ID = #{vslCallId}
					AND J.CG_NO = #{shipgNoteNo}
					AND J.JOB_GROUP = #{jobGroup}
					AND J.JOB_PURP_CD = #{jobPurpCd}
					AND J.JOB_CO_CD = #{jobCoCd}),
			#{jobNo}),
			#{newVersion}
		)
	</insert>
	
	<update id="updateHIGateInTime" parameterType="confirmHandlingInOfROROItem">
		UPDATE 	TMT_CG_ARRV_DELV
		   SET 	GATE_IN_DT = TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'),
				UPDATE_TIME = SYSDATE,
				STAFF_CD = #{userId},
				VERSION =#{newVersion}
		 WHERE VSL_CALL_ID=#{vslCallId} 
			   AND CG_NO=#{shipgNoteNo} 
			   AND CG_IN_OUT_CD =#{cgInOutCd}
			   AND SEQ = TO_NUMBER(#{seq})
	</update>
	
	<update id="updateHIGateInLorry" parameterType="confirmHandlingInOfROROItem">
		UPDATE 	TMT_CG_ARRV_DELV
		   SET 	GATE_IN_DT = TO_DATE(#{hdlInStDtStr}, 'DD/MM/YYYY HH24:MI'),
				TSPT_TP_CD = #{tsptTpCd},
				LORRY_NO = #{lorryId},
				UPDATE_TIME = SYSDATE,
				STAFF_CD = #{userId}
				,VERSION =#{newVersion}
		 WHERE VSL_CALL_ID=#{vslCallId} 
			   AND CG_NO=#{shipgNoteNo} 
			   AND CG_IN_OUT_CD =#{cgInOutCd}
			   AND SEQ = TO_NUMBER(#{seq})
	</update>
	
	<update id="updateHIOnlyLorry" parameterType="confirmHandlingInOfROROItem">
		UPDATE 	TMT_CG_ARRV_DELV
		   SET 	LORRY_NO = #{lorryId},
				UPDATE_TIME = SYSDATE,
				STAFF_CD = #{userId}
				,VERSION =#{newVersion}
		 WHERE VSL_CALL_ID=#{vslCallId} 
			   AND CG_NO=#{shipgNoteNo} 
			   AND CG_IN_OUT_CD =#{cgInOutCd}
			   AND SEQ = TO_NUMBER(#{seq})
	</update>
</mapper>