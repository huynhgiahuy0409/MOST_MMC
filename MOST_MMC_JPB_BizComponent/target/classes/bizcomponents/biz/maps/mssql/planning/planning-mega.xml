<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mega">
     <resultMap type="megaItem" 								id="EquipmentMap">
    	<result property="megaNo"               				column="MEGANO"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="divCd"                				column="DIVCD"/>
		<result property="eqDivCd"              				column="EQDIVCD"/>
		<result property="eqDivCdNm"            				column="EQDIVCDNM"/>
		<result property="capaCd"               				column="CAPACD"/>
		<result property="capaDescr"            				column="CAPADESCR"/>
		<result property="locId"                				column="LOCID"/>
		<result property="reqTime"              				column="REQTIME"/>
		<result property="reqMin"               				column="REQMIN"/>
		<result property="dspReqhhmm"           				column="DSPREQHHMM"/>
		<result property="reqQty"               				column="REQQTY"/>
		<result property="flStatus"             				column="flStatus"/>
		<result property="refNo"               					column="REFNO"/>
		<result property="confmQty"             				column="CONFMQTY"/>
		<result property="whQty"                				column="WHQTY"/>
		<result property="colColor"             				column="COLCOLOR"/>
		<result property="workStDt"             				column="WORKSTDT"/>
		<result property="workEndDt"             				column="WORKENDDT"/>
		<collection property="operInfoItems" 
				javaType="ArrayList" select="mega.selectOperInfo" 
				column="megaNo=MEGANO, eqDivCd=EQDIVCD, capaCd=CAPACD, megaIdx=SEQ, copyType=COPYTYPE"/>
    </resultMap>
    
    <resultMap type="megaItem" 									id="stevedoreMap">
   		<result property="megaNo"               				column="MEGANO"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="divCd"                				column="DIVCD"/>
    	<result property="megaNo"               				column="MEGANO"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="divCd"                				column="DIVCD"/>
		<result property="eqDivCd"              				column="EQDIVCD"/>
		<result property="eqDivCdNm"            				column="EQDIVCDNM"/>
		<result property="capaCd"               				column="CAPACD"/>
		<result property="capaDescr"            				column="CAPADESCR"/>
		<result property="locId"                				column="LOCID"/>
		<result property="reqTime"              				column="REQTIME"/>
		<result property="reqMin"               				column="REQMIN"/>
		<result property="dspReqhhmm"           				column="DSPREQHHMM"/>
		<result property="reqQty"               				column="REQQTY"/>
		<result property="flStatus"             				column="flStatus"/>
		<result property="refNo"               					column="REFNO"/>
		<result property="confmQty"             				column="CONFMQTY"/>
		<result property="whQty"                				column="WHQTY"/>
		<result property="colColor"             				column="COLCOLOR"/>
		<result property="workStDt"             				column="WORKSTDT"/>
		<result property="workEndDt"             				column="WORKENDDT"/>
		<result property="shipClewYn"             				column="SHIPCLEWYN"/>
		<result property="stvdComp"             				column="STVDCOMP"/>
		<result property="nofGang"             					column="NOFGANG"/>
		<result property="nofOprSprr"             				column="NOFOPRSPRR"/>
		<result property="nofOprClerk"             				column="NOFOPRCLERK"/>
		<result property="nofStvdSprr"             				column="NOFSTVDSPRR"/>
		<result property="nofWchmn"             				column="NOFWCHMN"/>
		<result property="nofStvdGwker"             			column="NOFSTVDGWKER"/>
		<result property="stvdNonTon"             				column="STVDNONTON"/>
		<result property="trmgComp"             				column="TRMGCOMP"/>
		<result property="nofHatch"             				column="NOFHATCH"/>
		<result property="nofTrmgSprr"             				column="NOFTRMGSPRR"/>
		<result property="nofSglmn"             				column="NOFSGLMN"/>
		<result property="nofDekmn"             				column="NOFDEKMN"/>
		<result property="nofHopmn"             				column="NOFHOPMN"/>
		<result property="nofTrmgGwker"             			column="NOFTRMGGWKER"/>
		<result property="trmgNonTon"             				column="TRMGNONTON"/>
		<result property="relationKey" 							column="RELATION_KEY"/>
		<collection property="operInfoItems" 
				javaType="ArrayList" select="mega.selectOperInfo" 
				column="megaNo=MEGANO, megaIdx=SEQ"/>
    </resultMap>

    <resultMap type="megaItem" id="EquipmentMapForReport">
    	<result property="megaNo"               				column="MEGANO"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="reqQty"               				column="reqQty"/>
		<result property="confmQty"             				column="confmQty"/>
		<result property="divCd"                				column="DIVCD"/>
		<result property="eqDivCd"              				column="EQDIVCD"/>
		<result property="eqDivCdNm"            				column="EQDIVCDNM"/>
		<result property="capaCd"               				column="CAPACD"/>
		<result property="capaDescr"            				column="CAPADESCR"/>
		<result property="locId"                				column="LOCID"/>
		<result property="reqTime"              				column="REQTIME"/>
		<result property="reqMin"               				column="REQMIN"/>
		<result property="dspReqhhmm"           				column="DSPREQHHMM"/>
		<result property="reqQty"               				column="REQQTY"/>
		<result property="confmQty"             				column="CONFMQTY"/>
		<result property="whQty"                				column="WHQTY"/>
		<result property="colColor"             				column="COLCOLOR"/>
		<result property="CRUD"                 				column="CRUD"/>
		<result property="shftId"               				column="shftid"/>
		<result property="submitBy"             				column="submitBy"/>
		<result property="shftNm"               				column="SHFTNM"/>
		<result property="shftIdx"              				column="SHFTIDX"/>
		<result property="purpTpCd"             				column="PURPTPCD"/>
		<result property="rmk"                  				column="rmk"/>
		<result property="rejRmk"               				column="rejRmk"/>
		<result property="apprvBy"              				column="apprvBy"/>
		<result property="statCd"               				column="statCd"/>
		<result property="statCdNm"             				column="statCdNm"/>
		<result property="purpTpCdNm"           				column="PURPTPCDNM"/>
		<result property="workYmd"              				column="WORKYMD"/>
		<result property="purpType"             				column="PURPTYPE"/>
		<result property="berthLoc"								column="BERTHLOC"/>
    </resultMap>
    
    <resultMap type="megaItem" id="EquipmentMapForReport2">
    	<result property="megaNo"               				column="MEGANO"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="reqQty"               				column="reqQty"/>
		<result property="confmQty"             				column="confmQty"/>
		<result property="divCd"                				column="DIVCD"/>
		<result property="eqDivCd"              				column="EQDIVCD"/>
		<result property="eqDivCdNm"            				column="EQDIVCDNM"/>
		<result property="capaCd"               				column="CAPACD"/>
		<result property="capaDescr"            				column="CAPADESCR"/>
		<result property="locId"                				column="LOCID"/>
		<result property="reqTime"              				column="REQTIME"/>
		<result property="reqMin"               				column="REQMIN"/>
		<result property="dspReqhhmm"           				column="DSPREQHHMM"/>
		<result property="reqQty"               				column="REQQTY"/>
		<result property="confmQty"             				column="CONFMQTY"/>
		<result property="whQty"                				column="WHQTY"/>
		<result property="colColor"             				column="COLCOLOR"/>
		<result property="CRUD"                 				column="CRUD"/>
		<result property="shftId"               				column="shftid"/>
		<result property="submitBy"             				column="submitBy"/>
		<result property="shftNm"               				column="SHFTNM"/>
		<result property="shftIdx"              				column="SHFTIDX"/>
		<result property="purpTpCd"             				column="PURPTPCD"/>
		<result property="rmk"                 					column="rmk"/>
		<result property="rejRmk"               				column="rejRmk"/>
		<result property="apprvBy"              				column="apprvBy"/>
		<result property="statCd"               				column="statCd"/>
		<result property="statCdNm"             				column="statCdNm"/>
		<result property="purpTpCdNm"           				column="PURPTPCDNM"/>
		<result property="workYmd"              				column="WORKYMD"/>
		<result property="purpType"             				column="PURPTYPE"/>
		<result property="berthLoc"								column="BERTHLOC"/>
    </resultMap>

    <resultMap type="megaItem" 									id="OperInfoMap">
		<result property="megaNo"               				column="MEGANO"/>
		<result property="megaIdx"              				column="MEGAIDX"/>
		<result property="seq"                  				column="SEQ"/>
		<result property="eqDivCd"              				column="EQDIVCD"/>
		<result property="capaCd"               				column="CAPACD"/>
		<result property="opeDivCd"             				column="OPEDIVCD"/>
		<result property="opeCompCd"            				column="OPECOMPCD"/>
		<result property="opeCompNm"            				column="OPECOMPNM"/>
		<result property="nofOpe"               				column="NOFOPE"/>
		<result property="CRUD"                 				column="CRUD"/>
		<result property="nofGang"            					column="NOF_GANG"/>
		<result property="nofStvdSprr"               			column="NOF_STVD_SPRR"/>
		<result property="nofWchmn"                 			column="NOF_WCHMN"/>
		<result property="nofStvdGwker"            				column="NOF_STVD_GWKER"/>
		<result property="nofTrmgSprr"               			column="NOF_TRMG_SPRR"/>
		<result property="nofSglmn"                 			column="NOF_SGLMN"/>
		<result property="nofDekmn"               				column="NOF_DEKMN"/>
		<result property="nofHopmn"                 			column="NOF_HOPMN"/>
		<result property="relationKey" 							column="RELATION_KEY"/>
    </resultMap>
    
    <resultMap type="megaItem" id="ConfirmationSlipDetailMap">
    	<result property="vslCallId"         					column="VSLCALLID"/>
		<result property="seq"               					column="SEQ"/>
		<result property="cgTpCd"								column="CGTPCD"/>
		<result property="opeTpCd"      	    				column="OPETPCD"/>
		<result property="cgTpNm"            					column="CGTPNM"/>
		<result property="cmdtCd"            					column="CMDTCD"/>
		<result property="cmdtCdNm"          					column="CMDTCDNM"/>
		<result property="cmdtGrCd"          					column="CMDTGRCD"/>
		<result property="cmdtGr"          	 					column="CMDTGR"/>
		<result property="opeHr"             					column="OPEHR"/>
		<result property="workDd"            					column="WORKDD"/>
		<result property="workHatchNo"       					column="WORKHATCHNO"/>
		<result property="wgt"               					column="WGT"/>
		<result property="msrmt"             					column="MSRMT"/>
		<result property="qty"               					column="QTY"/>
		<result property="pkgTpCd"           					column="PKGTPCD"/>
		<result property="clnCd"             					column="CLNCD"/>
		<result property="topCgCd"           					column="TOPCGCD"/>
		<result property="topCln"            					column="TOPCLN"/>
		<result property="tmnlOpr"           					column="TMNLOPR"/>
		<result property="shprCnsne"         					column="SHPRCNSNE"/>
		<result property="cnsne"								column="CNSNE"/>
		<result property="unno"              					column="UNNO"/>
		<result property="imdg"              					column="IMDG"/>
		<result property="pol"             						column="POL"/>
		<result property="fdest"             					column="FDEST"/>
		<result property="crc"               					column="CRC"/>
		<result property="tkNo"              					column="TKNO"/>
		<result property="blNo"              					column="BLNO"/>
		<result property="cgOptTpCd"         					column="CGOPTTPCD"/>
		<result property="cgOptTpNm"         					column="CGOPTTPNM"/>
		<result property="dgSeq"         	 					column="DGSEQ"/>
		<result property="dgChk"         	 					column="DGCHK"/>
		<result property="opeType"         	 					column="opeType"/>
		<result property="cnsneNm"         	 					column="cnsneNm"/>
		<result property="cnsneAddr"         					column="cnsneAddr"/>
		<result property="shpNm"         	 					column="shpNm"/>
		<result property="shpAddr"         	 					column="shpAddr"/>
		<result property="pkgTpNm"         	 					column="pkgTpNm"/>
		<association property="dgItems" 
				select="ConfirmationSlipMap.selectCFDGDeclaration" 
				column="{seq=DGSEQ}"/>
    </resultMap>
    
    <sql id="selectMegaSql">
		SELECT /* mega.selectMegaSql */
			A.MEGA_NO              								AS MEGANO,
			A.STAT_CD              								AS STATCD,
   			dbo.F_CM_CODE_NM('MT', 'MEGASTAT', A.STAT_CD) 		AS STATCDNM,
			CASE
				WHEN 
					((SELECT 
						MAX(SR.REF_NO)
					FROM 
						TMT_VSL_SVC_RPT 	SR
					WHERE 	
						SR.REF_NO 			= A.MEGA_NO
						AND SR.VSL_CALL_ID 	= A.VSL_CALL_ID
					)						IS NOT NULL
					AND 
					(SELECT 
						MAX(SR.REF_NO)
					FROM 
						TMT_VSL_SVC_RPT 	SR
					WHERE 	
						SR.REF_NO 			= A.MEGA_NO
						AND SR.VSL_CALL_ID 	= A.VSL_CALL_ID
					) <![CDATA[<>]]> '') 
						THEN 'Y'
	            ELSE 'N'
	        END 												AS deployed,
			A.VSL_CALL_ID          								AS VSLCALLID,
			(SELECT TOP(1)
				VSL_NM 
			FROM 
				TMT_VSL_PART 
			WHERE 
				VSL_CD = C.VSL_CD) 								AS VSLNM,
			A.SUMIT_BY             								AS REQR,
			ISNULL(
				(SELECT TOP(1)
					TP.ENG_SNM
				FROM 
					TMT_PTNR 			TP, 
					TMT_PTNR_USER 		B
				WHERE 
					B.USER_ID 			= A.SUMIT_BY
					AND TP.PTNR_CODE 	= B.PTNR_CODE
			), A.SUMIT_BY) 										AS REQRNM,
			A.SUMIT_DT 											AS REQDT,
			C.ARRV_SA_ID           								AS SAID,
			A.WORK_YMD             								AS SVCDATE,
			DATEADD(day, 1, CONVERT(DATE, A.WORK_YMD , 112))	AS WORKYMD,
			A.SHFT_ID              								AS SHFTID,
			(SELECT TOP(1)
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = A.SHFT_ID) 							AS SHFTNM,
			(SELECT 
				SHFT_IDX 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = A.SHFT_ID) 							AS SHFTIDX,
			A.PURP_TP_CD           								AS PURPTPCD,
			dbo.F_CM_CODE_NM('MT', 'MGPURP', A.PURP_TP_CD) 		AS PURPTPCDNM,
			(SELECT TOP(1)
				S_CD_LGV 
			FROM 
				TMT_CD_MSTD 
			WHERE 
				L_CD					= 'MT' 
				AND M_CD				= 'MGPURP'
				AND S_CD				= A.PURP_TP_CD) 		AS PURPTYPE,
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_DEPY 	
			WHERE 
				USE_YN 					= 'Y' 
				AND (CASE 
						WHEN A.VSL_CALL_ID = 'STRG' 
							THEN SUBSTRING(VSL_CALL_ID, 4, 9) 
						ELSE VSL_CALL_ID 
					END) 				= A.VSL_CALL_ID
				AND WORK_YMD 			= A.WORK_YMD
				AND PURP_TP_CD 			= A.PURP_TP_CD
				AND SHFT_ID 			= A.SHFT_ID 
				AND A.STAT_CD 			= 'AP'
			) 													AS DEPYYN,
			(SELECT TOP(1) 
				S_CD_NM 
			FROM 
				TMT_CD_MSTD 
			WHERE 
				L_CD					= 'MT' 
				AND M_CD				= 'CGTP' 
				AND S_CD				= B.CG_TP_CD) 			AS CGTPNM, 
			B.CG_TP_CD             								AS CGTPCD,
			B.CG_TON               								AS CGTON,
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
				MEGA_NO 				= A.MEGA_NO
				AND DIV_CD 				= 'EQ'
				AND EQ_DIV_CD 			IN 	('CH',	'CY', 'EH', 
											 'EX', 	'FN', 'GR', 
											 'PIP', 'RP', 'RS', 
											 'WB', 	'YT') 
			) 													AS GEARSYN,
			(SELECT TOP(1) 
				'Y' 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
				MEGA_NO 				= A.MEGA_NO
				AND DIV_CD 				= 'EQ'
				AND EQ_DIV_CD 			IN ('FL') 
			) 													AS FORKLIFTYN,
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
				MEGA_NO 				= A.MEGA_NO
				AND DIV_CD 				= 'EQ'
				AND EQ_DIV_CD 			= 'TR' 
			) 													AS TRAILERYN,
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_MEGA_DTL 			B
			WHERE 
				B.MEGA_NO 				= A.MEGA_NO
				AND B.DIV_CD 			= 'EQ'
				AND EQ_DIV_CD 	NOT IN ('CH',	'CY',	'EH', 
										'EX',	'FN', 	'GR', 
										'PIP', 	'RP', 	'RS', 
										'WB', 	'YT', 	'FL', 
										'TR',	'TC',	'QC', 
										'SC', 	'HG', 	'RT', 
										'SR') 
			) 													AS MECHANICALYN, 
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_MEGA_DTL 			B
			WHERE 
				B.MEGA_NO 				= A.MEGA_NO
				AND B.DIV_CD 			= 'EQ'
				AND (
					B.EQ_DIV_CD 		= 'SR' 
					OR EXISTS (
						SELECT 
							S_CD 
						FROM 
							TMT_CD_MSTD
						WHERE 
							L_CD 		= 'MT' 
							AND M_CD 	= 'EQFCTPCD'
							AND S_CD 	= B.EQ_DIV_CD
							AND S_CD_VAL= 'PC' 
					)
				)
			) 													AS PORTCRNYN, 
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
				MEGA_NO = A.MEGA_NO 
				AND DIV_CD = 'CD') 								AS CGDTLYN,
			(SELECT TOP(1)
				STVD_COMP 
			FROM 
				TMT_MEGA_DTL  
			WHERE 
				MEGA_NO = B.MEGA_NO 
				AND DIV_CD = 'SD' 
				AND (STVD_COMP IS NOT NULL
					AND STVD_COMP <![CDATA[<>]]> '')
			) 													AS STVDCOMP,
			(SELECT TOP(1)
				F.ENG_SNM 
			FROM 
				TMT_MEGA_DTL 			E, 
				TMT_PTNR 				F 
			WHERE 
				E.MEGA_NO 				= B.MEGA_NO
				AND E.DIV_CD 			= 'SD'
				AND E.STVD_COMP 		= F.PTNR_CODE
				AND F.PTNR_TYPE 		= 'STV'
			) 													AS STVDCOMPNM,
			(SELECT TOP(1)
				TRMG_COMP 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
			MEGA_NO = B.MEGA_NO 
			AND DIV_CD = 'SD' 
			AND (TRMG_COMP IS NOT NULL 
				AND TRMG_COMP <![CDATA[<>]]> '')) 				AS TRMGCOMP,
			(SELECT TOP(1) 
				F.ENG_SNM 
			FROM 
				TMT_MEGA_DTL 			E, 
				TMT_PTNR 				F 
			WHERE 
				E.MEGA_NO 				= B.MEGA_NO
				AND E.DIV_CD 			= 'SD'
				AND E.TRMG_COMP 		= F.PTNR_CODE
				AND F.PTNR_TYPE 		= 'TRM'
			) TRMGCOMPNM,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO 
				WHERE 
					USER_ID 			= A.APPRV_BY
				), ISNULL(A.APPRV_BY, ' ')
			) APPR,
			A.APPRV_DT AS APPDT,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.REJ_BY
				), ISNULL(A.REJ_BY, ' ')
			) 													AS REJBY,					
			CASE 
				WHEN (A.REJ_BY IS NOT NULL 
						AND A.REJ_BY <![CDATA[<>]]> '')
					THEN 'Y'
				ELSE 'N'
			END 												AS REJYN,
			A.REJ_DT 											AS REJDT,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.WH_CONFM_BY
				), ISNULL(A.REJ_BY, ' ')
			) 													AS whConfmBy,		
			A.WH_CONFM_DT										AS whConfmDt,
			CASE
				WHEN A.STAT_CD = 'CA' OR A.STAT_CD = 'RJ'
					THEN 'Denied'
				WHEN EXISTS (
					SELECT 
						1
					FROM 
						TMT_MEGA_DTL_OPE	TMDO
					WHERE 
						TMDO.MEGA_NO 		= A.MEGA_NO
						AND RMK IS NOT NULL
						AND RMK <![CDATA[<>]]> ''
				) 
					THEN 'Denied'
				WHEN A.STAT_CD = 'AP' AND NOT EXISTS (
					SELECT 	
						1
					FROM 
						TMT_MEGA_DTL_OPE	TMDO
					WHERE
						TMDO.MEGA_NO		= A.MEGA_NO
						AND SUPPLY_QTY 		<![CDATA[<>]]> NOF_OPE
				) 
					THEN 'Supplied'
				ELSE ''
			END													AS supplyStatus,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
			    FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID = A.CNCL_BY
				), A.CNCL_BY
			) 													AS CNCLBY,
			A.CNCL_DT 											AS CNCLDT,
			C.ETW 												AS ETW,	
			ISNULL(A.WH_APPRV_YN, 'N') 							AS WHAPPRYN,
			ISNULL(A.MEGA_WH_YN, 'N') 							AS MEGAWHYN,
			A.MEGA_TP_CD           								AS MEGATPCD,
			dbo.F_CM_CODE_NM('MT', 'MGTPCD', A.MEGA_TP_CD) 		AS MEGATPCDNM,
			B.CMDT                 								AS CMDT,     		
			CASE A.SUMIT_BY
				WHEN #{userId} THEN 'Y'
				ELSE 'N'
			END 												AS USERMEGAYN,
			ISNULL(A.PENALTY, 'N') 								AS penaltyCd,	   
			A.RMK 												AS rmk,
			A.REJ_RMK                            				AS rejRmk,
			A.CRT_BY											AS crtBy,		   
			A.VERSION              								AS VERSION,
			ISNULL(
				(SELECT 
					D.NX_BERTH_NO
				FROM 
					TMT_VSL_SHFT D
				WHERE 
					C.VSL_CALL_ID 	= D.VSL_CALL_ID
					AND D.SEQ 	= 	(SELECT 
										MAX(E.SEQ) 
									FROM 
										TMT_VSL_SHFT E 
									WHERE 
										D.VSL_CALL_ID = E.VSL_CALL_ID)
				), C.BERTH_LOC
			) 													AS BERTHLOC
		FROM 
			TMT_MEGA 											A 
		INNER JOIN
			TMT_MEGA_DTL 										B
		ON
			A.MEGA_NO 											= B.MEGA_NO
		LEFT OUTER JOIN	
			TMT_VSL_SCH 										C
				ON A.VSL_CALL_ID 								= C.VSL_CALL_ID
		WHERE 
			B.DIV_CD 											= 'VO'
			<if test="vslCallId == null or vslCallId == ''">
				<if test="scn == null or scn == ''">
					AND A.VSL_CALL_ID 							&lt;&gt; 'STRG'
				</if>
			</if>
			<if test="vslCallId != null and vslCallId != ''">
				AND A.VSL_CALL_ID 								= #{vslCallId}
			</if>
			<if test="scn != null and scn != ''">
				AND A.SHIP_CALL_NO 								= #{scn}
			</if>
			<if test="megaNo != null and megaNo != ''">
				AND A.MEGA_NO 									LIKE  '%' + #{megaNo} + '%' 
			</if>
			<if test='vslCallId == "STRG"'>
				<if test="etaFrom != null and etaFrom != ''">
					AND	CONVERT(DATE, A.WORK_YMD, 112) 
						BETWEEN CONVERT(DATE, #{etaFrom}, 103) 
							AND CONVERT(DATE, #{etaTo}, 103)
				</if>
			</if>
			<if test='vslCallId != "STRG"'>
				<if test="etaFrom != null and etaFrom != ''">
					AND CONVERT(DATE, C.ETA) 
						BETWEEN CONVERT(DATE, #{etaFrom}, 103) 
							AND CONVERT(DATE, #{etaTo}, 103)
				</if>
				<if test="etw != null and etw != ''">
					AND TRY_CONVERT(DATE, A.WORK_YMD, 112) 			= CONVERT(DATE, #{etw}, 103)
				</if>
				<if test="saId != null and saId != ''">
					AND C.ARRV_SA_ID 							= #{saId}
				</if>
			</if>
			<if test="cmdt != null and cmdt != ''">
				AND B.CMDT 										= #{cmdt}
			</if>
			<if test="purpTpCd != null and purpTpCd != ''">
				AND A.PURP_TP_CD 								= #{purpTpCd}
			</if>
			<if test="shftId != null and shftId != ''">
				AND A.SHFT_ID 									= #{shftId}
			</if>
			<if test="statCd != null and statCd != ''">
				AND A.STAT_CD 									= #{statCd}
			</if>
			<if test='depyYn == "Y"'>
				AND EXISTS (
					SELECT TOP(1)
						'Y' 
					FROM 
						TMT_DEPY 
					WHERE 
						USE_YN 				= 'Y' 
						AND (
							CASE 
								WHEN A.VSL_CALL_ID = 'STRG' 
									THEN SUBSTRING(VSL_CALL_ID, 3, 9) 
								ELSE VSL_CALL_ID 
							END
						) 					= A.VSL_CALL_ID 
						AND WORK_YMD 		= A.WORK_YMD
						AND PURP_TP_CD 		= A.PURP_TP_CD 
						AND SHFT_ID 		= A.SHFT_ID
				)
			</if>
			<if test='depyYn == "N"'>
				AND NOT EXISTS (
					SELECT TOP(1)
						'Y' 
					FROM 
						TMT_DEPY 
					WHERE 
						USE_YN 				= 'Y'
					AND (
						CASE 
							WHEN A.VSL_CALL_ID = 'STRG' 
								THEN SUBSTRING(VSL_CALL_ID, 3, 9) 
							ELSE VSL_CALL_ID 
						END
					) 						= A.VSL_CALL_ID 
					AND WORK_YMD 			= A.WORK_YMD
					AND PURP_TP_CD 			= A.PURP_TP_CD 
					AND SHFT_ID 			= A.SHFT_ID 
				)
			</if>
			<if  test="alertYn eq 'Y'.toString()">
				<if  test="alertTp eq 'M'.toString()">
					AND STAT_CD 								IN  ('SU','CF')
					<if test='vslCallId != "STRG"'>
						AND C.SUMMIT_STAT NOT 					IN ('CC','RC')
					</if>
				</if>
				<if test="alertTp eq 'S'.toString()">
					AND NOT EXISTS (
						SELECT TOP(1)
							'Y' 
						FROM 
							TMT_DEPY 
						WHERE 
							USE_YN 			= 'Y'
							AND (
								CASE 
									WHEN A.VSL_CALL_ID = 'STRG' 
										THEN SUBSTRING(VSL_CALL_ID, 3, 9) 
									ELSE VSL_CALL_ID 
								END
							) 				= A.VSL_CALL_ID 
							AND WORK_YMD 	= A.WORK_YMD
							AND PURP_TP_CD 	= A.PURP_TP_CD 
							AND SHFT_ID 	= A.SHFT_ID 
					)
					AND STAT_CD 			= 'AP'
				</if>
				AND DATEDIFF(
						DAY,
						SYSDATETIME(), 
						CONVERT(DATE, A.WORK_YMD , 102)) 		&lt;= 180 
			</if>
    </sql>
    
    <select id="selectMegaList" parameterType="megaParm" resultType="megaItem">
	 	<if test="pageNo != 0"> 
			SELECT /* mega.selectMegaList */
             	*
			FROM 
				(SELECT 
					ROW_NUMBER() OVER(ORDER BY SVCDATE DESC, SHFTIDX DESC, MEGANO DESC, PURPTPCD) 		AS ROW_NUM,
					innerTable.*
				FROM ( 
		</if>
				<include refid="getMega"/>
		<if test="pageNo != 0"> 
				) AS innerTable 
			) AS innerTable
			WHERE 
				innerTable.ROW_NUM 		<![CDATA[>]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT) - 1) 	* CAST(#{sizePerPage} AS INT)  
		  		AND	innerTable.ROW_NUM 	<![CDATA[<=]]> 	CAST((CASE WHEN #{pageNo}  = '0' THEN '1' ELSE #{pageNo} END) AS INT) 		* CAST(#{sizePerPage} AS INT)
		</if>
	</select>
	 
	<select id="selectMegaListCount" parameterType="megaParm" resultType="java.lang.String">
	 	SELECT /* mega.selectMegaListCount */
			COUNT(*)
		FROM 
			(<include refid="getMega"/>) 						AS TEMPTB
	</select>
	
	<sql id="getMega">
		/* mega.getMega */
		<include refid="selectMegaSql" />
		AND ((A.MEGA_TP_CD IS NULL 								OR A.MEGA_TP_CD = '') 
			OR A.MEGA_TP_CD 									&lt;&gt; 'H')
		AND A.REQR 												= 	(SELECT TOP(1)
																		D.PTNR_CODE 
																	FROM 
																		TMT_PTNR_USER 	D 
																	WHERE D.USER_ID 	= #{userId})
		<if test='userRole == "CS"'>
			UNION
			<include refid="selectMegaSql" />
		    AND (A.SUMIT_BY 			&lt;&gt; #{userId}
				AND NOT EXISTS (
					SELECT 
						'1' 
					FROM 
						TMT_PTNR_USER 			TPU, 
						TMT_PTNR_USER 			B 
					WHERE 
						TPU.USER_ID 		= A.SUMIT_BY
						AND TPU.PTNR_CODE 	= B.PTNR_CODE
						AND B.USER_ID 		= #{userId}
				)
			)
			AND A.STAT_CD 										&lt;&gt; 'CR'
			AND ((A.MEGA_TP_CD IS NULL	OR A.MEGA_TP_CD = '') 
				OR A.MEGA_TP_CD 		&lt;&gt; 'H')
			AND (A.PURP_TP_CD 			IN 	(SELECT 
												S_CD
											FROM 
												TMT_CD_MSTD 
											WHERE 
												L_CD		 ='MT'
												AND M_CD	 ='MGPURP'
												AND S_CD_LGV IN ('NP', 'VP')
				)
				OR A.MEGA_WH_YN 		= 'Y'
			)
		</if>
		<if test='userRole == "WS"'>
			UNION
			<include refid="selectMegaSql" />
		    AND (A.SUMIT_BY 				&lt;&gt; #{userId}
				AND NOT EXISTS(
					SELECT 
						'1' 
					FROM 
						TMT_PTNR_USER 		TPU, 
						TMT_PTNR_USER 		B 
					WHERE 
						TPU.USER_ID 		= A.SUMIT_BY
						AND TPU.PTNR_CODE 	= B.PTNR_CODE
						AND B.USER_ID 		= #{userId}
				)
			)
			AND A.STAT_CD 										&lt;&gt; 'CR'
			AND ((A.MEGA_TP_CD IS NULL 		OR A.MEGA_TP_CD = '') 
				OR A.MEGA_TP_CD 			&lt;&gt; 'H')
			AND A.PURP_TP_CD IN (
				SELECT 
					S_CD
				FROM 
					TMT_CD_MSTD 
				WHERE 
					L_CD					= 'MT'
					AND M_CD				= 'MGPURP'
					AND S_CD_LGV 			= 'MP'
			)
		</if>
		<if test='userRole == "BS"'>
			UNION
			<include refid="selectMegaSql" />
			AND ((A.MEGA_TP_CD IS NULL		OR A.MEGA_TP_CD = '') 
				OR A.MEGA_TP_CD 			&lt;&gt; 'H')
		</if>
		<if test="userRole == null or userRole == ''">
			<if test="ptnrCd == null or ptnrCd == ''">
				<if test="ptnrType == null or ptnrType == ''">
					UNION
					<include refid="selectMegaSql" />
			    	AND (A.SUMIT_BY 		&lt;&gt; #{userId}
						AND NOT EXISTS(
							SELECT 
								'1' 
							FROM 
								TMT_PTNR_USER 	tempA, 
								TMT_PTNR_USER 	B 
							WHERE 
								tempA.USER_ID 	= A.SUMIT_BY
							AND tempA.PTNR_CODE = B.PTNR_CODE
							AND B.USER_ID 		= #{userId}
						)
					)
					AND ((A.MEGA_TP_CD IS NULL OR A.MEGA_TP_CD = '') 
						OR A.MEGA_TP_CD &lt;&gt; 'H')
				</if>
			</if>
		</if>
	</sql>
	
	<select id="selectMegaDetail" parameterType="megaParm" resultType="megaItem">
		SELECT /* mega.selectMegaDetail */
			A.MEGA_NO              								AS MEGANO,		       
			A.PURP_TP_CD           								AS PURPTPCD,
			A.REF_NO               								AS REFNO,
			B.DIV_CD               								AS DIVCD,
			dbo.F_CM_CODE_NM('MT', 'MGPURP', A.PURP_TP_CD) 		AS PURPTPCDNM,
			DATEADD(day, 1, CONVERT(DATE, A.WORK_YMD , 111))	AS WORKYMD,
			A.STAT_CD              								AS STATCD,
			dbo.F_CM_CODE_NM('MT', 'MEGASTAT', A.STAT_CD) 		AS STATCDNM,
			A.VSL_CALL_ID          								AS VSLCALLID,
			A.SHFT_ID              								AS SHFTID,
			ISNULL(A.MEGA_WH_YN, 'N') 							AS MEGAWHYN,
			B.CMDT                 								AS CMDT,
			ISNULL(
				(SELECT DISTINCT 
					D.CMDT_GRP_CD
				FROM 
					TMT_CMDT D
				WHERE 
					D.CMDT_CD = B.CMDT
				), 
				' '
			) 													AS CMDTGRCD,
		  	ISNULL(
		  		(SELECT DISTINCT 
		  			D.CMDT_GRP_DESC
				FROM 
					TMT_CMDT D
				WHERE 
					D.CMDT_CD = B.CMDT
				), 
				' '
			) 													AS CMDTGR,
			B.CG_TP_CD             								AS CGTPCD,
			B.CG_TON               								AS CGTON,
	        ISNULL(
				(SELECT TOP(1)
					A.REQ_COMP
				FROM 
					TMT_PTNR 			TP, 
					TMT_PTNR_USER 		B
				WHERE 
					B.USER_ID 			= A.SUMIT_BY							
					AND TP.PTNR_CODE 	= B.PTNR_CODE
				), 
				A.SUMIT_BY
			) 													AS REQCOMP,
			A.SUMIT_DT 											AS REQDT,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.SUMIT_BY
				), 
				A.SUMIT_BY 
			) 													AS REQR,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.APPRV_BY
			), A.APPRV_BY)  									AS APPR,
			A.RMK                  								AS RMK,
			A.REJ_RMK              								AS REJRMK,
			B.LOC_DIV_CD          								AS LOCDIVCD,
			dbo.F_GET_MEGA_DTL_LOC(A.MEGA_NO) 					AS LOCID,
			B.SHIPG_NOTE_NOS       								AS SHIPGNOTENO,
			B.DO_NOS               								AS DONO,
			(SELECT 
				dbo.F_INTERVAL_OF_HOUR(
					'', 
					CONVERT(DATETIME, A.WORK_YMD + SH.FM_HHMM, 112), 
					SYSDATETIME()
				) 
				FROM 
					TMT_SHFT SH
				WHERE 
					SH.SHFT_METH_CD 	= 'Standard'
					AND SH.VLD_YN 		= 'Y'
					AND SH.SHFT_ID 		= A.SHFT_ID
			) 													AS HOUR,
			A.VERSION              								AS VERSION
		FROM 
			TMT_MEGA 											A, 
			TMT_MEGA_DTL 										B
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			AND A.MEGA_NO 										= #{megaNo}
			AND B.DIV_CD 										= 'VO'
	</select>
	
	<select id="selectShippingNote"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /* mega.selectShippingNote */
			SHIPG_NOTE_NO 										AS SHIPGNOTENO,
			DO.DO_NO											AS dono
		FROM 
			TMT_SHIPG_NOTE SN, TMT_DO DO
		WHERE 
			SN.VSL_CALL_ID 										= #{vslCallId} 
			AND SN.VSL_CALL_ID 									= DO.VSL_CALL_ID
			-- AND STAT_CD 										IN ('CF', 'FS')
			AND (SN.SHIPG_NOTE_NO IS NOT NULL 						AND SN.SHIPG_NOTE_NO <![CDATA[<>]]> '')
			AND (DO.DO_NO IS NOT NULL 								AND DO.DO_NO <![CDATA[<>]]> '') 
		<if test='ptnrType == "SHA"'>
			AND SHIPG_AGNCY 									= #{ptnrCd}
		</if>
		<if test='ptnrType == "FWD"'>
			AND FWRD 											= #{ptnrCd}
		</if>
		<if test='ptnrType == "BOTH"'>
			AND (SHIPG_AGNCY = #{ptnrCd} 						OR FWRD = #{ptnrCd})
		</if>
		ORDER BY 
			SHIPG_NOTE_NO
	</select>
	
	<select id="selectDeliveryOrder"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /* mega.selectDeliveryOrder */
			DO_NO AS DONO 
		FROM 
			TMT_DO
		WHERE 
			VSL_CALL_ID 										= #{vslCallId} 
			AND (DO_NO IS NOT NULL								AND DO_NO <![CDATA[<>]]> '')
		ORDER BY 
			DO_NO
	</select>
	
	<select id="selectPenaltyCode"  parameterType="megaParm" resultType="megaItem">
		<!-- dbo.F_GET_MEGA_PENALTY_LB does not exist in MMC DB  -->
		<!-- 
		<if test="penaltyTp == 'C_MEGA'">
			SELECT /*mega.selectPenaltyCode*/
				ISNULL(
					dbo.F_GET_MEGA_PENALTY_LB(
							#{workYmd}, 
							#{shftId}, 
							#{purpTpCd}, 
							#{nofGang})
				, 'N') 											AS PENALTYCD, 
				ISNULL(
					(SELECT 
						S_CD_NM 
					FROM 
						TMT_CD_MSTD 
					WHERE 
						M_CD ='PNTYTP' 
						AND S_CD = 	dbo.F_GET_MEGA_PENALTY_LB(
										#{workYmd},
										#{shftId},
										#{purpTpCd},
										#{nofGang})
				), ' ') 										AS PENALTYNM
		</if>
		 -->
		<if test="penaltyTp != 'C_MEGA'">
            SELECT /* mega.selectPenaltyCode */
            	ISNULL(
					dbo.F_GET_MEGA_PENALTY(
						#{megaNo},
						#{workYmd},
						#{shftId},
						#{nofGang},
						#{penaltyTp})
				, 'N') 											AS PENALTYCD, 
				ISNULL(
					(SELECT 
						S_CD_NM 
					FROM 
						TMT_CD_MSTD 
				   	WHERE 
						M_CD ='PNTYTP' 
						AND S_CD = 	dbo.F_GET_MEGA_PENALTY(
										#{megaNo},
										#{workYmd},
										#{shftId},
										#{nofGang},
										#{penaltyTp}))
				, ' ') 											AS PENALTYNM
		</if>
	</select>
	
	<select id="selectMegaManpowerList"  parameterType="megaParm" resultMap="stevedoreMap">
		SELECT /* mega.selectMegaManpowerList */
			A.MEGA_NO              								AS MEGANO,
			A.SEQ                  								AS SEQ,
			A.SEQ                  								AS RELATION_KEY,
			A.DIV_CD                          					AS DIVCD,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 1, 2)
				ELSE 0
			END 												AS REQTIME,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 3, 2)
				ELSE 0
			END 												AS REQMIN,
			A.SHIP_CLEW_YN         								AS SHIPCLEWYN, 
			A.STVD_COMP            								AS STVDCOMP,	      
			A.NOF_GANG             								AS NOFGANG,
			A.NOF_OPR_SPRR         								AS NOFOPRSPRR,
			A.NOF_OPR_CLERK        								AS NOFOPRCLERK,
			A.NOF_STVD_SPRR        								AS NOFSTVDSPRR,
			A.NOF_WCHMN            								AS NOFWCHMN,
			A.NOF_STVD_GWKER       								AS NOFSTVDGWKER,
			A.STVD_NON_TON         								AS STVDNONTON,
			A.TRMG_COMP            								AS TRMGCOMP,
			A.NOF_HATCH            								AS NOFHATCH,
			A.NOF_TRMG_SPRR        								AS NOFTRMGSPRR,
			A.NOF_SGLMN            								AS NOFSGLMN,
			A.NOF_DEKMN            								AS NOFDEKMN,
			A.NOF_HOPMN            								AS NOFHOPMN,
			A.NOF_TRMG_GWKER       								AS NOFTRMGGWKER,
			A.TRMG_NON_TON         								AS TRMGNONTON,
			A.LOC_ID               								AS LOCID,
			FORMAT(A.START_DATE, 'dd/MM/yyyy HH:mm')			AS WORKSTDT,
			FORMAT(A.END_DATE, 'dd/MM/yyyy HH:mm')				AS WORKENDDT
		FROM 
			TMT_MEGA_DTL 										A
		WHERE 
			A.MEGA_NO 											= #{megaNo}
			AND A.DIV_CD 										= #{divCd}
	</select>
	
	<sql id="sqlMegaCntt">
		SELECT DISTINCT /* mega.selectMegaCntt */
			A.SHIP_CALL_NO										AS SCN,
			A.VSL_CALL_ID 										AS VSLCALLID,  
			(SELECT 
				PT.VSL_NM 
			FROM 
				TMT_VSL_SCH 			SH, 
				TMT_VSL_PART 			PT
			WHERE 
				SH.VSL_CALL_ID 			= A.VSL_CALL_ID 
				AND SH.VSL_CD 			= PT.VSL_CD
			) 													AS VSLNM,
			dbo.F_CM_CODE_NM('MT', 'MGPURP', A.PURP_TP_CD) 		AS PURPTPCDNM,
			CONVERT(DATE, A.WORK_YMD , 112) 					AS WORKYMD, 
			A.SHFT_ID     										AS SHFTID, 
			(SELECT 
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID 				= A.SHFT_ID) 			AS SHFTNM,
			A.MEGA_NO     										AS MEGANO,
			C.SEQ 												AS SEQ,
			B.EQ_DIV_CD 										AS eqDivCd, 
			A.STAT_CD     										AS STATCD, 
			dbo.F_CM_CODE_NM('MT', 'MEGASTAT', A.STAT_CD) 		AS STATCDNM,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.SUMIT_BY
			), A.SUMIT_BY) 										AS REQRNM,
			<!-- 
			FORMAT(A.SUMIT_DT, 'dd/MM/yyyy HH:mm') 				AS REQDT,
			FORMAT(A.APPRV_DT, 'dd/MM/yyyy HH:mm') 				AS APPDT,
			FORMAT(A.CNCL_DT, 'dd/MM/yyyy HH:mm') 				AS CNCLDT,
			FORMAT(A.REJ_DT, 'dd/MM/yyyy HH:mm') 				AS REJDT,
			-->
			A.SUMIT_DT							 				AS REQDT,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.APPRV_BY
			), ISNULL(A.APPRV_BY, ' ')) 						AS APPR,
			A.APPRV_DT							 				AS APPDT,
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.CNCL_BY
			), A.CNCL_BY) 										AS CNCLBY, 
			A.CNCL_DT							 				AS CNCLDT,
			ISNULL(
				(SELECT (USER_ID + '/' + ENG_NM) 
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID = A.REJ_BY
			), ISNULL(A.REJ_BY, ' ')) 							AS REJBY, 
			A.REJ_DT							 				AS REJDT,
			(SELECT TOP(1)
				'Y' 
			FROM 
				TMT_DEPY 
			WHERE 
				USE_YN 					= 'Y' 
				AND VSL_CALL_ID 		= A.VSL_CALL_ID
				AND WORK_YMD 			= A.WORK_YMD
				AND PURP_TP_CD 			= A.PURP_TP_CD
				AND SHFT_ID 			= A.SHFT_ID 
				AND A.STAT_CD 			= 'AP'
			) 													AS DEPYYN,
			CASE
				WHEN C.FILE_YN = 'Y' THEN 'Y'
				ELSE 'N'
			END													AS FILEYN,
			C.VOUCHER_NO										AS VOUCHERNO,
			C.SUPPLY_QTY										AS SUPPLYQTY,
			C.RMK												AS DENYRMK,	
			C.MEGA_IDX											AS MEGAIDX,
			CASE
				WHEN (
					A.STAT_CD = 'RJ' OR A.STAT_CD = 'CA' 
					OR (
						C.RMK IS NOT NULL 
						AND C.RMK <![CDATA[<>]]> ''
					)
				) 
					THEN 'Denied'
				WHEN (
					A.STAT_CD = 'AP'
					AND (C.NOF_OPE = C.SUPPLY_QTY)
				)
					THEN 'Supplied'
				ELSE ''
			END													AS SUPPLYSTATUS,
	</sql>
	
	<sql id="sqlMegaCondition">
		/* mega.sqlMegaCondition */
		<if test="vslCallId == null or vslCallId == ''">
			<if test="etaFrom != null and etaFrom != ''">
				AND CONVERT(DATE, A.WORK_YMD, 112) 
					BETWEEN CONVERT(DATE, #{etaFrom}, 103) 
						AND CONVERT(DATE, #{etaTo}, 103)
			</if>
		</if>
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID 									= #{vslCallId}
		</if>
		<if test="scn != null and scn != ''">
			AND A.SHIP_CALL_NO 									= #{scn}
		</if>
		<if test="cmdt != null and cmdt != ''">
			AND B.CMDT 											= #{cmdt}
		</if>
		<if test="purpTpCd != null and purpTpCd != ''">
			AND A.PURP_TP_CD 									= #{purpTpCd}
		</if>
		<if test="shftId != null and shftId != ''">
			AND A.SHFT_ID 										= #{shftId}
		</if>
		<if test="statCd != null and statCd != ''">
			AND A.STAT_CD 										= #{statCd}
		</if>
		<if test="saId != null and saId != ''">
			AND EXISTS(
				SELECT 
					'1' 
				FROM 
					TMT_VSL_SCH 
				WHERE 
					VSL_CALL_ID 		= A.VSL_CALL_ID 
					AND ARRV_SA_ID		= #{saId})
		</if>
		<if test='depyYn == "Y"'>
			AND EXISTS (
		   		SELECT TOP(1) 
					'Y' 
				FROM 
					TMT_DEPY 
				WHERE 
					USE_YN = 'Y' 
					AND VSL_CALL_ID 	= A.VSL_CALL_ID 
					AND WORK_YMD 		= A.WORK_YMD
					AND PURP_TP_CD 		= A.PURP_TP_CD 
					AND SHFT_ID 		= A.SHFT_ID 
			)
		</if>
		<if test='depyYn == "N"'>
			AND NOT EXISTS(
				SELECT TOP(1) 
					'Y' 
				FROM 
					TMT_DEPY 
				WHERE 
					USE_YN 				= 'Y' 
					AND VSL_CALL_ID 	= A.VSL_CALL_ID 
					AND WORK_YMD 		= A.WORK_YMD
					AND PURP_TP_CD 		= A.PURP_TP_CD 
					AND SHFT_ID 		= A.SHFT_ID 
			)
		</if>
	</sql>
	
	<select id="selectMegaCnttList"  parameterType="megaParm" resultType="megaItem">
	 	<if test="pageNo != 0"> 
              SELECT /* mega.selectMegaCnttList */
             	*
			FROM 
				(SELECT 
					ROW_NUMBER() OVER(ORDER BY BERTH_CD) AS ROW_NUM,
					innerTable.*
				FROM ( 
		</if>
				<include refid="getMegaCntt"/>
		<if test="pageNo != 0"> 
				) AS innerTable 
			) AS innerTable
			WHERE 
				innerTable.ROW_NUM 		<![CDATA[>]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT) - 1) 	* CAST(#{sizePerPage} AS INT)  
		  		AND	innerTable.ROW_NUM 	<![CDATA[<=]]> 	CAST((CASE WHEN #{pageNo}  = '0' THEN '1' ELSE #{pageNo} END) AS INT) 		* CAST(#{sizePerPage} AS INT)
		</if>
	</select>
	
	<select id="selectMegaCnttCount" parameterType="megaParm" resultType="java.lang.String">
		SELECT /* mega.selectMegaCnttCount */
			COUNT(*)
		FROM 
			(<include refid="getMegaCntt"/>) 					AS TEMPTB
	</select>
	
	<sql id="getMegaCntt">
		<include refid="sqlMegaCntt"/>
			''           										AS OPECOMPNM,
			dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', C.EQ_DIV_CD) 	AS EQDIVCDNM, 
			(SELECT 
				CAPA_DESCR 
			FROM 
				TMT_EQ_CAPA 
			WHERE 
				CAPA_CD = C.CAPA_CD 
				AND EQ_TP_CD = C.EQ_DIV_CD) 					AS CAPADESCR,
			C.OPE_COMP    										AS OPECOMPCD,
			C.NOF_OPE     										AS NOFOPE, 
			0             										AS NOFGANG,
			0             										AS NOFOPRSPRR,
			0             										AS NOFOPRCLERK,
			0             										AS NOFSTVDSPRR,
			0             										AS NOFWCHMN,
			0             										AS NOFSTVDGWKER,
			0             										AS STVDNONTON,
			0             										AS NOFHATCH,
			0             										AS NOFTRMGSPRR,
			0             										AS NOFSGLMN,
			0             										AS NOFDEKMN,
			0             										AS NOFHOPMN,
			0             										AS NOFTRMGGWKER
		FROM 
			TMT_MEGA 											A
		INNER JOIN
			TMT_MEGA_DTL 										B
		ON 
			A.MEGA_NO 											= B.MEGA_NO
		INNER JOIN
			TMT_MEGA_DTL_OPE 									C
		ON 
			A.MEGA_NO 											= C.MEGA_NO
			AND B.SEQ 											= C.MEGA_IDX
		INNER JOIN 
			TMT_PTNR											D 
		ON 
			C.OPE_COMP 											= D.PTNR_CODE
		WHERE 
			A.STAT_CD 											IN ('CA', 'RJ', 'AP')
			AND B.DIV_CD 										= 'EQ'
			<!-- 
			AND C.OPE_DIV_CD 									= 'C'
			-->
	 	<if test='isMPTSBBBilling == "Y"'>
	 		<if test="opeCompCd != null and opeCompCd != ''">
	 			AND D.PTNR_TYPE 								= 'CTT' 
				AND D.PTNR_CODE 								= #{opeCompCd}
	 		</if>
	 		<if test="opeCompCd == null or opeCompCd == ''">
	 			AND D.PTNR_TYPE 								= 'CTT'
	 		</if>
	 	</if>
	 	<if test='isMPTSBBBilling == "N"'>
			AND
	 		<if test="opeCompCd != null and opeCompCd != ''">
	 			C.OPE_COMP 										= 	(SELECT 
																		PTNR_CODE 
																	FROM 
																		TMT_PTNR_USER 
																	WHERE 
																		PTNR_TYPE 	= 'CTT' 
																		AND USER_ID = #{userId})
	 		</if>
	 		<if test="opeCompCd == null or opeCompCd == ''">
	 			 D.PTNR_TYPE 									= 'CTT'
	 		</if>
	 	</if>
		<include refid="sqlMegaCondition"/>
		
		UNION ALL
		
		<include refid="sqlMegaCntt"/>
			'Stevedore'      									AS OPECOMPNM,
			''              									AS EQDIVCD, 
			''              									AS CAPADESCR, 
			C.OPE_COMP               							AS OPECOMPCD, 
			0                									AS NOFOPE, 
			B.NOF_GANG       									AS NOFGANG,
			B.NOF_OPR_SPRR   									AS NOFOPRSPRR,
			B.NOF_OPR_CLERK  									AS NOFOPRCLERK,
			B.NOF_STVD_SPRR  									AS NOFSTVDSPRR,
			B.NOF_WCHMN      									AS NOFWCHMN,
			B.NOF_STVD_GWKER 									AS NOFSTVDGWKER,
			B.STVD_NON_TON   									AS STVDNONTON,
			B.NOF_HATCH      									AS NOFHATCH,
			B.NOF_TRMG_SPRR  									AS NOFTRMGSPRR,
			B.NOF_SGLMN      									AS NOFSGLMN,
			B.NOF_DEKMN      									AS NOFDEKMN,
			B.NOF_HOPMN      									AS NOFHOPMN,
			B.NOF_TRMG_GWKER 									AS NOFTRMGGWKER
		FROM 
			TMT_MEGA 											A
		INNER JOIN
			TMT_MEGA_DTL 										B
		ON
			A.MEGA_NO 											= B.MEGA_NO
		INNER JOIN
			TMT_MEGA_DTL_OPE 									C
		ON 
			A.MEGA_NO 											= C.MEGA_NO
			AND B.SEQ 											= C.MEGA_IDX
		INNER JOIN
			TMT_PTNR 											D 
		ON
			B.STVD_COMP 										= D.PTNR_CODE
		WHERE
			B.DIV_CD 											= 'SD'
			AND A.STAT_CD 										IN ('CA', 'RJ', 'AP')
   		<if test='isMPTSBBBilling == "Y"'>
 			<if test="opeCompCd != null and opeCompCd != ''">
 				AND D.PTNR_TYPE 								= 'STV' 
				AND D.PTNR_CODE 								= #{opeCompCd}
 			</if>
 			<if test="opeCompCd == null or opeCompCd == ''">
 				AND D.PTNR_TYPE 								= 'STV'
 			</if>
 		</if>
 		<if test='isMPTSBBBilling == "N"'>
			AND B.STVD_COMP 									=	(SELECT 
																		PTNR_CODE 
																	FROM 
																		TMT_PTNR_USER 
																	WHERE 
																		PTNR_TYPE 	= 'STV' 
																		AND USER_ID = #{userId})
 		</if>
		<include refid="sqlMegaCondition"/>
		
		UNION ALL
		
		<include refid="sqlMegaCntt"/>
			'Trimming'      									AS OPECOMPNM,
			''              									AS EQDIVCD, 
			''              									AS CAPADESCR, 
			C.OPE_COMP              							AS OPECOMPCD, 
			0                									AS NOFOPE, 
			B.NOF_GANG       									AS NOFGANG,
			B.NOF_OPR_SPRR   									AS NOFOPRSPRR,
			B.NOF_OPR_CLERK  									AS NOFOPRCLERK,
			B.NOF_STVD_SPRR  									AS NOFSTVDSPRR,
			B.NOF_WCHMN      									AS NOFWCHMN,
			B.NOF_STVD_GWKER 									AS NOFSTVDGWKER,
			B.STVD_NON_TON   									AS STVDNONTON,
			B.NOF_HATCH      									AS NOFHATCH,
			B.NOF_TRMG_SPRR  									AS NOFTRMGSPRR,
			B.NOF_SGLMN      									AS NOFSGLMN,
			B.NOF_DEKMN      									AS NOFDEKMN,
			B.NOF_HOPMN      									AS NOFHOPMN,
			B.NOF_TRMG_GWKER 									AS NOFTRMGGWKER
		FROM 
			TMT_MEGA 											A
		INNER JOIN
			TMT_MEGA_DTL 										B
		ON 
			A.MEGA_NO 											= B.MEGA_NO
		INNER JOIN
			TMT_MEGA_DTL_OPE 									C
		ON 
			A.MEGA_NO 											= C.MEGA_NO
			AND B.SEQ 											= C.MEGA_IDX
		INNER JOIN
			TMT_PTNR 											D 
		ON 
			B.TRMG_COMP 										= D.PTNR_CODE
		WHERE 
			B.DIV_CD 											= 'TR'
			AND A.STAT_CD 										IN ('CA', 'RJ', 'AP')
 		<if test='isMPTSBBBilling == "Y"'>
 			<if test="opeCompCd != null and opeCompCd != ''">
 				AND D.PTNR_TYPE 								= 'TRM' 
				AND D.PTNR_CODE 								= #{opeCompCd}
 			</if>
 			<if test="opeCompCd == null or opeCompCd == ''">
 				AND D.PTNR_TYPE 								= 'TRM'
 			</if>
 		</if>
 		<if test='isMPTSBBBilling == "N"'>
			AND	B.TRMG_COMP 									= 	(SELECT 
																		PTNR_CODE 
																	FROM 
																		TMT_PTNR_USER 
																	WHERE 
																		PTNR_TYPE 	= 'TRM' 
																		AND USER_ID = #{userId})
 		</if>
		<include refid="sqlMegaCondition"/>
		ORDER BY 
			VSLCALLID, 
			MEGANO
	</sql>
	
	<select id="selectMegaEquipment" parameterType="megaParm" resultMap="EquipmentMap">
		SELECT /* mega.selectMegaEquipment */
			A.MEGA_NO                         					AS MEGANO,
			A.SEQ                             					AS SEQ,
			A.DIV_CD                          					AS DIVCD,
			A.EQ_DIV_CD                       					AS EQDIVCD,
			dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', A.EQ_DIV_CD) 	AS EQDIVCDNM,
			ISNULL(A.CAPA_CD, '')              					AS CAPACD,
			CASE A.EQ_DIV_CD
				WHEN 'SR' THEN '-'
				ELSE 
					(SELECT 
						CAPA_DESCR 
					FROM 
						TMT_EQ_CAPA 
						WHERE CAPA_CD 	= A.CAPA_CD
						<if test='eqDivCdType != "GR"'>
							AND EQ_TP_CD 	= A.EQ_DIV_CD
						</if>	
					)
			END													AS CAPADESCR,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 1, 2)
				ELSE 0
			END 												AS REQTIME,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 3, 2)
				ELSE 0
			END 												AS REQMIN,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS DSPREQHHMM, 
			CASE 
				WHEN (A.REQ_QTY IS NULL)
					THEN 0
				ELSE A.REQ_QTY
			END													AS REQQTY,
			<!-- 
			FORMAT(START_DATE, 'dd/MM/yyyy HH:mm') 				AS WORKSTDT,
			FORMAT(END_DATE, 'dd/MM/yyyy HH:mm')				AS WORKENDDT,
			-->
			FORMAT(START_DATE, 'dd/MM/yyyy HH:mm')				AS WORKSTDT,
			FORMAT(END_DATE, 'dd/MM/yyyy HH:mm')				AS WORKENDDT,
			FL_STATUS           								AS FLSTATUS,
			<if test='copyType != null and copyType == "C"'>
				0                               				AS CONFMQTY,
				0                               				AS WHQTY,
			</if>
			<if test='copyType != null and copyType != "C"'> 
				CASE A.CONFM_QTY
					WHEN 0 THEN 0
					ELSE A.CONFM_QTY
				END 											AS CONFMQTY,
				CASE A.WH_QTY
					WHEN 0 THEN 0
					ELSE A.WH_QTY
				END 											WHQTY,
			</if>
				ISNULL(A.LOC_ID, ' ')                			AS LOCID,
				' '                               				AS COLCOLOR,
				#{copyType, jdbcType=VARCHAR}					AS COPYTYPE
		FROM 
			TMT_MEGA_DTL A
		WHERE 
			A.MEGA_NO                             				= #{megaNo}
			AND A.DIV_CD                             			= #{divCd}
		<if test = 'eqDivCdType != null'>
			<if test='eqDivCdType == "GR"'>
			   AND A.CAPA_CD IN (SELECT 
								B.CAPA_CD    	
							FROM 	
								TMT_EQ_CAPA 					B, 
								TMT_CD_MSTD 					C
							WHERE 	
								B.EQ_TP_CD 						= C.S_CD 
								AND C.M_CD 						= 'EQFCTPCD'
								AND	C.S_CD_LGV 					= 'EQ'
								AND C.S_CD_VAL 					= 'GR'
							GROUP BY 
								B.EQ_TP_CD, C.S_CD_NM, 
								B.EQ_TP_CD, B.CAPA_CD, 
								B.CAPA_DESCR, B.CAPA)								
			</if>
			<if test='eqDivCdType == "FL"'>
			   AND A.EQ_DIV_CD 									= #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "TR"'>
			   AND A.EQ_DIV_CD 									= #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "MC"'>
				AND EQ_DIV_CD 	NOT IN ('CH',	'CY', 	'EH', 	'EX', 
										'FN', 	'GR', 	'PIP',	'RP', 
										'RS', 	'WB', 	'YT', 	'FL', 
										'TR',	'TC',	'QC', 	'SC', 
										'HG', 	'RT', 	'SR',	'CC',
										'CU',	'LL',	'PC',	'FC') 	
				AND dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', A.EQ_DIV_CD) NOT LIKE '%CRANE%'											
			</if>
			<if test='eqDivCdType == "PC"'>
				AND dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', A.EQ_DIV_CD) LIKE '%CRANE%'
				<!-- OR
					  (A.EQ_DIV_CD 		= 'SR' 
						OR EXISTS ( 
							SELECT 
								S_CD 
							FROM 
								TMT_CD_MSTD
							WHERE 
								L_CD 		 = 'MT' 
								AND M_CD 	 = 'EQFCTPCD'
								AND S_CD 	 = A.EQ_DIV_CD
								AND S_CD_VAL = 'PC' 
						)
					)) -->
			</if>
		</if>
		ORDER BY
			SEQ ASC
	</select>
	
    <select id="selectMegaEquipmentForReport" parameterType="megaParm" resultMap="EquipmentMapForReport2">
		SELECT /* mega.selectMegaEquipmentForReport */
			ROW_NUMBER() OVER(ORDER BY MEGANO, WORKYMD, SHFTNM) AS NO,
			*
		FROM
			(SELECT 
			A.MEGA_NO                         					AS MEGANO,
			A.SEQ                              					SEQ,				
			CASE
				WHEN A.req_qty IS NULL OR A.req_qty = ''
					THEN 0
				ELSE A.req_qty
			END 												AS reqqty,
			CASE
				WHEN A.confm_qty = NULL
					THEN 0
				ELSE A.confm_qty
			END 												AS confm_qty,
			A.DIV_CD                         					AS DIVCD,
			A.EQ_DIV_CD                       					AS EQDIVCD,
			dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', A.EQ_DIV_CD)		AS EQDIVCDNM,
			ISNULL(A.CAPA_CD, ' ')               				AS CAPACD,
			CASE A.EQ_DIV_CD
				WHEN 'SR' THEN '-'
				ELSE
					(SELECT 
						CAPA_DESCR 
					FROM 
						TMT_EQ_CAPA 
					WHERE 
						CAPA_CD 		= A.CAPA_CD
						AND EQ_TP_CD 	= A.EQ_DIV_CD)
			END 												AS CAPADESCR,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 1, 2)
				ELSE 0
			END 												AS REQTIME,
			CASE
				WHEN (A.REQ_HHMM IS NOT NULL
					 AND A.REQ_HHMM <![CDATA[<>]]> '')
						THEN SUBSTRING(A.REQ_HHMM, 3, 2)
				ELSE 0
			END 												AS REQMIN,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS DSPREQHHMM, 
			<!-- 
			CASE
				WHEN (A.REQ_QTY IS NOT NULL 
					 AND A.REQ_QTY <![CDATA[<>]]> '') 
					 	THEN ' '
				ELSE A.REQ_QTY
			END													AS REQQTY,
			 -->
			<if test='copyType == "C"'>
				' '                               				AS CONFMQTY,
				' '                               				AS WHQTY,
			</if>
			<if test="copyType != 'C'"> 
				CASE
					WHEN (A.CONFM_QTY IS NOT NULL 
						AND A.CONFM_QTY <![CDATA[<>]]> '') 
							THEN ' '
					ELSE A.CONFM_QTY
				END												AS REQQTY,
				ISNULL(A.WH_QTY, 0) 							AS WHQTY,
			</if>
			ISNULL(A.LOC_ID, ' ')                				AS LOCID,
			' '                               					AS COLCOLOR,
			#{copyType}                        					AS COPYTYPE,
			B.SHFT_ID                          					AS SHFTID,
            B.SUMIT_BY                          				AS submitBy,
			(SELECT 
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = B.SHFT_ID) 							AS SHFTNM,
			(SELECT 
				SHFT_IDX 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = B.SHFT_ID) 							AS SHFTIDX,
			B.PURP_TP_CD           								AS PURPTPCD,
			B.RMK 												AS rmk,
			B.REJ_RMK                            				AS rejRmk,
			B.APPRV_BY                           				AS apprvBy,
			B.STAT_CD                            				AS statCd,
			dbo.F_CM_CODE_NM('MT', 'MGPURP', B.PURP_TP_CD) 		AS PURPTPCDNM,
			FORMAT(
				CONVERT(DATE, B.WORK_YMD , 112), 
				'dd/MM/yyyy'
			) 													AS WORKYMD,
			dbo.F_CM_CODE_NM('MT', 'MEGASTAT', B.STAT_CD) 		AS STATCDNM,
			(SELECT 
				S_CD_LGV 
			FROM 
				TMT_CD_MSTD 
			WHERE 
				L_CD					= 'MT' 
				AND M_CD				= 'MGPURP' 
				AND S_CD 				= B.PURP_TP_CD)  		AS PURPTYPE,
			'' 													AS BERTHLOC
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			AND B.VSL_CALL_ID 									= #{vslCallId}
			AND A.DIV_CD 										= #{divCd}
			<if test='vslCallId == "STRG"'>
				<if test="etaFrom != null and etaFrom != ''">
					AND CONVERT(DATETIME, B.WORK_YMD,'YYYYMMDD') = CONVERT(DATETIME, #{etaFrom},'DD/MM/YYYY')
				</if>
			</if>
			<if test='eqDivCdType == "GR"'>
				AND A.EQ_DIV_CD 								= #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "FL"'>
				AND A.EQ_DIV_CD 								= #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "TR"'>
				AND A.EQ_DIV_CD 								= #{eqDivCdType}
			</if>
			<if test='eqDivCdType == "MC"'>
				AND EQ_DIV_CD NOT IN ('GR', 'FL', 'TR','BG','CU','LL','PC','TX','SR')
			</if>
			<if test='eqDivCdType == "PC"'>
				AND (A.EQ_DIV_CD 			= 'SR' 
					OR EXISTS (
						SELECT 
							S_CD 
						FROM 
							TMT_CD_MSTD
						WHERE 
							L_CD 			= 'MT' 
							AND M_CD 		= 'EQFCTPCD'
							AND S_CD 		= A.EQ_DIV_CD
							AND S_CD_VAL 	= 'PC'
					)
				)
			</if>
			<if test='ptnrType == "SHA"'>
				AND B.REQR 										= 	(SELECT TOP(1) 
																		C.PTNR_CODE 
																	FROM 
																		TMT_PTNR_USER C 
																	WHERE 
																		C.USER_ID = #{userId})
			</if>
			<if test="megaList != null and !megaList.isEmpty">
				AND A.MEGA_NO IN
				<foreach item="item" index="index" collection="megaList" separator="," open="(" close=")">
					${item}
				</foreach>
			</if>
			) AS TEMPTB
    </select>
    
	<select id="selectOperInfo" 								resultMap="OperInfoMap">
		SELECT /* mega.selectOperInfo */
			MEGA_NO              								AS MEGANO,
			MEGA_IDX             								AS MEGAIDX,
			SEQ                  								AS SEQ,
			MEGA_IDX											AS RELATION_KEY,
			EQ_DIV_CD            								AS EQDIVCD,
			ISNULL(CAPA_CD, ' ')    							AS CAPACD,
			OPE_DIV_CD           								AS OPEDIVCD,
			ISNULL(OPE_COMP, ' ')   							AS OPECOMPCD,
			ISNULL(OPE_COMP, 'JPB') 							AS OPECOMPNM,
			NOF_OPE              								AS NOFOPE,
			SUPPLY_QTY											AS SUPPLYQTY,
			RMK													AS RMK,
			NOF_GANG, 
			NOF_STVD_SPRR, 
			NOF_WCHMN, 
			NOF_STVD_GWKER,
			NOF_TRMG_SPRR, 
			NOF_SGLMN, 
			NOF_DEKMN, 
			NOF_HOPMN
		FROM 
			TMT_MEGA_DTL_OPE
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND MEGA_IDX 										= ${megaIdx}
		<if test="eqDivCd != null and eqDivCd != ''">
			AND EQ_DIV_CD 										= #{eqDivCd}
		</if>
		<if test="capaCd != null and capaCd != ''">
			AND CAPA_CD 										= #{capaCd}
		</if>
		<if test='copyType == "C"'>
			AND 1 &lt;&gt; 1
		</if>
	</select>
	
	<sql id="sqlInternalMega">
		SELECT /* mega.sqlInternalMega */
			A.MEGA_NO                                      		AS MEGANO, 
			B.SEQ                                         		AS SEQ,
			CONVERT(DATE, A.WORK_YMD , 111)				  		AS WORKYMD,
			B.DIV_CD                                       		AS DIVCD, 
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM) 
			  	FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= A.SUMIT_BY
			), A.SUMIT_BY) 										AS REQR,
			A.SUMIT_DT 											AS REQDT,
			(SELECT 
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
			SHFT_ID 					= A.SHFT_ID)            AS SHFTNM,
			B.LOC_DIV_CD                                   		AS LOCDIVCD, 
			B.LOC_ID                                       		AS LOCID, 
			(SELECT 
				MAX(SHIPG_NOTE_NOS + DO_NOS) 
			FROM 
				TMT_MEGA_DTL 
			WHERE 
				DIV_CD 					= 'VO' 
				AND MEGA_NO 			= A.MEGA_NO
			)                   								AS SNDO,
			B.EQ_DIV_CD 										AS eqDivCd,
			dbo.F_CM_CODE_NM('MT', 'EQFCTPCD', B.EQ_DIV_CD) 	AS eqDivCdNm,
			B.CAPA_CD 											AS CAPACD,
			(SELECT 
				CAPA_DESCR 
			FROM 
				TMT_EQ_CAPA 
			WHERE 
				CAPA_CD = B.CAPA_CD 
				AND EQ_TP_CD = B.EQ_DIV_CD) 					AS CAPADESCR,
			ISNULL(B.REQ_QTY, 0)                              	AS REQQTY, 
			CASE 
				WHEN 
					(B.WH_QTY IS NULL OR B.WH_QTY = 0 )
						THEN ISNULL(B.REQ_QTY, 0)
				ELSE ISNULL(B.CONFM_QTY, 0)
			END 												AS CONFMQTY,
			ISNULL(B.WH_QTY, 0)                               	AS WHQTY,              		
			CASE
				WHEN 
					(B.WH_QTY IS NOT NULL AND B.WH_QTY <![CDATA[<>]]> 0)
						THEN ' '
				ELSE  #{colColor}
			END 												AS COLCOLOR,
			A.VERSION                                      		AS VERSION,
	</sql>
	
	<sql id="sqlInternalMegaParm">
		/* mega.sqlInternalMegaParm */
		AND A.STAT_CD 											IN ('RV','SU','CF')
		AND A.WH_APPRV_YN 										= 'Y'
		AND A.PURP_TP_CD 										IN (
																	SELECT 
																		S_CD
																	FROM 
																		TMT_CD_MSTD 
																	WHERE 
																		L_CD		 ='MT'
																		AND M_CD	 ='MGPURP'
																		AND S_CD_LGV IN ('MP')
		)
		AND B.DIV_CD 											= 'EQ'
		<choose>
			<when test="eqDivCd == 'FL'">
				AND B.EQ_DIV_CD 								= 'FL'
		   	</when>
		   	<otherwise>
		   		AND B.EQ_DIV_CD NOT 							IN ('GR', 	'FL', 	'TR',	'BG',	'CU',	
																	'LL',	'PC',	'TX',	'SR')
		   	</otherwise>
		</choose>
		<if test="vslCallId != null and vslCallId != ''">
			AND A.VSL_CALL_ID 									= #{vslCallId}
		</if>
		<if test="scn != null and scn != ''">
			AND A.SHIP_CALL_NO 									= #{scn}
		</if>
		<if test="purpTpCd != null and purpTpCd != ''">
			AND A.PURP_TP_CD 									= #{purpTpCd}
		</if>
		<if test="reqDtFrom != null and reqDtFrom != ''">
			AND CONVERT(DATE, A.WORK_YMD, 112) 
				BETWEEN CONVERT(DATE, #{reqDtFrom}, 103) AND CONVERT(DATE, #{reqDtTo}, 103)
   		</if>
		<if test="statCd != null and statCd != ''">
			AND A.STAT_CD 										= #{statCd}
		</if>
		<if test="shftId != null and shftId != ''">
			AND A.SHFT_ID 										= #{shftId}
		</if>
		<if test="locId != null and locId != ''">
			AND B.LOC_ID 										= #{locId}
		</if>
		<if test="saAgent != null and saAgent != ''">
			AND EXISTS (
				SELECT 
					USER_ID 
				FROM 
					TMT_PTNR_USER 
				WHERE 
					PTNR_TYPE 			= 'SHA' 
					AND PTNR_CODE 		= #{saAgent}
					AND USER_ID 		= A.SUMIT_BY
			)
		</if>
		<if test="fwAgent != null and fwAgent != ''">
			AND EXISTS (
				SELECT 
					USER_ID 
				FROM 
					TMT_PTNR_USER 
				WHERE 
					PTNR_TYPE 			= 'FWD' 
					AND PTNR_CODE 		= #{fwAgent}
					AND USER_ID 		= A.SUMIT_BY
			)
		</if>
	</sql>
	
	<sql id="sqlAlertInternalMegaCondition">
		<if test="alertYn eq 'Y'.toString()">
			AND ISNULL(B.WH_QTY, 0) 							= 0
			AND DATEDIFF(DAY, SYSDATETIME(), CONVERT(DATE, A.WORK_YMD, 112)) 	&lt;= 180
		</if>
	</sql>
	
	<select id="selectInternalMegaList" parameterType="megaParm" resultType="megaItem">
		<if test="pageNo != 0"> 
			SELECT /* mega.selectInternalMegaList */
					*
				FROM 
					(SELECT 
						ROW_NUMBER() OVER(ORDER BY MEGANO DESC) AS ROW_NUM,
						innerTable.*
					FROM ( 
		</if>
				<include refid="getInternalMegaList"/>
		<if test="pageNo != 0"> 
				) AS innerTable 
			) AS innerTable
			WHERE 
				innerTable.ROW_NUM 		<![CDATA[>]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT) - 1) 	* CAST(#{sizePerPage} AS INT)  
		  		AND	innerTable.ROW_NUM 	<![CDATA[<=]]> 	(CAST((CASE WHEN #{pageNo} = '0' THEN '1' ELSE #{pageNo} END) AS INT)) 		* CAST(#{sizePerPage} AS INT)
		</if>
	</select>
	
	<select id="selectInternalMegaListCount"  parameterType="megaParm" resultType="java.lang.String">
		SELECT /* mega.selectInternalMegaList */
			COUNT(*)
		FROM 
			(<include refid="getInternalMegaList"/>) 			AS TEMPTB
	</select>
	
	<sql id="getInternalMegaList">
		<include refid="sqlInternalMega"/>
			A.VSL_CALL_ID                                  		AS VSLCALLID,
			D.VSL_NM                                       		AS VSLNM
		FROM 
			TMT_MEGA A, 
			TMT_MEGA_DTL B, 
			TMT_VSL_SCH C, 
			TMT_VSL_PART D
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			AND A.VSL_CALL_ID 									= C.VSL_CALL_ID
			AND A.VSL_CALL_ID 									&lt;&gt; 'STRG'
			AND C.VSL_CD 										= D.VSL_CD
			<include refid="sqlInternalMegaParm"/>
			<include refid="sqlAlertInternalMegaCondition"/>
		UNION
		<include refid="sqlInternalMega"/>
			'-'                                            		AS VSLCALLID,
			' '                                            		AS VSLNM
		FROM 
			TMT_MEGA A, 
			TMT_MEGA_DTL B
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			AND A.VSL_CALL_ID 									= 'STRG'
			<include refid="sqlInternalMegaParm"/>
			<include refid="sqlAlertInternalMegaCondition"/>
	</sql>
	
	<select id="selectMegaCgDtlList"  parameterType="megaParm" resultType="megaItem">
		SELECT /* mega.selectMegaCgDtlList */
			A.MEGA_NO                      						AS MEGANO,
			A.SEQ                          						AS SEQ,
			A.HATCH_NO                     						AS HATCHNO, 
			A.CG_DESC                      						AS CGDESCCD,
			dbo.F_CM_CODE_NM('MT', 'CGDESC', A.CG_DESC) 		AS CGDESCNM,
			ISNULL(A.CG_DESC_VAL, ' ')        					AS CGDESCVAL
		FROM 
			TMT_MEGA_DTL 										A
		WHERE 
			A.MEGA_NO 											= #{megaNo}
			AND A.DIV_CD 										= 'CD' 
	</select>
	
	<select id="selectMaxMegaNo"  parameterType="megaParm" resultType="megaItem">
		SELECT /* mega.selectMaxMegaNo */
			dbo.F_GET_MEGA_NO() 								AS MEGANO, 
			(SELECT TOP(1)
				S_CD_LGV 
			FROM 
				TMT_CD_MSTD 
			WHERE 
				L_CD					= 'MT' 
				AND M_CD				= 'MGPURP' 
				AND S_CD				= #{purpTpCd}) 			AS PURPTYPE
	</select>
	
	<select id="selectMaxSeqNo"  parameterType="megaParm" resultType="megaItem">
		SELECT /* mega.selectMaxSeqNo */
			ISNULL(MAX(SEQ), 0) + 1 							AS SEQ 
		FROM 
			TMT_MEGA_DTL 
		WHERE
			 MEGA_NO 											= #{megaNo}
	</select>
	
	<sql id="sqlMegaComp">
		/* mega.sqlMegaComp */
		FROM 
			TMT_MEGA 											A, 
			TMT_MEGA_DTL 										B, 
			TMT_PTNR 											C
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			AND A.STAT_CD 										= 'AP'
			AND B.DIV_CD 										= 'SD'
			AND C.PTNR_TYPE 									= #{ptnrType} 
			<if test="megaCompCd != null and megaCompCd != ''">
				AND C.PTNR_CODE 								= #{megaCompCd}
			</if>
			<if test="megaCompNm != null and megaCompNm != ''">
				AND UPPER(C.ENG_SNM) 							LIKE UPPER('%${megaCompNm}%')
			</if>
	</sql>
	
	<select id="selectMegaComp"  parameterType="megaParm" resultType="megaItem">
		<if test='ptnrType == "STV"'>
			SELECT /* mega.selectMegaComp */
				B.STVD_COMP 									AS MEGACOMPCD, 
				C.ENG_SNM 										AS MEGACOMPNM
			<include refid="sqlMegaComp"/>
				AND B.STVD_COMP 								= C.PTNR_CODE
				AND (B.STVD_COMP IS NOT NULL					AND B.STVD_COMP <![CDATA[<>]]> '')
			GROUP BY 
				B.STVD_COMP, 
				C.ENG_SNM 
		</if>
		<if test='ptnrType == "TRM"'>
			SELECT /* mega.selectMegaComp */
			B.TRMG_COMP 										AS MEGACOMPCD, 
			C.ENG_SNM 											AS MEGACOMPNM
			<include refid="sqlMegaComp"/>
				AND B.TRMG_COMP 								= C.PTNR_CODE
				AND (B.TRMG_COMP IS NOT NULL					AND B.TRMG_COMP <![CDATA[<>]]> '')
			GROUP BY 
				B.TRMG_COMP, 
				C.ENG_SNM  
		</if>
	</select>
	
	<select id="selectCompanyInfo"  parameterType="megaParm" resultType="megaItem">
		SELECT DISTINCT /* mega.selectCompanyInfo */
			(SELECT 
				A.ACC_NO AS ACCNO 
			FROM 
				TMT_AGENCY_INFO 								A 
			WHERE 
				A.AGENCY_CODE = C.ARRV_SA_ID) 					AS ACCOUNTNO,
			(SELECT 
				A.ENG_SNM AS ENGSNM 
			FROM 
				TMT_AGENCY_INFO A 
			WHERE 
				A.AGENCY_CODE = C.ARRV_SA_ID) 					AS ENGNM,
			(SELECT 
				VSL_NM 
			FROM 
				TMT_VSL_PART 
			WHERE 
				VSL_CD = C.VSL_CD) 								AS VSLNM,
			ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) 			AS NO   
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B,
			TMT_VSL_SCH 										C
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO  
			AND B.VSL_CALL_ID 									= C.VSL_CALL_ID
			AND A.NOF_OPR_SPRR 									IS NOT NULL
			<if test="vslCallId != null and vslCallId != ''">
				AND B.VSL_CALL_ID 								= #{vslCallId}
			</if>
	</select>
	
	<select id="selectMegaReportForStevedore"  parameterType="megaParm" resultType="megaItem" >
		SELECT /* mega.selectMegaReportForStevedore */
			ROW_NUMBER() OVER(ORDER BY MEGANO, WORKYMD, SHFTNM) AS NO,
			*
		FROM
			(SELECT 
				A.MEGA_NO              								AS MEGANO,
				A.SEQ                  								AS VSEQ,
				CASE
					WHEN (A.REQ_QTY IS NULL OR A.REQ_QTY = '')
						THEN 0
					ELSE A.REQ_QTY 
				END 												AS reqQty,
				CASE 
					WHEN A.CONFM_QTY = NULL
						THEN 0
					ELSE A.CONFM_QTY
				END 												AS confmQty,
				CONVERT(
					INT,
					CASE
						WHEN (A.REQ_HHMM IS NOT NULL
							AND A.REQ_HHMM <![CDATA[<>]]> '')
								THEN SUBSTRING(A.REQ_HHMM, 1, 2)
						ELSE 0
					END
				) 													AS REQTIME,
				CONVERT(
					INT,
					CASE
						WHEN (A.REQ_HHMM IS NOT NULL
							AND A.REQ_HHMM <![CDATA[<>]]> '')
								THEN SUBSTRING(A.REQ_HHMM, 3, 2)
						ELSE 0
					END
				) 													AS REQMIN,
				A.SHIP_CLEW_YN         								AS SHIPCLEWYN, 
				ISNULL(A.STVD_COMP, '')            					AS STVDCOMP,         
				A.NOF_GANG             								AS NOFGANG,
				A.NOF_OPR_SPRR         								AS NOFOPRSPRR,
				A.NOF_OPR_CLERK        								AS NOFOPRCLERK,
				A.NOF_STVD_SPRR        								AS NOFSTVDSPRR,
				A.NOF_WCHMN            								AS NOFWCHMN,
				A.NOF_STVD_GWKER       								AS NOFSTVDGWKER,
				A.STVD_NON_TON         								AS STVDNONTON,
				A.TRMG_COMP            								AS TRMGCOMP,
				A.NOF_HATCH            								AS NOFHATCH,
				A.NOF_TRMG_SPRR        								AS NOFTRMGSPRR,
				A.NOF_SGLMN            								AS NOFSGLMN,
				A.NOF_DEKMN            								AS NOFDEKMN,
				A.NOF_HOPMN            								AS NOFHOPMN,
				A.NOF_TRMG_GWKER       								AS NOFTRMGGWKER,
				A.TRMG_NON_TON         								AS TRMGNONTON,
				A.LOC_ID               								AS LOCID,
				B.SHFT_ID              								AS SHFTID,
				B.SUMIT_BY              							AS submitBy,
				B.RMK 	                            				AS rmk,
				ISNULL(B.REJ_RMK,''  )                          	AS rejRmk,
				B.APPRV_BY                           				AS apprvBy,
				B.STAT_CD                            				AS statCd,
				(SELECT 
					SHFT_NM 
				FROM 
					TMT_SHFT 
				WHERE 
					SHFT_ID = B.SHFT_ID) 							AS SHFTNM,
				(SELECT 
					SHFT_IDX 
				FROM 
					TMT_SHFT 
				WHERE 
					SHFT_ID = B.SHFT_ID) 							AS SHFTIDX,
				B.PURP_TP_CD           PURPTPCD,
				dbo.F_CM_CODE_NM('MT', 'MGPURP', B.PURP_TP_CD) 		AS PURPTPCDNM,
				CONVERT(
						DATE, 
						FORMAT(CONVERT(DATE, B.WORK_YMD , 112), 
									'dd/MM/yyyy'),
						103) 										AS WORKYMD,
				dbo.F_CM_CODE_NM('MT', 'MEGASTAT', B.STAT_CD) 		AS STATCDNM,     
				(SELECT DISTINCT
					S_CD_LGV 
				FROM 
					TMT_CD_MSTD 
				WHERE 
					L_CD					= 'MT' 
					AND M_CD				= 'MGPURP' 
					AND S_CD				= B.PURP_TP_CD) 		AS PURPTYPE
			FROM 
				TMT_MEGA_DTL 										A, 
				TMT_MEGA 											B
			WHERE 
				A.MEGA_NO                      						= B.MEGA_NO  
				AND A.DIV_CD                      					= 'SD'
				<if test="vslCallId != null and vslCallId != ''">
					AND B.VSL_CALL_ID                      			= #{vslCallId}
				</if>
				<if test='vslCallId == "STRG"'>
					<if test="etaFrom != null and etaFrom != ''">
						AND CONVERT(DATE, B.WORK_YMD, 112) 			= CONVERT(DATE, #{etaFrom}, 103)
					</if>
				</if>
				<if test="megaList != null and !megaList.isEmpty">
					AND A.MEGA_NO IN
					<foreach item="item" index="index" collection="megaList" separator="," open="(" close=")">
						${item}
					</foreach>
				</if>
				<if test='ptnrType == "SHA"'>
					AND (B.SUMIT_BY LIKE  '%' + #{userId} + '%' 
						OR EXISTS (
							SELECT 
								'1'
							FROM 
								TMT_PTNR_USER 	C, 
								TMT_PTNR_USER 	D
							WHERE 
								C.USER_ID 		= B.SUMIT_BY
								AND C.PTNR_CODE = D.PTNR_CODE
								AND C.USER_ID 	= #{userId}
						)
					)
				</if>
				AND ((A.STVD_COMP IS NOT NULL	AND A.STVD_COMP <![CDATA[<>]]> '') 
					OR (A.LOC_ID IS NOT NULL	AND A.LOC_ID <![CDATA[<>]]> '') 
					OR A.NOF_GANG 				!= 0 
					OR A.NOF_STVD_SPRR 			!= 0 
					OR A.STVD_NON_TON 			!= 0)
			) AS TEMPTB
	</select>
	
	<insert id="insertMegaItems"  parameterType="megaItem">
		INSERT /* mega.insertMegaItems */
		INTO TMT_MEGA(
			SHIP_CALL_NO,
			MEGA_NO,
			PURP_TP_CD,
			WORK_YMD,
			SHFT_ID,
			STAT_CD,
			VSL_CALL_ID,
			CRT_BY,
			CRT_DT,
			SUMIT_BY,
			SUMIT_DT,
			WH_APPRV_YN,
			MEGA_WH_YN,
			MEGA_TP_CD,
			C_MEGA_NO,
			PAYER,
			RMK,
			PENALTY,
			UPDATE_TIME,
			STAFF_CD,
			VERSION,
			REQR
		) VALUES(
			#{scn},
			#{megaNo},
			#{purpTpCd},
			FORMAT(#{workYmd}, 'yyyyMMdd'),
			#{shftId},
			#{statCd},
			#{vslCallId},
			#{userId},
			SYSDATETIME(),
			<choose>
				<when test="statCd == 'SU' and (reqr == null or reqr == '')">
					#{userId},
					SYSDATETIME(),
				</when>
				<otherwise>
					UPPER(#{reqr}),
					SYSDATETIME(),
				</otherwise>
			</choose>
			#{whApprYn},
			#{megaWhYn},
			#{megaTpCd},
			#{copyMegaNo},
			(SELECT TOP(1) 
				PTNR_CODE 
			FROM 
				TMT_PTNR_USER 
			WHERE 
				USER_ID = #{reqr}),
			#{rmk},
			#{penaltyCd},
			SYSDATETIME(),
			#{userId},
			#{newVersion}
			<choose>
				<when test="statCd == 'SU' and (reqr == null or reqr == '')">
					,(SELECT TOP(1) 
						PTNR_CODE 
					FROM 
						TMT_PTNR_USER 
					WHERE 
						USER_ID = UPPER(#{userId}))
				</when>
				<otherwise>
					,(SELECT TOP(1) 
						PTNR_CODE 
					FROM 
						TMT_PTNR_USER 
					WHERE 
						USER_ID = UPPER(#{reqr}))
				</otherwise>
			</choose>
		)
	</insert>
	
	<insert id="insertMegaDetailItems"  parameterType="megaItem">
		INSERT /* mega.insertMegaDetailItems */
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			CMDT,
			CG_TP_CD,
			CG_TON,
		    SHIPG_NOTE_NOS,
		    DO_NOS,		
			LOC_DIV_CD,
			UPDATE_TIME,
			STAFF_CD
		) VALUES (
			#{megaNo},
			(SELECT ISNULL(MAX(SEQ), 0) + 1 FROM TMT_MEGA_DTL WHERE MEGA_NO = #{megaNo}),
			'VO',
			#{cmdt},
			#{cgTpCd},
			#{cgTon},
			#{shipgNoteNo},
			#{dono},
			#{locDivCd},
			SYSDATETIME(), 
			#{userId}
		)
	</insert>

	<insert id="insertMegaManPowerItems"  parameterType="megaItem">
		INSERT /* mega.insertMegaManpowerItems */
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			REQ_HHMM,
			SHIP_CLEW_YN,
			STVD_COMP,
			NOF_GANG,
			NOF_OPR_SPRR,
			NOF_OPR_CLERK,
			NOF_STVD_SPRR,
			NOF_WCHMN,
			NOF_STVD_GWKER,
			STVD_NON_TON,
			TRMG_COMP,
			NOF_HATCH,
			NOF_TRMG_SPRR,
			NOF_SGLMN,
			NOF_DEKMN,
			NOF_HOPMN,
			NOF_TRMG_GWKER,
			TRMG_NON_TON,
			LOC_ID,
			START_DATE,
			END_DATE,
			UPDATE_TIME,
			STAFF_CD
		) VALUES (
			#{megaNo}, 
			#{seq}, 
			#{divCd}, 
			RIGHT('00' + #{reqTime}, 2) + RIGHT('00' + #{reqMin}, 2), 
			#{shipClewYn},
			#{stvdComp}, 
			#{nofGang}, 
			#{nofOprSprr}, 
			#{nofOprClerk}, 
			#{nofStvdSprr}, 
			#{nofWchmn}, 
			#{nofStvdGwker}, 
			#{stvdNonTon}, 
			#{trmgComp}, 
			#{nofHatch}, 
			#{nofTrmgSprr}, 
			#{nofSglmn}, 
			#{nofDekmn}, 
			#{nofHopmn}, 
			#{nofTrmgGwker}, 
			#{trmgNonTon}, 
			#{locId},
			CONVERT(DATETIME, #{workStDt}, 103),
			CONVERT(DATETIME, #{workEndDt}, 103),
			SYSDATETIME(), 
			#{userId}
		)
	</insert>
	
	<insert id="insertMegaEquipmentItem"  parameterType="megaItem">
		INSERT /* mega.insertMegaEquipmentItem */
		INTO TMT_MEGA_DTL(
			MEGA_NO,
			SEQ,
			DIV_CD,
			EQ_DIV_CD,
			CAPA_CD,
			LOC_DIV_CD,
			LOC_ID,
			REQ_HHMM,
			REQ_QTY,
			CONFM_QTY,
			WH_CHG_YN,
			WH_QTY,
			OPE_COMP,
			FL_STATUS,
			UPDATE_TIME,
			STAFF_CD,
			START_DATE,
			END_DATE
		) VALUES (
			#{megaNo}, 
			#{seq}, 
			#{divCd}, 
			#{eqDivCd}, 
			#{capaCd}, 
			#{locDivCd}, 
			#{locId},
			#{dspReqhhmm}, 
			#{reqQty}, 
			#{confmQty},
			#{whChgYn}, 
			#{whQty}, 
			#{opeCompCd},
			#{flStatus}, 
			SYSDATETIME(), 
			#{userId}, 
			CONVERT(DATETIME, #{workStDt}, 103), 
			CONVERT(DATETIME, #{workEndDt}, 103)
		)
	</insert>

	<insert id="insertMegaOperItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaOperItems*/
		INTO TMT_MEGA_DTL_OPE(
			MEGA_NO,
			MEGA_IDX,
			SEQ,
			EQ_DIV_CD,
			CAPA_CD,
			OPE_DIV_CD,
			OPE_COMP,
			NOF_OPE,
			UPDATE_TIME,
			STAFF_CD,
			SUPPLY_QTY,
			RMK,
			NOF_GANG,
			NOF_STVD_SPRR, 
			NOF_WCHMN, 
			NOF_STVD_GWKER,
			NOF_TRMG_SPRR, 
			NOF_SGLMN, 
			NOF_DEKMN, 
			NOF_HOPMN
		) VALUES (
			#{megaNo}, 
			#{megaIdx}, 
			(SELECT 
				ISNULL(MAX(SEQ), 0) + 1 
			FROM 
				TMT_MEGA_DTL_OPE 
			WHERE 
				MEGA_NO = #{megaNo}),
			#{eqDivCd}, 
			#{capaCd}, 
			#{opeDivCd},
			#{opeCompCd}, 
			#{nofOpe}, 
			SYSDATETIME(), 
			#{userId},
			#{supplyQty},
			#{rmk},
			#{nofGang},
			#{nofStvdSprr},
			#{nofWchmn},
			#{nofStvdGwker},
			#{nofTrmgSprr},
			#{nofSglmn},
			#{nofDekmn},
			#{nofHopmn}
		)
	</insert>
	
	<update id="updateMegaItems"  parameterType="megaItem">
		UPDATE /* mega.updateMegaItems */
			TMT_MEGA 
		SET 
			<if test="statCd != null">
				STAT_CD  										= #{statCd},
			</if>
			<if test='statCd == "CR"'>
				WORK_YMD 										= FORMAT(#{workYmd}, 'yyyyMMdd'),
				SHFT_ID  										= #{shftId},
				SUMIT_BY 										= #{userId},
				SUMIT_DT 										= SYSDATETIME(),
			</if>
			<if test='rejYn == "N"'>
				<if test='statCd == "SU"'>
					<if test="amdBy == null">
						WORK_YMD 								= FORMAT(#{workYmd}, 'yyyyMMdd'),
						SHFT_ID  								= #{shftId},
						SUMIT_BY 								= #{userId},
						SUMIT_DT 								= SYSDATETIME(),
					</if>
				</if>
			</if>
			<if test='statCd == "CA"'>
				CNCL_BY 										= #{userId},
				CNCL_DT 										= SYSDATETIME(),
			</if>
			<if test='statCd == "AP"'>
				APPRV_BY 										= #{userId},
				APPRV_DT 										= SYSDATETIME(),
			</if>
			<if test='statCd == "RJ"'>
				REJ_BY   										= #{userId},
				REJ_DT   										= SYSDATETIME(),
			</if>
			<if test="rmk != null">
				RMK      										= #{rmk},
			</if>
			<if test="rejRmk != null">
				REJ_RMK  										= #{rejRmk},
			</if>
			<if test="penaltyCd != null">
				<if test="penaltyCd != null and penaltyCd != ''" >
					PENALTY  									= #{penaltyCd},
				</if>
			</if>
			UPDATE_TIME   										= SYSDATETIME(),
			STAFF_CD 											= #{userId},
			VERSION 											= #{newVersion}
		WHERE 
			MEGA_NO 											= #{megaNo}
		<if test="version != null and version != ''">
			AND VERSION 										= #{version} 
	   </if>
	</update>
			
	<update id="updateMegaDetailItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaDetailItems*/
			TMT_MEGA_DTL 
		SET 
			CMDT        										= #{cmdt},
			CG_TP_CD    										= #{cgTpCd},
			CG_TON      										= #{cgTon},
			SHIPG_NOTE_NOS 										= #{shipgNoteNo},
			DO_NOS      										= #{dono},
			LOC_DIV_CD  										= #{locDivCd},
			UPDATE_TIME      									= SYSDATETIME(),
			STAFF_CD 											= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND DIV_CD 											= 'VO'
	</update>

	<update id="updateMegaManPowerItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaStevedoreItems*/
			TMT_MEGA_DTL 
		SET 
			REQ_HHMM        									= RIGHT('00' + #{reqTime}, 2) + RIGHT('00' + #{reqMin}, 2), 
			SHIP_CLEW_YN    									= #{shipClewYn},
			STVD_COMP       									= #{stvdComp},
			NOF_GANG        									= #{nofGang},
			NOF_OPR_SPRR    									= #{nofOprSprr},
			NOF_OPR_CLERK   									= #{nofOprClerk},
			NOF_STVD_SPRR   									= #{nofStvdSprr},
			NOF_WCHMN       									= #{nofWchmn},
			NOF_STVD_GWKER  									= #{nofStvdGwker},
			STVD_NON_TON    									= #{stvdNonTon},
			TRMG_COMP       									= #{trmgComp},
			NOF_HATCH       									= #{nofHatch},
			NOF_TRMG_SPRR   									= #{nofTrmgSprr},
			NOF_SGLMN       									= #{nofSglmn},
			NOF_DEKMN       									= #{nofDekmn},
			NOF_HOPMN       									= #{nofHopmn},
			NOF_TRMG_GWKER  									= #{nofTrmgGwker},
			TRMG_NON_TON    									= #{trmgNonTon},
			LOC_ID          									= #{locId},
			START_DATE											= CONVERT(DATETIME, #{workStDt}, 103),
			END_DATE											= CONVERT(DATETIME, #{workEndDt}, 103),
			UPDATE_TIME     									= SYSDATETIME(),
			STAFF_CD     										= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND SEQ 											= #{seq}
			AND DIV_CD 											= #{divCd}
	</update>
		
	<update id="updateMegaEquipmentItem"  parameterType="megaItem">
		UPDATE /*mega.updateMegaEquipmentItem*/
			TMT_MEGA_DTL 
		SET 
			EQ_DIV_CD      										= #{eqDivCd},
			CAPA_CD        										= #{capaCd},
			LOC_DIV_CD     										= #{locDivCd},
			LOC_ID         										= #{locId},
			REQ_HHMM       										= #{dspReqhhmm},
			REQ_QTY        										= #{reqQty},
			CONFM_QTY      										= #{confmQty},
			WH_CHG_YN      										= #{whChgYn},
			WH_QTY         										= #{whQty},
			OPE_COMP       										= #{opeCompCd},
			UPDATE_TIME     									= SYSDATETIME(),
			STAFF_CD     										= #{userId},
			FL_STATUS      										= #{flStatus},
			START_DATE 											= CONVERT(DATETIME, #{workStDt}, 103),
			END_DATE 											= CONVERT(DATETIME, #{workEndDt}, 103)
		WHERE 
			MEGA_NO												= #{megaNo}
			AND DIV_CD 											= #{divCd}
			AND SEQ 											= #{seq}
	</update>

	<update id="updateMegaOperItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaOperItems*/
			TMT_MEGA_DTL_OPE 
		SET 
			<if test="eqDivCd != null and eqDivCd != ''">
				EQ_DIV_CD       									= #{eqDivCd},
			</if>
			<if test="capaCd != null and capaCd != ''">
				CAPA_CD         									= #{capaCd},
			</if>
			<if test="opeDivCd != null and opeDivCd != ''">
				OPE_DIV_CD      									= #{opeDivCd},
			</if>
			<if test="opeCompCd != null and opeCompCd != ''">
				OPE_COMP        									= #{opeCompCd},
			</if>
			<if test="fileYn != null and fileYn != ''">
				FILE_YN												= #{fileYn},
			</if>
			<if test="voucherNo != null and voucherNo != ''">
				VOUCHER_NO											= #{voucherNo},
			</if>
			RMK													= #{denyRmk},
			NOF_OPE         									= #{nofOpe},
			SUPPLY_QTY											= #{supplyQty},
			UPDATE_TIME     									= SYSDATETIME(),
			STAFF_CD     										= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND MEGA_IDX 										= #{megaIdx}
			AND SEQ 											= #{seq}
	</update>
		
	<update id="updateMegaInternalEquipmentItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaInternalEquipmentItems*/
			TMT_MEGA_DTL 
		SET 
			CONFM_QTY       									= #{confmQty},
			WH_CHG_YN       									= #{whChgYn},
			WH_QTY          									= #{whQty},
			UPDATE_TIME          								= SYSDATETIME(),
			STAFF_CD     										= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND SEQ 											= #{seq}
	</update>
	
	<update id="updateMegaHistoryMasterItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaHistoryMasterItems*/
			TMT_MEGA 
		SET  
			UPDATE_TIME  										= SYSDATETIME(),
			STAFF_CD     										= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
	</update>
	
	<sql id="sqlUpdateMegaInternal">
		(SELECT /* mega.sqlUpdateMegaInternal */
			COUNT(B.MEGA_NO)
		FROM 
			TMT_MEGA 											A, 
			TMT_MEGA_DTL 										B
		WHERE 
			A.STAT_CD 											IN ('SU','RV')
			AND A.PURP_TP_CD IN (
				SELECT 
					S_CD 
				FROM 
					TMT_CD_MSTD 
				WHERE 
					L_CD				= 'MT' 
					AND M_CD			= 'MGPURP'
					AND S_CD_LGV 		IN ('MP')
			)
			AND A.MEGA_NO 										= B.MEGA_NO
			AND B.DIV_CD 										= 'EQ'
			AND (B.EQ_DIV_CD 			= 'FL' 
				OR B.EQ_DIV_CD 			NOT IN ('GR', 'FL', 
												'TR', 'BG',
												'CU', 'LL',
												'PC', 'TX',
												'SR')
				)
			AND B.MEGA_NO 										= #{megaNo}
			AND ISNULL(B.WH_QTY, 0) 							= 0
		)
	</sql>
	
	<update id="updateMegaInternalMasterItems" parameterType="megaItem">
		UPDATE /*mega.updateMegaInternalMasterItems*/
			TMT_MEGA 
		SET 
			UPDATE_TIME          								= SYSDATETIME(),
			STAFF_CD     										= #{staffCd},
			VERSION         									= #{newVersion},
			STAT_CD 											= 	CASE <include refid="sqlUpdateMegaInternal"/>
																		WHEN 0 THEN 'AP'
																		ELSE 'RV'
																	END,

			MEGA_WH_YN 											= 	CASE <include refid="sqlUpdateMegaInternal"/>
																		WHEN 0 THEN 'Y'
																		ELSE ''
																	END,
			<!--s-PL-017 MEGA list  Additional Columns Attributes -->
			WH_CONFM_DT											= SYSDATETIME(),
			WH_CONFM_BY											= #{whConfmBy}
			<!--e-PL-017 MEGA list  Additional Columns Attributes -->
		WHERE 
			MEGA_NO 											= #{megaNo}
	</update>

	<update id="updateCargoTonItems" parameterType="megaItem">
		UPDATE /*mega.updateCargoTonItems*/
			TMT_MEGA_DTL
		SET 
			CG_TON = (
				SELECT 
					SUM(CONVERT(FLOAT, CG_DESC_VAL)) 
				FROM 
					TMT_MEGA_DTL TMD
				WHERE 
					TMD.MEGA_NO 			= MEGA_NO 
					AND TMD.DIV_CD 			= 'CD'
					AND TMD.CG_DESC 		IN ('DCG', 'LCG')
			),
			UPDATE_TIME      									= SYSDATETIME(),
			STAFF_CD 											= #{userId}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND DIV_CD 											= 'VO'
	</update>
	
	<delete id="deleteMegaItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaItems*/
		FROM 
			TMT_MEGA
		WHERE 
			MEGA_NO 											= #{megaNo}
		<if test="version != null and version != ''">
			AND VERSION 										= #{version} 
		</if>
	</delete>
	
	<delete id="deleteMegaDetailItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaDetailItems*/
		FROM 	
			TMT_MEGA_DTL
		WHERE 
			MEGA_NO 											= #{megaNo}
	</delete>
	
	<delete id="deleteMegaDtlOperItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaDtlOperItems*/
		FROM 
			TMT_MEGA_DTL_OPE
		WHERE 
			MEGA_NO 											= #{megaNo}
	</delete>
		
	<delete id="deleteMegaEquipmentItem"  parameterType="megaItem">
		DELETE /*mega.deleteMegaEquipmentItem*/
		FROM 
			TMT_MEGA_DTL
		WHERE 
			MEGA_NO 											= #{megaNo} 
			AND DIV_CD 											= #{divCd}
			AND SEQ 											= #{seq}
	</delete>
	
	<delete id="deleteMegaManpowerItem"  parameterType="megaItem">
		DELETE /*mega.deleteMegaManpowerItem*/
		FROM 
			TMT_MEGA_DTL
		WHERE 
			MEGA_NO 											= #{megaNo} 
			AND DIV_CD 											= #{divCd}
			AND SEQ 											= #{seq}
	</delete>
	
	<delete id="deleteMegaFlOperItem"  parameterType="megaItem">
		DELETE /*mega.deleteMegaFlOperItem*/
		FROM 
			TMT_MEGA_DTL_OPE
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND MEGA_IDX 										= #{seq}
			AND EQ_DIV_CD 										= #{eqDivCd}
	</delete>
	
	<delete id="deleteMegaOperItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaOperItems*/
		FROM 
			TMT_MEGA_DTL_OPE
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND MEGA_IDX 										= #{megaIdx}
			AND SEQ 											= #{seq}
	</delete>

	<delete id="deleteMegaCgDtlItems"  parameterType="megaItem">
		DELETE /*mega.deleteMegaCgDtlItems*/
		FROM 
			TMT_MEGA_DTL
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND HATCH_NO 										= #{hatchNo}
			AND CG_DESC 										= #{cgDescCd}
	</delete>	
	
	<select id="selectOldPenaltyCd"  parameterType="megaParm" resultType="megaItem">
		SELECT /*mega.selectOldPenaltyCd*/
			MEGA_NO 											AS MEGANO, 
			PENALTY 											AS oldPenaltyCd
		FROM 
			TMT_MEGA
		WHERE 
			MEGA_NO 											= #{megaNo}
	</select>   
	
	<sql id="sqlMegaDtlRpt4EQ">
		SELECT /* mega.sqlMegaDtlRpt4EQ */
        	A.MEGA_NO 											AS megaNo,
	        FORMAT(
				CONVERT(DATE, B.WORK_YMD, 112), 
				'dd/MM/yyyy') 									AS workYmd,
	        B.SHFT_ID 											AS shftId,
	        (SELECT 
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = B.SHFT_ID) 							AS shftNm,
	        B.PURP_TP_CD 										AS purpTpCd,
	        dbo.F_CM_CODE_NM ('MT', 'MGPURP', B.PURP_TP_CD) 	AS purpTpCdNm,
	        B.STAT_CD 											AS statCd,
	        dbo.F_CM_CODE_NM ('MT', 'MEGASTAT', B.STAT_CD) 		AS statCdNm,
	        <if test='vslCallId != "STRG"'>
		    	B.VSL_CALL_ID 									AS vslCallId,
		        (SELECT 
					VSL_NM 
				FROM 
					TMT_VSL_PART 
				WHERE 
					VSL_CD = C.VSL_CD) 							AS vslNm,
	    	</if>
	    	<if test='vslCallId == "STRG"'>
		    	'STRG' 											AS vslCallId,
		        'STRG' 											AS vslNm,
	    	</if>
        	ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM)
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID 			= B.SUMIT_BY
			), B.SUMIT_BY) 										AS reqr,
        	ISNULL(
				(SELECT TOP(1)
					A1.ENG_SNM
				FROM 
					TMT_PTNR A1, 
					TMT_PTNR_USER B1
				WHERE     
					B1.USER_ID 			= B.SUMIT_BY
					AND A1.PTNR_CODE 	= B1.PTNR_CODE
			), B.SUMIT_BY) 										AS reqComp,
	        B.RMK 												AS rmk,
	        FORMAT(B.SUMIT_DT, 'dd/MM/yyyy HH:mm') 				AS reqDt,
			<!-- 
	        FORMAT(B.AMD_DT, 'dd/MM/yyyy HH:mm') 				AS amdDt,
	        B.AMD_BY 											AS amdBy,
			 -->
	        B.APPRV_BY 											AS appr,
	        FORMAT(B.APPRV_DT, 'dd/MM/yyyy HH:mm') 				AS appDt,
	        B.PENALTY penaltyCd,
        	ISNULL((SELECT S_CD_NM FROM TMT_CD_MSTD 
				WHERE M_CD ='PNTYTP' 
				AND S_CD = B.PENALTY
			), ' ') AS penaltyNm,
	        B.CNCL_BY cnclBy,
	        FORMAT(B.CNCL_DT, 'dd/MM/yyyy HH:mm') 				AS cnclDt,
	        B.REJ_BY 											AS rejBy,
	        FORMAT(B.REJ_DT, 'dd/MM/yyyy HH:mm') 				AS rejDt,
	        B.REJ_RMK 											AS rejRmk,
	        A.SEQ 												AS seq,
			A.DIV_CD 											AS divCd,
			A.EQ_DIV_CD 										AS eqDivCd,
			dbo.F_CM_CODE_NM ('MT', 'EQFCTPCD', A.EQ_DIV_CD) 	AS eqDivCdNm,
			ISNULL(A.CAPA_CD, ' ') 								AS capaCd, 													
			CASE A.EQ_DIV_CD
				WHEN 'SR' THEN '-'
				ELSE 
					(SELECT 
						CAPA_DESCR 
					FROM 
						TMT_EQ_CAPA 
					WHERE 
						CAPA_CD 		= A.CAPA_CD 
						AND EQ_TP_CD 	= A.EQ_DIV_CD)
			END 												AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2)			AS dspReqhhmm,
			CASE
				WHEN A.REQ_QTY = NULL 
					THEN ' '
				ELSE A.REQ_QTY
			END													AS  REQQTY,
			CASE 
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY
			END													AS CONFMQTY,
			CASE 
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY
			END													AS WHQTY,
			ISNULL(A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B
   		<if test='vslCallId != "STRG"'>
   			, TMT_VSL_SCH 										C
   		</if>
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			<if test='vslCallId != "STRG"'>
				AND B.VSL_CALL_ID 								= C.VSL_CALL_ID
			</if>
			AND A.DIV_CD 										= 'EQ'
			AND B.VSL_CALL_ID 									= #{vslCallId}
			<if test="megaStr != null and megaStr != ''">
				AND A.MEGA_NO 									= #{megaStr} 
			</if>
	</sql>
	
	<sql id="sqlMegaDtlRpt4SD">
		SELECT /* mega.sqlMegaDtlRpt4SD */
			A.MEGA_NO 											AS megaNo,
			FORMAT(
				CONVERT(DATE, B.WORK_YMD, 112), 
				'dd/MM/yyyy') 									AS workYmd,
			B.SHFT_ID shftId,
			(SELECT 
				SHFT_NM 
			FROM 
				TMT_SHFT 
			WHERE 
				SHFT_ID = B.SHFT_ID) 							AS shftNm,
			B.PURP_TP_CD 										AS purpTpCd,
			dbo.F_CM_CODE_NM ('MT', 'MGPURP', B.PURP_TP_CD) 	AS purpTpCdNm,
			B.STAT_CD 											AS statCd,
			dbo.F_CM_CODE_NM ('MT', 'MEGASTAT', B.STAT_CD) 		AS statCdNm,
			<if test='vslCallId != "STRG"'>
				B.VSL_CALL_ID 									AS vslCallId,
				(SELECT 
					VSL_NM 
				FROM 
					TMT_VSL_PART 
				WHERE 
					VSL_CD = C.VSL_CD) 							AS vslNm,
			</if>
			<if test='vslCallId == "STRG"'>
				'STRG' 											AS vslCallId,
				'STRG' 											AS vslNm,
			</if>
			ISNULL(
				(SELECT 
					(USER_ID + '/' + ENG_NM)
				FROM 
					TMT_USER_INFO
				WHERE 
					USER_ID = B.SUMIT_BY
			), B.SUMIT_BY) 										AS reqr,
			ISNULL(
				(SELECT TOP(1)
					A1.ENG_SNM
				FROM 
					TMT_PTNR 			A1, 
					TMT_PTNR_USER 		B1
				WHERE 
					B1.USER_ID = B.SUMIT_BY
		        	AND A1.PTNR_CODE = B1.PTNR_CODE
			), B.SUMIT_BY) 										AS reqComp,
			B.RMK 												AS rmk,
			FORMAT(B.SUMIT_DT, 'dd/MM/yyyy HH:mm') 				AS reqDt,
			<!-- 
			FORMAT(B.AMD_DT, 'dd/MM/yyyy HH:mm') 				AS amdDt,
			B.AMD_BY 											AS amdBy,
			 -->
			B.APPRV_BY 											AS appr,
			FORMAT(B.APPRV_DT, 'dd/MM/yyyy HH:mm') 				AS appDt,
			B.PENALTY 											AS penaltyCd,
			ISNULL(
				(SELECT 
					S_CD_NM 
				FROM 
					TMT_CD_MSTD 
				WHERE 
					M_CD 				='PNTYTP' 
					AND S_CD 			= B.PENALTY
			), ' ') 											AS penaltyNm,
			B.CNCL_BY 											AS cnclBy,
			FORMAT(B.CNCL_DT, 'dd/MM/yyyy HH:mm')  				AS cnclDt,
			B.REJ_BY 											AS rejBy,
			FORMAT(B.REJ_DT, 'dd/MM/yyyy HH:mm') 				AS rejDt,
			B.REJ_RMK 											AS rejRmk,
			A.SEQ 												AS seq,
			A.DIV_CD 											AS divCd
			, A.EQ_DIV_CD 										AS eqDivCd
	</sql>
	
	<select id="selectMegaDtlRpt" parameterType="megaParm" resultType="megaItem">
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD 										= 'FL'

		UNION ALL
		
		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD 										= 'TR'

		UNION ALL

		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD 										= 'GR'

		UNION ALL

		<include refid="sqlMegaDtlRpt4EQ" />
		AND A.EQ_DIV_CD 										NOT IN ('GR', 'FL', 'TR', 'BG', 'CU', 'LL', 'PC', 'TX', 'SR')

        UNION ALL

        <include refid="sqlMegaDtlRpt4EQ" />
		AND (A.EQ_DIV_CD = 'SR' 
			OR EXISTS (
				SELECT 
					S_CD 
				FROM 
					TMT_CD_MSTD
				WHERE 
					L_CD 				= 'MT' 
					AND M_CD 			= 'EQFCTPCD'
					AND S_CD 			= A.EQ_DIV_CD
					AND S_CD_VAL 		= 'PC'
			)
		)      

        UNION ALL

        <include refid="sqlMegaDtlRpt4SD" />
			,'STEVEDORE' 										AS eqDivCdNm,
			ISNULL(A.CAPA_CD, ' ') 								AS capaCd,
			A.STVD_COMP 										AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS dspReqhhmm,
			CONVERT(VARCHAR, A.NOF_GANG) 						AS REQQTY,
			CASE
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY 
			END 												AS CONFMQTY,
			CASE 
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY
			END													AS WHQTY,
			ISNULL(A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS
		FROM 
			TMT_MEGA_DTL										A, 
			TMT_MEGA											B
		<if test='vslCallId != "STRG"'>
			,TMT_VSL_SCH 										C
		</if>
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			<if test='vslCallId != "STRG"'>
				AND B.VSL_CALL_ID 								= C.VSL_CALL_ID
			</if>
			AND A.DIV_CD 										= 'SD'
			AND B.VSL_CALL_ID 									= #{vslCallId}
			<if test="megaStr != null and megaStr != ''">
				AND A.MEGA_NO 									= #{megaStr} 
			</if>
			AND (A.NOF_OPR_SPRR IS NOT NULL)
			AND ((A.STVD_COMP 	IS NOT NULL	AND A.STVD_COMP 	<![CDATA[<>]]> '')
				OR (A.LOC_ID 	IS NOT NULL	AND A.LOC_ID 		<![CDATA[<>]]> '')
				OR A.NOF_GANG 									!= 0
				OR A.NOF_STVD_SPRR 								!= 0
				OR A.STVD_NON_TON 								!= 0
			)

		UNION ALL

		<include refid="sqlMegaDtlRpt4SD" />
			, 'STEVEDORE' 										AS eqDivCdNm
			ISNULL (A.CAPA_CD, ' ') 							AS capaCd,
			'ADDITIONAL SUPERVISOR' 							AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2)		 	AS dspReqhhmm,
			CONVERT(VARCHAR, A.NOF_STVD_SPRR) 					AS REQQTY,
			CASE
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY 
			END 												AS CONFMQTY,
			CASE
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY 
			END 												AS WH_QTY,
			ISNULL (A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS,
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B
   		<if test='vslCallId != "STRG"'>
   			, TMT_VSL_SCH 										C
   		</if>
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			<if test='vslCallId != "STRG"'>
				AND B.VSL_CALL_ID 								= C.VSL_CALL_ID
			</if>
			AND A.DIV_CD 										= 'SD'
			AND B.VSL_CALL_ID 									= #{vslCallId}
			<if test="megaStr != null and megaStr != ''">
				AND A.MEGA_NO 									= #{megaStr} 
			</if>
			AND (A.NOF_OPR_SPRR IS NOT NULL)
			AND ((A.STVD_COMP IS NOT NULL 	AND A.STVD_COMP <![CDATA[<>]]> '')
				OR (A.LOC_ID  IS NOT NULL 	AND A.LOC_ID 	<![CDATA[<>]]> '')
				OR A.NOF_GANG 				!= 0
				OR A.NOF_STVD_SPRR 			!= 0
				OR A.STVD_NON_TON 			!= 0
			)
			AND A.NOF_STVD_SPRR 								!= 0
		
		UNION ALL
        
		<include refid="sqlMegaDtlRpt4SD" />
			,'STEVEDORE' 										AS eqDivCdNm,
			ISNULL(A.CAPA_CD, ' ') 								AS capaCd,
			'ADDITIONAL NON TONNAGE' 							AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS dspReqhhmm,
			CONVERT(VARCHAR, A.STVD_NON_TON) 					AS REQQTY,
			CASE
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY 
			END 												AS CONFMQTY,
			CASE
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY 
			END 												AS WHQTY,
			ISNULL(A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B
  		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH 										C
   		</if>
		WHERE     
			A.MEGA_NO 											= B.MEGA_NO
			<if test='vslCallId != "STRG"'>
				AND B.VSL_CALL_ID 								= C.VSL_CALL_ID
			</if>
			AND A.DIV_CD 										= 'SD'
			AND B.VSL_CALL_ID 									= #{vslCallId}
			<if test="megaStr != null and megaStr != ''">
				AND A.MEGA_NO 									= #{megaStr} 
			</if>
			AND (A.NOF_OPR_SPRR IS NOT NULL)
			AND ((A.STVD_COMP 	IS NOT NULL	AND A.STVD_COMP		<![CDATA[<>]]> '')
				OR (A.LOC_ID 	IS NOT NULL	AND A.LOC_ID 		<![CDATA[<>]]> '')
				OR A.NOF_GANG 									!= 0
				OR A.NOF_STVD_SPRR 								!= 0
				OR A.STVD_NON_TON 								!= 0
			)
			AND A.STVD_NON_TON 									!= 0

        UNION ALL

        <include refid="sqlMegaDtlRpt4SD" />
			,'TALLY' 											AS eqDivCdNm,
			ISNULL (A.CAPA_CD, ' ') 							AS capaCd,
			A.STVD_COMP 										AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS dspReqhhmm,
			CONVERT(VARCHAR, A.STVD_NON_TON) 					AS REQQTY,
			CASE
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY 
			END 												AS CONFMQTY,
			CASE
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY 
			END 												AS WHQTY,
			ISNULL (A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA 											B
   		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH 										C
   		</if>
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
		<if test='vslCallId != "STRG"'>
    		AND B.VSL_CALL_ID 									= C.VSL_CALL_ID
		</if>
			AND A.DIV_CD 										= 'SD'
		<!-- AND ISNULL(A.TALLY_YN, 'N') 						= 'Y'  -->
			AND B.VSL_CALL_ID 									= #{vslCallId}
		<if test="megaStr != null and megaStr != ''">
			AND A.MEGA_NO 										= #{megaStr} 
		</if>

		UNION ALL

        <include refid="sqlMegaDtlRpt4SD" />
			,'LASHING/UNLASHING/CHOKING' 						AS eqDivCdNm,
			ISNULL (A.CAPA_CD, ' ')  							AS capaCd,
			A.STVD_COMP 										AS capaDescr,
			LEFT(A.REQ_HHMM, 2) + RIGHT(A.REQ_HHMM, 2) 			AS dspReqhhmm,
			CONVERT(VARCHAR, A.NOF_GANG) 						AS REQQTY,
			CASE
				WHEN A.CONFM_QTY = NULL
					THEN ' '
				ELSE A.CONFM_QTY 
			END 												AS CONFMQTY,
			CASE
				WHEN A.WH_QTY = NULL
					THEN ' '
				ELSE A.WH_QTY 
			END 												AS WHQTY,
			ISNULL (A.LOC_ID, ' ') 								AS LOCID,
			CASE A.FL_STATUS
				WHEN 'Y' THEN 'YES'
				WHEN 'N' THEN 'NO'
			END 												AS FLSTATUS
		FROM 
			TMT_MEGA_DTL 										A, 
			TMT_MEGA											B
   		<if test='vslCallId != "STRG"'>
    		, TMT_VSL_SCH 										C
   		</if>
		WHERE 
			A.MEGA_NO 											= B.MEGA_NO
			<if test='vslCallId != "STRG"'>
				AND B.VSL_CALL_ID 								= C.VSL_CALL_ID
			</if>
			AND A.DIV_CD 										= 'SD'
			<!-- AND ISNULL(A.LASHING_YN, 'N') 					= 'Y' -->
			AND B.VSL_CALL_ID 									= #{vslCallId}
			<if test="megaStr != null and megaStr != ''">
				AND A.MEGA_NO 									= #{megaStr} 
			</if>
	</select>
	
	<select id="selectValidationCode" parameterType="megaParm" resultType="megaItem">
		<if test='tyCd == "checkMegaPayer"'>
			SELECT /* mega.selectValidationCode.checkMegaPayer */
				CASE US.USER_TYPE
					WHEN 'E' 
						THEN	
							(SELECT 
								CASE COUNT(*)
									WHEN 0 THEN 'N'
									ELSE 'Y'
								END
							FROM 
								TMT_PTNR_USER 
							WHERE 
								USER_ID = US.USER_ID)
					ELSE 'Y'
				END 											AS ISVALIDATED 
			FROM 
				TMT_USER_INFO US
			WHERE 
				US.USER_ID 										= #{userId} 
		</if>
		<if test='tyCd == "checkShipgAgent"'>
			SELECT /* mega.selectValidationCode.checkShipgAgent */ 
				CASE US.USER_TYPE
					WHEN 'E'
						THEN
							CASE 
								(SELECT 
									CASE COUNT(*)
										WHEN 0 THEN 'N'
										ELSE 'Y'
									END
								FROM 
									TMT_PTNR_USER 
								WHERE 
									PTNR_TYPE 	IN ( 'FWD' , 'CNS' )
									AND USER_ID = US.USER_ID)
								WHEN 'N'
									THEN 
										(SELECT 
											CASE COUNT(*)
												WHEN 0 THEN 'N'
												ELSE 'Y'
											END 
										FROM 
											TMT_VSL_SCH SH
										WHERE 
											VSL_CALL_ID = #{vslCallId}
											AND EXISTS (
												SELECT 
													'1' 
												FROM 
													TMT_AGENCY_INFO 
												WHERE 
													PTNR_TYPE		= 'SHA' 
													AND USER_ID 	= US.USER_ID
													AND AGENCY_CODE = SH.ARRV_SA_ID
											)
										)
								ELSE 'Y'
							END
					ELSE 'Y'
				END 											AS ISVALIDATED 
			FROM 
				TMT_USER_INFO 									US
			WHERE 
				US.USER_ID 										= #{userId}
		</if>
		<if test='tyCd == "createDocument"'>
			<if test="vslCallId != null and vslCallId != ''">
				<if test='cgTpCd == "CTR"'>
					SELECT /* mega.selectValidationCode.createDocument.CTR */
						CASE 
							WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 
								THEN
									CASE 
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME())
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
												)
											, 0) / 24) 
												THEN 'Y'
										ELSE 'N'
									END
             			ELSE 
             				CASE
                				WHEN 
									(SELECT TOP(1)
										KEY_VAL
                        			FROM 
										TMT_CFG_DTL
                       				WHERE 
										SYS_CD 		= 'MPTS'
										AND KEY_NM 	= #{cgTpCd}
									) = 0 THEN 'Y'
								ELSE 'N'
							END
             			END 									AS isValidated
                    FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "DBE"'>
					SELECT /* mega.selectValidationCode.createDocument.DBE*/
						CASE
          					WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME()) 
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
											), 0) / 24) 
												THEN 'Y'
										ELSE 'N'
									END
						ELSE
							CASE
				                WHEN 
									(SELECT TOP(1)
										KEY_VAL
									FROM 
										TMT_CFG_DTL
									WHERE 
										SYS_CD 		= 'MPTS'
										AND KEY_NM 	= #{cgTpCd}
									) = 0 THEN 'Y'
				                ELSE 'N'
							END
						END 									AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "DBN"'>
					SELECT /* mega.selectValidationCode.createDocument.DBN */
						CASE
          					WHEN DATEDIFF(SECOND, ETA, SYSDATETIME())  > 0 
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME()) 
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD = 'MPTS'
													AND KEY_NM = #{cgTpCd}
												)
											, 0) / 24) THEN 'Y'
										ELSE 'N'
									END
         					ELSE
             					CASE
                					WHEN 
										(SELECT TOP(1)
											KEY_VAL
                        				FROM 
											TMT_CFG_DTL
										WHERE
											SYS_CD 		= 'MPTS'
											AND KEY_NM 	= #{cgTpCd}
										) = 0 THEN 'Y'
                					ELSE 'N'
								END
             				END 								AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "BBK"'>
					SELECT /*mega.selectValidationCode.createDocument.BBK */
						CASE
							WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME())
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
												)
											, 0) / 24) THEN 'Y'
										ELSE 'N'
									END
						ELSE
             				CASE
								WHEN 
									(SELECT TOP(1)
										KEY_VAL
									FROM 
										TMT_CFG_DTL
									WHERE     
										SYS_CD = 'MPTS'
										AND KEY_NM = #{cgTpCd}
									) = 0 THEN 'Y'
								ELSE 'N'
							END
						END 									AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "LQE"'>
					SELECT /* mega.selectValidationCode.createDocument.LQE */
						CASE
          					WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME()) 
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
												)
											, 0) / 24) THEN 'Y'
										ELSE 'N'
									END
         					ELSE
            					CASE
									WHEN 
										(SELECT TOP(1)
											KEY_VAL
										FROM 
											TMT_CFG_DTL
										WHERE 
											SYS_CD 		= 'MPTS'
											AND KEY_NM 	= #{cgTpCd}
										) = 0 THEN 'Y'
									ELSE 'N'
                				END
            				END 								AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "LQN"'>
					SELECT /* mega.selectValidationCode.createDocument.LQN */
						CASE
							WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME()) 
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1) 
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
												)
											, 0) / 24) THEN 'Y'
										ELSE 'N'
									END
							ELSE
								CASE
									WHEN 
										(SELECT TOP(1)
											KEY_VAL
										FROM 
											TMT_CFG_DTL
										WHERE     
											SYS_CD 		= 'MPTS'
											AND KEY_NM 	= #{cgTpCd}
										) = 0 THEN 'Y'
									ELSE 'N'
								END
						END 									AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "OIMR"'>
					SELECT /* mega.selectValidationCode.createDocument.OIMR */
						CASE
							WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 
								THEN
									CASE
										WHEN 
											DATEDIFF(SECOND, ETA, SYSDATETIME()) 
											<![CDATA[>=]]> 
											(ISNULL(
												(SELECT TOP(1)
													KEY_VAL
												FROM 
													TMT_CFG_DTL
												WHERE 
													SYS_CD 		= 'MPTS'
													AND KEY_NM 	= #{cgTpCd}
												)
											, 0) / 24) THEN 'Y'
										ELSE 'N'
									END
							ELSE
							CASE
								WHEN 
									(SELECT TOP(1)
										KEY_VAL
									FROM 
										TMT_CFG_DTL
									WHERE     
										SYS_CD 		= 'MPTS'
										AND KEY_NM 	= #{cgTpCd}
									) = 0 THEN 'Y'
								ELSE 'N'
							END
						END 									AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
				<if test='ptnrCode == "BT"'>
					SELECT /* mega.selectValidationCode.createDocument.BT */
						CASE
							WHEN DATEDIFF(SECOND, ETA, SYSDATETIME()) > 0 THEN
								CASE
									WHEN 
										DATEDIFF(SECOND, ETA, SYSDATETIME()) 
										<![CDATA[>=]]> 
										(ISNULL(
											(SELECT TOP(1)
												KEY_VAL
											FROM 
												TMT_CFG_DTL
											WHERE 
												SYS_CD 		= 'MPTS'
												AND KEY_NM 	= #{cgTpCd}
											)
										, 0) / 24) THEN 'Y'
               						ELSE 'N'
           						END
         					ELSE
            					CASE
					                WHEN 
										(SELECT TOP(1) 
											KEY_VAL
				                        FROM 
											TMT_CFG_DTL
										WHERE 
											SYS_CD 		= 'MPTS'
											AND KEY_NM 	= #{cgTpCd}
										) = 0 THEN 'Y'
               						ELSE 'N'
                				END
							END 								AS isValidated
					FROM 
						TMT_VSL_SCH 
					WHERE 
						VSL_CALL_ID 							= #{vslCallId}
				</if>
			</if>
		</if>
		<if test='tyCd == "EXISTED_ACCOUNTNO_PTNR_VALIDATION"'>
			WITH 
				PTNR_INFO AS (
					SELECT  
						PTNR_CODE, 
						ACC_NO
					FROM    
						TMT_PTNR
					WHERE   
						PTNR_CODE 		= #{ptnrCode}
						AND (ACC_NO IS NOT NULL AND ACC_NO <![CDATA[<>]]> '')
					UNION
					SELECT  
						AGENCY_CODE 	AS PTNR_CODE, 
						ACC_NO
					FROM    
						TMT_AGENCY_INFO
					WHERE   
						AGENCY_CODE 	= #{ptnrCode}
						AND (ACC_NO IS NOT NULL AND ACC_NO <![CDATA[<>]]> '')
					)
			SELECT /* mega.selectValidationCode.EXISTED_ACCOUNTNO_PTNR_VALIDATION */
				CASE 
					WHEN COUNT(1) > 0 THEN 'Y' 
					ELSE 'N' 
				END 											AS isValidated
			FROM    
				PTNR_INFO
		</if>	
	</select>
	
	<select id="selectConfirmationSlipDryBreakBulk"  parameterType="megaParm" resultMap="ConfirmationSlipDetailMap"> 
		SELECT /* mega.selectConfirmationSlipDryBreakBulk */
			A.VSL_CALL_ID                          				AS VSLCALLID, 
			B.SEQ                                  				AS SEQ, 
			B.CG_TP_CD                             				AS CGTPCD, 
			ISNULL(B.OPE_TP_CD,' ')                   			AS OPETPCD,
			(SELECT 
				S_CD_NM 
			FROM 
				TMT_CD_MSTD 
			WHERE 
				L_CD					= 'MT' 
				AND M_CD				= 'CGTP' 
				AND S_CD				= B.CG_TP_CD) 			AS CGTPNM, 
			ISNULL(B.CMDT_CD,' ')                     			AS CMDTCD,
			ISNULL(
				(SELECT DISTINCT 
					D.CMDT_GRP_CD
				FROM 
					TMT_CMDT D
				WHERE 
					D.CMDT_CD 			= B.CMDT_CD)
			, ' ') 												AS CMDTGRCD,
			ISNULL(
				(SELECT DISTINCT 
					D.CMDT_GRP_DESC
				FROM 
					TMT_CMDT D
				WHERE 
					D.CMDT_CD 			= B.CMDT_CD)
			, ' ') 												AS CMDTGR,
			ISNULL(B.PKG_TP_CD,' ')					  			AS PKGTPCD,
			ISNULL(B.OPE_HR,0)                        			AS OPEHR, 
			ISNULL(B.WORK_DD,0)                       			AS WORKDD, 
			ISNULL(B.WORK_HATCH_NO,' ')               			AS WORKHATCHNO, 
			ISNULL(B.QTY,0)                           			AS QTY, 
			B.CLN_CD                               				AS CLNCD, 
			B.TOP_CG_CD                            				AS TOPCGCD, 
			(CASE 
				WHEN  B.CLN_CD = 'Y' 	THEN 'CLEAN' 
				WHEN  B.TOP_CG_CD ='Y' 	THEN 'TOP' 
				ELSE '' 
			END )						  		  				AS TOPCLN,
			B.TMNL_OPR                             				AS TMNLOPR, 
			B.SHPR_CNSNE                           				AS SHPRCNSNE, 
			B.CNSNE                           	  				AS CNSNE, 
			B.UNNO                                 				AS UNNO, 
			B.IMDG                                 				AS IMDG,
			B.POL	                              				AS POL, 
			B.FDEST                                				AS FDEST, 
			ISNULL(B.CRC,0)                           			AS CRC, 
			ISNULL(B.BL_NO,' ')                       			AS BLNO,
			B.CG_OPT_TP_CD                         				AS CGOPTTPCD,
			dbo.F_CM_CODE_NM('MT', 'CGOPETP', B.CG_OPT_TP_CD) 	AS CGOPTTPNM,
			B.DG_SEQ								 			AS DGSEQ,
			(CASE WHEN C.SEQ IS NULL THEN 'N'
					ELSE 'Y'
			END) 								  				AS DGCHK,
			OPE_CATEGORY                          				AS opeType,
			B.RMK 								  				AS remark,
			dbo.F_GET_PARTNER_INFO(B.CNSNE, 'ENG_SNM')			AS CNSNENM,
			dbo.F_GET_PARTNER_INFO(B.CNSNE, 'ADDR')				AS CNSNEADDR,
			dbo.F_GET_PARTNER_INFO(B.SHPR_CNSNE, 'ENG_SNM')		AS SHPNM,
			dbo.F_GET_PARTNER_INFO(B.SHPR_CNSNE, 'ADDR')		AS SHPADDR,
			dbo.F_CM_CODE_NM('MT', 'PKGTP', B.PKG_TP_CD) 		AS PKGTPNM
		FROM 
			TMT_CONFM_SLP 										A, 
			TMT_CONFM_SLP_DTL 									B
		LEFT OUTER JOIN
			TMT_DG 												C 
				ON B.DG_SEQ 									= C.SEQ
		WHERE 
			A.VSL_CALL_ID 										= B.VSL_CALL_ID
		   	AND A.VSL_CALL_ID 									= #{vslCallId}
		<if test="cargoType != 'LIQUID'">
			AND B.CG_TP_CD 										IN ('BBK','DBE','DBN', 'CTR')
		</if>
		<if test="cargoType == 'LIQUID'">
			AND B.CG_TP_CD 										IN ('LQE','LQN')
		</if>
	</select>
	
	<update id="updateMegaManpowerOprInfoItems"  parameterType="megaItem">
		UPDATE /*mega.updateMegaManpowerOprInfoItems*/
			TMT_MEGA_DTL_OPE 
		SET 
			EQ_DIV_CD       									= #{eqDivCd},
			CAPA_CD         									= #{capaCd},
			OPE_DIV_CD      									= #{opeDivCd},
			OPE_COMP        									= #{opeCompCd},
			NOF_OPE         									= #{nofOpe},
			UPDATE_TIME     									= SYSDATETIME(),
			STAFF_CD     										= #{userId},
			NOF_STVD_SPRR   									= #{nofStvdSprr},
			NOF_WCHMN       									= #{nofWchmn},
			NOF_STVD_GWKER  									= #{nofStvdGwker},
			NOF_TRMG_SPRR   									= #{nofTrmgSprr},
			NOF_SGLMN       									= #{nofSglmn},
			NOF_DEKMN  											= #{nofDekmn},
			NOF_HOPMN  											= #{nofHopmn}
		WHERE 
			MEGA_NO 											= #{megaNo}
			AND MEGA_IDX 										= #{megaIdx}
			AND SEQ 											= #{seq}
	</update>
	
	<insert id="insertMegaManpowerOprInfoItems"  parameterType="megaItem">
		INSERT /*mega.insertMegaOperItems*/
		INTO TMT_MEGA_DTL_OPE(
			MEGA_NO,
			MEGA_IDX,
			SEQ,
			OPE_DIV_CD,
			OPE_COMP, 
			NOF_GANG,
			NOF_STVD_SPRR, 
			NOF_WCHMN, 
			NOF_STVD_GWKER,
			NOF_TRMG_SPRR, 
			NOF_SGLMN, 
			NOF_DEKMN, 
			NOF_HOPMN,
			STAFF_CD,
			UPDATE_TIME
		) VALUES (
			#{megaNo}, 
			#{megaIdx}, 
			(SELECT 
				ISNULL(MAX(SEQ), 0) + 1 
			FROM 
				TMT_MEGA_DTL_OPE 
			WHERE 
				MEGA_NO = #{megaNo}),
			#{opeDivCd},
			#{opeCompCd}, 
			#{nofGang},
			#{nofStvdSprr},
			#{nofWchmn},
			#{nofStvdGwker},
			#{nofTrmgSprr},
			#{nofSglmn},
			#{nofDekmn},
			#{nofHopmn},
			#{userId},
			SYSDATETIME()
		)
	</insert> 
	
</mapper>
